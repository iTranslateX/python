# ç¬¬12ç«  éƒ¨ç½²

æœ¬ç« ä¸­åŒ…å«å¦‚ä¸‹å°èŠ‚ï¼š

-   å‘å¸ƒå¯å¤ç”¨çš„Djangoåº”ç”¨
-   åœ¨é¢„å‘å¸ƒç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache
-   åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache
-   åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²
-   åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²

## å¼•è¨€

ä¸€æ—¦æœ‰äº†å¯è¿è¡Œçš„ç½‘ç«™æˆ–å¯å¤ç”¨åº”ç”¨ï¼Œä¼šå¸Œæœ›è®©å®ƒå¯¹å¤–å¼€æ”¾ã€‚éƒ¨ç½²ç½‘ç«™æ˜¯é€šè¿‡Djangoå¼€å‘ä¸­æœ€å¤æ‚çš„æ´»åŠ¨ï¼Œå› ä¸ºéœ€è¦å¤„ç†å¾ˆå¤šéƒ¨åˆ†çš„å†…å®¹ï¼š

-   ç®¡ç†webæœåŠ¡å™¨
-   é…ç½®æ•°æ®åº“
-   å¯¹é™æ€å’Œåª’ä½“æ–‡ä»¶æä¾›æœåŠ¡
-   å¤„ç†Djangoé¡¹ç›®
-   é…ç½®ç¼“å­˜
-   è®¾ç½®emailå‘é€
-   ç®¡ç†åŸŸå
-   å®‰æ’åå°ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡
-   é…ç½®æŒç»­é›†æˆ
-   æ ¹æ®é¡¹ç›®è§„æ¨¡å’Œå¤æ‚åº¦æ‰€éœ€çš„å…¶å®ƒä»»åŠ¡

åœ¨è¾ƒå¤§çš„å›¢é˜Ÿä¸­ï¼Œæ‰€æœ‰è¿™äº›ä»»åŠ¡éƒ½æ˜¯ç”±è¿ç»´å·¥ç¨‹å¸ˆå®Œæˆï¼Œå®ƒä»¬è¦æ±‚å¯¹ç½‘ç»œå’Œè®¡ç®—æœºç»“æ„ã€ç®¡ç†LinuxæœåŠ¡å™¨ã€bashè„šæœ¬ç¼–å†™ã€vimä½¿ç”¨ç­‰æœ‰å¾ˆæ·±çš„ç†è§£ã€‚

ä¸“ä¸šç½‘ç«™é€šå¸¸å…·æœ‰å¼€å‘ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒã€‚æ¯ä¸ªç¯å¢ƒéƒ½æœ‰ç‰¹å®šçš„ç›®çš„ã€‚å¼€å‘ç¯å¢ƒç”¨äºåˆ›å»ºé¡¹ç›®ã€‚ç”Ÿæˆç¯å¢ƒæ˜¯å¯¹å¤–ç½‘ç«™æ‰˜ç®¡çš„ä¸€ä¸ªï¼ˆæˆ–ä¸€ç»„ï¼‰æœåŠ¡å™¨ã€‚é¢„å‘å¸ƒç¯å¢ƒæ˜¯ä¸€ç§ç±»ä¼¼äºç”Ÿæˆçš„ç³»ç»Ÿï¼Œä½†ç”¨äºæ£€æµ‹æ–°åŠŸèƒ½åŠåœ¨å‘å¸ƒå‰è¿›è¡Œä¼˜åŒ–ã€‚

## æŠ€æœ¯è¦æ±‚

è¿è¡Œæœ¬ç« çš„ä»£ç è¦æ±‚å®‰è£…æœ€æ–°ç¨³å®šç‰ˆçš„Python 3ã€MySQLæˆ–PostgreSQLæ•°æ®åº“ä»¥åŠé€šè¿‡è™šæ‹Ÿç¯å¢ƒåˆ›å»ºçš„Djangoé¡¹ç›®ã€‚

å¯åœ¨[GitHubä»“åº“](https://github.com/alanhou/django3-cookbook)çš„Chapter12ç›®å½•ä¸­æŸ¥çœ‹æœ¬ç« çš„ä»£ç ã€‚

## å‘å¸ƒå¯å¤ç”¨çš„Djangoåº”ç”¨

Djangoæ–‡æ¡£æœ‰ä¸€ä¸ªå¦‚ä½•å¯¹å¯å¤ç”¨åº”ç”¨è¿›è¡Œæ‰“åŒ…çš„æ•™ç¨‹ï¼Œè¿™äº›åº”ç”¨å¯åœ¨ç¨ååœ¨è™šæ‹Ÿç¯å¢ƒä¸­é€šè¿‡pipè¿›è¡Œå®‰è£…ã€‚è¯·é€šè¿‡https://docs.djangoproject.com/en/3.0/intro/reusable-apps/è¿›è¡ŒæŸ¥çœ‹ã€‚

ä½†æœ‰å¦ä¸€ç§æ‰“åŒ…å’Œå‘å¸ƒå¯å¤ç”¨Djangoåº”ç”¨çš„ï¼ˆæœ‰äººè®¤ä¸ºæ›´å¥½ï¼‰æ–¹å¼ï¼Œä½¿ç”¨ä¸ºä¸åŒä»£ç é¡¹ç›®åˆ›å»ºæ¨¡æ¿çš„å·¥å…·ï¼Œå¦‚æ–°çš„Django CMS ç½‘ç«™ã€Flaskç½‘ç«™æˆ–jQueryæ’ä»¶ã€‚ä¸€ä¸ªå¯ç”¨çš„é¡¹ç›®æ¨¡æ¿æ˜¯cookiecutter-djangopackageã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨å®ƒæ¥å‘å¸ƒå¯å¤ç”¨çš„likesåº”ç”¨ã€‚

### å‡†å¤‡å·¥ä½œ

é€šè¿‡è™šæ‹Ÿç¯å¢ƒæ–°å»ºä¸€ä¸ªé¡¹ç›®å¹¶å®‰è£…cookiecutterï¼Œå¦‚ä¸‹ï¼š

```
(env)$ pip install cookiecutter~=1.7.0
```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å‘å¸ƒlikesåº”ç”¨ï¼š

1.  å¯åŠ¨ä¸€ä¸ªæ–°çš„Djangoåº”ç”¨é¡¹ç›®ï¼Œå¦‚ä¸‹ï¼š  


    ```
    (env)$ cookiecutter https://github.com/pydanny/cookiecutter-djangopackage.git
    ```

    æˆ–è€…å› ä¸ºè¿™æ˜¯ä¸€ä¸ªGitHubæ‰˜ç®¡çš„cookiecutteræ¨¡æ¿ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çŸ­è¯­æ³•ï¼Œå¦‚ä¸‹ï¼š

    ```
    (env)$ cookiecutter gh:pydanny/cookiecutter-djangopackage
    ```

1.  å›ç­”é—®é¢˜æ¥åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¦‚ä¸‹ï¼š  


    ```
    full_name [Your full name here]: Aidas Bendoraitis 
    email [you@example.com]: aidas@bendoraitis.lt 
    github_username [yourname]: archatas
    project_name [Django Package]: django-likes 
    repo_name [dj-package]: django-likes
    app_name [django_likes]: likes
    app_config_name [LikesConfig]:
    project_short_description [Your project description goes here]: Django app for liking anything on your website.
    models [Comma-separated list of models]: Like
    django_versions [1.11,2.1]: master
    version [0.1.0]:
    create_example_project [N]:
    Select open_source_license:
    1 - MIT
    2 - BSD
    3 - ISCL
    4 - Apache Software License 2.0
    5 - Not open source
    Choose from 1, 2, 3, 4, 5 [1]:
    ```

    è¿™ä¼šå¯¹å¯å‘å¸ƒçš„DjangoåŒ…åˆ›å»ºä¸€ä¸ªåŸºæœ¬æ–‡ä»¶ç»“æ„ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

    ```
    django-likes/
    â”œâ”€â”€ docs/
    â”‚   â”œâ”€â”€ Makefile
    â”‚   â”œâ”€â”€ authors.rst
    â”‚   â”œâ”€â”€ conf.py
    â”‚   â”œâ”€â”€ contributing.rst
    â”‚   â”œâ”€â”€ history.rst
    â”‚   â”œâ”€â”€ index.rst
    â”‚   â”œâ”€â”€ installation.rst
    â”‚   â”œâ”€â”€ make.bat
    â”‚   â”œâ”€â”€ readme.rst
    â”‚   â””â”€â”€ usage.rst
    â”œâ”€â”€ likes/
    â”‚   â”œâ”€â”€ static/
    â”‚   â”‚   â”œâ”€â”€ css/
    â”‚   â”‚   â”‚   â””â”€â”€ likes.css
    â”‚   â”‚   â”œâ”€â”€ img/
    â”‚   â”‚   â””â”€â”€ js/
    â”‚   â”‚       â””â”€â”€ likes.js
    â”‚   â”œâ”€â”€ templates/
    â”‚   â”‚   â””â”€â”€ likes/
    â”‚   â”‚       â””â”€â”€ base.html
    â”‚   â””â”€â”€ test_utils/
    â”‚       â”œâ”€â”€ test_app/
    |       â”‚   â”œâ”€â”€ migrations/
    â”‚       â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚       â”‚   â”œâ”€â”€ __init__.py
    â”‚       â”‚   â”œâ”€â”€ admin.py
    â”‚       â”‚   â”œâ”€â”€ apps.py
    â”‚       â”‚   â””â”€â”€ models.html
    â”‚       â”œâ”€â”€ __init__.py
    â”‚       â”œâ”€â”€ admin.py
    â”‚       â”œâ”€â”€ apps.py
    â”‚       â”œâ”€â”€ models.py
    â”‚       â”œâ”€â”€ urls.py
    â”‚       â””â”€â”€ views.py
    â”œâ”€â”€ tests/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ README.md
    â”‚   â”œâ”€â”€ requirements.txt
    â”‚   â”œâ”€â”€ settings.py
    â”‚   â”œâ”€â”€ test_models.py
    â”‚   â””â”€â”€ urls.py
    â”œâ”€â”€ .coveragerc
    â”œâ”€â”€ .editorconfig
    â”œâ”€â”€ .gitignore
    â”œâ”€â”€ .travis.yml
    â”œâ”€â”€ AUTHORS.rst
    â”œâ”€â”€ CONTRIBUTING.rst
    â”œâ”€â”€ HISTORY.rst
    â”œâ”€â”€ LICENSE
    â”œâ”€â”€ MANIFEST.in
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ README.rst
    â”œâ”€â”€ manage.py
    â”œâ”€â”€ requirements.txt
    â”œâ”€â”€ requirements_dev.txt
    â”œâ”€â”€ requirements_test.txt
    â”œâ”€â”€ runtests.py
    â”œâ”€â”€ setup.cfg
    â”œâ”€â”€ setup.py*
    â””â”€â”€ tox.ini
    ```

1.  æ‹·è´Djangoé¡¹ç›®çš„likesåº”ç”¨çš„æ–‡ä»¶æ‹·è´åˆ°django-likes/likesç›®å½•ä¸­ã€‚åœ¨cookiecutteråˆ›å»ºç›¸åŒçš„æ–‡ä»¶æ—¶ï¼Œéœ€è¦åˆå¹¶å†…å®¹ï¼Œè€Œä¸æ˜¯é‡å†™ã€‚ä¾‹å¦‚ï¼Œlikes/__init__.pyæ–‡ä»¶éœ€è¦åŒ…å«ä¸€ä¸ªç‰ˆæœ¬å­—ç¬¦ä¸²æ¥åœ¨åç»­çš„æ­¥éª¤ä¸­é€šè¿‡ setup.pyæ­£å¸¸çš„è¿è¡Œï¼Œå¦‚ä¸‹ï¼š  


    ```
    # django-likes/likes/__init__.py
    __version__ = '0.1.0'
    ```

1.  é‡æ–°å¤„ç†ä¾èµ–ï¼Œè¿™æ ·é‡Œé¢æ²¡æœ‰å¯¹Djangoé¡¹ç›®çš„ä¾èµ–ï¼Œæ‰€æœ‰ä½¿ç”¨çš„å‡½æ•°å’Œç±»éƒ½å¤„äºè¿™ä¸ªåº”ç”¨ä¸­ã€‚ä¾‹å¦‚ï¼Œåœ¨likesåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æœ‰å¯¹coreåº”ç”¨çš„ä¸€äº›mixinsçš„ä¾èµ–ã€‚éœ€è¦å°†ç›¸å…³ä»£ç æ‹·è´åˆ°django-likesåº”ç”¨ä¸­ã€‚  


    > â„¹ï¸æˆ–è€…ï¼Œå¦‚æœæœ‰å¾ˆå¤šä¾èµ–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªéè€¦åˆåŒ…å‘å¸ƒcoreåº”ç”¨ï¼Œä½†è¿™æ ·æˆ‘ä»¬å°±éœ€è¦å•ç‹¬è¿›è¡Œç»´æŠ¤äº†ã€‚

1.  å°†å¯å¤ç”¨åº”ç”¨é¡¹ç›®ä½¿ç”¨æ­¤å‰è¾“å…¥çš„repo_nameæ·»åŠ åˆ°GitHubçš„Gitä»“åº“ä¸­ã€‚

1.  æŸ¥çœ‹å„ä¸ªæ–‡ä»¶å¹¶å®Œæˆè¯ä¹¦ã€READMEã€æ–‡æ¡£ã€é…ç½®åŠå…¶å®ƒæ–‡ä»¶ã€‚

1.  ç¡®ä¿åº”ç”¨é€šè¿‡cookiecutteræ¨¡æ¿æµ‹è¯•ï¼š  


    ```
    (env)$ pip install -r requirements_test.txt
    (env)$ python runtests.py
    Creating test database for alias 'default'...
    System check identified no issues (0 silenced).
    . 
    ----------------------------------------------------------------------
    Ran 1 test in 0.001s

    OK
    Destroying test database for alias 'default'...
    ```

1.  å¦‚æœä½ çš„åŒ…æ˜¯é—­æºçš„ï¼Œåˆ›å»ºä¸€ä¸ªå¯åˆ†äº«çš„ZIPå‹ç¼©åŒ…ï¼Œå¦‚ä¸‹ï¼š  


    ```
    (env)$ python setup.py sdist
    ```

    è¿™ä¼šåˆ›å»ºä¸€ä¸ªdjango-likes/dist/django-likes-0.1.0.tar.gzæ–‡ä»¶ï¼Œç„¶åå¯åœ¨ä»»æ„é¡¹ç›®çš„è™šæ‹Ÿç¯å¢ƒä¸­é€šè¿‡pipè¿›è¡Œå®‰è£…å’Œå¸è½½ï¼Œå¦‚ä¸‹ï¼š

    ```
    (env)$ pip install django-likes-0.1.0.tar.gz 
    (env)$ pip uninstall django-likes
    ```

1.  å¦‚æœä½ çš„åŒ…æ˜¯å¼€æºçš„ï¼Œå¯ä»¥æ³¨å†Œå¹¶å°†åº”ç”¨å‘å¸ƒè‡³Pythonå®‰è£…åŒ…ç´¢å¼•ï¼ˆPyPIï¼‰ï¼š  


    ```
    (env)$ python setup.py register 
    (env)$ python setup.py publish
    ```

1.  åŒæ—¶è¦è®©æ›´å¤šäººçŸ¥æ™“ï¼Œå¯ä»¥åº”ç”¨é€šè¿‡https://www.djangopackages.com/packages/add/ä¸­çš„è¡¨å•æ·»åŠ è‡³Djangoå®‰è£…åŒ…ä¸­ã€‚

### å®ç°åŸç†...

Cookiecutteråœ¨Djangoåº”ç”¨é¡¹ç›®æ¨¡æ¿çš„ä¸åŒåœ°æ–¹æ·»åŠ å…¥è¯·æ±‚æ•°æ®ï¼Œå¦‚æœä¸æƒ³è¦è¾“å…¥å†…å®¹å¯ä»¥æŒ‰ä¸‹Enteré”®ä½¿ç”¨ **[æ–¹æ‹¬å·]** å†…æ‰€ç»™å®šçš„é»˜è®¤å€¼ã€‚è¿™æ ·å°±å¯ä»¥è·å–èƒ½å…å‘å¸ƒåˆ°Pythonå®‰è£…åŒ…ç´¢å¼•çš„setup.pyã€Sphinxæ–‡æ¡£ã€é»˜è®¤è¯ä¹¦ä¸ºMITã€é¡¹ç›®çš„ç»Ÿä¸€æ–‡æœ¬ç¼–è¾‘å™¨é…ç½®ã€åº”ç”¨ä¸­æ‰€åŒ…å«çš„é™æ€æ–‡ä»¶å’Œæ¨¡å—ä»¥åŠå…¶å®ƒæœ‰ç›Šçš„å†…å®¹ã€‚

### ç›¸å…³å†…å®¹

-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åˆ›å»ºé¡¹ç›®æ–‡ä»¶ç»“æ„*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*ä½¿ç”¨Dockerå®¹å™¨å¤„ç†Django, Gunicorn, Nginxå’ŒPostgreSQL*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*é€šè¿‡pipå¤„ç†é¡¹ç›®ä¾èµ–*ä¸€èŠ‚
-   **[ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript](https://alanhou.org/django3-templates-javascript/)**ä¸­çš„*å®ç°Likeå¾®ä»¶*ä¸€èŠ‚
-   **[ç¬¬11ç«  æµ‹è¯•](https://alanhou.org/django3-testing/)**ä¸­çš„*ä½¿ç”¨mockåº“æµ‹è¯•è§†å›¾*ä¸€èŠ‚

## åœ¨é¢„å‘å¸ƒç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache

æœ¬èŠ‚ä¸­æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œæ¥åœ¨ç”µè„‘çš„è™šæ‹Ÿæœºä¸­çš„é¢„å‘å¸ƒç¯å¢ƒä¸­éƒ¨ç½²é¡¹ç›®ã€‚è¿™ä¸€é¡¹ç›®ä¼šä½¿ç”¨å¸¦æœ‰mod_wsgiæ¨¡å—çš„Apacheç½‘é¡µæœåŠ¡å™¨ã€‚å®‰è£…ä¸­æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°Ansibleã€Vagrantå’ŒVirtualBoxã€‚å‰é¢æåˆ°è¿‡æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦å¤„ç†ï¼Œå¹¶ä¸”é€šå¸¸éœ€è¦èŠ±å‡ å¤©æ¥éƒ¨ç½²ç±»ä¼¼äºäº›çš„ä¼˜åŒ–éƒ¨ç½²è„šæœ¬ã€‚

### å‡†å¤‡å·¥ä½œ

æŒ‰ç…§https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/é¡µé¢æ‰€åˆ—çš„éƒ¨ç½²æ¸…å•ã€ç¡®ä¿é…ç½®é€šè¿‡æ‰€æœ‰çš„å®‰å…¨æ¨èã€‚è‡³å°‘è¦ä¿è¯åœ¨è¿è¡Œå¦‚ä¸‹å‘½ä»¤æ—¶é¡¹ç›®é…ç½®ä¸ä¼šæŠ›å‡ºè­¦å‘Šï¼š

```
(env)$ python manage.py check --deploy --settings=myproject.settings.staging
```

å®‰è£…æœ€æ–°çš„ç¨³å®šç‰ˆAnsibleã€Vagrantå’ŒVirtualBoxã€‚å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„å®˜ç½‘è¿›è¡Œè·å–ï¼š

-   [**Ansible**](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
-   **[VirtualBox](https://www.virtualbox.org/wiki/Downloads)**
-   **[Vagrant](https://www.vagrantup.com/downloads.html)**

macOS Xä¸­å¯ä»¥ä½¿ç”¨HomeBrewæ¥è¿›è¡Œå®‰è£…ï¼š

```
$ brew install ansible
$ brew cask install virtualbox
$ brew cask install vagrant
```

### å¦‚ä½•å®ç°...

é¦–å…ˆï¼Œéœ€è¦å¯¹æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„ä¸åŒæœåŠ¡åˆ›å»ºé…ç½®æ¨¡æ¿ã€‚é¢„å‘å¸ƒå’Œç”Ÿäº§éƒ¨ç½²è¿‡ç¨‹ä¸­éƒ½ä¼šä½¿ç”¨åˆ°ï¼š

1.  åœ¨Djangoé¡¹ç›®ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªdeploymentç›®å½•ï¼Œå¹¶åœ¨å…¶å†…åˆ›å»ºä¸€ä¸ªansible_templatesç›®å½•ã€‚

1.  åˆ›å»ºä¸€ä¸ªç”¨äºæ—¶åŒºé…ç½®çš„Jinjaæ¨¡æ¿æ–‡ä»¶ï¼š  


    ```
    {# deployment/ansible_templates/timezone.j2 #}
    {{ timezone }}
    ```

1.  åœ¨é…ç½®SSLè¯ä¹¦å‰ä¸ºApacheåŸŸåé…ç½®åˆ›å»ºä¸€ä¸ªJinjaæ¨¡æ¿æ–‡ä»¶ï¼š  


    ```
    {# deployment/ansible_templates/apache_site-pre.conf.j2 #}
    <VirtualHost *:80>
        ServerName {{ domain_name }}
        ServerAlias {{ domain_name }} www.{{ domain_name }}

        DocumentRoot {{ project_root }}/public_html 
        DirectoryIndex index.html
        
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        AliasMatch ^/.well-known/(.*) "/var/www/letsencrypt/$1"

        <Directory "/var/www/letsencrypt">
            Require all granted
        </Directory>

        <Directory "/">
            Require all granted
        </Directory>
        
    </VirtualHost>
    ```

1.  ä¸ºåŒ…å«è¯ä¹¦çš„ApacheåŸŸåé…ç½®åˆ›å»ºJinjaæ¨¡æ¿æ–‡ä»¶deployment/ansible_templates/apache_site.conf.j2 ã€‚è¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹å¯ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-apache/ansible_templates/apache_site.conf.j2è¿›è¡Œæ‹·è´ã€‚

1.  ä½¿ç”¨https://github.com/postgres/postgres/blob/REL_10_STABLE/src/backend/utils/misc/postgresql.conf.sampleçš„å†…å®¹ä¸ºPostgreSQLé…ç½®åˆ›å»ºæ¨¡æ¿æ–‡ä»¶deployment/ansible_templates/postgresql.j2ã€‚ç¨åå¯ä»¥å¯¹é…ç½®è¿›è¡Œä¿®æ”¹åœ¨åŒ¹é…æœåŠ¡çš„è¦æ±‚ã€‚

1.  ä¸ºPostgreSQLçš„æƒé™é…ç½®æ–‡ä»¶åˆ›å»ºæ¨¡æ¿ï¼ˆå½“å‰æˆæƒè¾ƒå¤§ï¼Œç¨åå¯æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œä¿®æ”¹ï¼‰ï¼š  


    ```
    {# deployment/ansible_templates/pg_hba.j2 #}
    # TYPE  DATABASE        USER           CIDR-ADDRESS    METHOD
    local   all             all                            ident
    host    all             all            ::0/0           md5
    host    all             all            0.0.0.0/32      md5
    host    {{ db_name }}   {{ db_user }}  127.0.0.1/32    md5
    ```

1.  ä¸ºPostfixé‚®ä»¶æœåŠ¡é…ç½®åˆ›å»ºæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/postfix.j2 #}
    # See /usr/share/postfix/main.cf.dist for a commented, more 
    # complete version


    # Debian specific:  Specifying a file name will cause the first
    # line of that file to be used as the name.  The Debian default
    # is /etc/mailname.
    # myorigin = /etc/mailname

    smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
    biff = no

    # appending .domain is the MUA's job.
    append_dot_mydomain = no

    # Uncomment the next line to generate "delayed mail" warnings
    #delay_warning_time = 4h

    readme_directory = no

    # TLS parameters
    smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
    smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
    smtpd_use_tls=yes
    smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
    smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

    # See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc 
    # package for information on enabling SSL 
    # in the smtp client.

    smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
    myhostname = {{ domain_name }}
    alias_maps = hash:/etc/aliases
    alias_database = hash:/etc/aliases
    mydestination = $myhostname, localhost, localhost.localdomain, , 
     localhost
    relayhost =
    mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
    mailbox_size_limit = 0
    recipient_delimiter = +
    inet_interfaces = all
    inet_protocols = all
    virtual_alias_domains = {{ domain_name }}
    virtual_alias_maps = hash:/etc/postfix/virtual
    ```

1.  ä¸ºemailè½¬å‘é…ç½®åˆ›å»ºæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/virtual.j2 #}
    # /etc/postfix/virtual

    hello@{{ domain_name }} admin@example.com 
    @{{ domain_name }} admin@example.com
    ```

1.  ä¸ºmemcachedé…ç½®åˆ›å»ºæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/memcached.j2 #}
    # memcached default config file
    # 2003 - Jay Bonci <jaybonci@debian.org>
    # This configuration file is read by the start-memcached script 
    # provided as part of the Debian GNU/Linux
    # distribution.

    # Run memcached as a daemon. This command is implied, and is not 
    # needed for the daemon to run. See the README.Debian that
    # comes with this package for more information. 
    -d

    # Log memcached's output to /var/log/memcached 
    logfile /var/log/memcached.log

    # Be verbose 
    # -v

    # Be even more verbose (print client commands as well) 
    # -vv

    # Use 1/16 of server RAM for memcached
    -m {{ (ansible_memtotal_mb * 0.0625) | int }}

    # Default connection port is 11211 
    -p 11211

    # Run the daemon as root. The start-memcached will default to 
    # running as root if no -u command is present
    # in this config file
    -u memcache

    # Specify which IP address to listen on. The default is to 
    # listen on all IP addresses
    # This parameter is one of the only security measures that 
    # memcached has, so make sure it's listening on
    # a firewalled interface. 
    -l 127.0.0.1

    # Limit the number of simultaneous incoming connections. 
    # The daemon default is 1024
    # -c 1024

    # Lock down all paged memory. Consult with the README and 
    # homepage before you do this
    # -k

    # Return error when memory is exhausted (rather than 
    # removing items)
    # -M

    # Maximize core file limit 
    # -r
    ```

1.  æœ€åä¸ºsecrets.jsonæ–‡ä»¶åˆ›å»ºä¸€ä¸ªJinjaæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/secrets.json.j2 #}
    {
        "DJANGO_SECRET_KEY": "{{ django_secret_key }}", 
        "DATABASE_ENGINE": "django.contrib.gis.db.backends.postgis", 
        "DATABASE_NAME": "{{ db_name }}",
        "DATABASE_USER": "{{ db_user }}",
        "DATABASE_PASSWORD": "{{ db_password }}",
        "EMAIL_HOST": "{{ email_host }}",
        "EMAIL_PORT": "{{ email_port }}",
        "EMAIL_HOST_USER": "{{ email_host_user }}", 
        "EMAIL_HOST_PASSWORD": "{{ email_host_password }}"
    }
    ```

ç°åœ¨æ“ä½œé’ˆå¯¹é¢„å‘å¸ƒç¯å¢ƒçš„Vagrantå’ŒAnsibleè„šæœ¬ï¼š

1.  åœ¨.gitignoreæ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä»£ç è¡Œåœ¨å¿½ç•¥Vagrantå’ŒAnsibleç›¸å…³çš„æ–‡ä»¶ï¼š  


    ```
    # .gitignore
    # Secrets 
    secrets.json 
    secrets.yml

    # Vagrant / Ansible 
    .vagrant
    *.retry
    ```

1.  åˆ›å»ºä¸¤ä¸ªç›®å½•deployment/staging å’Œ deployment/staging/ansibleã€‚

1.  åœ¨å…¶ä¸­åˆ›å»ºVagrantfileæ–‡ä»¶æ¥é…ç½®Ubuntu 18è™šæ‹Ÿæœºå¹¶åœ¨å…¶ä¸­è¿è¡ŒAnsibleè„šæœ¬ï¼š  


    ```
    # deployment/staging/ansible/Vagrantfile
    VAGRANTFILE_API_VERSION = "2"

    Vagrant.configure(VAGRANTFILE_API_VERSION) do |config| 
        config.vm.box = "bento/ubuntu-18.04" 
        config.vm.box_version = "201912.14.0" 
        config.vm.box_check_update = false 
        config.ssh.insert_key=false
        config.vm.provider "virtualbox" do |v| 
            v.memory = 512
            v.cpus = 1
            v.name = "myproject"
        end
        config.vm.network "private_network", ip: "192.168.50.5" 
        config.vm.provision "ansible" do |ansible|
            ansible.limit = "all"
            ansible.playbook = "setup.yml" 
            ansible.inventory_path = "./hosts/vagrant" 
            ansible.host_key_checking = false
            ansible.verbose = "vv"
            ansible.extra_vars = { ansible_python_interpreter: "/usr/bin/python3" }
        end 
    end
    ```

1.  åˆ›å»ºhostsç›®å½•ï¼Œå…¶ä¸­åŒ…å«vagrantæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š  


    ```
     # deployment/staging/ansible/hosts/vagrant
    [servers] 
    192.168.50.5
    ```

1.  åˆ›å»ºä¸€ä¸ªvars.ymlæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åœ¨å®‰è£…è„šæœ¬å’Œç”¨äºé…ç½®çš„Jinjaè„šæœ¬ä¸­ä¼šä½¿ç”¨åˆ°çš„å˜é‡ï¼š  


    ```
    # deployment/staging/ansible/vars.yml
    ---
    # a unix path-friendly name (IE, no spaces or special characters) 
    project_name: myproject

    user_username: "{{ project_name }}"

    # the base path to install to. You should not need to change this. 
    install_root: /home

    project_root: "{{ install_root }}/{{ project_name }}"

    # the python module path to your project's 
    wsgi file wsgi_module: myproject.wsgi

    # any directories that need to be added to the PYTHONPATH. 
    python_path: "{{ project_root }}/src/{{ project_name }}"

    # the git repository URL for the project
    project_repo: git@github.com:archatas/django-myproject.git

    # The value of your django project's STATIC_ROOT settings. 
    static_root: "{{ python_path }}/static"
    media_root: "{{ python_path }}/media"

    locale: en_US.UTF-8 
    timezone: Europe/Berlin

    domain_name: myproject.192.168.50.5.xip.io 
    django_settings: myproject.settings.staging

    letsencrypt_email: "" 
    wsgi_file_name: wsgi_staging.py
    ```

1.  æˆ‘ä»¬è¿˜éœ€è¦å¸¦æœ‰å¯†ç å’Œè®¤è¯å¯†é’¥ç­‰ç§å¯†å€¼çš„secrets.ymlæ–‡ä»¶ã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ªä¸å«æ•æ„Ÿä¿¡æ¯çš„sample_secrets.ymlæ–‡ä»¶ï¼Œå…¶ä¸­åªåŒ…å«å˜é‡åï¼Œå°†å…¶æ‹·è´åˆ°secrets.ymlä¹‹ä¸­å¹¶å¡«å†™å¯†é’¥ä¿¡æ¯ã€‚å‰ä¸€ä¸ªæ–‡ä»¶å¤„äºç‰ˆæœ¬æ§åˆ¶ä¹‹ä¸‹ï¼Œè€Œåä¸€ä¸ªæ–‡ä»¶åˆ™è¿›è¡Œå¿½ç•¥ï¼š  


    ```
    # deployment/staging/ansible/sample_secrets.yml
    # Django Secret Key
    django_secret_key: "change-this-to-50-characters-long-random-string"

    # PostgreSQL database settings
    db_name: "myproject"
    db_user: "myproject"
    db_password: "change-this-to-a-secret-password" 
    db_host: "localhost"
    db_port: "5432"

    # Email SMTP settings
    email_host: "localhost"
    email_port: "25"
    email_host_user: ""
    email_host_password: ""

    # a private key that has access to the repository URL 
    ssh_github_key: ~/.ssh/id_rsa_github
    ```

1.  åœ¨deployment/staging/ansible/setup.ymlä¸­åˆ›å»ºAnsibleè„šæœ¬ï¼ˆç§°ä¹‹ä¸ºplaybookï¼‰ï¼Œç”¨äºå®‰è£…æ‰€æœ‰ä¾èµ–åŠé…ç½®æœåŠ¡ã€‚é€šè¿‡https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-apache/staging/ansible/setup.ymlæ‹·è´è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚

1.  ç„¶ååœ¨deployment/staging/ansible/deploy.ymlä¸­åˆ›å»ºå¦ä¸€ä¸ªAnsibleè„šæœ¬ç”¨äºå¤„ç†Djangoé¡¹ç›®ã€‚ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-apache/staging/ansible/deploy.ymlä¸­æ‹·è´è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚

1.  åˆ›å»ºç”¨äºæ‰§è¡Œå¯åŠ¨éƒ¨ç½²çš„bashè„šæœ¬ï¼š  


    ```
    # deployment/staging/ansible/setup_on_virtualbox.sh
    #!/usr/bin/env bash
    echo "=== Setting up the local staging server ===" 
    date

    cd "$(dirname "$0")" 
    vagrant up --provision
    ```

1.  ä¸ºbashè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿è¡Œï¼š  


    ```
    $ chmod +x setup_on_virtualbox.sh 
    $ ./setup_on_virtualbox.sh
    ```

1.  å¦‚æœè„šæœ¬å› æŠ¥é”™è€Œå¤±è´¥ï¼Œå¾ˆå¯èƒ½è¦é‡å¯è™šæ‹Ÿæœºæ¥è®©ä¿®æ”¹ç”Ÿæ•ˆã€‚å¯ä»¥é€šè¿‡sshè¿æ¥åˆ°è™šæ‹Ÿæœºï¼Œä¿®æ”¹ä¸ºrootç”¨æˆ·ï¼Œç„¶åè¿›è¡Œé‡å¯ï¼Œå¦‚ä¸‹ï¼š  


    ```
    $ vagrant ssh
    Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-72-generic x86_64)

     * Documentation:  https://help.ubuntu.com
     * Management:     https://landscape.canonical.com
     * Support:        https://ubuntu.com/advantage

      System information as of Wed Jan 15 04:44:42 CET 2020

      System load:  0.21              Processes:           126
      Usage of /:   4.0% of 61.80GB   Users logged in:     1
      Memory usage: 35%               IP address for eth0: 10.0.2.15
      Swap usage:   4%                IP address for eth1: 192.168.50.5


    0 packages can be updated.
    0 updates are security updates.


    *** System restart required ***

    This system is built by the Bento project by Chef Software
    More information can be found at https://github.com/chef/bento
    Last login: Wed Jan 15 04:43:32 2020 from 192.168.50.1
    vagrant@myproject:~$ sudo su
    root@myproject:/home/vagrant#
    reboot
    Connection to 127.0.0.1 closed by remote host.
    Connection to 127.0.0.1 closed.
    ```

1.  è¦æµè§ˆDjangoé¡¹ç›®ç›®å½•ï¼Œsshè¿æ¥è‡³è™šæ‹Ÿæœºå¹¶ä¿®æ”¹ç”¨æˆ·ä¸ºmyprojectï¼Œå¦‚ä¸‹ï¼š  


    ```
    $ vagrant ssh
    Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64) 
    #...
    vagrant@myproject:~$ sudo su - myproject
    (env) myproject@myproject:~$ pwd
    /home/myproject
    (env) myproject@myproject:~$ ls
    commands db_backups logs public_html src env
    ```

### å®ç°åŸç†...

VirtualBoxè®©æˆ‘ä»¬å¯ä»¥åœ¨ä¸€å°ç”µè„‘ä¸Šå®‰è£…å¤šä¸ªä¸æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿä¸»æœºã€‚Vagrantæ˜¯ä¸€ä¸ªåˆ›å»ºè¿™äº›è™šæ‹Ÿä¸»æœºä»¥åŠä½¿ç”¨è„šæœ¬åœ¨å…¶ä¸­ä¸‹è½½å’Œå®‰è£…æ“ä½œç³»ç»Ÿçš„å·¥å…·ã€‚Ansibleæ˜¯ä¸€ä¸ªåŸºäºPythonå·¥å…·ï¼Œå®ƒè¯»å–.yamlé…ç½®æ–‡ä»¶ä¸­çš„æŒ‡ä»¤å¹¶åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿›è¡Œæ‰§è¡Œã€‚

æˆ‘ä»¬æ‰€ç¼–å†™çš„éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

-   åœ¨VirtualBoxä¸­åˆ›å»ºè™šæ‹Ÿæœºå¹¶å®‰è£…Ubuntu 18
-   ä¸ºè™šæ‹Ÿæœºåˆ†é…IP192.168.50.5
-   ä¸ºè™šæ‹Ÿæœºè®¾ç½®ä¸»æœºå
-   å‡çº§LinuxåŒ…
-   ä¸ºæœåŠ¡å™¨é…ç½®æœ¬åœ°åŒ–è®¾ç½®
-   å®‰è£…æ‰€æœ‰Linuxä¾èµ–ï¼ŒåŒ…æ‹¬Pythonã€Apacheã€PostgreSQLã€Postfixå’ŒMemcachedç­‰
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºä¸€ä¸ªLinuxç”¨æˆ·å’Œå®¶ç›®å½•
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
-   åˆ›å»ºPostgreSQLæ•°æ®åº“ç”¨æˆ·åŠæ•°æ®åº“
-   é…ç½®Apacheç½‘é¡µæœåŠ¡å™¨
-   å®‰è£…è‡ªç­¾ç½²SSLè¯ä¹¦
-   é…ç½®Memcachedç¼“å­˜æœåŠ¡
-   é…ç½®Postfixé‚®ä»¶æœåŠ¡å™¨
-   å…‹éš†Djangoé¡¹ç›®ä»“åº“
-   å®‰è£…Pythonä¾èµ–
-   åˆ›å»ºsecrets.jsonæ–‡ä»¶
-   è¿ç§»æ•°æ®åº“
-   è½¬å­˜é™æ€æ–‡ä»¶
-   é‡å¯Apache

ç°åœ¨å¯é€šè¿‡https://www.myproject.192.168.50.5.xip.ioè®¿é—®Djangoç½‘ç«™ï¼Œæ˜¾ç¤ºHello, World!é¡µã€‚æ³¨æ„æœ‰äº›æµè§ˆå™¨ï¼Œå¦‚Chromeï¼Œå¯èƒ½ä¸å¸Œæœ›æ‰“å¼€è‡ªç­¾ç½²SSLè¯ä¹¦çš„ç½‘ç«™ï¼Œå¹¶é‡‡å–å±è”½æ‰“å¼€çš„å®‰å…¨æªæ–½ã€‚

> ğŸ’¡xip.ioæ˜¯ä¸€ç§é€šé…DNSæœåŠ¡ï¼Œå°†æŒ‡å®š IPçš„å­åŸŸåæŒ‡å‘æŸä¸€IPï¼Œå¹¶å…è®¸ä½¿ç”¨SSLè¯ä¹¦æˆ–å…¶å®ƒéœ€è¦ä½¿ç”¨åŸŸåçš„ç½‘ç«™åŠŸèƒ½ã€‚

å¦‚æœå¸Œæœ›ä½¿ç”¨ä¸åŒçš„é…ç½®æˆ–æ›´å¤šå‘½ä»¤è¿›è¡ŒéªŒè¯ï¼Œåˆç†çš„æ–¹å¼æ˜¯ä¸€ç‚¹ç‚¹å¢åŠ ä¿®æ”¹ã€‚æœ‰äº›éƒ¨åˆ†åœ¨å°†ä»»åŠ¡è½¬åŒ–ä¸ºAnsibleæŒ‡ä»¤ä¹‹å‰éœ€è¦ç›´æ¥åœ¨è™šæ‹Ÿæœºä¸Šè¿›è¡Œæµ‹è¯•ã€‚

> ğŸ’¡æœ‰å…³Ansibleçš„ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹å…¶[å®˜æ–¹ç½‘ç«™](https://docs.ansible.com/ansible/latest/index.html)ã€‚å®ƒå±•ç¤ºäº†å¾ˆå¤šç”¨ä¾‹çš„æœ‰ç”¨ç¤ºä¾‹ã€‚

å¦‚æœä»»ä½•æœåŠ¡æŠ¥é”™ï¼Œsshè¿æ¥åˆ°è™šæ‹Ÿæœºï¼Œåˆ‡æ¢ä¸ºrootç”¨æˆ·ï¼ŒæŸ¥çœ‹è¯¥æœåŠ¡çš„æ—¥å¿—ã€‚Google é”™è¯¯ç³»ç»Ÿå¯ä»¥è®©æˆ‘ä»¬çš„ç³»ç»Ÿæ›´å¿«æ­£å¸¸è¿è¡Œã€‚

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡å»ºè™šæ‹Ÿæœºï¼š

```
$ vagrant destroy
$ vagrant up --provision
```

### ç›¸å…³å†…å®¹

-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åˆ›å»ºé¡¹ç›®æ–‡ä»¶ç»“æ„*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*é€šè¿‡pipå¤„ç†é¡¹ç›®ä¾èµ–*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åŠ¨æ€è®¾ç½®STATIC_URL*ä¸€èŠ‚
-   *åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚
-   *åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸€èŠ‚
-   *åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*åˆ›å»ºåŠè¿˜åŸPostgreSQLæ•°æ®åº“å¤‡ä»½*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*é…ç½®cron jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡*ä¸€èŠ‚

## åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache

Apacheæ˜¯æœ€æµè¡Œçš„webæœåŠ¡å™¨ä¹‹ä¸€ã€‚å¯¹äºåœ¨åŒä¸€æœåŠ¡å™¨ä¸Šå­˜åœ¨è¦æ±‚Apacheçš„æœåŠ¡å™¨ç®¡ç†ã€ç›‘æ§ã€åˆ†æã€åšå®¢ã€ç”µå•†ç­‰æ—¶ï¼Œä½¿ç”¨Apacheæ¥éƒ¨ç½²Djangoæ˜¯å¾ˆè‡ªç„¶çš„é€‰æ‹©ã€‚

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨å‰ä¸€å°èŠ‚çš„å†…å®¹ï¼Œå®ç°ä¸€ä¸ªAnsibleè„šæœ¬ï¼ˆplaybookï¼‰æ¥åœ¨ç”Ÿäº§ç¯å¢ƒé…ç½®å¸¦æœ‰mod_wsgiæ¨¡å—çš„Apacheã€‚

### å‡†å¤‡å·¥ä½œ

ç¡®ä¿åœ¨è¿è¡Œå¦‚ä¸‹å‘½ä»¤æ—¶é¡¹ç›®é…ç½®ä¸ä¼šæŠ›å‡ºè­¦å‘Šï¼š

```
(env)$ python manage.py check --deploy --settings=myproject.settings.production
```

è¯·å®‰è£…æœ€æ–°ç¨³å®šç‰ˆçš„Ansibleã€‚

é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨æä¾›å•†åˆ›å»ºä¸€ä¸ªç‹¬ç«‹æœåŠ¡å™¨ï¼Œå¯ä½¿ç”¨å…¬é’¥åŠç§é’¥è®¤è¯é€šè¿‡SSHè¿›è¡Œ root è®¿é—®ã€‚æˆ‘é€‰æ‹©çš„æä¾›å•†æ˜¯[DigitalOcean](https://www.digitalocean.com)ï¼Œé€šè¿‡å®ƒæˆ‘åˆ›å»ºäº†ä¸€ä¸ªUbuntu 18ç³»ç»Ÿçš„ç‹¬ç«‹æœåŠ¡å™¨ï¼ˆDropletï¼‰ã€‚æˆ‘å¯ä»¥ä½¿ç”¨æ–°çš„SSHç§é’¥å’Œå…¬é’¥å¯¹é€šè¿‡ IP 142.93.167.30è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œåˆ†åˆ«ä¸º~/.ssh/id_rsa_django_cookbook å’Œ ~/.ssh/id_rsa_django_cookbook.pubã€‚

æœ¬åœ°æˆ‘ä»¬éœ€è¦æŒ‰ç…§å¦‚ä¸‹å†…å®¹åˆ›å»ºæˆ–ä¿®æ”¹ ~/.ssh/configæ–‡ä»¶æ¥é…ç½®SSHè¿æ¥ï¼š

```
# ~/.ssh/config
Host *
   ServerAliveInterval 240
   AddKeysToAgent yes
   UseKeychain yes
       
Host github
    Hostname github.com
    IdentityFile ~/.ssh/id_rsa_github

Host myproject-apache
    Hostname 142.93.167.30
    User root
    IdentityFile ~/.ssh/id_rsa_django_cookbook
```

ç°åœ¨æˆ‘ä»¬åº”è¯¥å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é€šè¿‡SSHä»¥rootç”¨æˆ·è¿æ¥åˆ°è¿™å°ç‹¬ç«‹ä¸»æœºï¼š

```
$ ssh myproject-apache
```

åœ¨åŸŸåé…ç½®ä¸­ï¼Œå°†åŸŸåçš„DNS Aè®°å½•æŒ‡å‘ç‹¬ç«‹æœåŠ¡å™¨çš„IPåœ°å€ã€‚é…åˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨myproject.142.93.167.30.xip.ioæ¥å±•ç¤ºå¦‚ä½•ä¸ºDjangoç«™ç‚¹é…ç½®SSLè¯ä¹¦ã€‚

> â„¹ï¸å‰é¢æåˆ°è¿‡ï¼Œxip.ioæ˜¯ä¸€ä¸ªé€šé…DNSæœåŠ¡ï¼Œå®ƒå°†å…·ä½“IPçš„å­åŸŸåæŒ‡å‘IPå¹¶å¯ä»¥ç”¨å®ƒæ·»åŠ SSLè¯ä¹¦æˆ–å…¶å®ƒéœ€è¦ç”¨åˆ°åŸŸåçš„ç½‘ç«™åŠŸèƒ½ã€‚

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ä¸ºç”Ÿäº§ç¯å¢ƒåˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼š

1.  ç¡®ä¿æœ‰å‰é¢*åœ¨é¢„å‘å¸ƒç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚ä¸­åˆ›å»ºçš„ deployment/ansible_templatesåŠç”¨äºæœåŠ¡é…ç½®çš„Jinjaæ¨¡æ¿ã€‚

1.  ä¸ºAnsibleè„šæœ¬åˆ›å»ºdeployment/production å’Œ deployment/production/ansibleç›®å½•ã€‚

1.  åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªhostsç›®å½•ä»¥åŠåŒ…å«å¦‚ä¸‹å†…å®¹çš„remoteæ–‡ä»¶ï¼š  


    ```
    # deployment/production/ansible/hosts/remote
    [servers] 
    myproject-apache

    [servers:vars] 
    ansible_python_interpreter=/usr/bin/python3
    ```

1.  åˆ›å»ºä¸€ä¸ªvars.yml æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å®‰è£…è„šæœ¬å’Œé…ç½®çš„Jinjaæ¨¡æ¿æ‰€ä½¿ç”¨çš„å˜é‡ï¼š  


    ```
    # deployment/production/ansible/vars.yml
    ---
    # a unix path-friendly name (IE, no spaces or special characters) 
    project_name: myproject
               
    user_username: "{{ project_name }}"
    # the base path to install to. You should not need to change this. 
    install_root: /home

    project_root: "{{ install_root }}/{{ project_name }}"

    # the python module path to your project's wsgi file 
    wsgi_module: myproject.wsgi

    # any directories that need to be added to the PYTHONPATH. 
    python_path: "{{ project_root }}/src/{{ project_name }}"

    # the git repository URL for the project
    project_repo: git@github.com:archatas/django-myproject.git

    # The value of your django project's STATIC_ROOT settings. 
    static_root: "{{ python_path }}/static"
    media_root: "{{ python_path }}/media"

    locale: en_US.UTF-8 
    timezone: Europe/Berlin

    domain_name: myproject.142.93.167.30.xip.io 
    django_settings: myproject.settings.production

    # letsencrypt settings 
    letsencrypt_email: hello@myproject.com 
    wsgi_file_name: wsgi_production.py
    ```

1.  åŒæ—¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŒ…å«å¯†ç åŠè®¤è¯å¯†é’¥ç­‰ç§å¯†å€¼çš„secrets.ymlæ–‡ä»¶ã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ªä¸åŒ…å«æ•æ„Ÿä¿¡æ¯åªå…·æœ‰å˜é‡åçš„sample_secrets.ymlæ–‡ä»¶ï¼Œç„¶åæ‹·è´åˆ°secrets.ymlå¹¶å¡«å†™ç§å¯†ä¿¡æ¯ã€‚å‰ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œåä¸€ä¸ªè¿›è¡Œå¿½ç•¥ï¼š  


    ```
    # deployment/production/ansible/sample_secrets.yml
    # Django Secret Key
    django_secret_key: "change-this-to-50-characters-long-random-string"

    # PostgreSQL database settings
    db_name: "myproject"
    db_user: "myproject"
    db_password: "change-this-to-a-secret-password" 
    db_host: "localhost"
    db_port: "5432"

    # Email SMTP settings
    email_host: "localhost"
    email_port: "25"
    email_host_user: ""
    email_host_password: ""

    # a private key that has access to the repository URL 
    ssh_github_key: ~/.ssh/id_rsa_github
    ```

1.  åˆ›å»ºä¸€ä¸ªAnsibleè„šæœ¬ï¼ˆplaybookï¼‰deployment/production/ansible/setup.ymlï¼Œç”¨äºå®‰è£…æ‰€æœ‰ä¾èµ–åŠé…ç½®æœåŠ¡ã€‚é€šè¿‡https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-apache/production/ansible/setup.ymlå¤åˆ¶è¿™ä¸€æ–‡ä»¶çš„å†…å®¹ã€‚

1.  ç„¶ååˆ›å»ºå¦ä¸€ä¸ªAnsibleè„šæœ¬deployment/production/ansible/deploy.ymlï¼Œç”¨äºå¤„ç†Djangoé¡¹ç›®ï¼Œé€šè¿‡https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-apache/production/ansible/deploy.ymlå¤åˆ¶è¿™ä¸€æ–‡ä»¶çš„å†…å®¹ã€‚

1.  åˆ›å»ºä¸€ä¸ªå¯ä»¥æ‰§è¡Œæ¥å¯åŠ¨éƒ¨ç½²çš„bashè„šæœ¬ï¼š  


    ```
    # deployment/production/ansible/setup_remotely.sh
    #!/usr/bin/env bash
    echo "=== Setting up the production server ===" 
    date

    cd "$(dirname "$0")"
    ansible-playbook setup.yml -i hosts/remote
    ```

1.  ä¸ºbashè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿è¡Œï¼š  


    ```
    $ chmod +x setup_remotely.sh 
    $ ./setup_remotely.sh
    ```

1.  å¦‚æœè„šæœ¬å¤±è´¥æŠ¥é”™ï¼Œå¾ˆå¯èƒ½éœ€è¦é‡å¯ç‹¬ç«‹ä¸»æœºæ¥è®©ä¿®æ”¹ç”Ÿæ•ˆã€‚å¯ä»¥é€šè¿‡sshè¿æ¥åˆ°æœåŠ¡å™¨ä¸Šç”¨ä¸‹é¢çš„å‘½ä»¤é‡å¯ï¼š  


    ```
    $ ssh myproject-apache
    Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64)

      * Documentation: https://help.ubuntu.com
      * Management: https://landscape.canonical.com 
      * Support: https://ubuntu.com/advantage
       
       System information as of Wed Jan 15 11:39:51 CET 2020

      System load: 0.08 Processes: 104
      Usage of /: 8.7% of 24.06GB Users logged in: 0 
      Memory usage: 35% IP address for eth0: 142.93.167.30 
      Swap usage: 0%
      
      * Canonical Livepatch is available for installation.
      - Reduce system reboots and improve kernel security. Activate at: https://ubuntu.com/livepatch

    0 packages can be updated.
    0 updates are security updates.

    *** System restart required ***

    Last login: Sun Jan 12 12:23:35 2020 from 178.12.115.146 
    root@myproject:~# reboot
    Connection to 142.93.167.30 closed by remote host. 
    Connection to 142.93.167.30 closed.
    ```

1.  åˆ›å»ºå¦ä¸€ä¸ªç”¨äºæ›´æ–°Djangoé¡¹ç›®çš„bashè„šæœ¬ï¼š  


    ```
    # deployment/production/ansible/deploy_remotely.sh
    #!/usr/bin/env bash
    echo "=== Deploying project to production server ===" 
    date

    cd "$(dirname "$0")"
    ansible-playbook deploy.yml -i hosts/remote
    ```

1.  ä¸ºè¿™ä¸ªbashè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼š  


    ```
    $ chmod +x deploy_remotely.sh
    ```

### å®ç°åŸç†...

Ansibleè„šæœ¬ï¼ˆplaybookï¼‰æ˜¯å¹‚ç­‰çš„ã€‚å³ä½ å¯ä»¥æ‰§è¡Œå¤šæ¬¡ä½†æ°¸è¿œå¾—åˆ°åŒæ ·çš„ç»“æœï¼šä¸€ä¸ªå®‰è£…å¹¶è¿è¡Œäº†Djangoç½‘ç«™çš„æœ€æ–°ç‰ˆç‹¬ç«‹ä¸»æœºã€‚å¦‚æœæœåŠ¡å™¨æœ‰ä»»ä½•æŠ€æœ¯ç¡¬ä»¶é—®é¢˜å¹¶ä¸”æœ‰æ•°æ®åº“å’Œåª’ä½“æ–‡ä»¶å¤‡ä»½çš„è¯ï¼Œå¯ä»¥ç›¸å¯¹å¿«é€Ÿåœ°åœ¨å¦ä¸€å°ç‹¬ç«‹ä¸»æœºä¸Šä»¥åŒæ ·çš„é…ç½®è¿›è¡Œå®‰è£…ã€‚

ç”Ÿäº§éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

-   ä¸ºè™šæ‹Ÿæœºè®¾ç½®ä¸»æœºå
-   å‡çº§LinuxåŒ…
-   ä¸ºæœåŠ¡å™¨é…ç½®æœ¬åœ°åŒ–è®¾ç½®
-   å®‰è£…åŒ…æ‹¬Pythonã€Apacheã€PostgreSQLã€Postfixã€Memcachedç­‰çš„Linuxä¾èµ–
-   åˆ›å»ºä¸€ä¸ªLinuxç”¨æˆ·ä»¥åŠç”¨äºDjangoé¡¹ç›®çš„homeç›®å½•
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ
-   åˆ›å»ºPostgreSQLæ•°æ®åº“ç”¨æˆ·åŠæ•°æ®åº“
-   é…ç½®Apacheç½‘é¡µæœåŠ¡å™¨
-   å®‰è£…Let's Encrypt SSLè¯ä¹¦
-   é…ç½®Memcachedç¼“å­˜æœåŠ¡
-   é…ç½®Postfixé‚®ä»¶æœåŠ¡å™¨
-   å…‹éš†Djangoé¡¹ç›®ä»“åº“
-   å®‰è£…Pythonä¾èµ–
-   åˆ›å»ºsecrets.jsonæ–‡ä»¶
-   è¿ç§»æ•°æ®åº“
-   è½¬å­˜é™æ€æ–‡ä»¶
-   é‡å¯Apache

åœ¨é¦–æ¬¡éœ€è¦å®‰è£…æœåŠ¡åŠä¾èµ–æ—¶è¿è¡Œsetup_remotely.shè„šæœ¬ã€‚ç„¶åï¼Œå¦‚æœéœ€è¦å‡çº§Djangoé¡¹ç›®çš„è¯å¯ä»¥ä½¿ç”¨deploy_remotely.shã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„å®‰è£…éå¸¸ç±»ä¼¼äºé¢„å‘å¸ƒæœåŠ¡å™¨ï¼Œä½†ä¸ºä¿æŒçµæ´»ä»¥åŠæ›´åˆ©äºä¿®æ”¹ï¼Œæˆ‘ä»¬å°†å…¶å•ç‹¬ä¿å­˜åˆ°äº†deployment/productionç›®å½•ä¸­ã€‚

ç†è®ºä¸Šä½ å¯ä»¥å®Œå…¨è·³è¿‡é¢„å‘å¸ƒç¯å¢ƒï¼Œä¾¿å°è¯•åœ¨è™šæ‹Ÿæœºä¸Šè¿›è¡Œéƒ¨ç½²æµç¨‹æ¯”ç›´æ¥åœ¨è¿œç¨‹æœåŠ¡ä¸Šè¿›è¡Œå®‰è£…è¯•éªŒæ¥å¾—æ›´åˆ‡å®é™…ã€‚

### ç›¸å…³å†…å®¹

-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åˆ›å»ºé¡¹ç›®æ–‡ä»¶ç»“æ„*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*é€šè¿‡pipå¤„ç†é¡¹ç›®ä¾èµ–*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åŠ¨æ€è®¾ç½®STATIC_URL*ä¸€èŠ‚
-   *åœ¨é¢„å‘å¸ƒç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚
-   *åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸€èŠ‚
-   *åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*åˆ›å»ºåŠè¿˜åŸPostgreSQLæ•°æ®åº“å¤‡ä»½*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*é…ç½®cron jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡*ä¸€èŠ‚

## åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²ä¸€èŠ‚

Apacheå’Œmod_wsgiæ˜¯ä¸€ç§è‰¯å¥½ç¨³å®šçš„éƒ¨ç½²æ–¹å¼ï¼Œä½†åœ¨éœ€è¦é«˜æ€§èƒ½çš„æ—¶å€™ï¼Œæ¨èä½¿ç”¨Nginxå’ŒGunicornæ¥å¯¹Djangoç½‘ç«™æä¾›æœåŠ¡ã€‚Gunicornæ˜¯ä¸€ç§PythonæœåŠ¡ç«¯è¿è¡Œçš„WSGIè„šæœ¬ã€‚Nginxæ˜¯ä¸€ä¸ªè§£æåŸŸåé…ç½®å¹¶å°†è¯·æ±‚ä¼ é€’ç»™Gunicornçš„webæœåŠ¡å™¨ã€‚

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åˆ›å»ºä¸€ä¸ªè„šæœ¬æ¥éƒ¨ç½²é¡¹ç›®åˆ°ç”µè„‘è™šæ‹Ÿæœºä¸Šçš„é¢„å‘å¸ƒç¯å¢ƒä¸­ã€‚å®ç°éƒ¨ç½²ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Ansibleã€Vagrantå’ŒVirtualBoxã€‚å‰é¢æåˆ°è¿‡ï¼Œå¾ˆå¤šç»†èŠ‚è¦é“­è®°äºå¿ƒï¼Œå¹¶ä¸”éœ€è¦å‡ä»¥æ—¶æ—¥æ¥å¼€å‘ç±»ä¼¼äºè¿™é‡Œçš„ä¼˜åŒ–å¼€å‘è„šæœ¬ã€‚

### å‡†å¤‡å·¥ä½œ

æŒ‰ç…§https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/ä¸Šçš„éƒ¨ç½²æ¸…å•ï¼Œç¡®ä¿é…ç½®é€šè¿‡æ‰€æœ‰çš„å®‰å…¨æ¨èã€‚è‡³å°‘åº”ä¿è¯åœ¨è¿è¡Œå¦‚ä¸‹å‘½ä»¤æ—¶é¡¹ç›®é…ç½®ä¸ä¼šæŠ›å‡ºä»»åŠ¡è­¦å‘Šï¼š

```
(env)$ python manage.py check --deploy --settings=myproject.settings.staging
```

å®‰è£…æœ€æ–°çš„ç¨³å®šç‰ˆAnsibleã€Vagrantå’ŒVirtualBoxã€‚å¯é€šè¿‡å®˜æ–¹ç½‘ç«™è·å–åˆ°è¿™äº›è½¯ä»¶ï¼š

-   [**Ansible**](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
-   **[VirtualBox](https://www.virtualbox.org/wiki/Downloads)**
-   **[Vagrant](https://www.vagrantup.com/downloads.html)**

åœ¨macOSä¸Šå¯é€šè¿‡HomeBrewè¿›è¡Œå®‰è£…ï¼š

```
$ brew install ansible
$ brew cask install virtualbox
$ brew cask install vagrant
```

### å¦‚ä½•å®ç°...

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€äº›æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„å„ç±»æœåŠ¡çš„é…ç½®æ¨¡æ¿ã€‚ç”±ä¸¤ä¸ªéƒ¨ç½²æµç¨‹ä½¿ç”¨ï¼šé¢„å‘å¸ƒå’Œç”Ÿäº§ã€‚

1.  åœ¨Djangoé¡¹ç›®ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªdeploymentç›®å½•å¹¶åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªansible_templatesç›®å½•ã€‚

1.  ä¸ºæ—¶åŒºé…ç½®åˆ›å»ºä¸€ä¸ªJinjaæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/timezone.j2 #}
    {{ timezone }}
    ```

1.  åœ¨è®¾ç½®SSLè¯ä¹¦å‰ä¸ºNginxåŸŸåé…ç½®åˆ›å»ºä¸€ä¸ªJinjaæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/nginx-pre.j2 #}
    server{
      listen 80;
      server_name {{ domain_name }};

      location /.well-known/acme-challenge { 
        root /var/www/letsencrypt; 
        try_files $uri $uri/ =404;
      }
      location / {
        root /var/www/letsencrypt;
      }
    }
    ```

1.  åœ¨deployment/ansible_templates/nginx.j2 ä¸­ä¸ºNginxé…ç½®åŒ…æ‹¬SSLè¯ä¹¦åˆ›å»ºJinjaæ¨¡æ¿ã€‚ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-nginx/ansible_templates/nginx.j2æ‹·è´å†…å®¹åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚

1.  ä¸ºGunicornæœåŠ¡é…ç½®åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š  


    ```
    # deployment/ansible_templates/gunicorn.j2
    [Unit]
    Description=Gunicorn daemon for myproject website 
    After=network.target

    [Service]
    PIDFile=/run/gunicorn/pid
    Type=simple
    User={{ user_username }}
    Group=www-data
    RuntimeDirectory=gunicorn
    WorkingDirectory={{ python_path }}
    ExecStart={{ project_root }}/env/bin/gunicorn --pid /run/gunicorn/pid --log-file={{ project_root }}/logs/gunicorn.log --workers {{ ansible_processor_count | int }} --bind 127.0.0.1:8000 {{ project_name }}.wsgi:application --env DJANGO_SETTINGS_MODULE={{ django_settings }} --max-requests 1000
    ExecReload=/bin/kill -s HUP $MAINPID
    ExecStop=/bin/kill -s TERM $MAINPID
    PrivateTmp=true

    [Install]
    WantedBy=multi-user.target
    ```

1.  åœ¨deployment/ansible_templates/postgresql.j2 ä¸­ä¸ºPostgreSQLé…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼Œä½¿ç”¨å†…å®¹https://github.com/postgres/postgres/blob/REL_10_STABLE/src/backend/utils/misc/postgresql.conf.sampleã€‚ç¨åå¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¿®æ”¹é…ç½®ã€‚

1.  ä¸ºPostgreSQLæƒé™é…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼ˆå½“å‰æˆäºˆæƒé™è¾ƒå¤§ï¼Œä½†å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ï¼‰ï¼š  


    ```
    {# deployment/ansible_templates/pg_hba.j2 #}
    # TYPE  DATABASE        USER           CIDR-ADDRESS    METHOD
    local   all             all                            ident
    host    all             all            ::0/0           md5
    host    all             all            0.0.0.0/32      md5
    host    {{ db_name }}   {{ db_user }}  127.0.0.1/32    md5
    ```

1.  ä¸ºPostfixé‚®ä»¶æœåŠ¡å™¨é…ç½®åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/postfix.j2 #}
    # See /usr/share/postfix/main.cf.dist for a commented, more 
    # complete version


    # Debian specific:  Specifying a file name will cause the first
    # line of that file to be used as the name.  The Debian default
    # is /etc/mailname.
    # myorigin = /etc/mailname

    smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
    biff = no

    # appending .domain is the MUA's job.
    append_dot_mydomain = no

    # Uncomment the next line to generate "delayed mail" warnings
    #delay_warning_time = 4h

    readme_directory = no

    # TLS parameters
    smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
    smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
    smtpd_use_tls=yes
    smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
    smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

    # See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc 
    # package for information on enabling SSL 
    # in the smtp client.

    smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
    myhostname = {{ domain_name }}
    alias_maps = hash:/etc/aliases
    alias_database = hash:/etc/aliases
    mydestination = $myhostname, localhost, localhost.localdomain, , 
     localhost
    relayhost =
    mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
    mailbox_size_limit = 0
    recipient_delimiter = +
    inet_interfaces = all
    inet_protocols = all
    virtual_alias_domains = {{ domain_name }}
    virtual_alias_maps = hash:/etc/postfix/virtual
    ```

1.  ä¸ºé‚®ä»¶è½¬å‘é…ç½®åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/virtual.j2 #}
    # /etc/postfix/virtual

    hello@{{ domain_name }} admin@example.com 
    @{{ domain_name }} admin@example.com
    ```

1.  ä¸ºmemcachedé…ç½®åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/memcached.j2 #}
    # memcached default config file
    # 2003 - Jay Bonci <jaybonci@debian.org>
    # This configuration file is read by the start-memcached script 
    # provided as part of the Debian GNU/Linux distribution.

    # Run memcached as a daemon. This command is implied, and is not 
    # needed for the daemon to run. See the README.Debian 
    # that comes with this package for more information.
    -d

    # Log memcached's output to /var/log/memcached
    logfile /var/log/memcached.log

    # Be verbose
    # -v

    # Be even more verbose (print client commands as well)
    # -vv

    # Use 1/16 of server RAM for memcached
    -m {{ (ansible_memtotal_mb * 0.0625) | int }}

    # Default connection port is 11211
    -p 11211

    # Run the daemon as root. The start-memcached will default to 
    # running as root if no -u command is present 
    # in this config file
    -u memcache

    # Specify which IP address to listen on. The default is to 
    # listen on all IP addresses
    # This parameter is one of the only security measures that 
    # memcached has, so make sure it's listening 
    # on a firewalled interface.
    -l 127.0.0.1

    # Limit the number of simultaneous incoming connections. The 
    # daemon default is 1024
    # -c 1024

    # Lock down all paged memory. Consult with the README and homepage 
    # before you do this
    # -k

    # Return error when memory is exhausted (rather than 
    # removing items)
    # -M

    # Maximize core file limit
    # -r
    ```

1.  æœ€åï¼Œä¸ºsecrets.jsonæ–‡ä»¶åˆ›å»ºä¸€ä¸ªJinjaæ¨¡æ¿ï¼š  


    ```
    {# deployment/ansible_templates/secrets.json.j2 #}
    {
        "DJANGO_SECRET_KEY": "{{ django_secret_key }}",
        "DATABASE_ENGINE": "django.contrib.gis.db.backends.postgis",
        "DATABASE_NAME": "{{ db_name }}",
        "DATABASE_USER": "{{ db_user }}",
        "DATABASE_PASSWORD": "{{ db_password }}",
        "EMAIL_HOST": "{{ email_host }}",
        "EMAIL_PORT": "{{ email_port }}",
        "EMAIL_HOST_USER": "{{ email_host_user }}",
        "EMAIL_HOST_PASSWORD": "{{ email_host_password }}"
    }
    ```

ä¸‹é¢ç¼–å†™é¢„å‘å¸ƒç¯å¢ƒæ‰€éœ€ä½¿ç”¨çš„Vagrantå’ŒAnsibleè„šæœ¬ï¼š

1.  åœ¨ .gitignoreæ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹è¡Œæ¥å¿½ç•¥æ‰ä¸€äº›Vagrantå’ŒAnsibleç›¸å…³æ–‡ä»¶ï¼š  


    ```
    # .gitignore
    # Secrets
    secrets.json
    secrets.yml

    # Vagrant / Ansible
    .vagrant
    *.retry
    ```

1.  åˆ›å»ºdeployment/staging åŠ deployment/staging/ansible ç›®å½•ã€‚

1.  åœ¨deployment/staging/ansibleç›®å½•ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå¸¦æœ‰å¦‚ä¸‹è„šæœ¬çš„Vagrantfileæ–‡ä»¶ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªç³»ç»Ÿä¸ºUbuntu 18çš„è™šæ‹Ÿæœºå¹¶åœ¨å…¶ä¸Šè¿è¡ŒAnsibleè„šæœ¬ï¼š  


    ```
    # deployment/staging/ansible/Vagrantfile
    VAGRANTFILE_API_VERSION = "2"

    Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
      config.vm.box = "bento/ubuntu-18.04"
      config.vm.box_version = "201912.14.0"
      config.vm.box_check_update = false
      config.ssh.insert_key=false
      config.vm.provider "virtualbox" do |v|
        v.memory = 512
        v.cpus = 1
        v.name = "myproject"
      end
      config.vm.network "private_network", ip: "192.168.50.5"
      config.vm.provision "ansible" do |ansible|
        ansible.limit = "all"
        ansible.playbook = "setup.yml"
        ansible.inventory_path = "./hosts/vagrant"
        ansible.host_key_checking = false
        ansible.verbose = "vv"
        ansible.extra_vars = { ansible_python_interpreter: 
        "/usr/bin/python3" }
      end
    end
    ```

1.  åˆ›å»ºä¸€ä¸ªhostsç›®å½•åŠåŒ…å«å¦‚ä¸‹å†…å®¹çš„vagrantæ–‡ä»¶ï¼š  


    ```
    # deployment/staging/ansible/hosts/vagrant
    [servers]
    192.168.50.5
    ```

1.  åˆ›å»ºä¸€ä¸ªvars.yml æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åœ¨å®‰è£…è„šæœ¬å’Œç”¨äºé…ç½®çš„Jinjaæ¨¡æ¿æ‰€ä½¿ç”¨çš„æ¨¡æ¿ï¼š  


    ```
    # deployment/staging/ansible/vars.yml
    ---
    # a unix path-friendly name (IE, no spaces or special characters)
    project_name: myproject

    user_username: "{{ project_name }}"

    # the base path to install to. You should not need to change this.
    install_root: /home

    project_root: "{{ install_root }}/{{ project_name }}"

    # the python module path to your project's wsgi file
    wsgi_module: myproject.wsgi

    # any directories that need to be added to the PYTHONPATH.
    python_path: "{{ project_root }}/src/{{ project_name }}"

    # the git repository URL for the project
    project_repo: git@github.com:archatas/django-myproject.git

    # The value of your django project's STATIC_ROOT settings.
    static_root: "{{ python_path }}/static"
    media_root: "{{ python_path }}/media"

    locale: en_US.UTF-8
    timezone: Europe/Berlin

    domain_name: myproject.192.168.50.5.xip.io
    django_settings: myproject.settings.staging

    letsencrypt_email: ""
    ```

1.  æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªåŒ…å«å¯†ç å’Œè®¤è¯å¯†é’¥ç­‰ç§å¯†å€¼çš„secrets.ymlæ–‡ä»¶ã€‚é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªä¸å«æ•æ„Ÿä¿¡æ¯ä»…åŒ…å«å˜é‡åçš„sample_secrets.ymlæ–‡ä»¶ï¼Œç„¶åå°†å…¶æ‹·è´åˆ°secrets.ymlå¹¶å¡«å†™ä¿å¯†ä¿¡æ¯ã€‚å‰ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œåè€…è¿›è¡Œå¿½ç•¥ï¼š  


    ```
    # deployment/staging/ansible/sample_secrets.yml
    # Django Secret Key
    django_secret_key: "change-this-to-50-characters-long-random-string"

    # PostgreSQL database settings
    db_name: "myproject"
    db_user: "myproject"
    db_password: "change-this-to-a-secret-password"
    db_host: "localhost"
    db_port: "5432"

    # Email SMTP settings
    email_host: "localhost"
    email_port: "25"
    email_host_user: ""
    email_host_password: ""

    # a private key that has access to the repository URL
    ssh_github_key: ~/.ssh/id_rsa_github
    ```

1.  åœ¨deployment/staging/ansible/setup.yml å¤„åˆ›å»ºä¸€ä¸ªAnsibleè„šæœ¬ï¼ˆplaybookï¼‰ç”¨äºå®‰è£…æ‰€æœ‰ä¾èµ–åŠé…ç½®æœåŠ¡ã€‚ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-nginx/staging/ansible/setup.ymlæ‹·è´å…¥æ–‡ä»¶å†…å®¹ã€‚

1.  ç„¶ååœ¨deployment/staging/ansible/deploy.ymlå¤„åˆ›å»ºå¦ä¸€ä¸ªAnsibleè„šæœ¬å¤„ç†Djangoé¡¹ç›®ã€‚ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-nginx/staging/ansible/deploy.ymlæ‹·å…¥æ–‡ä»¶å†…å®¹ã€‚

1.  åˆ›å»ºä¸€ä¸ªå¯ä»¥æ‰§è¡Œå¯åŠ¨éƒ¨ç½²çš„bashè„šæœ¬ï¼š  


    ```
    # deployment/staging/ansible/setup_on_virtualbox.sh
    #!/usr/bin/env bash
    echo "=== Setting up the local staging server ==="
    date

    cd "$(dirname "$0")"
    vagrant up --provision
    ```

1.  ä¸ºbashè„šæœ¬æ·»åŠ æ‰§è¡Œæ‰§è¡Œå¹¶è¿è¡Œï¼š  


    ```
    $ chmod +x setup_on_virtualbox.sh
    $ ./setup_on_virtualbox.sh
    ```

1.  å¦‚æœè„šæœ¬å¤±è´¥æŠ¥é”™ï¼Œå¾ˆå¯èƒ½éœ€è¦é‡å¯è™šæ‹Ÿæœºæ¥è®©ä¿®æ”¹ç”Ÿæ•ˆã€‚å¯ä»¥é€šè¿‡sshè¿æ¥åˆ°è™šæ‹Ÿæœºï¼Œåˆ‡æ¢ä¸ºrootï¼ŒæŒ‰ç…§ä¸‹é¢è¿™æ ·è¿›è¡Œé‡å¯ï¼š  


    ```
    $ vagrant ssh
    Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-72-generic x86_64)

     * Documentation:  https://help.ubuntu.com
     * Management:     https://landscape.canonical.com
     * Support:        https://ubuntu.com/advantage

      System information as of Wed Jan 15 04:44:42 CET 2020

      System load:  0.21              Processes:           126
      Usage of /:   4.0% of 61.80GB   Users logged in:     1
      Memory usage: 35%               IP address for eth0: 10.0.2.15
      Swap usage:   4%                IP address for eth1: 192.168.50.5


    0 packages can be updated.
    0 updates are security updates.


    *** System restart required ***

    This system is built by the Bento project by Chef Software
    More information can be found at https://github.com/chef/bento
    Last login: Wed Jan 15 04:43:32 2020 from 192.168.50.1
    vagrant@myproject:~$ sudo su
    root@myproject:/home/vagrant#
    reboot
    Connection to 127.0.0.1 closed by remote host.
    Connection to 127.0.0.1 closed.
    ```

1.  è¦æµè§ˆDjangoé¡¹ç›®ç›®å½•ï¼Œsshè¿æ¥è‡³è™šæ‹Ÿæœºå¹¶åƒä¸‹é¢è¿™æ ·åˆ‡æ¢ç”¨æˆ·ä¸ºmyprojectï¼š  


    ```
    $ vagrant ssh
    Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64)
    # â€¦ 
    vagrant@myproject:~$ sudo su - myproject
    (env) myproject@myproject:~$ pwd
    /home/myproject
    (env) myproject@myproject:~$ ls
    commands db_backups logs public_html src env
    ```

### å®ç°åŸç†...

VirtualBoxè®©æˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€å°ç”µè„‘ä¸Šå®‰è£…ä¸åŒæ“ä½œç³»ç»Ÿçš„å¤šä¸ªè™šæ‹Ÿä¸»æœºã€‚Vagrantæ˜¯ä¸€ä¸ªåˆ›å»ºè¿™äº›è™šæ‹Ÿä¸»æœºçš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢ä¸‹è½½å¹¶å®‰è£…æ“ä½œç³»ç»Ÿã€‚Ansibleæ˜¯ä¸€ä¸ªåŸºäºPythonçš„å·¥å…·ï¼Œå®ƒè¯»å–.yaml é…ç½®æ–‡ä»¶å¹¶åœ¨è¿œç¨‹ä¸»æœºä¸Šè¿›è¡Œæ‰§è¡Œã€‚

æˆ‘ä»¬åˆšåˆšç¼–å†™çš„éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

-   åœ¨VirtualBoxä¸­åˆ›å»ºè™šæ‹Ÿä¸»æœºå¹¶å®‰è£…Ubuntu 18
-   ä¸ºè™šæ‹Ÿä¸»æœºåˆ†é…IPåœ°å€192.168.50.5
-   ä¸ºè™šæ‹Ÿä¸»æœºè®¾ç½®ä¸»æœºå
-   å‡çº§LinuxåŒ…
-   ä¸ºæœåŠ¡å™¨è®¾ç½®æœ¬åœ°åŒ–é…ç½®
-   å®‰è£…æ‰€æœ‰Linuxä¾èµ–ï¼ŒåŒ…æ‹¬Pythonã€Nginxã€PostgreSQLã€Postfixã€Memcachedç­‰ã€‚
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºä¸€ä¸ªLinuxç”¨æˆ·å’Œå®¶ç›®å½•
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ
-   åˆ›å»ºPostgreSQLæ•°æ®åº“ç”¨æˆ·åŠæ•°æ®åº“
-   é…ç½®Nginxç½‘é¡µæœåŠ¡å™¨
-   å®‰è£…è‡ªç­¾ç½²SSLè¯ä¹¦
-   é…ç½®Memcachedç¼“å­˜æœåŠ¡
-   é…ç½®Postfixé‚®ä»¶æœåŠ¡å™¨
-   å…‹éš†Djangoé¡¹ç›®ä»“åº“
-   å®‰è£…Pythonä¾èµ–
-   é…ç½®Gunicorn
-   åˆ›å»ºsecrets.jsonæ–‡ä»¶
-   è¿ç§»æ•°æ®åº“
-   è½¬å­˜é™æ€æ–‡ä»¶
-   é‡å¯Nginx

ç°åœ¨å¯é€šè¿‡https://www.myproject.192.168.50.5.xip.ioè®¿é—®è¿™ä¸ªDjangoç½‘ç«™ï¼Œå®ƒä¼šæ˜¾ç¤ºä¸€ä¸ªHello, World!é¡µé¢ã€‚æ³¨æ„æœ‰äº›æµè§ˆå™¨åŒ…æ‹¬Chromeåœ¨å†…å¯èƒ½ä¼šä¸å…è®¸æ‰“å¼€è‡ªç­¾ç½²SSLè¯ä¹¦çš„ç½‘ç«™ï¼Œå‡ºäºå®‰å…¨æªæ–½è¿›è¡Œäº†å±è”½ã€‚

> â„¹ï¸xip.ioæ˜¯ä¸€ä¸ªé€šé…ç¬¦DNSæœåŠ¡ï¼Œå®ƒå°†å…·ä½“IPå­åŸŸåæŒ‡å‘è¯¥IPï¼Œå¹¶è®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¥å®‰è£…SSLè¯ä¹¦æˆ–å…¶å®ƒéœ€è¦åŸŸåçš„ç½‘ç«™åŠŸèƒ½ã€‚

å¦‚æœå¸Œæœ›æµ‹è¯•å…¶å®ƒé…ç½®æˆ–æ›´å¤šçš„å‘½ä»¤ï¼Œå°æ­¥å¢é‡ä¿®æ”¹æ˜¯ä¸€ç§åˆç†çš„é€‰æ‹©ã€‚å¯¹äºæœ‰äº›éƒ¨åˆ†ï¼Œä¼šéœ€è¦åœ¨å°†ä»»åŠ¡è½¬åŒ–ä¸ºAnsibleæŒ‡ä»¤ä¹‹å‰ç›´æ¥åœ¨è™šæ‹Ÿæœºä¸Šæµ‹è¯•ã€‚

> ğŸ’¡æ›´å¤šæœ‰å…³Ansibleçš„ä½¿ç”¨ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[å®˜æ–¹ç½‘ç«™](https://docs.ansible.com/ansible/latest/index.html)ã€‚å®ƒæ˜¾ç¤ºäº†é’ˆå¯¹å¤§é‡ç”¨ä¾‹çš„æœ‰ç”¨æŒ‡å¯¼ç¤ºä¾‹ã€‚

å¦‚æœä»»ä½•æœåŠ¡æŠ¥é”™äº†ï¼Œsshè¿æ¥è‡³è™šæ‹Ÿæœºï¼Œåˆ‡æ¢ä¸ºrootç”¨æˆ·ï¼ŒæŸ¥çœ‹è¯¥æœåŠ¡çš„æ—¥å¿—ã€‚Google è¯¥é”™è¯¯ä¿¡æ¯ä¼šè®©ä»¬æ›´æ¥è¿‘ä¸€ä¸ªæœ‰æ•ˆç³»ç»Ÿã€‚

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡å»ºè™šæ‹Ÿæœºï¼š

```
$ vagrant destroy
$ vagrant up --provision
```

### ç›¸å…³å†…å®¹

-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åˆ›å»ºé¡¹ç›®æ–‡ä»¶ç»“æ„*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*é€šè¿‡pipå¤„ç†é¡¹ç›®ä¾èµ–*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åŠ¨æ€è®¾ç½®STATIC_URL*ä¸€èŠ‚
-   *åœ¨é¢„å‘å¸ƒç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚
-   *åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚
-   *åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*åˆ›å»ºåŠè¿˜åŸPostgreSQLæ•°æ®åº“å¤‡ä»½*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*é…ç½®cron jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡*ä¸€èŠ‚

## åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­å‰ä¸€å°èŠ‚çš„æ“ä½œï¼Œå®ç°ä¸€ä¸ªAnsibleè„šæœ¬ï¼ˆplaybookï¼‰æ¥ä½¿ç”¨Nginxå’ŒGunicornè®¾ç½®ç”Ÿäº§ç¯å¢ƒã€‚

### å‡†å¤‡å·¥ä½œ

æ£€æµ‹åœ¨è¿è¡Œå¦‚ä¸‹å‘½ä»¤æ—¶é¡¹ç›®é…ç½®ä¸ä¼šæŠ›å‡ºè­¦å‘Šï¼š

```
(env)$ python manage.py check --deploy --settings=myproject.settings.production
```

ç¡®ä¿å®‰è£…äº†æœ€æ–°ç¨³å®šç‰ˆçš„Ansibleã€‚

é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨æä¾›å•†å¹¶åˆ›å»ºä¸€å°ç‹¬ç«‹æœåŠ¡å™¨ï¼Œå¯ä½¿ç”¨å…¬é’¥åŠç§é’¥è®¤è¯é€šè¿‡SSHè¿›è¡Œ root è®¿é—®ã€‚æˆ‘é€‰æ‹©çš„æä¾›å•†æ˜¯[DigitalOcean](https://www.digitalocean.com)ï¼Œé€šè¿‡å®ƒæˆ‘åˆ›å»ºäº†ä¸€ä¸ªUbuntu 18ç³»ç»Ÿçš„ç‹¬ç«‹æœåŠ¡å™¨ï¼ˆDropletï¼‰ã€‚æˆ‘å¯ä»¥ä½¿ç”¨æ–°çš„SSHç§é’¥å’Œå…¬é’¥å¯¹é€šè¿‡ IP 46.101.136.102è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œåˆ†åˆ«ä¸º~/.ssh/id_rsa_django_cookbook å’Œ ~/.ssh/id_rsa_django_cookbook.pubã€‚

æœ¬åœ°æˆ‘ä»¬éœ€è¦æŒ‰ç…§å¦‚ä¸‹å†…å®¹åˆ›å»ºæˆ–ä¿®æ”¹ ~/.ssh/configæ–‡ä»¶æ¥é…ç½®SSHè¿æ¥ï¼š

```
# ~/.ssh/config
Host *
   ServerAliveInterval 240
   AddKeysToAgent yes
   UseKeychain yes
       
Host github
    Hostname github.com
    IdentityFile ~/.ssh/id_rsa_github

Host myproject-nginx
    Hostname 46.101.136.102
    User root
    IdentityFile ~/.ssh/id_rsa_django_cookbook
```

ç°åœ¨æˆ‘ä»¬åº”è¯¥å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é€šè¿‡SSHä»¥rootç”¨æˆ·è¿æ¥åˆ°è¿™å°ç‹¬ç«‹ä¸»æœºï¼š

```
$ ssh myproject-nginx
```

åœ¨åŸŸåé…ç½®ä¸­ï¼Œå°†åŸŸåçš„DNS Aè®°å½•æŒ‡å‘ç‹¬ç«‹æœåŠ¡å™¨çš„IPåœ°å€ã€‚é…åˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨myproject.46.101.136.102.xip.ioæ¥å±•ç¤ºå¦‚ä½•ä¸ºDjangoç«™ç‚¹é…ç½®SSLè¯ä¹¦ã€‚

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ä¸ºç”Ÿäº§ç¯å¢ƒåˆ›å»ºä¸€ä¸ªéƒ¨ç½²è„šæœ¬ï¼š

1.  ç¡®ä¿æœ‰ä¸€ä¸ªdeployment/ansible_templatesç›®å½•ï¼Œå…¶ä¸­åŒ…å«æœ‰å‰ä¸€å°èŠ‚*åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸­æ‰€åˆ›å»ºç”¨äºæœåŠ¡é…ç½®çš„é‚£äº›Jinjaæ¨¡æ¿ã€‚

1.  ä¸ºAnsibleè„šæœ¬åˆ›å»ºdeployment/production å’Œ deployment/production/ansibleç›®å½•ã€‚

1.  åˆ›å»ºä¸€ä¸ªhostsç›®å½•åŠåŒ…å«å¦‚ä¸‹å†…å®¹çš„remoteæ–‡ä»¶ï¼š  


    ```
    # deployment/production/ansible/hosts/remote
    [servers] 
    myproject-nginx

    [servers:vars] 
    ansible_python_interpreter=/usr/bin/python3
    ```

1.  åˆ›å»ºä¸€ä¸ªvars.ymlæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åœ¨å®‰è£…è„šæœ¬å’Œç”¨äºé…ç½®çš„Jinjaæ¨¡æ¿ä¸­ä½¿ç”¨çš„å˜é‡ï¼š  


    ```
    # deployment/production/ansible/vars.yml
    ---
    # a unix path-friendly name (IE, no spaces or special characters)
    project_name: myproject

    user_username: "{{ project_name }}"

    # the base path to install to. You should not need to change this.
    install_root: /home

    project_root: "{{ install_root }}/{{ project_name }}"

    # the python module path to your project's wsgi file
    wsgi_module: myproject.wsgi

    # any directories that need to be added to the PYTHONPATH.
    python_path: "{{ project_root }}/src/{{ project_name }}"

    # the git repository URL for the project
    project_repo: git@github.com:archatas/django-myproject.git

    # The value of your django project's STATIC_ROOT settings.
    static_root: "{{ python_path }}/static"
    media_root: "{{ python_path }}/media"

    locale: en_US.UTF-8
    timezone: Europe/Berlin

    domain_name: myproject.46.101.136.102.xip.io
    django_settings: myproject.settings.production

    # letsencrypt settings
    letsencrypt_email: hello@myproject.com
    ```

1.  æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªåŒ…å«å¯†ç å’Œè®¤è¯å¯†é’¥ç­‰ä¿å¯†ä¿¡æ¯çš„secrets.ymlæ–‡ä»¶ã€‚é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ä»…åŒ…å«å˜é‡åçš„sample_secrets.ymlæ–‡ä»¶ï¼Œç„¶åå°†å…¶æ‹·è´åˆ°secrets.ymlï¼Œå¡«å…¥ä¿å¯†ä¿¡æ¯ã€‚å‰ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œåè€…è¿›è¡Œå¿½ç•¥ï¼š  


    ```
    # deployment/production/ansible/sample_secrets.yml
    # Django Secret Key
    django_secret_key: "change-this-to-50-characters-long-random-string"

    # PostgreSQL database settings
    db_name: "myproject"
    db_user: "myproject"
    db_password: "change-this-to-a-secret-password"
    db_host: "localhost"
    db_port: "5432"

    # Email SMTP settings
    email_host: "localhost"
    email_port: "25"
    email_host_user: ""
    email_host_password: ""

    # a private key that has access to the repository URL
    ssh_github_key: ~/.ssh/id_rsa_github
    ```

1.  ç°åœ¨å¯ä»¥åœ¨deployment/production/ansible/setup.ymlå¤„åˆ›å»ºä¸€ä¸ªAnsibleè„šæœ¬ï¼ˆplaybookï¼‰ï¼Œç”¨äºå®‰è£…æ‰€æœ‰ä¾èµ–å’Œé…ç½®æœåŠ¡ã€‚ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-nginx/production/ansible/setup.ymlæ‹·å…¥è¯¥æ–‡ä»¶çš„å†…å®¹ã€‚

1.  ç„¶ååˆ›å»ºå¦ä¸€ä¸ªAnsibleè„šæœ¬deployment/production/ansible/deploy.yml æ¥å¤„ç†Djangoé¡¹ç›®ã€‚ä»https://raw.githubusercontent.com/PacktPublishing/Django-3-Web-Development-Cookbook-Fourth-Edition/master/ch12/myproject_virtualenv/src/django-myproject/deployment-nginx/production/ansible/deploy.ymlæ‹·å…¥æ–‡ä»¶çš„å†…å®¹ã€‚

1.  åˆ›å»ºä¸€ä¸ªå¯ä»¥æ‰§è¡Œå¯åŠ¨éƒ¨ç½²çš„bashè„šæœ¬ï¼š  


    ```
    # deployment/production/ansible/setup_remotely.sh
    #!/usr/bin/env bash
    echo "=== Setting up the production server ==="
    date

    cd "$(dirname "$0")"
    ansible-playbook setup.yml -i hosts/remote
    ```

1.  ä¸ºbashè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿è¡Œï¼š  


    ```
    $ chmod +x setup_remotely.sh
    $ ./setup_remotely.sh
    ```

1.  å¦‚æœè„šæœ¬å¤±è´¥æŠ¥é”™ï¼Œå¾ˆå¯èƒ½éœ€è¦é‡å¯ç‹¬ç«‹ä¸»æœºæ¥ä½¿ç”¨ä¿®æ”¹ç”Ÿæ•ˆã€‚å¯ä»¥é€šè¿‡sshè¿æ¥åˆ°æœåŠ¡å™¨å¹¶åƒå¦‚ä¸‹è¿™æ ·è¿›è¡Œé‡å¯ï¼š  


    ```
    $ ssh myproject-nginx
    Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64)

     * Documentation: https://help.ubuntu.com
     * Management: https://landscape.canonical.com
     * Support: https://ubuntu.com/advantage

     System information as of Wed Jan 15 11:39:51 CET 2020

     System load: 0.08 Processes: 104
     Usage of /: 8.7% of 24.06GB Users logged in: 0
     Memory usage: 35% IP address for eth0: 142.93.167.30
     Swap usage: 0%

     * Canonical Livepatch is available for installation.
     - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

    0 packages can be updated.
    0 updates are security updates.


    *** System restart required ***

    Last login: Sun Jan 12 12:23:35 2020 from 178.12.115.146
    root@myproject:~# reboot
    Connection to 142.93.167.30 closed by remote host.
    Connection to 142.93.167.30 closed.
    ```

1.  åˆ›å»ºå¦ä¸€ä¸ªbashè„šæœ¬ä»…ç”¨äºæ›´æ–°Djangoé¡¹ç›®ï¼š  


    ```
    # deployment/production/ansible/deploy_remotely.sh
    #!/usr/bin/env bash
    echo "=== Deploying project to production server ==="
    date

    cd "$(dirname "$0")"
    ansible-playbook deploy.yml -i hosts/remote
    ```

1.  ä¸ºbashè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼š  


    ```
    $ chmod +x deploy_remotely.sh
    ```

### å®ç°åŸç†...

Ansibleè„šæœ¬ï¼ˆplaybookï¼‰æ˜¯å¹‚ç­‰çš„ã€‚å³æ‰§è¡Œå¤šæ¬¡ä»å°†å¾—åˆ°ç›¸åŒçš„ç»“æœï¼Œä¸€ä¸ªå®‰è£…å¹¶è¿è¡Œäº†Djangoç½‘ç«™çš„æœ€æ–°ç‰ˆç‹¬ç«‹ä¸»æœºã€‚å¦‚æœæœåŠ¡å™¨å‡ºç°ç¡¬ä»¶é—®é¢˜ï¼Œå¹¶ä¸”æœ‰æ•°æ®åº“å’Œåª’ä½“æ–‡ä»¶çš„å¤‡ä»½ï¼Œå¯ä»¥ç›¸å¯¹å¿«é€Ÿåœ°åœ¨å¦ä¸€å°ç‹¬ç«‹æœåŠ¡å™¨ä¸Šå®‰è£…ç›¸åŒçš„é…ç½®ã€‚

ç”Ÿäº§éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

-   ä¸ºè™šæ‹Ÿæœºè®¾ç½®ä¸»æœºå
-   å‡çº§LinuxåŒ…
-   ä¸ºæœåŠ¡å™¨è®¾ç½®æœ¬åœ°åŒ–é…ç½®
-   å®‰è£…Pythonã€Nginxã€PostgreSQLã€Postfixã€Memcachedç­‰Linuxä¾èµ–
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºä¸€ä¸ªLinuxç”¨æˆ·å’Œhomeç›®å½•
-   ä¸ºDjangoé¡¹ç›®åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒ
-   åˆ›å»ºPostgreSQLæ•°æ®åº“ç”¨æˆ·åŠæ•°æ®åº“
-   é…ç½®Nginxç½‘é¡µæœåŠ¡å™¨
-   å®‰è£…Let's Encrypt SSLè¯ä¹¦
-   é…ç½®Memcachedç¼“å­˜æœåŠ¡
-   é…ç½®Postfixé‚®ä»¶æœåŠ¡å™¨
-   å…‹éš†Djangoé¡¹ç›®ä»“åº“
-   å®‰è£…Pythonä¾èµ–
-   é…ç½®Gunicorn
-   åˆ›å»ºsecrets.jsonæ–‡ä»¶
-   è¿ç§»æ•°æ®åº“
-   è½¬å­˜é™æ€æ–‡ä»¶
-   é‡å¯Nginx

å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„å®‰è£…éå¸¸ç±»ä¼¼é¢„å‘å¸ƒæœåŠ¡å™¨ï¼Œä½†ä¸ºä¿æŒçµæ´»å’Œæ˜“äºä¿®æ”¹ï¼Œæˆ‘ä»¬å°†å…¶å•ç‹¬ä¿å­˜åˆ°äº†deployment/production ç›®å½•ä¸­ã€‚

ç†è®ºä¸Šè¯´ï¼Œå¯ä»¥å®Œå…¨è·³è¿‡é¢„å‘å¸ƒç¯å¢ƒï¼Œä½†åœ¨è™šæ‹Ÿæœºä¸Šæµ‹è¯•éƒ¨ç½²ç¯èŠ‚æ¯”ç›´æ¥åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿›è¡Œå®‰è£…è¯•éªŒè¦æ›´åˆ‡å®é™…ã€‚

### ç›¸å…³å†…å®¹

-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åˆ›å»ºé¡¹ç›®æ–‡ä»¶ç»“æ„*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*é€šè¿‡pipå¤„ç†é¡¹ç›®ä¾èµ–*ä¸€èŠ‚
-   **[ç¬¬1ç«  Django 3.0å…¥é—¨](https://alanhou.org/getting-started-django3/)**ä¸­çš„*åŠ¨æ€è®¾ç½®STATIC_URL*ä¸€èŠ‚
-   *åœ¨é¢„å‘å¸ƒç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚
-   *åœ¨ç”Ÿäº§ç¯å¢ƒé€šè¿‡mod_wsgiéƒ¨ç½²Apache*ä¸€èŠ‚
-   *åœ¨é¢„å‘å¸ƒç¯å¢ƒä¸­åŸºäºNginxå’ŒGunicornéƒ¨ç½²*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*åˆ›å»ºåŠè¿˜åŸPostgreSQLæ•°æ®åº“å¤‡ä»½*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*é…ç½®cron jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡*ä¸€èŠ‚
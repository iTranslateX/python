# ç¬¬3ç«  è¡¨å•å’Œè§†å›¾

æœ¬ç« åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š

-   ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨
-   ä¿å­˜æ¨¡å‹å®ä¾‹çš„ä½œè€…
-   ä¸Šä¼ å›¾ç‰‡
-   é€šè¿‡è‡ªå®šä¹‰æ¨¡æ¿åˆ›å»ºè¡¨å•å¸ƒå±€
-   é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€
-   å¤„ç†formsets
-   è¿‡æ»¤å¯¹è±¡åˆ—è¡¨
-   ç®¡ç†åˆ†é¡µåˆ—è¡¨
-   ç¼–å†™åŸºäºç±»çš„è§†å›¾
-   æ·»åŠ Open Graphå’ŒTwitter Cardæ•°æ®
-   æ·»åŠ schema.orgç”¨è¯
-   ç”ŸæˆPDFæ–‡æ¡£
-   é€šè¿‡Haystackå’ŒWhooshå®ç°å¤šè¯­è¨€æœç´¢
-   é€šè¿‡Elasticsearch DSLå®ç°å¤šè¯­è¨€æœç´¢

## å¼•è¨€

åœ¨æ¨¡å‹ä¸­å®šä¹‰äº†æ•°æ®åº“ç»“æ„æ—¶ï¼Œè§†å›¾æä¾›äº†è¦å‘ç”¨æˆ·æ˜¾ç¤ºå†…å®¹æˆ–è®©ç”¨æˆ·è¾“å…¥æ–°æ•°æ®åŠæ›´æ–°æ•°æ®çš„ç«¯ç‚¹ï¼ˆendpointï¼‰ã€‚æœ¬ç« ä¸­ï¼Œ æˆ‘ä»¬é›†ä¸­å­¦ä¹ ç®¡ç†è¡¨å•çš„è§†å›¾ã€åˆ—è¡¨è§†å›¾åŠå‘HTMLç”Ÿæˆæ›¿ä»£è¾“å‡ºçš„è§†å›¾ã€‚è¿™æœ€ç®€åŒ–çš„ç¤ºä¾‹ä¸­ï¼ŒURLè§„åˆ™åŠæ¨¡æ¿åˆ›å»ºå°±äº¤ç»™è¯»è€…äº†ã€‚

## æŠ€æœ¯è¦æ±‚

è¦ä½¿ç”¨æœ¬ç« ä¸­çš„ä»£ç ï¼ŒåŒæ—¶ï¼Œè¯»è€…éœ€è¦æœ€æ–°çš„ç¨³å®šç‰ˆPythonã€MySQLæˆ–PostgreSQLæ•°æ®åº“ä»¥åŠè™šæ‹Ÿç¯å¢ƒä¸­åˆ›å»ºçš„Djangoé¡¹ç›®ä¸­ã€‚éƒ¨åˆ†å°èŠ‚è¦æ±‚æœ‰ç‰¹å®šçš„Pythonä¾èµ–ã€‚æ­¤å¤–ï¼Œè¦ç”ŸæˆPDFæ–‡ä»¶ï¼Œéœ€è¦æœ‰cairoã€pangoã€gdk-pixbufåŠlibffiåº“ã€‚æœç´¢éœ€è¦ç”¨åˆ°ElasticsearchæœåŠ¡ç«¯ã€‚æ›´å¤šè¯¦æƒ…åœ¨ç›¸åº”çš„å°èŠ‚ä¸­ä¼šè¿›è¡Œè®¨è®ºã€‚

æœ¬ç« ä¸­çš„å¤§éƒ¨åˆ†æ¨¡æ¿ä¼šä½¿ç”¨Bootstrap 4 CSSæ¡†æ¶æ¥ä¿æŒç¾è§‚åº¦ã€‚

æœ¬ç« ä¸­çš„ä»£ç è¯·è§[GitHubä»“åº“](https://github.com/alanhou/django3-cookbook)çš„Chapter03ç›®å½•ã€‚

## ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨

åœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸï¼ŒCRUDLæ˜¯Createï¼ˆåˆ›å»º/å¢ï¼‰, Readï¼ˆè¯»å–/æŸ¥ï¼‰, Updateï¼ˆæ›´æ–°/æ”¹ï¼‰, Deleteï¼ˆåˆ é™¤/åˆ ï¼‰å’ŒListï¼ˆåˆ—ä¸¾ï¼‰å‡½æ•°çš„ç¼©å†™ã€‚å¾ˆå¤šå…·æœ‰äº¤äº’åŠŸèƒ½çš„Djangoé¡¹ç›®è¦æ±‚æˆ‘ä»¬å®ç°æ‰€æœ‰è¿™äº›å‡½æ•°æ¥å¯¹ç½‘ç«™è¿›è¡Œæ•°æ®çš„ç®¡ç†ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ å¦‚ä½•é€šè¿‡è¿™äº›åŸºæœ¬å‡½æ•°æ¥åˆ›å»ºURLå’Œè§†å›¾ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªåä¸ºideasçš„åº”ç”¨å¹¶å°†æ·»åŠ åˆ°è®¾ç½®æ–‡ä»¶çš„INSTALLED_APPSä¸­ã€‚åœ¨è¯¥åº”ç”¨ä¸­åˆ›å»ºå¦‚ä¸‹åŒ…å«å¸¦æœ‰ç¿»è¯‘æ–‡ä»¶çš„IdeaTranslationsæ¨¡å‹åŠIdeaæ¨¡å‹ï¼š

```
# myproject/apps/idea/models.py
import uuid

from django.db import models
from django.urls import reverse
from django.conf import settings
from django.utils.translation import gettext_lazy as _

from myproject.apps.core.model_fields import TranslatedField 
from myproject.apps.core.models import (
  CreationModificationDateBase, UrlBase
)

RATING_CHOICES = ( 
  (1, "â˜…â˜†â˜†â˜†â˜†"), 
  (2, "â˜…â˜…â˜†â˜†â˜†"), 
  (3, "â˜…â˜…â˜…â˜†â˜†"), 
  (4, "â˜…â˜…â˜…â˜…â˜†"), 
  (5, "â˜…â˜…â˜…â˜…â˜…"),
)


class Idea(CreationModificationDateBase, UrlBase):
  uuid = models.UUIDField(
    primary_key=True, default=uuid.uuid4, editable=False
  )
  author = models.ForeignKey(
    settings.AUTH_USER_MODEL, 
    verbose_name=_("Author"), 
    on_delete=models.SET_NULL, 
    blank=True,
    null=True,
    related_name="authored_ideas", 
  )
  title = models.CharField(_("Title"), max_length=200) 
  content = models.TextField(_("Content"))

  categories = models.ManyToManyField(
    "categories.Category", 
    verbose_name=_("Categories"), 
    related_name="category_ideas",
  )
  rating = models.PositiveIntegerField(
    _("Rating"), 
    choices=RATING_CHOICES, 
    blank=True, 
    null=True 
  )
  translated_title = TranslatedField("title") 
  translated_content = TranslatedField("content")

  class Meta:
    verbose_name = _("Idea") 
    verbose_name_plural = _("Ideas")

  def __str__(self): 
    return self.title

  def get_url_path(self):
    return reverse("ideas:idea_detail", kwargs={"pk": self.pk})


class IdeaTranslations(models.Model):
  idea = models.ForeignKey(
    Idea, 
    verbose_name=_("Idea"), 
    on_delete=models.CASCADE, 
    related_name="translations",
  )
  language = models.CharField(_("Language"), max_length=7)
  title = models.CharField(_("Title"), max_length=200) 
  content = models.TextField(_("Content"))
  
  class Meta:
    verbose_name = _("Idea Translations") 
    verbose_name_plural = _("Idea Translations") 
    ordering = ["language"]
    unique_together = [["idea", "language"]]
  
  def __str__(self): 
    return self.title
```

æˆ‘ä»¬ä½¿ç”¨äº†å‰ä¸€ç« ä¸­çš„ä¸€äº›æ¦‚å¿µï¼šç»§æ‰¿äº†æ¨¡å‹mixinå¹¶ä½¿ç”¨äº†ä¸€ä¸ªæ¨¡å‹ç¿»è¯‘è¡¨ã€‚é˜…è¯»*ä½¿ç”¨æ¨¡å‹mixin*åŠ*æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨*å°èŠ‚äº†è§£æ›´å¤šå†…å®¹ã€‚æˆ‘ä»¬å°†åœ¨æœ¬ç« çš„å‰©ä½™å°èŠ‚ä¸­ä½¿ç”¨ideasåº”ç”¨åŠè¿™äº›æ¨¡å‹ã€‚

æ­¤å¤–ï¼Œåˆ›å»ºä¸€ä¸ªåŒçº§categoriesåº”ç”¨å¹¶åŒ…å«Categoryå’ŒCategoryTranslationsæ¨¡å‹ï¼š

```
# myproject/apps/categories/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _

from myproject.apps.core.model_fields import TranslatedField

class Category(models.Model):
  title = models.CharField(_("Title"), max_length=200)

  translated_title = TranslatedField("title")
  
  class Meta:
    verbose_name = _("Category") 
    verbose_name_plural = _("Categories")

  def __str__(self): 
  return self.title


class CategoryTranslations(models.Model): 
  category = models.ForeignKey(
    Category, 
    verbose_name=_("Category"), 
    on_delete=models.CASCADE, 
    related_name="translations",
  )
  language = models.CharField(_("Language"), max_length=7)

  title = models.CharField(_("Title"), max_length=200)
  
  class Meta:
    verbose_name = _("Category Translations") 
    verbose_name_plural = _("Category Translations") 
    ordering = ["language"]
    unique_together = [["category", "language"]]
  
  def __str__(self): 
    return self.title
```

### å¦‚ä½•å®ç°...

Djangoä¸­çš„CRUDLåŠŸèƒ½ç”±è¡¨å•ã€è§†å›¾å’ŒURLè§„åˆ™æ‰€ç»„æˆã€‚ä¸‹é¢è¿›è¡Œåˆ›å»ºï¼š

1.  åœ¨ideasåº”ç”¨ä¸­æ–°å¢forms.pyæ–‡ä»¶ï¼Œæ·»åŠ ç”¨äºå¯¹Ideaæ¨¡å‹å®ä¾‹è¿›è¡Œæ–°å¢å’Œä¿®æ”¹çš„æ¨¡å‹è¡¨å•ï¼š


    ```
    # myprojects/apps/ideas/forms.py
    from django import forms 
    from .models import Idea


    class IdeaForm(forms.ModelForm): 
      class Meta:
        model = Idea 
        fields = "__all__"
    ```

1.  åœ¨ideasåº”ç”¨ä¸­æ·»åŠ views.pyç”¨äºæ–°å¢æ“ä½œIdeaæ¨¡å‹çš„è§†å›¾ï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.contrib.auth.decorators import login_required
    from django.shortcuts import render, redirect, get_object_or_404 
    from django.views.generic import ListView, DetailView
    
    from .forms import IdeaForm
    from .models import Idea
    
    class IdeaList(ListView): 
      model = Idea


    class IdeaDetail(DetailView): 
      model = Idea
      context_object_name = "idea"


    @login_required
    def add_or_change_idea(request, pk=None):
      idea = None 
      if pk:
        idea = get_object_or_404(Idea, pk=pk)
    
      if request.method == "POST": 
        form = IdeaForm(
          data=request.POST, 
          files=request.FILES, 
          instance=idea
        )
    
        if form.is_valid():
          idea = form.save()
          return redirect("ideas:idea_detail", pk=idea.pk)
      else:
        form = IdeaForm(instance=idea)
    
      context = {"idea": idea, "form": form}
      return render(request, "ideas/idea_form.html", context)


    @login_required
    def delete_idea(request, pk):
      idea = get_object_or_404(Idea, pk=pk) 
      if request.method == "POST":
        idea.delete()
        return redirect("ideas:idea_list")
      context = {"idea": idea}
      return render(request, "ideas/idea_deleting_confirmation.html", context)
    ```

1.  åœ¨ideasåº”ç”¨åˆ›å»ºurls.pyæ–‡ä»¶å¹¶æ·»åŠ URLè§„åˆ™ï¼š


    ```
    # myproject/apps/ideas/urls.py
    from django.urls import path
    
    from .views import ( 
      IdeaList,
      IdeaDetail,
      add_or_change_idea,
      delete_idea,
    )
    
    urlpatterns = [
      path("", IdeaList.as_view(), name="idea_list"),
      path("add/", add_or_change_idea, name="add_idea"), 
      path("<uuid:pk>/", IdeaDetail.as_view(), name="idea_detail"), 
      path("<uuid:pk>/change/", add_or_change_idea, name="change_idea"),
      path("<uuid:pk>/delete/", delete_idea, name="delete_idea"),
    ]
    ```

1.  ç°åœ¨æˆ‘ä»¬æŠŠè¿™äº›URLè§„åˆ™æ’å…¥åˆ°é¡¹ç›®çš„URLé…ç½®ä¸­ã€‚æˆ‘ä»¬è¿˜ä¼šåŒ…å«Djangoç¤¾åŒºçš„authåº”ç”¨ä¸­çš„è´¦æˆ·URLè§„åˆ™ï¼Œè¿™æ ·@login_requiredè£…é¥°å™¨å°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼š


    ```
    # myproject/urls.py
    from django.contrib import admin
    from django.conf.urls.i18n import i18n_patterns 
    from django.urls import include, path
    from django.conf import settings
    from django.conf.urls.static import static 
    from django.shortcuts import redirect
    
    urlpatterns = i18n_patterns(
      path("", lambda request: redirect("ideas:idea_list")), 
      path("admin/", admin.site.urls),
      path("accounts/", include("django.contrib.auth.urls")), 
      path("ideas/", include(("myproject.apps.ideas.urls", "ideas"), namespace="ideas")),
    )
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
    urlpatterns += static("/media/", document_root=settings.MEDIA_ROOT)
    ```

1.  ç°åœ¨å¯ä»¥åˆ›å»ºå¦‚ä¸‹æ¨¡æ¿äº†ï¼š

    -   åŒ…å«ç™»å½•è¡¨å•çš„registration/login.html
    -   åŒ…å«å¯¹ideasè¿›è¡Œåˆ—ä¸¾çš„ideas/idea_list.html
    -   æœ‰å…³å•ä¸ªideaè¯¦æƒ…çš„ideas/idea_detail.html
    -   å¸¦æœ‰æ·»åŠ æˆ–ä¿®æ”¹ idea è¡¨å•çš„ideas/idea_form.html
    -   åŒ…å«ç¡®è®¤åˆ é™¤ idea ç©ºè¡¨å•çš„ideas/idea_deleting_confirmation.html

åœ¨æ¨¡æ¿ä¸­ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½åç©ºé—´å’Œpathåç§°æ¥è°ƒç”¨ideasåº”ç”¨çš„URLï¼š

```
{% load i18n %}
<a href="{% url 'ideas:change_idea' pk=idea.pk %}">{% trans "Change this idea" %}</a>
<a href="{% url 'ideas:add_idea' %}">{% trans "Add idea" %}</a>
```

> â„¹ï¸å¦‚æœç¢°åˆ°é—®é¢˜æˆ–æ˜¯å¸Œæœ›èŠ‚çœæ—¶é—´ï¼Œå¯ä»¥æŸ¥çœ‹æœ¬ä¹¦ä»£ç æ–‡ä»¶ä¸­çš„ç›¸åº”æ¨¡æ¿ï¼Œåœ°å€ä¸ºhttps://github.com/alanhou/django3-cookbook/tree/master/Chapter03/django-myproject/myproject/templates/ideas

### å®ç°åŸç†...

æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨UUIDå­—æ®µä½œä¸ºIdeaæ¨¡å‹çš„ä¸»é”®ã€‚å€ŸåŠ©è¿™ä¸€IDï¼Œæ¯ä¸ªideaçš„å”¯ä¸€URLéƒ½æ˜¯æ— æ³•é çŒœæ¥çŸ¥é“çš„ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯å¯¹URLä½¿ç”¨slugå­—æ®µï¼Œä½†è¿™æ—¶è¦ç¡®ä¿ä¼šç”Ÿæˆslugä¸”åœ¨æ•´ä¸ªç½‘ç«™ä¸­æ˜¯å”¯ä¸€çš„ã€‚

> ğŸ’¡å‡ºäºå®‰å…¨è€ƒè™‘ä¸æ¨èå¯¹URLä½¿ç”¨é»˜è®¤çš„é€’å¢IDï¼šé‚£æ ·ç”¨æˆ·å°±èƒ½å¤Ÿæ¨ç®—å‡ºæ•°æ®åº“ä¸­æœ‰å¤šå°‘æ¡è®°å½•å¹¶å¯ä»¥å°è¯•è®¿é—®ä»–ä»¬å¯èƒ½æ²¡æœ‰æƒé™è®¿é—®çš„å‰ä¸€æ¡æˆ–åä¸€æ¡è®°å½•ã€‚

åœ¨æˆ‘ä»¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨é€šç”¨çš„è§†å›¾ç±»æ¥åˆ—å‡ºå¹¶è¯»å–ideaä»¥åŠè§†å›¾å‡½æ•°æ¥å¢ã€æ”¹ã€åˆ è¿™äº›ideaã€‚åœ¨æ•°æ®åº“ä¸­æ›´æ”¹è®°å½•çš„è§†å›¾é€šè¿‡@login_requiredè£…é¥°å™¨è¦æ±‚ä¸ºè®¤è¯ç”¨æˆ·ã€‚ä½¿ç”¨è§†å›¾ç±»æˆ–é’ˆå¯¹æ‰€æœ‰çš„CRUDLå‡½æ•°çš„è§†å›¾å‡½æ•°éƒ½æ²¡æœ‰é—®é¢˜ã€‚

åœ¨æˆåŠŸæ–°å¢æˆ–ä¿®æ”¹ideaä¹‹åï¼Œè¿™äº›ç”¨æˆ·ä¼šè¢«é‡å®šå‘åˆ°è¯¦æƒ…è§†å›¾ã€‚åœ¨åˆ é™¤ideaä¹‹åï¼Œç”¨æˆ·ä¼šè¢«é‡å®šå‘åˆ°åˆ—è¡¨è§†å›¾ã€‚

### æ‰©å±•çŸ¥è¯†...

æ­¤å¤–å¯ä»¥ä½¿ç”¨Djangoæ¶ˆæ¯æ¡†æ¶æ¥åœ¨æˆåŠŸæ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ—¶åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ã€‚

å¯ä»¥åœ¨[å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/en/3.0/ref/contrib/messages/)ä¸­é˜…è¯»ç›¸å…³å†…å®¹ã€‚

### ç›¸å…³å†…å®¹

-   [**ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„**](https://alanhou.org/models-database-structure/)ä¸­*ä½¿ç”¨æ¨¡å‹mixin*ä¸€èŠ‚
-   [**ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„**](https://alanhou.org/models-database-structure/)ä¸­*æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨*ä¸€èŠ‚
-   *ä¿å­˜æ¨¡å‹å®ä¾‹çš„ä½œè€…*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­*å®‰æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚

## ä¿å­˜æ¨¡å‹å®ä¾‹çš„ä½œè€…

Djangoçš„æ¯ä¸ªè§†å›¾çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯HttpRequestå¯¹è±¡ï¼ŒæŒ‰ç…§æƒ¯ä¾‹åç§°ä¸ºrequestã€‚å®ƒåŒ…å«æœ‰å…³ç”±æµè§ˆå™¨æˆ–å…¶å®ƒå®¢æˆ·ç«¯å‘è¯·æ±‚çš„å…ƒæ•°æ®ï¼ŒåŒ…å«å½“å‰è¯­è¨€ç ã€ç”¨æˆ·æ•°æ®ã€cookieå’Œsessionæ•°æ®ã€‚é»˜è®¤ï¼Œè§†å›¾ä½¿ç”¨è¡¨å•æ¥æ¥å—GETæˆ–POSTæ•°æ®ã€æ–‡ä»¶ã€åˆå§‹æ•°æ®åŠå…¶å®ƒå‚æ•°ï¼›ä½†æ˜¯å®ƒä»¬ä¸æ˜¯é»˜è®¤å°±å¯ä»¥è®¿é—®HttpRequestå¯¹è±¡ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé¢å¤–å°†HttpRequestä¼ é€’ç»™è¡¨å•ä¼šå¾ˆç”¨ï¼Œå°¤å…¶æ˜¯åœ¨æƒ³è¦æ ¹æ®å…¶å®ƒè¯·æ±‚æ•°æ®æˆ–åœ¨è¡¨å•ä¸­å¤„ç†å½“å‰ç”¨æˆ·æˆ–IPçš„ä¿å­˜æ—¶è¿‡æ»¤æ‰è¡¨å•å­—æ®µçš„é€‰é¡¹æ—¶ã€‚

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ è¡¨å•çš„ç¤ºä¾‹ï¼Œå…¶ä¸­å¯ä»¥æ·»åŠ æˆ–ä¿®æ”¹ideaï¼Œå¹¶å°†å½“å‰ç”¨æˆ·ä¿å­˜ä¸ºä½œè€…ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬å°†åœ¨å‰ä¸€å°èŠ‚ç¤ºä¾‹çš„åŸºç¡€ä¸Šè¿›è¡Œæ¼”ç¤ºã€‚
### å¦‚ä½•å®ç°...

è¦å®Œæˆæœ¬å°èŠ‚ï¼Œæ‰§è¡Œå¦‚ä¸‹ä¸¤æ­¥ï¼š

1.  ä¿®æ”¹IdeaFormæ¨¡å‹å¦‚ä¸‹ï¼š


    ```
    # myprojects/apps/ideas/forms.py
    from django import forms 
    from .models import Idea
    
    class IdeaForm(forms.ModelForm): 
      class Meta:
        model = Idea
        exclude = ["author"]
    
      def __init__(self, request, *args, **kwargs): 
        self.request = request 
        super().__init__(*args, **kwargs)
    
      def save(self, commit=True):
        instance = super().save(commit=False) 
        instance.author = self.request.user 
        if commit:
          instance.save()
          self.save_m2m() 
        return instance
    ```

1.  ä¿®æ”¹è§†å›¾æ¥æ·»åŠ æˆ–ä¿®æ”¹ideaï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.contrib.auth.decorators import login_required
    from django.shortcuts import render, redirect, get_object_or_404
    
    from .forms import IdeaForm 
    from .models import Idea


    @login_required
    def add_or_change_idea(request, pk=None):
      idea = None 
      if pk:
        idea = get_object_or_404(Idea, pk=pk)
      if request.method == "POST":
        form = IdeaForm(request, data=request.POST, files=request.FILES, instance=idea) 
        if form.is_valid():
          idea = form.save()
          return redirect("ideas:idea_detail", pk=idea.pk)
      else:
        form = IdeaForm(request, instance=idea)
      
      context = {"idea": idea, "form": form}
      return render(request, "ideas/idea_form.html", context)
    ```

### å®ç°åŸç†...

æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªè¡¨å•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ä»è¡¨å•ä¸­æ’é™¤äº†authorå­—æ®µï¼Œå› ä¸ºå¸Œæœ›ä½¿ç”¨ç¨‹åºæ¥è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬é‡å†™äº†__init__()æ–¹æ³•æ¥æ¥æ”¶HttpRequestä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å¹¶åœ¨è¡¨å•ä¸­è¿›è¡Œå­˜å‚¨ã€‚æ¨¡å‹è¡¨å•çš„save()æ–¹æ³•å¤„ç†æ¨¡å‹çš„å­˜å‚¨ã€‚commitå‚æ•°å‘Šè¯‰æ¨¡å‹è¡¨å•ç«‹å³å­˜å‚¨å®ä¾‹æˆ–è€…æ˜¯åˆ›å»ºå¹¶è°ƒç”¨å®ä¾‹ï¼Œä½†æš‚ä¸ä¿å­˜ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬è·å–äº†å®ä¾‹ä½†ä¸è¿›è¡Œä¿å­˜ï¼Œç„¶åé€šè¿‡å½“å‰ç”¨æˆ·ä¸ºauthorèµ‹å€¼ã€‚æœ€ååœ¨commitä¸ºTrueæ—¶æˆ‘ä»¬ä¿å­˜äº†è¯¥å®ä¾‹ã€‚æˆ‘ä»¬ä¼šåŠ¨æ€è°ƒç”¨è¡¨å•æ‰€æ·»åŠ çš„save_m2m() æ–¹æ³•æ¥ä¿å­˜å¤šå¯¹å¤šå…³è”ï¼Œå¦‚categoriesã€‚

åœ¨è§†å›¾ä¸­ï¼Œæˆ‘ä»¬åªå¯¹è¡¨å•ä¼ é€’requestå˜é‡ä½œä¸ºæ¯ä¸€ä¸ªå‚æ•°ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚
-   *ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚

## ä¸Šä¼ å›¾ç‰‡

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¤„ç†å›¾ç‰‡ä¸Šä¼ çš„æœ€ç®€å•æ–¹å¼ã€‚æˆ‘ä»¬ä¼šå¯¹Ideaæ¨¡å‹æ·»åŠ ä¸€ä¸ªpictureå­—æ®µï¼Œå¹¶ä¸ºä¸åŒç”¨é€”åˆ›å»ºä¸åŒå¤§å°ç‰ˆæœ¬çš„å›¾ç‰‡ã€‚

### å‡†å¤‡å·¥ä½œ

å¯¹äºå…·æœ‰ç‰ˆæœ¬çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°Pillowå’Œdjango-imagekitåº“ã€‚ä¸‹é¢é€šè¿‡pipæ¥åœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿›è¡Œå®‰è£…ï¼ˆå¹¶åœ¨requirements/_base.txtä¸­è¿›è¡Œæ·»åŠ ï¼‰ï¼š

```
(env)$ pip install Pillow
(env)$ pip install django-imagekit==4.0.2
```

ç„¶ååœ¨è®¾ç½®çš„INSTALLED_APPSæ·»åŠ imagekitã€‚

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤å®Œæˆæœ¬å°èŠ‚ä¸­çš„å¼€å‘ï¼š

1.  ä¿®æ”¹Ideaæ¨¡å‹ï¼Œæ·»åŠ ä¸€ä¸ªpictureå­—æ®µä»¥åŠå„å›¾ç‰‡ç‰ˆæœ¬è§„æ ¼ï¼š


    ```
    # myproject/apps/ideas/models.py import contextlib
    import os
    
    from imagekit.models import ImageSpecField 
    from pilkit.processors import ResizeToFill
    
    from django.db import models
    from django.utils.translation import gettext_lazy as _ 
    from django.utils.timezone import now as timezone_now
    
    from myproject.apps.core.models import (
      CreationModificationDateBase, 
      UrlBase
    )


    def upload_to(instance, filename):
      now = timezone_now()
      base, extension = os.path.splitext(filename) 
      extension = extension.lower()
      return f"ideas/{now:%Y/%m}/{instance.pk}{extension}"
    
    class Idea(CreationModificationDateBase, UrlBase): # attributes and fields...
      picture = models.ImageField(
        _("Picture"), upload_to=upload_to 
      )
      picture_social = ImageSpecField( 
        source="picture",
        processors=[ResizeToFill(1024, 512)], 
        format="JPEG",
        options={"quality": 100},
      )
      picture_large = ImageSpecField(
        source="picture", 
        processors=[ResizeToFill(800, 400)], 
        format="PNG"
      )
      picture_thumbnail = ImageSpecField(
        source="picture", 
        processors=[ResizeToFill(728, 250)], 
        format="PNG"
      )
      # other fields, properties, and methods...
    
      def delete(self, *args, **kwargs):
        from django.core.files.storage import default_storage 
        if self.picture:
          with contextlib.suppress(FileNotFoundError): 
            default_storage.delete(
              self.picture_social.path 
              )
            default_storage.delete( 
              self.picture_large.path
            ) 
            default_storage.delete(
              self.picture_thumbnail.path 
            )
          self.picture.delete() 
        super().delete(*args, **kwargs)
    ```

1.  å’Œå‰é¢å°èŠ‚ä¸­ä¸€æ ·ï¼Œåœ¨forms.pyä¸­ä¸ºIdeaæ¨¡å‹åˆ›å»ºæ¨¡å‹è¡¨å•IdeaFormã€‚

1.  åœ¨æ·»åŠ æˆ–ä¿®æ”¹ideaçš„è§†å›¾ä¸­ï¼Œç¡®ä¿åœ¨è¡¨å•ä¸­åœ¨request.POSTä¹‹åpostè¯·æ±‚è¿˜æäº¤request.FILESï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.contrib.auth.decorators import login_required
    from django.shortcuts import (render, redirect, get_object_or_404) 
    from django.conf import settings
    
    from .forms import IdeaForm 
    from .models import Idea


    @login_required
    def add_or_change_idea(request, pk=None): 
      idea = None
      if pk:
        idea = get_object_or_404(Idea, pk=pk) 
      if request.method == "POST":
        form = IdeaForm( request,
          data=request.POST, 
          files=request.FILES, 
          instance=idea,
        )
        if form.is_valid():
          idea = form.save()
          return redirect("ideas:idea_detail", pk=idea.pk)
      else:
        form = IdeaForm(request, instance=idea)
        
      context = {"idea": idea, "form": form}
      return render(request, "ideas/idea_form.html", context)
    ```

1.  åœ¨æ¨¡æ¿ä¸­ï¼Œè®°å¾—ä¸ºmultipart/form- dataè®¾ç½®ç¼–ç ç±»å‹ï¼Œå¦‚ä¸‹ï¼š


    ```
    <form action="{{ request.path }}" method="post" 
    enctype="multipart/form-data">
      {% csrf_token %} 
      {{ form.as_p }}
      <button type="submit">{% trans "Save" %}</button> 
    </form>
    ```

> â„¹ï¸å¦‚æœåƒ*é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚ä¸­æ‰€æè¿°é‚£æ ·ä½¿ç”¨django-crispy-formï¼Œåˆ™ä¼šåœ¨è¡¨å•ä¸­è‡ªåŠ¨æ·»åŠ enctypeå±æ€§ã€‚

### å®ç°åŸç†...

Djangoæ¨¡å‹è¡¨å•æ˜¯åŠ¨æ€åœ°ç”±æ¨¡å‹è¿›è¡Œåˆ›å»ºçš„ã€‚å®ƒä»¬æä¾›æ¥è‡ªæ¨¡å‹çš„æŒ‡å®šå­—æ®µï¼Œå› æ­¤æ— éœ€åœ¨è¡¨å•ä¸­æ‰‹åŠ¨é‡æ–°å®šä¹‰è¿™äº›å­—æ®µã€‚åœ¨å‰ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸ºIdeaæ¨¡å‹åˆ›å»ºäº†ä¸€ä¸ªæ¨¡å‹è¡¨å•ã€‚åœ¨ä¿å­˜è¡¨å•æ—¶ï¼Œè¡¨å•ä¼šçŸ¥é“åœ¨æ•°æ®åº“ä¸­å¦‚ä½•ä¿å­˜æ¯ä¸ªå­—æ®µã€å¦‚ä½•ä¸Šä¼ æ–‡ä»¶å¹¶åœ¨mediaç›®å½•ä¸­è¿›è¡Œä¿å­˜ã€‚

æœ¬ä¾‹ä¸­çš„upload_to() å‡½æ•°ç”¨äºå°†å›¾ç‰‡ä¿å­˜åˆ°æŒ‡å®šç›®å½•å¹¶é‡æ–°å®šä¹‰å…¶åç§°ï¼Œè¿™æ ·ä¸ä¼šä¸å…¶å®ƒæ¨¡å‹å®ä¾‹ä¸­çš„æ–‡ä»¶åç›¸å†²çªã€‚æ¯ä¸ªæ–‡ä»¶ä¿å­˜çš„è·¯å¾„ç±»ä¼¼ideas/2020/01/0422c6fe- b725-4576-8703-e2a9d9270986.jpgï¼Œå…¶ä¸­åŒ…å«ä¸Šä¼ çš„å¹´ã€æœˆä»¥åŠIdeaå®ä¾‹çš„ä¸»é”®ã€‚

> ğŸ’¡ä¸€äº›æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚FAT32å’ŒNTFSï¼‰å¯¹æ¯ä¸ªç›®å½•ä¸­çš„æ–‡ä»¶å­˜åœ¨ä¸Šé™ï¼›å› æ­¤æŒ‰ç…§ä¸Šä¼ æ—¥æœŸã€å­—æ¯æˆ–å…¶å®ƒæ¡ä»¶åˆ†å‰²åˆ°ä¸åŒç›®å½•æ˜¯ä¸€ç§å¥½å®è·µã€‚

æˆ‘ä»¬ä½¿ç”¨django-imagekitä¸­çš„ImageSpecFieldæ¥åˆ›å»º3ç§å›¾ç‰‡è§„æ ¼ï¼š

-   picture_socialç”¨äºç¤¾äº¤åˆ†äº«
-   picture_largeç”¨äºè¯¦æƒ…è§†å›¾
-   picture_thumbnailç”¨äºåˆ—è¡¨è§†å›¾

å›¾ç‰‡è§„æ ¼åœ¨æ•°æ®åº“ä¸­ä¸è¿›è¡Œå…³è”ï¼Œè€Œåªæ˜¯åœ¨CACHE/images/ideas/2020/01/0422c6fe-b725-4576-8703- e2a9d9270986/è¿™æ ·çš„æ–‡ä»¶è·¯å¾„ä¸­æŒ‰é»˜è®¤æ–‡ä»¶å­˜å‚¨è¿›è¡Œä¿å­˜ã€‚

åœ¨æ¨¡æ¿ä¸­ï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹ä½¿ç”¨åŸå§‹æˆ–æŒ‡å®šå›¾ç‰‡ç‰ˆæœ¬ï¼š

```
<img src="{{ idea.picture.url }}" alt="" />
<img src="{{ idea.picture_large.url }}" alt="" />
```

åœ¨Ideaæ¨¡å‹å®šä¹‰æœ€åï¼Œæˆ‘ä»¬é‡å†™äº†delete()æ–¹æ³•æ¥åœ¨åˆ é™¤Ideaå®ä¾‹æœ¬èº«ä¹‹å‰ä»ç£ç›˜ä¸Šåˆ é™¤å„ç‰ˆæœ¬å›¾ç‰‡åŠå›¾ç‰‡æœ¬èº«ã€‚

### ç›¸å…³å†…å®¹

-   *é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*ç¼–æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*ä½¿ç”¨å“åº”å¼å›¾ç‰‡*ä¸€èŠ‚

## é€šè¿‡è‡ªå®šä¹‰æ¨¡æ¿åˆ›å»ºè¡¨å•å¸ƒå±€

åœ¨Djangoçš„æ—©å‰ç‰ˆæœ¬ä¸­ï¼Œæ‰€æœ‰è¡¨å•çš„æ¸²æŸ“éƒ½ç‹¬ç«‹æ”¾åœ¨Pythonä»£ç ä¸­å¤„ç†ï¼Œä½†ä»Django 1.11å¼€å§‹ï¼Œå°±å¼•å…¥äº†åŸºäºæ¨¡æ¿çš„è¡¨å•ç»„ä»¶æ¸²æŸ“ã€‚åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å¯¹è¡¨å•ç»„ä»¶ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ã€‚æˆ‘ä»¬ä¼šä½¿ç”¨Djangoåå°è¡¨å•æ¥è®²è§£è‡ªå®šä¹‰ç»„ä»¶æ¨¡æ¿å¦‚ä½•æå‡å­—æ®µçš„æ˜“ç”¨æ€§ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬å…ˆåˆ›å»ºIdeaæ¨¡å‹çš„é»˜è®¤åå°ç®¡ç†å¹¶æ·»åŠ ç¿»è¯‘ï¼š

```
# myproject/apps/ideas/admin.py
from django import forms
from django.contrib import admin
from django.utils.translation import gettext_lazy as _

from myproject.apps.core.admin import LanguageChoicesForm 

from .models import Idea, IdeaTranslations


class IdeaTranslationsForm(LanguageChoicesForm):
  class Meta:
    model = IdeaTranslations 
    fields = "__all__"


class IdeaTranslationsInline(admin.StackedInline): 
  form = IdeaTranslationsForm
  model = IdeaTranslations
  extra = 0


@admin.register(Idea)
class IdeaAdmin(admin.ModelAdmin):
  inlines = [IdeaTranslationsInline]
  fieldsets = [
    (_("Author and Category"), 
    {"fields": ["author", "categories"]}),
    (_("Title and Content"), 
    {"fields": ["title", "content", "picture"]}),
    (_("Ratings"), 
    {"fields": ["rating"]}),
  ]
```

æ­¤æ—¶å¦‚è®¿é—®ideasçš„åå°è¡¨å•ï¼Œç•Œé¢ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

![Ideasåå°è¡¨å•é¡µé¢](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/45b9185281bd4b6087935365405f12ec~tplv-k3u1fbpfcp-zoom-1.image)

### å¦‚ä½•å®ç°...

å­¦ä¹ æœ¬å°èŠ‚ï¼Œéœ€æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š

1.  é€šè¿‡å°†django.formsæ·»åŠ åˆ°INSTALLED_APPSä¸­ã€åœ¨æ¨¡æ¿é…ç½®ä¸­å°†APP_DIRSæ ‡è®°è®¾ç½®ä¸ºTrueå¹¶ä½¿ç”¨TemplatesSettingè¡¨å•æ¸²æŸ“å™¨æ¥ç¡®ä¿æ¨¡æ¿ç³»ç»Ÿèƒ½å¤Ÿå‘ç°è‡ªå®šä¹‰æ¨¡æ¿ï¼š


    ```
    # myproject/settings/_base.py
    INSTALLED_APPS = [ 
      "django.contrib.admin", 
      "django.contrib.auth", 
      "django.contrib.contenttypes", 
      "django.contrib.sessions", 
      "django.contrib.messages", 
      "django.contrib.staticfiles", 
      "django.forms",
      # other apps... 
    ]
    
    TEMPLATES = [ 
      {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [os.path.join(BASE_DIR, "myproject", "templates")], 
        "APP_DIRS": True,
        "OPTIONS": {
          "context_processors": [ 
            "django.template.context_processors.debug", 
            "django.template.context_processors.request", 
            "django.contrib.auth.context_processors.auth", 
            "django.contrib.messages.context_processors.messages", 
            "django.template.context_processors.media", 
            "django.template.context_processors.static", 
            "myproject.apps.core.context_processors .website_url",
          ] 
        },
      } 
    ]
    
    FORM_RENDERER = "django.forms.renderers.TemplatesSetting"
    ```

1.  ç¼–è¾‘admin.pyæ–‡ä»¶å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/admin.py
    from django import forms
    from django.contrib import admin
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.admin import LanguageChoicesForm
    
    from myproject.apps.categories.models import Category
    from .models import Idea, IdeaTranslations


    class IdeaTranslationsForm(LanguageChoicesForm):
      class Meta:
        model = IdeaTranslations 
        fields = "__all__"


    class IdeaTranslationsInline(admin.StackedInline): 
      form = IdeaTranslationsForm
      model = IdeaTranslations
      extra = 0


    class IdeaForm(forms.ModelForm):
      categories = forms.ModelMultipleChoiceField(
        label=_("Categories"), 
        queryset=Category.objects.all(), 
        widget=forms.CheckboxSelectMultiple(), 
        required=True,
      )
    
      class Meta:
        model = Idea
        fields = "__all__"
    
      def __init__(self, *args, **kwargs): 
        super().__init__(*args, **kwargs)
      
        self.fields[ 
          "picture"
        ].widget.template_name = "core/widgets/image.html"


    @admin.register(Idea)
    class IdeaAdmin(admin.ModelAdmin):
      form = IdeaForm
      inlines = [IdeaTranslationsInline]
    
      fieldsets = [
        (_("Author and Category"), 
        {"fields": ["author", "categories"]}),
        (_("Title and Content"),  "picture"]}),
        (_("Ratings"), {"fields": ["rating"]}),
      ]
    ```

1.  æœ€åï¼Œä¸ºpictureå­—æ®µåˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š


    ```
    {# core/widgets/image.html #}
    {% load i18n %}
    
    <div style="margin-left: 160px; padding-left: 10px;"> 
      {% if widget.is_initial %}
        <a href="{{ widget.value.url }}">
          <img src="{{ widget.value.url }}" width="624" height="auto" alt="" />
        </a>
        {% if not widget.required %}<br />
          {{ widget.clear_checkbox_label }}:
          <input type="checkbox" name="{{ widget.checkbox_name }}" id="{{ widget.checkbox_id }}"> 
        {% endif %}<br />
        {{ widget.input_text }}: 
      {% endif %}
      <input type="{{ widget.type }}" name="{{ widget.name }}"{% include "django/forms/widgets/attrs.html" %}>
    </div>
    <div class="help">
      {% trans "Available formats are JPG, GIF, and PNG." %} 
      {% trans "Minimal size is 800 x 800 px." %}
    </div>
    ```

### å®ç°åŸç†...

æ­¤æ—¶å†è®¿é—®ideasçš„åå°ç•Œé¢ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![Djangoåå° Ideaä¿®æ”¹è¡¨å•](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19dd59621bcb426697e4e2ccafd7adb9~tplv-k3u1fbpfcp-zoom-1.image)

è¿™é‡Œæœ‰ä¸¤å¤„å˜åŠ¨ï¼š

-   åˆ†ç±»é€‰é¡¹æ­¤æ—¶ä½¿ç”¨å¸¦æœ‰å¤šä¸ªå¤é€‰æ¡†çš„ç»„ä»¶
-   å›¾ç‰‡å­—æ®µé€šè¿‡æŒ‡å®šçš„æ¨¡æ¿è¿›è¡Œäº†æ¸²æŸ“ï¼Œä½¿ç”¨æ‰€æŒ‡å®šæ–‡ä»¶ç±»å‹å’Œå°ºå¯¸æ˜¾ç¤ºç€å›¾ç‰‡é¢„è§ˆå’Œå¸®åŠ©æ–‡ä»¶ã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„æ˜¯ï¼Œé‡å†™ideaæ¨¡å‹è¡¨å•ã€ä¿®æ”¹åˆ†ç±»ç»„ä»¶åŠå›¾ç‰‡å­—æ®µçš„æ¨¡æ¿ã€‚

Djangoä¸­é»˜è®¤çš„è¡¨å•æ¸²æŸ“å™¨æ˜¯django.forms.renderers.DjangoTemplatesï¼Œå®ƒä»…åœ¨åº”ç”¨ç›®å½•ä¸­æœç´¢æ¨¡æ¿ã€‚æˆ‘ä»¬å°†å…¶ä¿®æ”¹ä¸ºdjango.forms.renderers.TemplatesSettingè®©å®ƒåŒæ—¶è¿˜åœ¨DIRSè·¯å¾„ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚

### ç›¸å…³å†…å®¹

-   [**ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„**](https://alanhou.org/models-database-structure/)ä¸­*æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨*ä¸€èŠ‚
-   *ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚
-   *é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚

## é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€

Djangoåº”ç”¨django-crispy-formsè®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä¸€ç§CSSæ¡†æ¶æ„å»ºã€è‡ªå®šä¹‰åŠå¤ç”¨è¡¨å•ï¼šUni-Formã€Bootstrap 3ã€Bootstrap 4æˆ–Foundationã€‚django-crispy-formsçš„ä½¿ç”¨ä¸Djangoè‡ªå¸¦çš„fieldsetsæœ‰äº›ç±»ä¼¼ï¼›ä½†å®ƒæ›´ä¸ºé«˜çº§ã€å®šåˆ¶åŒ–æ›´å¼ºã€‚å¯ä»¥åœ¨Pythonä»£ç ä¸­å®šä¹‰è¡¨å•å¸ƒå±€è€Œæ— éœ€æ‹…å¿ƒæ¯ä¸ªå­—æ®µåœ¨HTMLä¸­å¦‚ä½•å±•ç¤ºã€‚æ­¤å¤–ï¼Œå¦‚æœéœ€è¦æ·»åŠ æŒ‡å®šçš„HTMLå±æ€§æˆ–æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥è½»æ¾å®ç°ã€‚django-crispy-formsæ‰€ä½¿ç”¨çš„æ‰€æœ‰æ ‡è®°ä½äºtemplateså†…ï¼Œå¯åœ¨éœ€è¦æ—¶è¿›è¡Œé‡å†™ã€‚
æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ç”¨äºå¼€å‘å“åº”å¼ã€mobile-firstç½‘é¡µé¡¹ç›®çš„æµè¡Œå‰å°æ¡†æ¶Bootstrap 4ï¼Œæ¥ä¸ºå‰å°è¡¨å•åˆ›å»ºæ¼‚äº®çš„å¸ƒå±€ï¼Œç”¨äºæ·»åŠ æˆ–ç¼–è¾‘ideasã€‚

### å‡†å¤‡å·¥ä½œ

é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨åœ¨æœ¬ç« ä¸­åˆ›å»ºçš„ideasåº”ç”¨ã€‚æ¥ç€é€ä¸€æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š

1.  è®°å¾—ä¸ºç½‘ç«™åˆ›å»ºä¸€ä¸ªbase.html æ¨¡æ¿ã€‚æ›´å¤šè¯¦æƒ…å‚è§[**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­å®‰æ’base.htmlæ¨¡æ¿ä¸€èŠ‚ã€‚

1.  æ ¹æ®https://getbootstrap.com/docs/4.3/getting-started/introduction/å°†Bootstrap 4å‰ç«¯æ¡†æ¶ä¸­çš„CSSå’ŒJSæ–‡ä»¶é›†æˆåˆ°base.htmlæ¨¡æ¿ä¸­ã€‚

1.  é€šè¿‡pipåœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…django-crispy-formsï¼ˆå¹¶å°†å…¶æ·»åŠ åˆ°requirements/_base.txtä¸­ï¼‰ï¼š


    ```
    (env)$ pip install django-crispy-forms
    ```

1.  åœ¨è®¾ç½®çš„INSTALLED_APPSä¸­æ·»åŠ crispy_formsï¼Œç„¶åè®¾ç½®bootstrap4ä¸ºé¡¹ç›®ä¸­æ‰€ä½¿ç”¨çš„æ¨¡æ¿åŒ…ï¼š


    ```
    # myproject/settings/_base.py
    INSTALLED_APPS = ( 
      # ...
      "crispy_forms",
      "ideas", 
    )
    # ...
    CRISPY_TEMPLATE_PACK = "bootstrap4"
    ```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ“ä½œï¼š

1.  ä¿®æ”¹ideasçš„æ¨¡å‹è¡¨å•ï¼š


    ```
    # myproject/apps/ideas/forms.py
    from django import forms
    from django.utils.translation import ugettext_lazy as _ 
    from django.conf import settings
    from django.db import models
    
    from crispy_forms import bootstrap, helper, layout
    
    from .models import Idea


    class IdeaForm(forms.ModelForm): 
      class Meta:
        model = Idea 
        exclude = ["author"]
    
      def __init__(self, request, *args, **kwargs): 
        self.request = request 
        super().__init__(*args, **kwargs)
    
        self.fields["categories"].widget = forms.CheckboxSelectMultiple()
        
        title_field = layout.Field(
          "title", css_class="input-block-level"
        )
        content_field = layout.Field(
          "content", css_class="input-block-level", rows="3" 
        )
        main_fieldset = layout.Fieldset(
          _("Main data"), title_field, content_field
        )
    
        picture_field = layout.Field(
          "picture", css_class="input-block-level"
        )
        format_html = layout.HTML(
          """{% include "ideas/includes/picture_guidelines.html" %}"""
        )
        picture_fieldset = layout.Fieldset( 
          _("Picture"),
          picture_field,
          format_html,
          title=_("Image upload"),
          css_id="picture_fieldset",
        )
    
        categories_field = layout.Field(
          "categories", css_class="input-block-level"
        )
        categories_fieldset = layout.Fieldset(
          _("Categories"), categories_field,
          css_id="categories_fieldset"
        )
    
        submit_button = layout.Submit("save", _("Save")) 
        actions = bootstrap.FormActions(submit_button)
        self.helper = helper.FormHelper() 
        self.helper.form_action = self.request.path 
        self.helper.form_method = "POST" 
        self.helper.layout = layout.Layout(
          main_fieldset,
          picture_fieldset,
          categories_fieldset,
          actions,
        )
    
      def save(self, commit=True):
        instance = super().save(commit=False) 
        instance.author = self.request.user 
        if commit:
          instance.save()
          self.save_m2m() 
        return instance
    ```

1.  ç„¶åé€šè¿‡å¦‚ä¸‹å†…å®¹åˆ›å»ºpicture_guidelines.htmlæ¨¡æ¿ï¼š


    ```
    {# ideas/includes/picture_guidelines.html #}
    {% load i18n %}
    <p class="form-text text-muted">
      {% trans "Available formats are JPG, GIF, and PNG." %}
      {% trans "Minimal size is 800 Ã— 800 px." %} 
    </p>
    ```

1.  æœ€åæ›´æ–°ideasè¡¨å•çš„æ¨¡æ¿ï¼š


    ```
    {# ideas/idea_form.html #}
    {% extends "base.html" %}
    {% load i18n crispy_forms_tags static %}
    
    {% block content %}
      <a href="{% url "ideas:idea_list" %}">{% trans "List of ideas" %}</a>
      <h1>
        {% if idea %}
          {% blocktrans trimmed with title=idea.translated_title %} 
            Change Idea "{{ title }}
          {% endblocktrans %}
        {% else %}
          {% trans "Add Idea" %}
        {% endif %}
      </h1>
      {% crispy form %}
    {% endblock %}
    ```

### å®ç°åŸç†...

åœ¨ideasçš„æ¨¡å‹è¡¨å•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè¡¨å•å¸®åŠ©ç±»ï¼Œå¸ƒå±€ç”±ä¸»å­—æ®µé›†ã€å›¾ç‰‡å­—æ®µé›†ã€åˆ†ç±»å­—æ®µé›†å’Œæäº¤æŒ‰é’®æ‰€ç»„æˆã€‚æ¯ä¸ªå­—æ®µé›†ç”±ä¸åŒå­—æ®µç»„æˆã€‚æ¯ä¸ªå­—æ®µé›†ã€å­—æ®µæˆ–æŒ‰é’®å¯ä»¥å¸¦æœ‰å…¶å®ƒå‚æ•°ï¼Œæˆä¸ºå­—æ®µçš„å±æ€§ï¼Œå¦‚rows="3"æˆ–placeholder=_("Please enter a title")ã€‚å¯¹äºHTMLç±»å’Œidå±æ€§ï¼Œæœ‰ç‰¹å®šçš„å‚æ•°css_classå’Œcss_idã€‚

ideaè¡¨å•çš„é¡µé¢ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

![Django 3 Ideaå‰å°ä¿®æ”¹é¡µé¢](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2032c6df56884bedbf8bc8045c66a0d9~tplv-k3u1fbpfcp-zoom-1.image)

å’Œå‰é¢å°èŠ‚ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†ç›®å½•å­—æ®µçš„ç»„ä»¶å¹¶ä¸ºå›¾ç‰‡å­—æ®µæ·»åŠ äº†é¢å¤–çš„å¸®åŠ©æ–‡æœ¬ã€‚

### æ‰©å±•çŸ¥è¯†...

å‰ä¾‹å¯¹äºåŸºç¡€ä½¿ç”¨å·²ç»è¶³å¤Ÿäº†ã€‚ä½†å¦‚æœéœ€è¦åœ¨è¡¨å•ä¸­è®¾ç½®æŒ‡å®šæ ‡è®°ï¼Œåˆ™ä»éœ€é‡å†™å¹¶ä¿®æ”¹django-crispy-formsåº”ç”¨çš„æ¨¡æ¿ï¼Œå› ä¸ºåœ¨Pythonæ–‡ä»¶ä¸­æ²¡æœ‰ç¡¬ç¼–ç çš„æ ‡è®°ï¼Œè€Œæ˜¯æ‰€æœ‰ç”Ÿæˆçš„æ ‡è®°å‡é€šè¿‡æ¨¡æ¿è¿›è¡Œæ¸²æŸ“ã€‚åªéœ€å°†django-crispy-formsä¸­çš„æ¨¡æ¿æ‹·è´åˆ°é¡¹ç›®æ¨¡æ¿ç›®å½•ä¸­å¹¶æŒ‰éœ€ä¿®æ”¹ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚
-   *é€šè¿‡è‡ªå®šä¹‰æ¨¡å‹åˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚
-   é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€
-   *è¿‡æ»¤å¯¹è±¡åˆ—è¡¨*ä¸€èŠ‚
-   *ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚
-   *ç¼–å†™åŸºäºç±»çš„è§†å›¾*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­*å®‰æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚

## å¤„ç†formsets

é™¤äº†å¸¸è§„è¡¨å•æˆ–æ¨¡å‹è¡¨å•å¤–ï¼ŒDjangoè¿˜æœ‰ä¸€ä¸ªè¡¨å•é›†çš„æ¦‚å¿µã€‚è¿™äº›æ˜¯å…è®¸ä¸€æ¬¡æ€§åˆ›å»ºæˆ–ä¿®æ”¹å¤šä¸ªå®ä¾‹çš„åŒä¸€ç±»å‹è¡¨å•çš„é›†åˆã€‚Djangoè¡¨å•é›†å¯é€šè¿‡JavaScriptä¸°å¯ŒåŠŸèƒ½ï¼Œå®ƒè®©æˆ‘ä»¬å¯ä»¥å¯¹é¡µé¢åŠ¨æ€æ·»åŠ è¡¨å•é›†ã€‚è¿™ä¹Ÿæœ¬å°èŠ‚è¦è®¨è®ºçš„ã€‚æˆ‘ä»¬ä¼šæ‰©å±•ideasè¡¨å•æ¥å…è®¸å¯¹åŒä¸€é¡µé¢æ·»åŠ ä¸åŒè¯­è¨€çš„ç¿»è¯‘ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬å°†ç»§ç»­ä½¿ç”¨å‰ä¸€å°èŠ‚*é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸­çš„IdeaFormã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤ï¼š

1.  ä¿®æ”¹IdeaFormçš„è¡¨å•å¸ƒå±€ï¼š


    ```
    # myproject/apps/ideas/forms.py
    from django import forms
    from django.utils.translation import ugettext_lazy as _ 
    from django.conf import settings
    from django.db import models
    
    from crispy_forms import bootstrap, helper, layout 
    
    from .models import Idea, IdeaTranslations


    class IdeaForm(forms.ModelForm): 
      class Meta:
        model = Idea 
        exclude = ["author"]
      def __init__(self, request, *args, **kwargs): 
        self.request = request 
        super().__init__(*args, **kwargs)
      
        self.fields["categories"].widget = forms.CheckboxSelectMultiple()
      
        title_field = layout.Field(
          "title", css_class="input-block-level"
        )
        content_field = layout.Field(
          "content", css_class="input-block-level", rows="3" 
        )
        main_fieldset = layout.Fieldset(
          _("Main data"), title_field, content_field
        )
        picture_field = layout.Field(
          "picture", css_class="input-block-level"
        )
        format_html = layout.HTML(
          """{% include "ideas/includes/picture_guidelines.html" %}"""
        )
    
        picture_fieldset = layout.Fieldset(
          _("Picture"), 
          picture_field, 
          format_html, 
          title=_("Image upload"), 
          css_id="picture_fieldset",
        )
    
        categories_field = layout.Field(
          "categories", css_class="input-block-level"
        )
        categories_fieldset = layout.Fieldset(
          _("Categories"), categories_field,
          css_id="categories_fieldset" )
        
        inline_translations = layout.HTML(
          """{% include "ideas/forms/translations.html" %}"""
        )
    
        submit_button = layout.Submit("save", _("Save")) 
        actions = bootstrap.FormActions(submit_button)
    
        self.helper = helper.FormHelper() 
        self.helper.form_action = self.request.path 
        self.helper.form_method = "POST" 
        self.helper.layout = layout.Layout(
          main_fieldset,
          inline_translations,
          picture_fieldset,
          categories_fieldset,
          actions,
        )
    
      def save(self, commit=True):
        instance = super().save(commit=False) 
        instance.author = self.request.user 
        if commit:
          instance.save()
          self.save_m2m() 
        return instance
    ```

1.  ç„¶åï¼ŒåŒä¸€æ–‡ä»¶çš„æœ€åæ·»åŠ IdeaTranslationsFormï¼š


    ```
    class IdeaTranslationsForm(forms.ModelForm): 
      language = forms.ChoiceField(
        label=_("Language"), 
        choices=settings.LANGUAGES_EXCEPT_THE_DEFAULT, 
        required=True,
      )
      
      class Meta:
        model = IdeaTranslations
        exclude = ["idea"]
    
      def __init__(self, request, *args, **kwargs): 
        self.request = request 
        super().__init__(*args, **kwargs)
    
        id_field = layout.Field("id") 
        language_field = layout.Field(
          "language", css_class="input-block-level" 
        )
        title_field = layout.Field(
          "title", css_class="input-block-level"
        )
        content_field = layout.Field(
          "content", css_class="input-block-level", rows="3" 
        )
        delete_field = layout.Field("DELETE") 
        main_fieldset = layout.Fieldset(
          _("Main data"),
          id_field,
          language_field,
          title_field,
          content_field,
          delete_field,
        )
      
        self.helper = helper.FormHelper() 
        self.helper.form_tag = False 
        self.helper.disable_csrf = True 
        self.helper.layout = layout.Layout(main_fieldset)
    ```

1.  ä¿®æ”¹è§†å›¾æ¥æ·»åŠ æˆ–ä¿®æ”¹ideasï¼Œå¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.contrib.auth.decorators import login_required
    from django.shortcuts import render, redirect, get_object_or_404 
    from django.forms import modelformset_factory
    from django.conf import settings
    
    from .forms import IdeaForm, IdeaTranslationsForm 
    from .models import Idea, IdeaTranslations


    @login_required
    def add_or_change_idea(request, pk=None):
      idea = None 
      if pk:
        idea = get_object_or_404(Idea, pk=pk)
      IdeaTranslationsFormSet = modelformset_factory(
        IdeaTranslations, form=IdeaTranslationsForm,
        extra=0, can_delete=True
      )
      if request.method == "POST":
        form = IdeaForm(request, data=request.POST,
        files=request.FILES, instance=idea)
        translations_formset = IdeaTranslationsFormSet( 
          queryset=IdeaTranslations.objects.filter(idea=idea), 
          data=request.POST,
          files=request.FILES,
          prefix="translations",
          form_kwargs={"request": request},
        )
        if form.is_valid() and translations_formset.is_valid(): 
          idea = form.save()
          translations = translations_formset.save(
            commit=False
          )
          for translation in translations: 
            translation.idea = idea 
            translation.save()
          translations_formset.save_m2m() 
          for translation in translations_formset.deleted_objects: 
            translation.delete()
          return redirect("ideas:idea_detail", pk=idea.pk)
      else:
        form = IdeaForm(request, instance=idea) 
        translations_formset = IdeaTranslationsFormSet(
          queryset=IdeaTranslations.objects.filter(idea=idea),
          prefix="translations",
          form_kwargs={"request": request},
         )
        context = { 
          "idea": idea,
          "form": form,
          "translations_formset": translations_formset
        }
        return render(request, "ideas/idea_form.html", context)
    ```

1.  ç„¶åï¼Œç¼–è¾‘idea_form.htmlæ¨¡æ¿å¹¶åœ¨æœ€åæ·»åŠ å¯¹inlines.jsè„šæœ¬çš„å¼•ç”¨ï¼š


    ```
    {# ideas/idea_form.html #}
    {% extends "base.html" %}
    {% load i18n crispy_forms_tags static %}
    
    {% block content %}
        <a href="{% url "ideas:idea_list" %}">{% trans "List of ideas" %}</a>
        <h1>
            {% if idea %}
                {% blocktrans trimmed with title=idea.translated_title %} 
                    Change Idea "{{ title }}"
                {% endblocktrans %}
            {% else %}
                {% trans "Add Idea" %}
            {% endif %}
        </h1>
        {% crispy form %}
    {% endblock %}
    
    {% block js %}
        <script src="{% static 'site/js/inlines.js' %}"></script>
    {% endblock %}
    ```

1.  ä¸ºç¿»è¯‘è¡¨å•é›†åˆ›å»ºæ¨¡æ¿ï¼š


    ```
    {# ideas/forms/translations.html #}
    {% load i18n crispy_forms_tags %}
    <section id="translations_section" class="formset my-3">
        {{ translations_formset.management_form }} 
        <h3>{% trans "Translations" %}</h3>
        <div class="formset-forms">
            {% for formset_form in translations_formset %} 
                <div class="formset-form">
                    {% crispy formset_form %}
                </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-primary btn-sm add-inline-form">
            {% trans "Add translations to another language" %}
        </button>
        <div class="empty-form d-none">
            {% crispy translations_formset.empty_form %}
        </div>
    </section>
    ```

1.  æœ€åï¼Œæ·»åŠ JavaScriptæ¥æ“ä½œè¡¨å•é›†ï¼š


    ```
    /* site/js/inlines.js */
    window.WIDGET_INIT_REGISTER = window.WIDGET_INIT_REGISTER || [];
    
    $(function () {
        function reinit_widgets($formset_form) {
            $(window.WIDGET_INIT_REGISTER).each(function (index, func)
            {
                func($formset_form);
            });
        }
    
        function set_index_for_fields($formset_form, index) { 
            $formset_form.find(':input').each(function () {
                var $field = $(this); 
                if ($field.attr("id")) {
                    $field.attr( 
                        "id",
                        $field.attr("id").replace(/-__prefix__-/, "-" + index + "-")
                    ); 
                }
                if ($field.attr("name")) { 
                    $field.attr(
                        "name",
                        $field.attr("name").replace( 
                            /-__prefix__-/, "-" + index + "-"
                        )
                    );
                }
            });    
            $formset_form.find('label').each(function () { 
                var $field = $(this);
                if ($field.attr("for")) {
                    $field.attr( 
                        "for",
                        $field.attr("for").replace( 
                            /-__prefix__-/, "-" + index + "-"
                        ) 
                    );
                }
            });
            $formset_form.find('div').each(function () { 
                var $field = $(this);
                if ($field.attr("id")) {
                    $field.attr( 
                        "id",
                        $field.attr("id").replace( 
                            /-__prefix__-/, "-" + index + "-"
                        ) 
                    );
                }
            });
        }
    
        function add_delete_button($formset_form) { 
            $formset_form.find('input:checkbox[id$=DELETE]')
            .each(function () {
                var $checkbox = $(this); 
                var $deleteLink = $(
                    '<button class="delete btn btn-sm btn-danger mb-3">Remove</button>'
                );
                $formset_form.append($deleteLink); 
                $checkbox.closest('.form-group').hide();
            }); 
        }
        
        $('.add-inline-form').click(function (e) { 
            e.preventDefault();
            var $formset = $(this).closest('.formset');
            var $total_forms = $formset.find('[id$="TOTAL_FORMS"]');
            var $new_form = $formset.find('.empty-form').clone(true).attr("id", null); 
            $new_form.removeClass('empty-form d-none').addClass('formset-form'); 
            set_index_for_fields($new_form, parseInt($total_forms.val(), 10)); 
            $formset.find('.formset-forms').append($new_form); 
            add_delete_button($new_form); 
            $total_forms.val(parseInt($total_forms.val(), 10) + 1); 
            reinit_widgets($new_form);
        });
        $('.formset-form').each(function () {
            $formset_form = $(this); 
            add_delete_button($formset_form); 
            reinit_widgets($formset_form);
        });
        $(document).on('click', '.delete', function (e) {
            e.preventDefault();
            var $formset = $(this).closest('.formset-form'); 
            var $checkbox = $formset.find('input:checkbox[id$=DELETE]'); 
            $checkbox.attr("checked", "checked"); 
            $formset.hide();
        }); 
    });
    ```

### å®ç°åŸç†...

è¯»è€…å¯èƒ½é€šè¿‡Djangoæ¨¡å‹ç®¡ç†åå°å·²ç»äº†è§£åˆ°è¡¨å•é›†äº†ã€‚è¡¨å•é›†åœ¨é‚£é‡Œç”¨äºå¯¹äºçˆ¶æ¨¡å‹æ‹¥æœ‰å¤–é”®çš„å­æ¨¡å‹çš„è¡Œå†…æœºåˆ¶ã€‚

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨django-crispy-formså¯¹ideaè¡¨å•æ·»åŠ äº†è¡¨å•é›†ã€‚ç»“æœå¦‚ä¸‹ï¼š

![Django 3æ·»åŠ ç¿»è¯‘è¡¨å•](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de95f27612ac4217ab849d901650420b~tplv-k3u1fbpfcp-zoom-1.image)

å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬ä¸ä¸€å®šè¦åœ¨è¡¨å•çš„ç»“å°¾å¤„æ’å…¥è¡¨å•é›†ï¼Œè€Œæ˜¯åœ¨ä¸­é—´ä»»æ„æœ‰ä½œç”¨ä¹‹å¤„çš†å¯ã€‚æœ¬ä¾‹ä¸­ï¼ŒæŠŠç¿»è¯‘æ”¾åˆ°å¯ç¿»è¯‘å­—æ®µä¹‹åæœ‰å®é™…æ„ä¹‰ã€‚

ç¿»è¯‘è¡¨å•çš„è¡¨å•å¸ƒå±€åƒIdeaFormçš„å¸ƒå±€ä¸€æ ·æœ‰fieldsetï¼Œä½†é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰è¯†åˆ«æ¯ä¸ªæ¨¡å‹å®ä¾‹æ‰€éœ€çš„idåŠè¿›è¡Œåˆ é™¤æ—¶ä½¿ç”¨çš„DELETEå­—æ®µã€‚DELETEå­—æ®µå®é™…ä¸Šæ˜¯ä¸€ä¸ªå¤é€‰æ¡†ï¼Œåœ¨é€‰ä¸­æ—¶ä»æ•°æ®åº“ä¸­åˆ é™¤ç›¸åº”å†…å®¹ã€‚åŒæ—¶ï¼Œç¿»è¯‘çš„è¡¨å•helperä¸­æœ‰form_tag=Falseï¼Œä¸ç”Ÿæˆ<form>æ ‡ç­¾ï¼Œdisable_csrf=Trueä¼šä¸åŒ…å«CSRFä»¤ç‰Œï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨å…¶çˆ¶è¡¨å•IdeaFormä¸­è¿›è¡Œè¿‡å®šä¹‰ã€‚

åœ¨è¡¨å•ä¸­ï¼Œå¦‚æœè¯·æ±‚ç”±POSTæ–¹æ³•å‘é€ï¼Œä¸”è¡¨å•å’Œè¡¨å•é›†æœ‰æ•ˆï¼Œé‚£ä¹ˆä¼šä¿å­˜è¡¨å•å¹¶åˆ›å»ºç›¸åº”çš„ç¿»è¯‘å®ä¾‹ï¼Œä¸äº‹å…ˆè¿›è¡Œä¿å­˜ã€‚è¿™é€šè¿‡commit=Falseå±æ€§å®ç°ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ªç¿»è¯‘å®ä¾‹åˆ†é…ideaï¼Œç„¶åå°†ç¿»è¯‘å†…å®¹ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚æœ€åï¼ŒæŸ¥çœ‹è¡¨å•é›†ä¸­çš„è¡¨å•æ˜¯æœ‰å¦æ ‡è®°ä¸ºåˆ é™¤çš„å¹¶ä»æ•°æ®åº“ä¸­è¿›è¡Œç›¸åº”çš„åˆ é™¤ã€‚

åœ¨translations.htmlæ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬åœ¨è¡¨å•é›†ä¸­æ¸²æŸ“æ¯ä¸ªè¡¨å•ï¼Œç„¶åæ·»åŠ ä¸€ä¸ªé¢å¤–çš„éšè—ç©ºè¡¨å•ï¼Œå®ƒç”±JavaScriptç”¨æ¥åœ¨è¡¨å•é›†ä¸­ç”ŸæˆåŠ¨æ€æ·»åŠ çš„æ–°è¡¨å•ã€‚

è¡¨å•é›†ä¸­çš„æ¯ä¸ªè¡¨å•å¯¹æ¯ä¸ªå­—æ®µæœ‰å‰ç¼€ã€‚å¦‚ï¼Œè¡¨å•é›†çš„ç¬¬ä¸€ä¸ªè¡¨å•çš„titleå­—æ®µä¼šæœ‰ä¸€ä¸ªHTMLå­—æ®µåtranslations-0-titleï¼ŒåŒä¸€è¡¨å•é›†ä¸­çš„DELETEå­—æ®µæ‹¥æœ‰HTMLå­—æ®µåtranslations-0- DELETEã€‚ç©ºè¡¨å•ä½¿ç”¨çš„æ˜¯__prefix__æ¥ä»£æ›¿ç´¢å¼•å·ï¼Œå¦‚translations-__prefix__-titleã€‚è¿™åœ¨Djangoå±‚è¿›è¡Œçš„æŠ½è±¡ï¼Œä½†åœ¨é€šè¿‡JavaScriptæ“ä½œè¡¨å•é›†ä¸­è¡¨å•æ—¶éœ€è¦çŸ¥æ™“ã€‚

inlines.js JavaScriptè„šæœ¬æ‰§è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š

-   å¯¹è¡¨å•é›†ä¸­çš„å·²æœ‰è¡¨å•ï¼Œå®ƒåˆå§‹åŒ–JavaScripté©±åŠ¨çš„ç»„ä»¶ï¼ˆå¯ä»¥ä½¿ç”¨æç¤ºæ¶ˆæ¯ã€æ—¥æœŸæˆ–é¢œè‰²æ‹¾å–å™¨ã€åœ°å›¾ç­‰ï¼‰å¹¶åˆ›å»ºä¸€ä¸ªåˆ é™¤æŒ‰é’®ï¼Œç”¨äºä»£æ›¿DELETEå¤é€‰æ¡†è¿›è¡Œæ˜¾ç¤ºã€‚
-   åœ¨ç‚¹å‡»åˆ é™¤æŒ‰é’®æ—¶ï¼Œå®ƒä¼šå‹¾é€‰DELETEå¤é€‰æ¡†å¹¶å¯¹ç”¨æˆ·éšè—è¡¨å•ã€‚
-   åœ¨ç‚¹å‡»æ·»åŠ æŒ‰é’®æ—¶ï¼Œå®ƒä¼šå¤åˆ¶ä¸€ä¸ªç©ºè¡¨å•å¹¶å°†__prefix__æ›¿æ¢ä¸ºä¸‹ä¸€ä¸ªå¯ç”¨ç´¢å¼•ã€å‘åˆ—è¡¨æ·»åŠ æ–°è¡¨å•å¹¶åˆå§‹åŒ–JavaScripté©±åŠ¨çš„ç»„ä»¶ã€‚

### æ‰©å±•çŸ¥è¯†...

JavaScriptä½¿ç”¨æ•°ç»„window.WIDGET_INIT_REGISTERï¼Œå®ƒåŒ…å«åº”ç”±ç»™å®šè¡¨å•åˆå§‹åŒ–ç»„ä»¶æ—¶è°ƒç”¨çš„å‡½æ•°ã€‚è¦åœ¨å¦ä¸€ä¸ªJavaScriptæ–‡ä»¶ä¸­æ³¨å†Œæ–°å‡½æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š

```
/* site/js/main.js */
function apply_tooltips($formset_form) {
    $formset_form.find('[data-toggle="tooltip"]').tooltip(); 
}

/* register widget initialization for a formset form */ 
window.WIDGET_INIT_REGISTER = window.WIDGET_INIT_REGISTER || []; 
window.WIDGET_INIT_REGISTER.push(apply_tooltips);
```

è¿™ä¼šå¯¹æ‰€æœ‰åŒ…å«data-toggle="tooltip"å’Œtitleå±æ€§çš„è¡¨å•åº”ç”¨æç¤ºæ¶ˆæ¯åŠŸèƒ½ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š

```
<button data-toggle="tooltip" title="{% trans 'Remove this translation' %}">{% trans "Remove" %}</button>
```

### ç›¸å…³å†…å®¹

-   *é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*ç¼–æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚

## è¿‡æ»¤å¯¹è±¡åˆ—è¡¨

åœ¨ç½‘é¡µå¼€å‘ä¸­ï¼Œé™¤å¸¦è¡¨å•çš„è§†å›¾å¤–ï¼Œå¯¹è±¡åˆ—è¡¨è§†å›¾å’Œè¯¦æƒ…è§†å›¾ä¹Ÿå¾ˆå¸¸è§ã€‚åˆ—è¡¨è§†å›¾å¯ä»¥ç®€å•åˆ—ä¸¾å·²æ’åºçš„å¯¹è±¡ï¼Œå¦‚ï¼ŒæŒ‰å­—æ¯æ’åºæˆ–åˆ›å»ºæ—¥æœŸæ’åºï¼›ä½†åºå¤§çš„æ•°æ®é‡å¯¹ç”¨æˆ·ä¸å‹å¥½ã€‚ä¸ºå®ç°æœ€å¥½çš„å¯ç”¨æ€§å’Œä¾¿æ·æ€§ï¼Œåº”å½“èƒ½å¤Ÿé€šè¿‡æ‰€æœ‰å¯ç”¨åˆ†ç±»å¯¹å†…å®¹è¿›è¡Œè¿‡æ»¤ã€‚æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ç”¨äºå¯¹è¿‡åˆ†ç±»å·è¿‡æ»¤åˆ—è¡¨è§†å›¾çš„æ¨¡å¼ã€‚

æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªideasçš„åˆ—è¡¨è§†å›¾ï¼Œå¯é€šè¿‡ä½œè€…ã€åˆ†ç±»æˆ–è¯„åˆ†è¿›è¡Œè¿‡æ»¤ã€‚åº”ç”¨äº†Bootstrap 4ä¹‹åæ•ˆæœç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

![Django 3è¿‡æ»¤åˆ—è¡¨](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7d6ef273bad4933bc743c746b42595a~tplv-k3u1fbpfcp-watermark.image?)
### å‡†å¤‡å·¥ä½œ

è¿™ä¸ªè¿‡æ»¤ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Ideaæ¨¡å‹å…³è”ä½œè€…å’Œåˆ†ç±»è¿›è¡Œè¿‡æ»¤ã€‚ä¹Ÿå¯ä»¥é€šè¿‡è¯„åˆ†è¿›è¡Œè¿‡æ»¤ï¼Œå³å¸¦é€‰é¡¹çš„PositiveIntegerFieldã€‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å‰é¢å°èŠ‚ä¸­æ‰€åˆ›å»ºçš„ideasåº”ç”¨ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤å®Œæˆæœ¬å°èŠ‚çš„å­¦ä¹ ï¼š

1.  åˆ›å»ºIdeaFilterFormè¿›è¡Œå¯ç”¨åˆ†ç±»çš„è¿‡æ»¤ï¼š


    ```
    # myproject/apps/ideas/forms.py
    from django import forms
    from django.utils.translation import ugettext_lazy as _ 
    from django.db import models
    from django.contrib.auth import get_user_model
    
    from myproject.apps.categories.models import Category 
    
    from .models import RATING_CHOICES
    
    User = get_user_model()


    class IdeaFilterForm(forms.Form): 
        author = forms.ModelChoiceField(
            label=_("Author"), 
            required=False, 
            queryset=User.objects.annotate(
                idea_count=models.Count("authored_ideas") 
            ).filter(idea_count__gt=0),
        )
        category = forms.ModelChoiceField(
            label=_("Category"), 
            required=False, 
            queryset=Category.objects.annotate(
                idea_count=models.Count("category_ideas") 
            ).filter(idea_count__gt=0),
        )
        rating = forms.ChoiceField(
            label=_("Rating"), required=False, choices=RATING_CHOICES 
        )
    ```

1.  åˆ›å»ºidea_listè§†å›¾æ¥åˆ—ä¸¾è¿‡æ»¤åçš„ideasï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.shortcuts import render, redirect, get_object_or_404 
    from django.conf import settings
    
    from .forms import IdeaFilterForm
    from .models import Idea, RATING_CHOICES
    
    PAGE_SIZE = getattr(settings, "PAGE_SIZE", 24)
    
    def idea_list(request):
        qs = Idea.objects.order_by("title") 
        form = IdeaFilterForm(data=request.GET)
    
        facets = { 
            "selected": {},
            "categories": {
                "authors": form.fields["author"].queryset, 
                "categories": form.fields["category"].queryset, 
                "ratings": RATING_CHOICES,
            }, 
        }
    
        if form.is_valid(): 
            filters = (
                # query parameter, filter parameter
                ("author", "author"),
                ("category", "categories"),
                ("rating", "rating"),
            )
            qs = filter_facets(facets, qs, form, filters)
    
        context = {"form": form, "facets": facets, "object_list": qs} 
        return render(request, "ideas/idea_list.html", context)
    ```

1.  åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­æ·»åŠ å¸®åŠ©å‡½æ•°filter_facets()ï¼š


    ```
    def filter_facets(facets, qs, form, filters):
        for query_param, filter_param in filters:
            value = form.cleaned_data[query_param] 
            if value:
                selected_value = value
                if query_param == "rating":
                    rating = int(value) 
                    selected_value = (rating, dict(RATING_CHOICES)[rating]) 
                facets["selected"][query_param] = selected_value 
                filter_args = {filter_param: value}
                qs = qs.filter(**filter_args).distinct()
        return qs
    ```

1.  å¦‚æœªåˆ›å»ºï¼Œè¯·åˆ›å»ºbase.htmlæ¨¡æ¿ã€‚å¯ä»¥å‚ç…§[**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*ç¼–æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚çš„ç¤ºä¾‹ã€‚

1.  åˆ›å»ºidea_list.html æ¨¡å‹å¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    {# ideas/idea_list.html #}
    {% extends "base.html" %} 
    {% load i18n utility_tags %}
    
    {% block sidebar %}
      {% include "ideas/includes/filters.html" %}
    {% endblock %}
    
    {% block main %}
      <h1>{% trans "Ideas" %}</h1>
      {% if object_list %}
        {% for idea in object_list %}
          <a href="{{ idea.get_url_path }}" class="d-block my-3">
            <div class="card">
              <img src="{{ idea.picture_thumbnail.url }}" alt="" />
              <div class="card-body">
                <p class="card-text">{{ idea.translated_title }}</p>
              </div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <p>{% trans "There are no ideas yet." %}</p>
      {% endif %}
      <a href="{% url 'ideas:add_idea' %}" class="btn btn-primary">{% trans "Add idea" %}</a>
    {% endblock %}
    ```

1.  ç„¶åå¯¹è¿‡æ»¤å™¨åˆ›å»ºæ¨¡æ¿ã€‚è¿™ä¸ªæ¨¡æ¿ä½¿ç”¨ {% modify_query %}æ¨¡æ¿æ ‡ç­¾æ¥ç”Ÿæˆè¿‡æ»¤å™¨çš„URLï¼Œå‚è§[**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­çš„*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚ï¼š


    ```
    {# ideas/includes/filters.html #}
    {% load i18n utility_tags %}
    <div class="filters panel-group" id="accordion">
      {% with title=_('Author') selected=facets.selected.author %} 
        <div class="panel panel-default my-3">
          {% include "misc/includes/filter_heading.html" with title=title %}
          <div id="collapse-{{ title|slugify }}" 
            class="panel-collapse{% if not selected %}
            collapse{% endif %}">
            <div class="panel-body"><div class="list-group">
              {% include "misc/includes/filter_all.html" with param="author" %}
              {% for cat in facets.categories.authors %} 
                <a class="list-group-item
                  {% if selected == cat %} 
                  active{% endif %}"
                  href="{% modify_query "page" 
                  author=cat.pk %}">
                  {{ cat }}</a>
              {% endfor %}
            </div></div>
          </div>
        </div>
    {% endwith %}
    {% with title=_('Category') selected=facets.selected.category %}
      <div class="panel panel-default my-3">
        {% include "misc/includes/filter_heading.html" with title=title %}
        <div id="collapse-{{ title|slugify }}" 
          class="panel-collapse{% if not selected %}
          collapse{% endif %}">
          <div class="panel-body"><div class="list-group">
            {% include "misc/includes/filter_all.html" with param="category" %}
            {% for cat in facets.categories.categories %} 
              <a class="list-group-item
                {% if selected == cat %} active{% endif %}"
                href="{% modify_query "page" category=cat.pk %}">
                {{ cat }}</a>
            {% endfor %}
          </div></div>
        </div>
      </div>
    {% endwith %}
    {% with title=_('Rating') selected=facets.selected.rating %}
      <div class="panel panel-default my-3">
        {% include "misc/includes/filter_heading.html" with title=title %}
        <div id="collapse-{{ title|slugify }}" 
          class="panel-collapse{% if not selected %}
          collapse{% endif %}">
          <div class="panel-body"><div class="list-group">
            {% include "misc/includes/filter_all.html" with param="rating" %}
            {% for r_val, r_display in facets.categories.ratings %}
              <a class="list-group-item
              {% if selected.0 == r_val %} active{% endif %}"
                href="{% modify_query "page" rating=r_val %}">
                {{ r_display }}</a>
            {% endfor %}
            </div></div>
          </div>
        </div>
      {% endwith %}
    </div>
    ```

1.  æ¯ä¸ªåˆ†ç±»åœ¨è¾¹æ ä¸­éµå¾ªé€šç”¨çš„æ¨¡å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¹¶åŒ…å«å¸¦æœ‰é€šç”¨éƒ¨åˆ†çš„æ¨¡æ¿ã€‚é¦–å…ˆæœ‰è¿‡æ»¤å¤´éƒ¨ï¼Œå¯¹åº”æ–‡ä»¶ä¸º misc/includes/filter_heading.htmlï¼Œå¦‚ä¸‹ï¼š


    ```
    {# misc/includes/filter_heading.html #}
    {% load i18n %}
    <div class="panel-heading">
      <h6 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion"
          href="#collapse-{{ title|slugify }}"> 
          {% blocktrans trimmed %}
            Filter by {{ title }}
          {% endblocktrans %}
        </a> 
      </h6>
    </div>
    ```

1.  ç„¶åæ¯ä¸ªè¿‡æ»¤å™¨ä¼šåŒ…å«é‡ç½®è¯¥åˆ†ç±»è¿‡æ»¤å™¨çš„é“¾æ¥ï¼Œè¿™é‡Œä½äºmisc/includes/filter_all.htmlã€‚è¿™ä¸ªæ¨¡æ¿è¿˜ä½¿ç”¨{% modify_query %}æ¨¡æ¿æ ‡ç­¾ï¼Œå‚è§[**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­çš„*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚ï¼š


    ```
    {# misc/includes/filter_all.html #}
    {% load i18n utility_tags %}
    <a class="list-group-item {% if not selected %}active{% endif %}"
      href="{% modify_query "page" param %}"> 
      {% trans "All" %}
    </a>
    ```

1.  è¿™ä¸ªideaåˆ—è¡¨éœ€è¦æ·»åŠ åˆ°ideasåº”ç”¨çš„URLä¸­ï¼š


    ```
    # myproject/apps/ideas/urls.py
    from django.urls import path
    
    from .views import idea_list
    
    urlpatterns = [
      path("", idea_list, name="idea_list"), 
      # other paths...
    ]
    ```

### å®ç°åŸç†...

æˆ‘ä»¬ä½¿ç”¨facetså­—å…¸ï¼Œä¼ é€’ç»™æ¨¡æ¿ä¸Šæ–‡æ¥çŸ¥é“æœ‰å“ªäº›è¿‡æ»¤å™¨ä»¥åŠé€‰ä¸­äº†å“ªäº›è¿‡æ»¤å™¨ã€‚å†æ·±å…¥ä¸€ç‚¹ï¼Œfacetså­—å…¸åŒ…å«ä¸¤å—ï¼šcategorieså­—å…¸å’Œselectedå­—å…¸ã€‚categorieså­—å…¸åŒ…å«æŸ¥è¯¢é›†æˆ–æ‰€æœ‰åˆ†ç±»çš„é€‰é¡¹ã€‚selectedå­—å…¸åŒ…å«å½“å‰æ¯ä¸ªåˆ†ç±»çš„é€‰ä¸­å€¼ã€‚åœ¨IdeaFilterFormä¸­ï¼Œæˆ‘ä»¬ç¡®ä¿åªæœ‰è‡³å°‘åŒ…å«ä¸€ä¸ªideaçš„åˆ†ç±»å’Œä½œè€…è¢«åˆ—ä¸¾å‡ºæ¥ã€‚

åœ¨è§†å›¾ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥è¡¨å•ä¸­çš„æŸ¥è¯¢å‚æ•°æ˜¯å¦æœ‰æ•ˆï¼Œç„¶åæ ¹æ®æ‰€é€‰ä¸­åˆ†ç±»è¿‡æ»¤å¯¹è±¡çš„æŸ¥è¯¢é›†ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸ºfacetså­—å…¸è®¾ç½®æ‰€é€‰ä¸­çš„å€¼ï¼Œè¿™ä¸ªå­—å…¸ä¼šä¼ é€’ç»™æ¨¡æ¿ã€‚

åœ¨æ¨¡æ¿ä¸­ï¼Œå¯¹facetså­—å…¸ä¸­çš„æ¯ä¸ªåˆ†ç±»ï¼Œæˆ‘ä»¬åˆ—ä¸¾å‡ºæ‰€æœ‰åˆ†ç±»å¹¶å½“å‰é€‰ä¸­çš„åˆ†ç±»ä¸ºæ´»è·ƒçŠ¶æ€ã€‚å¦‚æœæœªé€‰ä¸­æ‰€ç»™å®šåˆ†ç±»ï¼Œæˆ‘ä»¬é»˜è®¤æ ‡è®°Allä¸ºæ´»è·ƒå€¼ã€‚

### ç›¸å…³å†…å®¹

-   *ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚
-   *ç¼–å†™åŸºäºç±»çš„è§†å›¾*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­*å®‰æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚
-   [**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­çš„*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚

## ç®¡ç†åˆ†é¡µåˆ—è¡¨

å¦‚æœåŠ¨æ€åœ°ä¿®æ”¹äº†å¯¹è±¡åˆ—è¡¨æˆ–å…¶æ€»æ•°è¶…è¿‡24ç­‰æ•°ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šéœ€è¦é€šè¿‡åˆ†é¡µæ¥æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚åˆ†é¡µä¸æ˜¯æŸ¥è¯¢å…¨éƒ¨é›†åˆï¼Œè€Œæ˜¯åœ¨æ•°æ®é›†ä¸­å–å‡ºå¯¹åº”ä¸€é¡µæ•°é‡çš„æŒ‡å®šä¸ªæ•°æ®é¡¹ã€‚æˆ‘ä»¬è¿˜æä¾›é“¾æ¥æ¥è®©ç”¨æˆ·è®¿é—®ç»„æˆå®Œæ•´æ•°æ®çš„å…¶å®ƒé¡µé¢ã€‚Djangoæœ‰ä¸€ä¸ªç®¡ç†åˆ†é¡µæ•°æ®çš„ç±»ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬å°±æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨*è¿‡æ»¤å¯¹è±¡åˆ—è¡¨ä¸€èŠ‚*ä¸­ideasåº”ç”¨çš„æ¨¡å‹ã€è¡¨å•å’Œè§†å›¾ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å‘ideasçš„åˆ—è¡¨è§†å›¾æ·»åŠ åˆ†é¡µåŠŸèƒ½ï¼š

1.  åœ¨views.pyæ–‡ä»¶ä¸­å¯¼å…¥Djangoåˆ†é¡µç±»ã€‚æˆ‘ä»¬å°†åœ¨è¿‡æ»¤ä»£ç åå¯¹idea_listè§†å›¾æ·»åŠ åˆ†é¡µç®¡ç†ã€‚åŒæ—¶ï¼Œè¿˜ä¼šé€šè¿‡å‘object_listé”®åˆ†é…pageæ¥å¾®è°ƒä¸Šä¸‹æ–‡å­—å…¸ï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.shortcuts import render, redirect, get_object_or_404 
    from django.conf import settings
    from django.core.paginator import (EmptyPage, PageNotAnInteger, Paginator)
    
    from .forms import IdeaFilterForm
    
    from .models import Idea, RATING_CHOICES
    
    PAGE_SIZE = getattr(settings, "PAGE_SIZE", 24)
    
    def idea_list(request):
    
      qs = Idea.objects.order_by("title") 
      form = IdeaFilterForm(data=request.GET)
      facets = { 
        "selected": {},
        "categories": {
          "authors": form.fields["author"].queryset, 
          "categories": form.fields["category"].queryset, 
          "ratings": RATING_CHOICES,
        }, 
      }
    
      if form.is_valid(): 
        filters = (
          # query parameter, filter parameter
          ("author", "author"),
          ("category", "categories"),
          ("rating", "rating"),
        )
        qs = filter_facets(facets, qs, form, filters)
    
      paginator = Paginator(qs, PAGE_SIZE) 
      page_number = request.GET.get("page") 
      try:
        page = paginator.page(page_number) 
      except PageNotAnInteger:
        # If page is not an integer, show first page.
        page = paginator.page(1) 
      except EmptyPage:
        # If page is out of range, show last existing page. 
        page = paginator.page(paginator.num_pages)
    
      context = { 
        "form": form,
        "facets": facets,
        "object_list": page, 
      }
      return render(request, "ideas/idea_list.html", context)
    ```

1.  ä¿®æ”¹idea_list.htmlæ¨¡æ¿å¦‚ä¸‹ï¼š


    ```
    {# ideas/idea_list.html #}
    {% extends "base.html" %} 
    {% load i18n utility_tags %}
    
    {% block sidebar %}
      {% include "ideas/includes/filters.html" %}
    {% endblock %}
    
    {% block main %}
      <h1>{% trans "Ideas" %}</h1>
      {% if object_list %}
        {% for idea in object_list %}
          <a href="{{ idea.get_url_path }}" class="d-block my-3"> 
            <div class="card">
              <img src="{{ idea.picture_thumbnail.url }}" alt="" />
              <div class="card-body">
                <p class="card-text">{{ idea.translated_title }}</p>
              </div>
            </div> 
          </a>
        {% endfor %}
        {% include "misc/includes/pagination.html" %}
      {% else %}
        <p>{% trans "There are no ideas yet." %}</p>
      {% endif %}
      <a href="{% url 'ideas:add_idea' %}" class="btn btn-primary">{% trans "Add idea" %}</a>
    {% endblock %}
    ```

1.  åˆ›å»ºåˆ†ç±»ç»„ä»¶æ¨¡æ¿ï¼š


    ```
    {# misc/includes/pagination.html #}
    {% load i18n utility_tags %}
    {% if object_list.has_other_pages %}
      <nav aria-label="{% trans 'Page navigation' %}">
    
        <ul class="pagination">
          {% if object_list.has_previous %}
            <li class="page-item"><a class="page-link" href="{% modify_query page=object_list.previous_page_number %}">{% trans "Previous" %}</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page- link">{% trans "Previous" %}</span></li>
          {% endif %}
    
          {% for page_number in object_list.paginator .page_range %}
            {% if page_number == object_list.number %} 
              <li class="page-item active">
                <span class="page-link">{{ page_number }} 
                  <span class="sr-only">{% trans "(current)" %}</span>
                </span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="{% modify_query page=page_number %}">{{ page_number }}</a>
              </li>
            {% endif %}
          {% endfor %}
    
          {% if object_list.has_next %}
            <li class="page-item"><a class="page-link" href="{% modify_query page=object_list.next_page_number %}"> {% trans "Next" %}</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
          {% endif %}
        </ul> 
      </nav>
    {% endif %}
    ```

### å®ç°åŸç†...

åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ç»“æœæ—¶ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„åˆ†é¡µæ§åˆ¶å™¨ï¼š

![Django 3 åˆ†é¡µæ§åˆ¶å™¨](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db05bb6a5a79472eab080cec56c277a2~tplv-k3u1fbpfcp-zoom-1.image)

è¿™æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿåœ¨è¿‡æ»¤å¥½æŸ¥è¯¢é›†åˆåï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªpaginatorå¯¹è±¡ï¼Œä¼ é€’æŸ¥è¯¢é›†åˆåŠæ¯é¡µå¸Œæœ›æ˜¾ç¤ºçš„æœ€å¤§æ¡æ•°ï¼Œæœ¬ä¾‹ä¸­ä¸º24ã€‚ç„¶åï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æŸ¥è¯¢å‚æ•°pageè¯»å–å½“å‰é¡µæ•°ã€‚ä¸‹ä¸€æ­¥æ˜¯é€šè¿‡paginatorè·å–å½“å‰é¡µå¯¹è±¡ã€‚å¦‚æœé¡µæ•°ä¸æ˜¯æ•´å‹ï¼Œåˆ™è·å–ç¬¬ä¸€é¡µã€‚å¦‚æœé¡µæ•°è¶…å‡ºå¯æ˜¾ç¤ºé¡µé¢æ•°ï¼Œè·å–æœ€åä¸€é¡µã€‚pageå¯¹è±¡ä¸­æœ‰ä¸Šå›¾æ‰€ç¤ºåˆ†é¡µç»„ä»¶æ‰€éœ€çš„æ–¹æ³•å’Œå±æ€§ã€‚åŒæ—¶ï¼Œpageç±»ä¼¼æŸ¥è¯¢é›†åˆï¼Œå¯ä»¥è¿›è¡Œéå†å¹¶å–å‡ºé¡µé¢ä¸­çš„éƒ¨åˆ†é¡¹ã€‚

æ¨¡æ¿ä¸­æ‰€ç¤ºçš„ä»£ç ç‰‡æ–­ç”¨Bootstrap 4å‰ç«¯æ¡†æ¶åˆ›å»ºä¸€ä¸ªåˆ†é¡µç»„ä»¶ã€‚ä»…åœ¨é¡µé¢å¤šäºå½“å‰é¡µæ—¶æ‰ä¼šæ˜¾ç¤ºåˆ†é¡µæ§ä»¶ã€‚é‡Œé¢æœ‰ä¸Šä¸€é¡µã€ä¸‹ä¸€é¡µï¼Œä»¥åŠç»„ä»¶ä¸­æ‰€æœ‰é¡µç çš„åˆ—è¡¨ã€‚å½“å‰é¡µç è¿›è¡Œäº†é«˜äº®æ˜¾ç¤ºã€‚æˆ‘ä»¬ä½¿ç”¨{% modify_query %}æ¥å°†é“¾æ¥ç”ŸæˆURLï¼Œè¿™éƒ¨åˆ†åœ¨ç¨åçš„[**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­çš„*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚ä¸­ä¼šè¿›è¡Œè¯¦ç»†è®²è§£ã€‚

### ç›¸å…³å†…å®¹

-   *è¿‡æ»¤å¯¹è±¡åˆ—è¡¨*ä¸€èŠ‚
-   *ç¼–å†™åŸºäºç±»çš„è§†å›¾*ä¸€èŠ‚
-   [**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­çš„*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚

## ç¼–å†™åŸºäºç±»çš„è§†å›¾

Djangoè§†å›¾æ˜¯å¯æ¥æ”¶è¯·æ±‚å¹¶è¿”å›å“åº”çš„å¯è°ƒç”¨å‡½æ•°ã€‚é™¤äº†å‡½æ•°å½¢å¼çš„è§†å›¾å¤–ï¼ŒDjangoè¿˜æä¾›äº†ä¸€ç§é€šè¿‡ç±»å®šä¹‰è§†å›¾çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼åœ¨æƒ³è¦åˆ›å»ºå¯å¤ç”¨çš„æ¨¡å—åŒ–è§†å›¾æˆ–åˆå¹¶é€šç”¨mixinçš„è§†å›¾æ—¶éå¸¸æœ‰ç”¨ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†å‰é¢çš„å‡½æ•°è§†å›¾idea_liståŒ–ä¸ºç±»è§†å›¾IdeaListViewã€‚

### å‡†å¤‡å·¥ä½œ

åˆ›å»ºç±»ä¼¼å‰é¢*è¿‡æ»¤å¯¹è±¡åˆ—è¡¨*å’Œ*ç®¡ç†åˆ†é¡µåˆ—è¡¨*å°èŠ‚ä¸­çš„æ¨¡å‹ã€è¡¨å•å’Œæ¨¡æ¿ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å®Œæˆæœ¬å°èŠ‚çš„å†…å®¹:

1.  æˆ‘ä»¬çš„ç±»è§†å›¾IdeaListViewç»§æ‰¿Djangoçš„Viewç±»å¹¶é‡è½½get()æ–¹æ³•ï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.shortcuts import render, redirect, get_object_or_404 
    from django.conf import settings
    from django.core.paginator import (EmptyPage, PageNotAnInteger, Paginator)
    from django.views.generic import View
    
    from .forms import IdeaFilterForm
    from .models import Idea, RATING_CHOICES
    
    PAGE_SIZE = getattr(settings, "PAGE_SIZE", 24)


    class IdeaListView(View):
      form_class = IdeaFilterForm 
      template_name = "ideas/idea_list.html"
      
      def get(self, request, *args, **kwargs):
        form = self.form_class(data=request.GET)
        qs, facets = self.get_queryset_and_facets(form) 
        page = self.get_page(request, qs)
        context = {"form": form, "facets": facets, "object_list": page}
        return render(request, self.template_name, context)
      
      def get_queryset_and_facets(self, form): 
        qs = Idea.objects.order_by("title") 
        facets = {
          "selected": {},
          "categories": {
            "authors": form.fields["author"].queryset, 
            "categories": form.fields["category"].queryset, 
            "ratings": RATING_CHOICES,
          }, 
        }
      
        if form.is_valid(): 
          filters = (
            # query parameter, filter parameter
            ("author", "author"),
            ("category", "categories"),
            ("rating", "rating"),
          )
          qs = self.filter_facets(facets, qs, form, filters) 
        return qs, facets
      
      @staticmethod
      def filter_facets(facets, qs, form, filters):
        for query_param, filter_param in filters: 
          value = form.cleaned_data[query_param] 
          if value:
            selected_value = value
            if query_param == "rating":
              rating = int(value) 
              selected_value = (rating, dict(RATING_CHOICES)[rating]) 
              facets["selected"][query_param] = selected_value 
              filter_args = {filter_param: value}
              qs = qs.filter(**filter_args).distinct()
          return qs
    
      def get_page(self, request, qs):
        paginator = Paginator(qs, PAGE_SIZE) 
        page_number = request.GET.get("page") 
        try:
          page = paginator.page(page_number) 
        except PageNotAnInteger:
          page = paginator.page(1) 
        except EmptyPage:
          page = paginator.page(paginator.num_pages) 
        return page
    ```

1.  æˆ‘ä»¬éœ€è¦åœ¨URLé…ç½®ä¸­ä½¿ç”¨è§†å›¾ç±»åˆ›å»ºURLè§„åˆ™ã€‚ä½ å¯èƒ½å·²ç»ä½¿ç”¨è§†å›¾å‡½æ•°idea_listæ·»åŠ è¿‡è§„åˆ™ï¼Œæ–¹æ³•ç›¸ä¼¼ã€‚åœ¨URLè§„åˆ™ä¸­åŒ…å«è§†å›¾ç±»ï¼Œéœ€è¦ä½¿ç”¨as_view()æ–¹æ³•å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/urls.py
    from django.urls import path
    
    from .views import IdeaListView
    
    urlpatterns = [
      path("", IdeaListView.as_view(), name="idea_list"),
      # other paths... 
    ]
    ```

### å®ç°åŸç†...

ç”±HTTP GETè¯·æ±‚æ‰€è°ƒç”¨çš„get()æ–¹æ³•ä¸­æ‰€æ‰§è¡Œçš„æ“ä½œå¦‚ä¸‹ï¼š

-   é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºäº†formå¯¹è±¡ï¼Œå¯¹å…¶ä¼ é€’ç±»ä¼¼å­—å…¸çš„request.GETå¯¹è±¡ã€‚request.GETå¯¹è±¡åŒ…å«æ‰€æœ‰ä½¿ç”¨GETæ–¹æ³•ä¼ é€’çš„æŸ¥è¯¢å˜é‡ã€‚
-   ç„¶åï¼Œformè¢«ä¼ é€’ç»™get_queryset_and_facets()æ–¹æ³•ï¼Œå®ƒé€šè¿‡åŒ…å«ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„è¿”å›å…³è”å€¼ï¼Œè¿™ä¸¤ä¸ªå…ƒç´ åˆ†åˆ«ä¸ºQuerySetå’Œfacetsã€‚
-   å½“å‰çš„è¯·æ±‚å¯¹è±¡åŠæ‰€è·å–çš„æŸ¥è¯¢é›†åˆè¢«ä¼ é€’ç»™get_page()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›é¡µé¢å¯¹è±¡ã€‚
-   æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡å­—å…¸å¹¶æ¸²æŸ“è¯·æ±‚çš„å“åº”ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥æä¾›ç”±HTTP POSTè¯·æ±‚æ‰€è°ƒç”¨çš„ post()æ–¹æ³•æ¥è¿›è¡Œç›¸åº”çš„æ”¯æŒã€‚

### æ‰©å±•çŸ¥è¯†...

å¯ä»¥çœ‹åˆ°ï¼Œget() å’Œget_page()æ–¹æ³•å¾ˆé€šç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨coreåº”ç”¨ä¸­åˆ›å»ºå¸¦æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•çš„FilterableListViewé€šç”¨ç±»ã€‚ç„¶åï¼Œåœ¨éœ€è¦ä½¿ç”¨å¯è¿‡æ»¤åˆ—è¡¨çš„åº”ç”¨ä¸­ï¼Œå¯ä»¥åˆ›å»ºç»§æ‰¿FilterableListViewçš„è§†å›¾ç±»å¤„ç†è¿™ç§åœºæ™¯ã€‚è¿™ä¸€ç»§æ‰¿ç±»åªéœ€è¦å®šä¹‰form_classå’Œtemplate_nameå±æ€§ä»¥åŠget_queryset_and_facets()æ–¹æ³•ã€‚è¿™ç§æ¨¡æ¿åŒ–å’Œæ‰©å±•æ€§ä»£è¡¨äº†è§†å›¾ç±»çš„ä¸»è¦å¥½å¤„ã€‚
### ç›¸å…³å†…å®¹

-   *è¿‡æ»¤å¯¹è±¡åˆ—è¡¨*ä¸€èŠ‚
-   *ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚

## æ·»åŠ Open Graphå’ŒTwitter Cardæ•°æ®

å¦‚æœå¸Œæœ›åœ¨ç¤¾äº¤ç½‘ç«™ä¸Šåˆ†äº«ç½‘ç«™çš„å†…å®¹ï¼Œåˆ™è‡³å°‘åº”å®ç°Open Graphå’ŒTwitter Cardæ ‡ç­¾ã€‚è¿™äº›å…ƒæ ‡ç­¾å®šä¹‰äº†ç½‘é¡µå¦‚ä½•åœ¨Facebookæˆ–Twitterä¿¡æ¯æµä¸­æ˜¾ç¤ºï¼šå±•ç¤ºä»€ä¹ˆæ ‡é¢˜å’Œæè¿°ï¼Œè®¾ç½®ä»€ä¹ˆå›¾ç‰‡ä»¥åŠå…³è”çš„URLã€‚æœ¬å°èŠ‚ä¸­æˆ‘ä»¬å°†ä¸ºç¤¾äº¤åˆ†äº«å‡†å¤‡idea_detail.htmlæ¨¡æ¿ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ç»§ç»­ä½¿ç”¨å‰é¢å°èŠ‚ä¸­çš„ideasåº”ç”¨ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å®Œæˆæœ¬å°èŠ‚çš„å­¦ä¹ ï¼š

1.  ç¡®ä¿Ideaæ¨¡æ¿åˆ›å»ºäº†å›¾ç‰‡å­—æ®µåŠå„ä¸ªå›¾ç‰‡ç‰ˆæœ¬è§„æ ¼ã€‚å‚è§*ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚å’Œ*ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚äº†è§£æ›´å¤šä¿¡æ¯ã€‚

1.  å‡†å¤‡å¥½ideasè¯¦æƒ…è§†å›¾ã€‚å‚è§*ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚äº†è§£å¦‚ä½•æ·»åŠ ã€‚

1.  å°†è¯¦æƒ…è§†å›¾æ’å…¥åˆ°URLé…ç½®ä¸­ã€‚ç›¸å…³é…ç½®å‚è§*ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚ã€‚

1.  åœ¨å…·ä½“ç¯å¢ƒçš„è®¾ç½®ä¸­ï¼Œå®šä¹‰WEBSITE_URLå’Œä½œä¸ºå®Œæ•´åª’ä½“æ–‡ä»¶URLçš„MEDIA_URLï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š


    ```
    # myproject/settings/dev.py
    from ._base import *
    
    DEBUG = True
    WEBSITE_URL = "http://127.0.0.1:8000" # without trailing slash 
    MEDIA_URL = f"{WEBSITE_URL}/media/"
    ```

1.  åœ¨coreåº”ç”¨ä¸­ï¼Œåˆ›å»ºè¿”å›è®¾ç½®ä¸­WEBSITE_URLå˜é‡çš„ä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼š


    ```
    # myproject/apps/core/context_processors.py
    from django.conf import settings
    
    def website_url(request):
      return {
        "WEBSITE_URL": settings.WEBSITE_URL,
      }
    ```

1.  åœ¨è®¾ç½®ä¸­æ’å…¥ä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼š


    ```
    # myproject/settings/_base.py
    TEMPLATES = [ 
      {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [os.path.join(BASE_DIR, "myproject", "templates")], 
        "APP_DIRS": True,
        "OPTIONS": {
          "context_processors": [ 
            "django.template.context_processors.debug", 
            "django.template.context_processors.request", 
            "django.contrib.auth.context_processors.auth", 
            "django.contrib.messages.context_processors.messages", 
            "django.template.context_processors.media", 
            "django.template.context_processors.static", 
            "myproject.apps.core.context_processors.website_url",
          ]
        } 
      }
    ]
    ```

1.  åˆ›å»ºæ¨¡æ¿æ–‡ä»¶idea_detail.htmlå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    {# ideas/idea_detail.html #}
    {% extends "base.html" %} 
    {% load i18n %}
    
    {% block meta_tags %}
      <meta property="og:type" content="website" />
      <meta property="og:url" content="{{ WEBSITE_URL }}{{ request.path }}" />
      <meta property="og:title" content="{{ idea.translated_title }}" />
      {% if idea.picture_social %}
        <meta property="og:image" content= "{{ idea.picture_social.url }}" />
        <!-- Next tags are optional but recommended --> 
        <meta property="og:image:width" content="{{ idea.picture_social.width }}" /> 
        <meta property="og:image:height" content="{{ idea.picture_social.height }}" /> 
      {% endif %}
      <meta property="og:description" content= "{{ idea.translated_content }}" />
      <meta property="og:site_name" content="MyProject" />
      <meta property="og:locale" content="{{ LANGUAGE_CODE }}" />
    
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:site" content="@DjangoTricks">
      <meta name="twitter:creator" content="@archatas">
      <meta name="twitter:url" content="{{ WEBSITE_URL }}{{ request.path }}">
      <meta name="twitter:title" content="{{ idea.translated_title }}">
      <meta name="twitter:description" content="{{ idea.translated_content }}"> 
      {% if idea.picture_social %}
        <meta name="twitter:image" content= "{{ idea.picture_social.url }}">
      {% endif %}
    {% endblock %}
    
    {% block content %}
      <a href="{% url "ideas:idea_list" %}">
        {% trans "List of ideas" %}</a>
      <h1>
        {% blocktrans trimmed with title=idea.translated_title %} 
          Idea "{{ title }}"
        {% endblocktrans %}
      </h1>
      <img src="{{ idea.picture_large.url }}" alt="" /> 
      {{ idea.translated_content|linebreaks|urlize }} 
      <p>
        {% for category in idea.categories.all %} 
          <span class="badge badge-pill badge-info">
            {{ category.translated_title }}
          </span> 
        {% endfor %}
      </p>
      <a href="{% url 'ideas:change_idea' pk=idea.pk %}"
        class="btn btn-primary">{% trans "Change this idea" %}</a> 
      <a href="{% url 'ideas:delete_idea' pk=idea.pk %}"
        class="btn btn-danger">{% trans "Delete this idea" %}</a> 
    {% endblock %}
    ```

### å®ç°åŸç†...

Open Graphæ ‡ç­¾æ˜¯ä»¥og:æ‰“å¤´ç‰¹æ®Šåç§°çš„å…ƒæ ‡ç­¾ï¼ŒTwitter cardæ ‡ç­¾æ˜¯ä»¥twitter:æ‰“å¤´ç‰¹æ®Šåç§°çš„å…ƒæ ‡ç­¾ã€‚è¿™äº›å…ƒæ ‡ç­¾å®šä¹‰äº†URLã€æ ‡ç­¾ã€æè¿°å’Œå½“å‰é¡µé¢çš„å›¾ç‰‡ã€ç«™ç‚¹åã€ä½œè€…å’Œåœ°ç†ä½ç½®ã€‚åœ¨è¿™é‡Œè¦æä¾›å®Œæ•´è·¯å¾„ï¼Œåªæä¾›åé¢çš„è·¯å¾„æ˜¯ä¸å¤Ÿçš„ã€‚

æˆ‘ä»¬ä½¿ç”¨picture_socialå›¾ç‰‡ç‰ˆæœ¬ï¼Œå®ƒæ˜¯é’ˆå¯¹ç¤¾äº¤ç½‘ç«™çš„ä¼˜åŒ–å°ºå¯¸ï¼š1024 Ã— 512 pxã€‚

å¯ä»¥é€šè¿‡https://developers.facebook.com/tools/debug/æ¥éªŒè¯Open Graphçš„å®ç°æƒ…å†µã€‚

é€šè¿‡https://cards-dev.twitter.com/validatorå¯ä»¥éªŒè¯Twitter Cardçš„å®ç°æƒ…å†µã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚
-   *ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚
-   *æ·»åŠ schema.orgç”¨è¯*ä¸€èŠ‚

## æ·»åŠ schema.orgç”¨è¯

æœç´¢å¼•æ“ä¼˜åŒ–SEOéœ€è¦éµå¾ªè¯­æ³•çš„æ ‡è®°ã€‚ä½†æ›´è¿›ä¸€æ­¥æå‡æœç´¢å¼•æ“æ’åï¼Œæ ¹æ®schema.orgçš„ç”¨è¯æä¾›ç»“æ„åŒ–æ•°æ®æ˜¯å¤§æœ‰è£¨ç›Šçš„ã€‚å¾ˆå¤šæ¥è‡ªè°·æ­Œã€å¾®è½¯ã€Pinterestå’ŒYandexç­‰çš„åº”ç”¨éƒ½ä½¿ç”¨schema.orgç»“æ„æ¥åˆ›é€ ä¸°å¯Œå¯æ‰©å±•çš„ä½“éªŒï¼Œå¦‚åœ¨æœç´¢ç»“æœåœ¨æ´»åŠ¨ã€ç”µè„‘ã€ä½œè€…ç­‰çš„ç‰¹æ®Šä¸€è‡´æ€§å¡ç‰‡å±•ç¤ºã€‚

æœ‰ä¸€äº›ç¼–ç ï¼ŒåŒ…æ‹¬RDFaã€Microdataå’ŒJSON-LDï¼Œå¯ç”¨äºåˆ›å»ºschema.orgç”¨è¯ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥JSON-LDæ ¼å¼æ¥ä¸ºIdeaæ¨¡æ¿å‡†å¤‡ç»“æ„åŒ–æ•°æ®ï¼Œè¿™ä¸€æ ¼å¼æ˜¯è°·æ­Œæ‰€æ¨èçš„ã€‚

### å‡†å¤‡å·¥ä½œ

åœ¨é¡¹ç›®çš„è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…django-json-ldåŒ…ï¼ˆå¹¶å°†å…¶æ·»åŠ åˆ°requirements/_base.txtä¸­ï¼‰ï¼š

```
(env)$ pip install django-json-ld==0.0.4
```

åœ¨è®¾ç½®ä¸­å°†django_json_ldæ·»åŠ åˆ°INSTALLED_APPSä¸­ï¼š

```
# myproject/settings/_base.py
INSTALLED_APPS = [ 
  # other apps...
  "django_json_ld",
]
```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å®Œæˆæœ¬å°èŠ‚çš„å­¦ä¹ ï¼š

1.  åœ¨Ideaæ¨¡å‹ä¸­ä½¿ç”¨å¦‚ä¸‹å†…å®¹æ·»åŠ structured_dataå±æ€§ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.models import ( 
      CreationModificationDateBase, UrlBase 
    )


    class Idea(CreationModificationDateBase, UrlBase):
      # attributes, fields, properties, and methods...
      @property
      def structured_data(self):
        from django.utils.translation import get_language
        
        lang_code = get_language()
        data = {
          "@type": "CreativeWork",
          "name": self.translated_title, 
          "description": self.translated_content, 
          "inLanguage": lang_code,
        }
        if self.author:
          data["author"] = {
            "@type": "Person",
            "name": self.author.get_full_name() or
            self.author.username, 
          }
        if self.picture:
          data["image"] = self.picture_social.url
        return data
    ```

1.  ä¿®æ”¹idea_detail.htmlæ¨¡æ¿ï¼š


    ```
    {# ideas/idea_detail.html #}
    {% extends "base.html" %} 
    {% load i18n json_ld %}
    
    {% block meta_tags %}
      {# Open Graph and Twitter Card meta tags here... #}
    
      {% render_json_ld idea.structured_data %}
    {% endblock %}
    
    {% block content %}
      <a href="{% url "ideas:idea_list" %}">
        {% trans "List of ideas" %}</a>
      <h1>
        {% blocktrans trimmed with title=idea.translated_title %} 
          Idea "{{ title }}"
        {% endblocktrans %}
      </h1>
      <img src="{{ idea.picture_large.url }}" alt="" /> 
      {{ idea.translated_content|linebreaks|urlize }} 
      <p>
        {% for category in idea.categories.all %}
          <span class="badge badge-pill badge-info"> {{ category.translated_title }}</span>
        {% endfor %}
      </p>
      <a href="{% url 'ideas:change_idea' pk=idea.pk %}" class="btn btn-primary">{% trans "Change this idea" %}</a>
      <a href="{% url 'ideas:delete_idea' pk=idea.pk %}" class="btn btn-danger">{% trans "Delete this idea" %}</a>
    {% endblock %}
    ```

### å®ç°åŸç†...

{% render_json_ld %}æ¨¡æ¿æ ‡ç­¾ä¼šåƒç±»ä¼¼ä¸‹é¢è¿™æ ·æ¸²æŸ“scriptæ ‡ç­¾ï¼š

```
<script type=application/ld+json>{"@type": "CreativeWork", "author": {"@type": "Person", "name": "alan"}, "description": "Wouldn't it make sense to gather people with opposing opinions and try to solve mutual problems together?", "image": "http://127.0.0.1:8000/media/CACHE/images/ideas/2020/05/0080c405-9dfe-4b03-9769-b5f49149f064/922cbc290ac1421d7bc950c912678453.jpg", "inLanguage": "en", "name": "A reality show about people from opposing standpoints trying to solve mutual problems"}</script>
```

structured_dataå±æ€§æ ¹æ®schema.orgç”¨è¯è¿”å›ä¸€ä¸ªåµŒå¥—å­—å…¸ï¼Œè¿™å¯ç”±å¤§éƒ¨åˆ†ä¸»æµæœç´¢å¼•æ“æ‰€ç†è§£ã€‚

å¯é€šè¿‡æŸ¥é˜…[å®˜æ–¹æ–‡æ¡£](https://schema.org/docs/schemas.html)æ¥å†³å®šå¯¹æ¨¡å‹åº”ç”¨å“ªäº›ç”¨è¯ã€‚

### ç›¸å…³å†…å®¹

-   [**ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„**](https://alanhou.org/models-database-structure/)ä¸­*åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾*ä¸€èŠ‚
-   *ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚
-   *ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚
-   *æ·»åŠ Open Graphå’ŒTwitter Cardæ•°æ®*ä¸€èŠ‚

## ç”ŸæˆPDFæ–‡æ¡£

Djangoè§†å›¾ä¸æ­¢æ˜¯èƒ½è®©æˆ‘ä»¬åˆ›å»ºHTMLé¡µé¢ã€‚è¿˜å¯ä»¥åˆ›å»ºä»»æ„ç±»å‹çš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œåœ¨[**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*åœ¨JavaScriptæš´éœ²è®¾ç½®*ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬è§†å›¾çš„è¾“å‡ºæ˜¯JavaScriptæ–‡ä»¶çš„å½¢å¼è€ŒéHTMLã€‚ä¹Ÿå¯ä»¥å¯¹å‘ç¥¨ã€ç¥¨åŠ¡ã€æ”¶æ®ã€é¢„è®¢ç¡®è®¤ç­‰åˆ›å»ºPDFæ–‡ä»¶ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä¸ºæ•°æ®åº“ä¸­çš„æ¯ä¸ªåˆ›å»ºç”Ÿæˆä¼ å•ã€‚è¿™é‡Œä½¿ç”¨WeasyPrintåº“æ¥ç”¨HTMLæ¨¡æ¿ç”ŸæˆPDFæ–‡æ¡£ã€‚

### å‡†å¤‡å·¥ä½œ

WeasyPrintä¾èµ–äºä¸€äº›åº“ï¼Œéœ€è¦åœ¨ç”µè„‘ä¸Šè¿›è¡Œå®‰è£…ã€‚macOSä¸­å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é€šè¿‡Homebrewæ¥å®‰è£…è¿™äº›åº“ï¼š

```
$ brew install python3 cairo pango gdk-pixbuf libffi
```

ç„¶åï¼Œå¯ä»¥åœ¨é¡¹ç›®çš„è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…WeasyPrintæœ¬å°Šã€‚åŒæ ·è¯·åœ¨requirements/_base.txtä¸­è¿›è¡Œæ·»åŠ ï¼š

```
(env)$ pip install WeasyPrint==48
```

å¯¹äºå…¶å®ƒæ“ä½œç³»ç»Ÿï¼Œè¯·å‚ç…§[å®‰è£…æ•™ç¨‹](https://weasyprint.readthedocs.io/en/latest/install.html)ã€‚

å¦å¤–æˆ‘ä»¬å°†ä½¿ç”¨django-qr-codeæ¥ç”Ÿæˆå¿«é€Ÿé“¾æ¥å›åˆ°ç½‘ç«™çš„äºŒç»´ç ã€‚åœ¨è™šæ‹Ÿç¯å¢ƒä¸­ä¹Ÿå¯¹å…¶è¿›è¡Œå®‰è£…ï¼ˆå¹¶åœ¨requirements/_base.txtä¸­æ·»åŠ ï¼‰ï¼š

```
(env)$ pip install django-qr-code==1.0.0
```

åœ¨è®¾ç½®çš„INSTALLED_APPSä¸­æ·»åŠ qr_codeï¼š

```
# myproject/settings/_base.py
INSTALLED_APPS = [ 
  # Django apps...
  "qr_code", 
]
```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å®Œæˆæœ¬èŠ‚çš„å­¦ä¹ ï¼š

1.  åˆ›å»ºç”¨äºç”ŸæˆPDFæ–‡æ¡£çš„è§†å›¾ï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.shortcuts import get_object_or_404 
    from .models import Idea
    
    def idea_handout_pdf(request, pk):
      from django.template.loader import render_to_string 
      from django.utils.timezone import now as timezone_now 
      from django.utils.text import slugify
      from django.http import HttpResponse
    
      from weasyprint import HTML
      from weasyprint.fonts import FontConfiguration
    
      idea = get_object_or_404(Idea, pk=pk) 
      context = {"idea": idea}
      html = render_to_string(
        "ideas/idea_handout_pdf.html", context 
      )
    
      response = HttpResponse(content_type="application/pdf") 
      response[
        "Content-Disposition"
      ] = "inline; filename={date}-{name}-handout.pdf".format(
        date=timezone_now().strftime("%Y-%m-%d"),
        name=slugify(idea.translated_title), 
      )
    
      font_config = FontConfiguration() 
      HTML(string=html).write_pdf(
        response, font_config=font_config 
      )
      
      return response
    ```

1.  å°†è¿™ä¸ªè§†å›¾æ’å…¥åˆ°URLé…ç½®ä¸­ï¼š


    ```
    # myproject/apps/ideas/urls.py
    from django.urls import path
    
    from .views import idea_handout_pdf 
    urlpatterns = [
      # URL configurations... 
      path("<uuid:pk>/handout/", idea_handout_pdf, name="idea_handout"),
    ]
    ```

1.  ä¸ºPDFæ–‡æ¡£åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š


    ```
    {# ideas/idea_handout_pdf.html #}
    {% extends "base_pdf.html" %} 
    {% load i18n qr_code %}
    
    {% block content %}
      <h1 class="h3">{% trans "Handout" %}</h1>
      <h2 class="h1">{{ idea.translated_title }}</h2> 
      <img src="{{ idea.picture_large.url }}" alt="" class="img-responsive w-100" />
      <div class="my-3">{{ idea.translated_content|linebreaks|urlize }}</div>
      <p>
        {% for category in idea.categories.all %} 
          <span class="badge badge-pill badge-info">
          {{ category.translated_title }}</span> 
        {% endfor %}
      </p>
      <h4>{% trans "See more information online:" %}</h4>
      {% qr_from_text idea.get_url size=20 border=0 as svg_code %} 
      <img alt="" src="data:image/svg+xml,
        {{ svg_code|urlencode }}" />
      <p class="mt-3 text-break">{{ idea.get_url }}</p>
    {% endblock %}
    ```

1.  å¦å¤–ï¼Œåˆ›å»ºbase_pdf.htmlæ¨¡æ¿ï¼š


    ```
    {# base_pdf.html #}
    <!doctype html>
    {% load i18n static %} 
    <html lang="en"> 
    <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
      <!-- Bootstrap CSS --> 
      <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <title>{% trans "Hello, World!" %}</title>
      
      <style>
      @page {
        size: "A4";
        margin: 2.5cm 1.5cm 3.5cm 1.5cm; 
      }
      footer {
        position: fixed; 
        bottom: -2.5cm; 
        width: 100%; 
        text-align: center; 
        font-size: 10pt;
      }
      footer img {
        height: 1.5cm; 
      }
      </style>
    
      {% block meta_tags %}{% endblock %}
    </head>
    <body>
      <main class="container">
        {% block content %}
        {% endblock %}
      </main>
      <footer>
      <img alt="" src="data:image/svg+xml,
        {# url-encoded SVG logo goes here #}" /> 
        <br />
        {% trans "Printed from MyProject" %}
      </footer>
    </body>
    </html>
    ```

### å®ç°åŸç†...

WeasyPrintç”Ÿæˆå¯ä¾›æ‰“å°ã€åƒç´ ç²¾è‡´çš„æ–‡æ¡£ã€‚æœ¬ä¾‹ä¸­å¯åœ¨å±•ç¤ºæ—¶åˆ†å‘ç»™è§‚ä¼—çš„ä¼ é€’ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

![WeasyPrintç”Ÿæˆ PDF](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87f192282d434feeb17bdb84f9b642d1~tplv-k3u1fbpfcp-zoom-1.image)

> **è¯‘è€…æ³¨ï¼š** å®é™…æµ‹è¯•ä¹¦ä¸­ä»£ç æ‰€æ·»åŠ çš„ BootStrap æ ·å¼ä¸ä¼šç”Ÿæ•ˆï¼Œè€Œå› è¿œç¨‹æ–‡ä»¶ä¼šæŠ¥ ssl ç›¸å…³é”™è¯¯ï¼Œåœ¨idea_handout_pdfæˆ‘ä½¿ç”¨çš„æœ¬åœ° css  ï¼ˆçº¿ä¸Šä¸‹è½½çš„ BootStrap 4 css ä»£ç ï¼‰çš„æ–¹å¼ç”Ÿæˆçš„ PDFï¼Œä»£ç å¦‚ä¸‹ï¼š
>
> ```
> css = CSS(
>          settings.WEBSITE_URL + settings.STATIC_URL + 'site/css/bootstrap.min.css',
>      )
>  HTML(string=html).write_pdf(
>      response,
>      font_config=font_config,
>      stylesheets=[css]
>  )
> ```
>
> æµ‹è¯•æ—¶å‘ç° font_config é…ç½®å¹¶ä¸ä¼šäº§ç”Ÿä»€ä¹ˆå½±å“ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£å®ƒä¸»è¦ç”¨äºå…¼å®¹@font-faceï¼Œæ€»ä½“æµ‹è¯•å‘ç° WeasyPrintä¸ BootStrap çš„å…¼å®¹æ€§å­˜åœ¨ä¸€å®šé—®é¢˜ï¼Œå¦‚ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ä½¿ç”¨ BootStrap 4æ—¶æ•°å­—çš„æ˜¾ç¤ºå­˜åœ¨é—®é¢˜ï¼Œä½¿ç”¨ BootStrap 3æ—¶åˆ™æ— æ­¤é—®é¢˜ï¼Œè°ƒè¯•æ—¶å‘ç° HTMLä»£ç æ˜¾ç¤ºä¹Ÿæ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœæœ‰çŸ¥é“é—®é¢˜çš„è¯»è€…æ¬¢è¿åœ¨è¯„è®ºåŒºä¸­å‘ŠçŸ¥ã€‚

æ–‡æ¡£çš„å¸ƒå±€ç”±HTML å’ŒCSSè¿›è¡Œå®šä¹‰ã€‚WeasyPrintæœ‰å…¶è‡ªèº«çš„æ¸²æŸ“å¼•æ“ã€‚é˜…è¯»[å®˜æ–¹æ–‡æ¡£](https://weasyprint.readthedocs.io/en/latest/features.html)è·å–æ›´å¤šæ”¯æŒåŠŸèƒ½ã€‚

å¯ä»¥ä½¿ç”¨ä¿å­˜ä¸ºçŸ¢é‡å›¾è€Œéä½å›¾çš„SVGå›¾åƒï¼Œè¿™æ ·ä¼ å•ä¼šæ›´ä¸ºç²¾è‡´ã€‚å½“å‰è¿˜ä¸æ”¯æŒè¡Œå†…SVGï¼Œä½†å¯ä»¥ä½¿ç”¨å¸¦æœ‰æ•°æ®æºæˆ–å¤–éƒ¨URLçš„<img>æ ‡ç­¾ã€‚æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯¹äºŒç»´ç åŠåº•éƒ¨çš„logoä½¿ç”¨äº†SVGå›¾åƒã€‚

æˆ‘ä»¬æ¥è¿‡ä¸€ä¸‹è§†å›¾ä¸­çš„ä»£ç ã€‚é€šè¿‡æ‰€é€‰çš„ideaæ¥ä½œä¸ºhtmlå­—ç¬¦ä¸²æ¥æ¸²æŸ“idea_handout_pdf.htmlæ¨¡æ¿ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºPDFå†…å®¹ç±»å‹çš„HttpResponseå¯¹è±¡ï¼Œæ–‡ä»¶åç”±å½“å‰æ—¥æœŸè½¬ä¸ºé“¾æ¥çš„ideaçš„æ ‡é¢˜æ‰€æ„æˆã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡HTMLåˆ›å»ºäº†ä¸€ä¸ªWeasyPrintçš„HTMLå¯¹è±¡ï¼Œå¹¶åƒå†™å…¥æ–‡ä»¶ä¸­é‚£æ ·å°†å…¶å†™å…¥åˆ°å“åº”ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨FontConfigurationå¯¹è±¡ï¼Œå®ƒè®©æˆ‘ä»¬å¯ä»¥åœ¨å¸ƒå±€çš„CSSé…ç½®ä¸­æ·»åŠ å¹¶ä½¿ç”¨ç½‘é¡µå­—ä½“ã€‚æœ€åï¼Œæˆ‘ä»¬è¿”å›å“åº”å¯¹è±¡ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚
-   *ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*åœ¨JavaScriptæš´éœ²è®¾ç½®*ä¸€èŠ‚

## é€šè¿‡Haystackå’ŒWhooshå®ç°å¤šè¯­è¨€æœç´¢

å†…å®¹ç½‘ç«™çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½æ˜¯å…¨æ–‡æœ¬æœç´¢ã€‚Haystackæ˜¯ä¸€ä¸ªæ”¯æŒSolrã€Elasticsearchã€Whooshå’ŒXapianæœç´¢å¼•æ“çš„æ¨¡å—åŒ–æœç´¢APIã€‚å¯¹äºé¡¹ç›®ä¸­å¸Œæœ›å¯è¿›è¡Œæœç´¢çš„æ¨¡å‹ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªå¯é€šè¿‡æ¨¡å‹è¯»å–æ–‡æœ¬ä¿¡æ¯å¹¶å°†å…¶æ”¾åˆ°åå°ä¸­çš„ç´¢å¼•ã€‚æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•é€šè¿‡Haystackå’ŒåŸºäºPythonçš„æœç´¢è¯­è¨€æ¥ä¸ºå¤šè¯­è¨€ç½‘ç«™é…ç½®æœç´¢ã€‚
### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨æ­¤å‰å®šä¹‰çš„categorieså’Œideasåº”ç”¨ã€‚

ç¡®ä¿åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…äº†django-haystackå’ŒWhooshï¼ˆå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°requirements/_base.txtä¸­ï¼‰ï¼š

```
(env)$ pip install django-haystack==2.8.1
(env)$ pip install Whoosh==2.7.4
```

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤æ¥é€šè¿‡Haystackå’ŒWhooshæ¥è®¾ç½®å¤šè¯­ç§æœç´¢ï¼š

1.  åˆ›å»ºä¸€ä¸ªsearchåº”ç”¨ï¼Œå…¶ä¸­åŒ…å«MultilingualWhooshEngineä»¥åŠå¯¹ideasçš„æœç´¢ç´¢å¼•ã€‚æœç´¢å¼•æ“æ”¾åˆ°multilingual_whoosh_backend.pyæ–‡ä»¶ï¼š


    ```
    # myproject/apps/search/multilingual_whoosh_backend.py
    from django.conf import settings
    from django.utils import translation
    from haystack.backends.whoosh_backend import (
      WhooshSearchBackend,
      WhooshSearchQuery,
      WhooshEngine,
    )
    from haystack import connections
    from haystack.constants import DEFAULT_ALIAS


    class MultilingualWhooshSearchBackend(WhooshSearchBackend): 
      def update(self, index, iterable, commit=True, language_specific=False):
        if not language_specific and self.connection_alias == "default":
          current_language = (translation.get_language() or
          settings.LANGUAGE_CODE)[:2]
          for lang_code, lang_name in settings.LANGUAGES:
            lang_code_underscored = lang_code.replace("-", "_") 
            using = f"default_{lang_code_underscored}" 
            translation.activate(lang_code)
            backend = connections[using].get_backend()
            backend.update(index, iterable, commit, language_specific=True)
            translation.activate(current_language) 
        elif language_specific:
          super().update(index, iterable, commit)


    class MultilingualWhooshSearchQuery(WhooshSearchQuery): 
      def __init__(self, using=DEFAULT_ALIAS):
        lang_code_underscored = translation.get_language().replace("-", "_") 
        using = f"default_{lang_code_underscored}" 
        super().__init__(using=using)


    class MultilingualWhooshEngine(WhooshEngine): 
      backend = MultilingualWhooshSearchBackend 
      query = MultilingualWhooshSearchQuery
    ```

1.  åˆ›å»ºæœç´¢ç´¢å¼•å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/search/search_indexes.py
    from haystack import indexes
    
    from myproject.apps.ideas.models import Idea


    class IdeaIndex(indexes.SearchIndex, indexes.Indexable): 
      text = indexes.CharField(document=True)
    
      def get_model(self):
        return Idea
    
      def index_queryset(self, using=None): 
        """
        Used when the entire index for model is updated. 
        """
        return self.get_model().objects.all()
             
      def prepare_text(self, idea):
        """
        Called for each language / backend 
        """
        fields = [
          idea.translated_title, idea.translated_content 
        ]
        fields += [ 
          category.translated_title
          for category in idea.categories.all() 
        ]
        return "\n".join(fields)
    ```

1.  ä½¿ç”¨MultilingualWhooshEngineé…ç½®è®¾ç½®æ–‡ä»¶ï¼š


    ```
    # myproject/settings/_base.py
    import os
    BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(
       os.path.abspath(__file__) 
    )))
    
    #...
    
    INSTALLED_APPS = [ 
       # contributed
       #...
       # third-party
       #...
       "haystack",
       # local 
       "myproject.apps.core", 
       "myproject.apps.categories", 
       "myproject.apps.ideas", 
       "myproject.apps.search",
    ]
    
    LANGUAGE_CODE = "en"
    
    # All official languages of European Union 
    LANGUAGES = [
       ("bg", "Bulgarian"),
       ("hr", "Croatian"),
       ("cs", "Czech"),
       ("da", "Danish"),
       ("nl", "Dutch"),
       ("en", "English"),
       ("et", "Estonian"),
       ("fi", "Finnish"),
       ("fr", "French"),
       ("de", "German"),
       ("el", "Greek"),
       ("hu", "Hungarian"),
       ("ga", "Irish"),
       ("it", "Italian"),
       ("lv", "Latvian"),
       ("lt", "Lithuanian"),
       ("mt", "Maltese"),
       ("pl", "Polish"),
       ("pt", "Portuguese"),
       ("ro", "Romanian"),
       ("sk", "Slovak"),
       ("sl", "Slovene"),
       ("es", "Spanish"),
       ("sv", "Swedish"),
    ]
    
    HAYSTACK_CONNECTIONS = {}
    for lang_code, lang_name in LANGUAGES:
       lang_code_underscored = lang_code.replace("-", "_") 
       HAYSTACK_CONNECTIONS[f"default_{lang_code_underscored}"] = { 
          "ENGINE": "myproject.apps.search.multilingual_whoosh_backend.MultilingualWhooshEngine",
          "PATH": os.path.join(BASE_DIR, "tmp", f"whoosh_index_{lang_code_underscored}"),
       }
    lang_code_underscored = LANGUAGE_CODE.replace("-", "_") 
    HAYSTACK_CONNECTIONS["default"] = HAYSTACK_CONNECTIONS[ 
       f"default_{lang_code_underscored}"
    ]
    ```

1.  åœ¨URLè§„åˆ™é‡Œæ·»åŠ è·¯å¾„ï¼š


    ```
    # myproject/urls.py
    from django.contrib import admin
    from django.conf.urls.i18n import i18n_patterns 
    from django.urls import include, path
    from django.conf import settings
    from django.conf.urls.static import static 
    from django.shortcuts import redirect
    
    urlpatterns = i18n_patterns(
       path("", lambda request: redirect("ideas:idea_list")), 
       path("admin/", admin.site.urls),
       path("accounts/", include("django.contrib.auth.urls")), 
       path("ideas/", include(("myproject.apps.ideas.urls", "ideas"), namespace="ideas")),
       path("search/", include("haystack.urls")),
    )
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
    urlpatterns += static("/media/", document_root=settings.MEDIA_ROOT)
    ```

1.  éœ€è¦ä¸€ä¸ªé’ˆå¯¹æœç´¢è¡¨å•å’Œæœç´¢ç»“æœçš„æ¨¡æ¿ï¼Œå¦‚ä¸‹ï¼š


    ```
    {# search/search.html #}
    {% extends "base.html" %} 
    {% load i18n %}
    
    {% block sidebar %}
      <form method="get" action="{{ request.path }}">
        <div class="well clearfix"> 
          {{ form.as_p }}
          <p class="pull-right">
            <button type="submit" class="btn btn-primary">
              {% trans "Search" %}</button>
          </p>
         </div>
      </form>
     {% endblock %}
     
    {% block main %}
      {% if query %}
        <h1>{% trans "Search Results" %}</h1>
    
        {% for result in page.object_list %} 
          {% with idea=result.object %}
            <a href="{{ idea.get_url_path }}" class="d-block my-3">
              <div class="card">
                <img src="{{ idea.picture_thumbnail.url }}" alt="" />
                <div class="card-body">
                  <p class="card-text">
                  {{ idea.translated_title }}</p>
                </div>
                </div>
            </a>
          {% endwith %}
        {% empty %}
          <p>{% trans "No results found." %}</p>
        {% endfor %}
        
        {% include "misc/includes/pagination.html" with object_list=page %}
      {% endif %}
    {% endblock %}
    ```

1.  åƒ*ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚ä¸­é‚£æ ·åœ¨misc/includes/pagination.htmlä¸­æ·»åŠ åˆ†é¡µæ¨¡æ¿ã€‚

1.  è°ƒç”¨rebuild_indexç®¡ç†å‘½ä»¤æ¥ç´¢å¼•æ•°æ®åº“ä¸­çš„æ•°æ®å¹¶å‡†å¤‡ç”¨äºå…¨æ–‡æœ¬æœç´¢ï¼š


    ```
    (env)$ python manage.py rebuild_index --noinput
    ```

> **è¯‘è€…æ³¨ï¼š** Haystack æœ€æ–°ç‰ˆæœ¬ä¸ Django 3.0åœ¨æµ‹è¯•æ—¶å‘ç°å­˜åœ¨å…¼å®¹æ€§çš„é—®é¢˜ï¼Œä¸»è¦æœ‰
>
> 1.  ImportError: cannot import name 'six' from 'django.utils'
> 1.  ImportError: cannot import name 'python_2_unicode_compatible' from 'django.utils.encoding'
>
> è¿™ä¸¤ä¸ªé”™è¯¯éœ€è¦åœ¨æºç å±‚é¢è¿›è¡Œå¤„ç†ï¼š
>
> ä¿®æ”¹åŸå¯¼å…¥ä¸º import six åŠ from six import python_2_unicode_compatibleæˆ–å°†å¯¹åº”æ–‡ä»¶ä»£ç æ‹·è´åˆ° django.utils ä¸­

### å®ç°åŸç†...

MultilingualWhooshEngineä¸­æŒ‡å®šäº†ä¸¤ä¸ªè‡ªå®šä¹‰å±æ€§ï¼š

-   backendæŒ‡å‘MultilingualWhooshSearchBackendï¼Œç¡®ä¿LANGUAGESè®¾ç½®ä¸­ç»™å®šæ¯ç§è¯­è¨€å¯¹åº”æ•°æ®éƒ½ä¼šè¢«ç´¢å¼•ï¼Œå¹¶æ”¾åˆ°HAYSTACK_CONNECTIONSæ‰€å®šä¹‰çš„ç›¸å…³è”Haystackç´¢å¼•ä½ç½®ã€‚
-   queryå¼•ç”¨MultilingualWhooshSearchQueryï¼Œåè€…çš„èŒè´£æ˜¯ç¡®ä¿åœ¨æœç´¢å…³é”®è¯æ—¶ï¼Œä¼šä½¿ç”¨å½“å‰è¯­è¨€æ‰€å¯¹åº”çš„Haystackè¿æ¥ã€‚

æ¯ä¸ªç´¢å¼•éƒ½æœ‰ä¸€ä¸ªtextå­—æ®µï¼Œè¿™é‡Œé¢å­˜å‚¨æ¨¡å‹ä¸­å…·ä½“è¯­è¨€çš„å…¨æ–‡æœ¬ã€‚ç´¢å¼•çš„æ¨¡å‹ç”±get_model()æ‰€å†³å®šï¼Œindex_queryset()å®šä¹‰åº”ç´¢å¼•å“ªä¸ªæŸ¥è¯¢é›†åˆï¼Œå…¶ä¸­æœç´¢çš„å†…å®¹åœ¨prepare_text()æ–¹æ³•ä¸­æŒ‰æ–°è¡Œåˆ†éš”è¿›è¡Œå®šä¹‰ã€‚

æ¨¡æ¿ä¸­æˆ‘ä»¬é›†æˆäº†ä¸€äº›Bootstrap 4çš„å…ƒç´ æ¥å¯¹è¡¨å•è¿›è¡Œå¼€ç®±å³ç”¨çš„æ¸²æŸ“ã€‚è¿™å¯ä»¥é€šè¿‡æœ¬ç« æ­¤å‰çš„*é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚ä¸­æ‰€ä»‹ç»çš„æ–¹æ³•è¿›è¡Œå®Œå–„ã€‚

æœ€ç»ˆçš„æœç´¢é¡µé¢è¡¨å•åœ¨ä¾§è¾¹æ ä¸­ã€æœç´¢ç»“æœä½äºä¸»æ ä¸­ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

![Django 3 Haystackæœç´¢ç»“æœ](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb672792bbea4b26aa613d96fff5cc38~tplv-k3u1fbpfcp-zoom-1.image)

å®šæœŸæ›´æ–°æœç´¢ç´¢å¼•æœ€ç®€å•çš„æ–¹å¼æ˜¯é€šè¿‡å®šæ—¶ä»»åŠ¡ï¼ˆæ¯”å¦‚æ¯æ™šï¼‰è°ƒç”¨rebuild_index managementå‘½ä»¤ã€‚äº†è§£è¿™éƒ¨åˆ†çŸ¥è¯†ï¼Œè¯·å‚è§[**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*è®¾ç½®cron jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡*ä¸€èŠ‚ã€‚

### ç›¸å…³å†…å®¹

-   *é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚
-   *ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚
-   [**ç¬¬13ç«  ç»´æŠ¤**](https://alanhou.org/django3-maintenance/)ä¸­çš„*è®¾ç½®cron jobæ‰§è¡Œå®šæ—¶ä»»åŠ¡*ä¸€èŠ‚

## é€šè¿‡Elasticsearch DSLå®ç°å¤šè¯­è¨€æœç´¢

Haystackç»“åˆWhooshä¸€ç§å¾ˆç¨³å®šçš„æœç´¢æœºåˆ¶ ï¼Œåªéœ€è¦ç”¨ä¸€äº›Pythonæ¨¡å—ï¼Œä½†è¦å®ç°æ›´å¥½çš„æ€§èƒ½ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨Elasticsearchã€‚æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒæ¥å®ç°å¤šè¯­ç§çš„æœç´¢ã€‚

### å‡†å¤‡å·¥ä½œ

é¦–å…ˆå®‰è£…ElasticsearchæœåŠ¡ç«¯ã€‚åœ¨macOSä¸­å¯ä»¥ä½¿ç”¨Homebrewæ¥è¿›è¡Œå®‰è£…ï¼š

```
$ brew install elasticsearch
```

åœ¨å†™æœ¬ä¹¦æ—¶ï¼ŒHomebrewä¸­æœ€æ–°çš„Elasticsearchç¨³å®šç‰ˆæœ¬ä¸º6.8.2ã€‚

åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…django-elasticsearch-dslï¼ˆå¹¶å°†å…¶æ·»åŠ åˆ°requirements/_base.txtä¸­ï¼‰ï¼š

```
(env)$ pip install django-elasticsearch-dsl==6.4.1
```

> â„¹ï¸æ³¨æ„å®‰è£…ç‰ˆæœ¬ç›¸åŒ¹é…çš„django-elasticsearch-dsléå¸¸é‡è¦ã€‚å¦åˆ™åœ¨å°è¯•è¿æ¥ElasticsearchæœåŠ¡æˆ–æ„å»ºç´¢å¼•æ—¶ä¼šæŠ¥é”™ã€‚ç‰ˆæœ¬å…¼å®¹æ€§è¡¨è¯·è§https://github.com/sabricot/django-elasticsearch-dslã€‚

 

> **è¯‘è€…æ³¨ï¼š** Elasticsearch å¯é€šè¿‡å¤šç§æ–¹å¼ï¼Œä¸‹è½½æºç äº¦å¯ç›´æ¥å¯åŠ¨ï¼ŒAlanä½¿ç”¨ Docker çš„æ–¹å¼è¿›è¡Œå®‰è£…ï¼Œ documents.py ä¸­title_bgç­‰é…ç½®å–å†³äºå¤šè¯­è¨€æ‰€é€‰æ‹©çš„æ–¹æ¡ˆã€‚å¦åœ¨ ES 7ä¸­ StringField å¯ä¿®æ”¹ä¸º KeywordField
>
> ```
> docker pull docker.elastic.co/elasticsearch/elasticsearch:7.7.0
> docker run -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" docker.elastic.co/elasticsearch/elasticsearch:7.7.0
> pip install django-elasticsearch-dsl==7.1.1
> ```

### å¦‚ä½•å®ç°...

æˆ‘ä»¬æ¥é€šè¿‡å¦‚ä¸‹æ­¥éª¤å€ŸåŠ© Elasticsearch DSLè®¾ç½®å¤šè¯­è¨€æœç´¢ï¼š

1.  ä¿®æ”¹é…ç½®æ–‡ä»¶ã€æ·»åŠ django_elasticsearch_dslåˆ°INSTALLED_APPSä¸­ï¼Œå¹¶é…ç½®ELASTICSEARCH_DSLå¦‚ä¸‹ï¼š


    ```
    # myproject/settings/_base.py
    INSTALLED_APPS = [ 
      # other apps...
      "django_elasticsearch_dsl", 
    ]
    
    ELASTICSEARCH_DSL={
      'default': {
        'hosts': 'localhost:9200'
      },
    }
    ```

1.  åœ¨ideasåº”ç”¨ä¸­ï¼Œåˆ›å»ºdocuments.pyæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æ·»åŠ IdeaDocumentæ¥è¿›è¡Œideaæœç´¢çš„ç´¢å¼•ï¼Œå¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/documents.py
    from django.conf import settings
    from django.utils.translation import get_language, activate 
    from django.db import models
    
    from django_elasticsearch_dsl import fields 
    from django_elasticsearch_dsl.documents import (
      Document,
      model_field_class_to_field_class,
    )
    from django_elasticsearch_dsl.registries import registry
    
    from myproject.apps.categories.models import Category 
    from .models import Idea
    
    def _get_url_path(instance, language): 
      current_language = get_language() 
      activate(language)
      url_path = instance.get_url_path() 
      activate(current_language)
      return url_path


    @registry.register_document 
    class IdeaDocument(Document):
      author = fields.NestedField( 
        properties={
          "first_name": fields.StringField(), 
          "last_name": fields.StringField(), 
          "username": fields.StringField(), 
          "pk": fields.IntegerField(),
        },
        include_in_root=True, 
      )
      title_bg = fields.StringField()
      title_hr = fields.StringField()
      # other title_* fields for each language in the LANGUAGES setting...
      content_bg = fields.StringField()
      content_hr = fields.StringField()
      # other content_* fields for each language in the LANGUAGES setting...
    
      picture_thumbnail_url = fields.StringField()
      categories = fields.NestedField( 
        properties=dict(
          pk=fields.IntegerField(), 
          title_bg=fields.StringField(), 
          title_hr=fields.StringField(),
          # other title_* definitions for each language in the LANGUAGES setting... 
        ),
        include_in_root=True,
      )
      url_path_bg = fields.StringField()
      url_path_hr = fields.StringField()
      # other url_path_* fields for each language in the LANGUAGES setting...
    
      class Index:
        name = "ideas"
        settings = {"number_of_shards": 1, "number_of_replicas": 0}
    
      class Django: 
        model = Idea
        # The fields of the model you want to be indexed in Elasticsearch
        fields = ["uuid", "rating"] 
        related_models = [Category]
        
      def get_instances_from_related(self, related_instance):
        if isinstance(related_instance, Category):
          category = related_instance
          return category.category_ideas.all()
    ```

1.  åœ¨IdeaDocumentä¸­æ·»åŠ prepare_*æ–¹æ³•æ¥å‡†å¤‡ç´¢å¼•çš„æ•°æ®ï¼š


    ```
    def prepare(self, instance):
      lang_code_underscored = settings.LANGUAGE_CODE.replace("-", "_")
      setattr(instance, f"title_{lang_code_underscored}", instance.title)
      setattr(instance, f"content_{lang_code_underscored}", instance.content) 
      setattr(
        instance, 
        f"url_path_{lang_code_underscored}", 
        _get_url_path(instance=instance,
        language=settings.LANGUAGE_CODE), 
      )
      for lang_code, lang_name in settings.LANGUAGES_EXCEPT_THE_DEFAULT: 
        lang_code_underscored = lang_code.replace("-", "_") 
        setattr(instance, f"title_{lang_code_underscored}", "")
        setattr(instance, f"content_{lang_code_underscored}", "")
        translations = instance.translations.filter(language=lang_code).first() 
        if translations:
          setattr(instance, f"title_{lang_code_underscored}", translations.title)
          setattr(
            instance, f"content_{lang_code_underscored}",
            translations.content 
          )
          setattr(
            instance,
            f"url_path_{lang_code_underscored}", 
            _get_url_path(instance=instance,
            language=lang_code),
          )
      data = super().prepare(instance=instance) 
      return data
    
    def prepare_picture_thumbnail_url(self, instance): 
      if not instance.picture:
        return ""
      return instance.picture_thumbnail.url
    
    def prepare_author(self, instance): 
      author = instance.author
      if not author:
        return [] 
      author_dict = {
        "pk": author.pk,
        "first_name": author.first_name, 
        "last_name": author.last_name, 
        "username": author.username,
      }
      return [author_dict]
    
    def prepare_categories(self, instance): 
      categories = []
      for category in instance.categories.all(): 
        category_dict = {"pk": category.pk} 
        lang_code_underscored = settings.LANGUAGE_CODE.replace("-", "_") 
        category_dict[f"title_{lang_code_underscored}"] = category.title
        for lang_code, lang_name in settings.LANGUAGES_EXCEPT_THE_DEFAULT: 
          lang_code_underscored = lang_code.replace("-", "_") 
          category_dict[f"title_{lang_code_underscored}"] = "" 
          translations = category.translations.filter(language= lang_code).first()
          if translations:
            category_dict[f"title_{lang_code_underscored}"] = translations.title 
        categories.append(category_dict)
      return categories
    ```

1.  å¯¹IdeaDocumentæ·»åŠ ä¸€äº›å±æ€§å’Œæ–¹æ³•ï¼Œä»ç´¢å¼•æ–‡æ¡£ä¸­è¿”å›ç¿»è¯‘å†…å®¹ï¼š


    ```
    @property
    def translated_title(self):
      lang_code_underscored = get_language().replace("-", "_") 
      return getattr(self, f"title_{lang_code_underscored}", "")
    
    @property
    def translated_content(self):
      lang_code_underscored = get_language().replace("-", "_") 
      return getattr(self, f"content_{lang_code_underscored}", "")
    
    def get_url_path(self):
      lang_code_underscored = get_language().replace("-", "_") 
      return getattr(self, f"url_path_{lang_code_underscored}", "")
    
    def get_categories(self):
      lang_code_underscored = get_language().replace("-", "_") 
      return [
        dict( 
          translated_title=category_dict[f"title_{lang_code_underscored}"],
          **category_dict,
        )
        for category_dict in self.categories 
      ]
    ```

1.  åœ¨documents.pyæ–‡ä»¶ä¸­è¿˜è¦åšçš„ä¸€ä»¶äº‹æ˜¯å¯¹UUIDFieldæ‰“çŒ´å­è¡¥ä¸ï¼Œå› é»˜è®¤Django Elasticsearch DSLä¸æ”¯æŒè¿™ç§å­—æ®µã€‚åªéœ€è¦åœ¨å¯¼å…¥åŒºå—ä¹‹åæ·»åŠ å¦‚ä¸‹ä»£ç å³å¯ï¼š


    ```
    model_field_class_to_field_class[models.UUIDField] = fields.TextField
    ```

1.  åœ¨ideasåº”ç”¨çš„forms.pyä¸­åˆ›å»ºIdeaSearchFormï¼š


    ```
    # myproject/apps/ideas/forms.py
    from django import forms
    from django.utils.translation import ugettext_lazy as _
    
    from crispy_forms import helper, layout


    class IdeaSearchForm(forms.Form):
      q = forms.CharField(label=_("Search for"), required=False)
    
      def __init__(self, request, *args, **kwargs): 
        self.request = request 
        super().__init__(*args, **kwargs)
      
        self.helper = helper.FormHelper() 
        self.helper.form_action = self.request.path 
        self.helper.form_method = "GET" 
        self.helper.layout = layout.Layout(
          layout.Field("q", css_class="input-block-level"),
          layout.Submit("search", _("Search")), 
        )
    ```

1.  æ·»åŠ ä½¿ç”¨Elasticsearchè¿›è¡Œæœç´¢çš„è§†å›¾ï¼š


    ```
    # myproject/apps/ideas/views.py
    from django.shortcuts import render
    from django.conf import settings
    from django.core.paginator import EmptyPage, PageNotAnInteger, Paginator
    from django.utils.functional import LazyObject
    
    from .forms import IdeaSearchForm
    
    PAGE_SIZE = getattr(settings, "PAGE_SIZE", 24)


    class SearchResults(LazyObject):
      def __init__(self, search_object):
        self._wrapped = search_object
    
      def __len__(self):
        return self._wrapped.count()
      
      def __getitem__(self, index): 
        search_results = self._wrapped[index] 
        if isinstance(index, slice):
          search_results = list(search_results) 
        return search_results
    
    def search_with_elasticsearch(request): 
      from .documents import IdeaDocument 
      from elasticsearch_dsl.query import Q
      
      form = IdeaSearchForm(request, data=request.GET)
      
      search = IdeaDocument.search()
      
      if form.is_valid():
        value = form.cleaned_data["q"]
        lang_code_underscored = request.LANGUAGE_CODE.replace("-", "_")
        search = search.query(
          Q("match_phrase", 
            **{f"title_{lang_code_underscored}":
            value})
          | Q("match_phrase", **{f"content_{
              lang_code_underscored}": value})
          | Q(
              "nested",
              path="categories", 
              query=Q(
                "match_phrase",
                **{f"categories__title_{
                lang_code_underscored}": value},
              ),
            )
        )
    
        search_results = SearchResults(search)
      
        paginator = Paginator(search_results, PAGE_SIZE) 
        page_number = request.GET.get("page")
        try:
          page = paginator.page(page_number) 
        except PageNotAnInteger:
          # If page is not an integer, show first page.
          page = paginator.page(1) 
        except EmptyPage:
          # If page is out of range, show last existing page. 
          page = paginator.page(paginator.num_pages)
      
        context = {"form": form, "object_list": page}
        return render(request, "ideas/idea_search.html", context)
    ```

1.  å¯¹æœç´¢è¡¨å•å’Œæœç´¢ç»“æœåˆ›å»ºidea_search.htmlæ¨¡æ¿ï¼š


    ```
    {# ideas/idea_search.html #}
    {% extends "base.html" %}
    {% load i18n crispy_forms_tags %}
    
    {% block sidebar %}
      {% crispy form %}
    {% endblock %}
    
    {% block main %}
      <h1>{% trans "Search Results" %}</h1>
      {% if object_list %}
        {% for idea in object_list %}
          <a href="{{ idea.get_url_path }}" class="d-block my-3">
            <div class="card">
              <img src="{{ idea.picture_thumbnail_url }}" alt="" />
              <div class="card-body">
                <p class="card-text">{{ idea.translated_title }}</p>
              </div>
            </div>
          </a>
        {% endfor %}
        {% include "misc/includes/pagination.html" %} 
      {% else %}
        <p>{% trans "No ideas found." %}</p> 
      {% endif %}
    {% endblock %}
    ```

1.  åƒ*ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚ä¸­é‚£æ ·åœ¨ misc/includes/pagination.htmlä¸­æ·»åŠ åˆ†é¡µæ¨¡æ¿ã€‚

1.  è°ƒç”¨search_index --rebuildç®¡ç†å‘½ä»¤æ¥ç´¢å¼•æ•°æ®åº“æ•°æ®å¹¶å‡†å¤‡ç”¨äºæœç´¢çš„å…¨æ–‡æœ¬ï¼š


    ```
    (env)$ python manage.py search_index --rebuild
    ```

### å®ç°åŸç†...

Django Elasticsearch DSLæ–‡æ¡£ç±»ä¼¼äºæ¨¡å‹è¡¨å•ã€‚è¿™é‡Œå¯ä»¥å®šä¹‰å­˜å‚¨æ¨¡å‹ä¸­çš„å“ªä¸ªå­—æ®µä¾›ç¨ååœ¨æœç´¢æŸ¥è¯¢æ—¶ä½¿ç”¨ã€‚åœ¨æˆ‘ä»¬çš„IdeaDocumentç¤ºä¾‹ä¸­ï¼Œä¿å­˜äº†UUIDã€è¯„åˆ†ã€ ä½œè€…ã€åˆ†ç±»ã€æ ‡é¢˜ã€å†…å®¹å’Œæ‰€æœ‰è¯­è¨€çš„URLè·¯å¾„ä»¥åŠå›¾ç‰‡ç¼©ç•¥å›¾URLã€‚Indexç±»å®šä¹‰è¿™ä¸ªæ–‡æ¡£çš„Elasticsearchç´¢å¼•è®¾ç½®ã€‚Djangoç±»å®šä¹‰ä»ä½•å¤„è·å–ç´¢å¼•å­—æ®µã€‚æœ‰ä¸€ä¸ªrelated_modelsè®¾ç½®åœ¨å“ªä¸ªæ¨¡å‹ä¿®æ”¹åæ›´æ–°è¿™ä¸ªç´¢å¼•ã€‚æœ¬ä¾‹ä¸­ä¸ºCategoryæ¨¡å‹ã€‚æ³¨æ„ä½¿ç”¨django-elasticsearch-dslæ—¶ï¼Œä¸è®ºä½•æ—¶ä¿å­˜æ¨¡å‹éƒ½ä¼šè‡ªåŠ¨æ›´æ–°ã€‚è¿™æ˜¯é€šè¿‡ä¿¡å·æ¥å®ç°çš„ã€‚

get_instances_from_related()æ–¹æ³•è¡¨æ˜åœ¨ä¿®æ”¹Categoryå®ä¾‹æ—¶å¦‚ä½•è·å–Ideaæ¨¡å‹å®ä¾‹ã€‚

IdeaDocumentçš„prepare() å’Œ prepare_*()æ–¹æ³•è¡¨æ˜ä»ä½•å¤„è·å–æ•°æ®ä»¥åŠå¯¹æŒ‡å®šå­—æ®µä¿å­˜æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨è¯­è¨€å­—æ®µç­‰äºltæ—¶æˆ‘ä»¬ä»IdeaTranslationsæ¨¡å‹çš„æ ‡é¢˜å­—æ®µè¯»å–title_ltæ•°æ®ã€‚

IdeaDocumentæœ€åé¢çš„é‚£äº›å±æ€§å’Œæ–¹æ³•ç”¨äºæŒ‰å½“å‰è¯­è¨€ä»ç´¢å¼•ä¸­è·å–ä¿¡æ¯ã€‚

ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæœç´¢è¡¨å•è§†å›¾ã€‚è¡¨å•ä¸­æœ‰ä¸€ä¸ªåä¸ºqçš„æŸ¥è¯¢å­—æ®µã€‚åœ¨è¿›è¡Œæäº¤æ—¶ï¼Œæˆ‘ä»¬åœ¨å½“å‰è¯­è¨€çš„æ ‡é¢˜ã€å†…å®¹æˆ–åˆ†ç±»æ ‡é¢˜å­—æ®µä¸­æœç´¢æ‰€æŸ¥è¯¢å…³é”®è¯ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨æ‡’åŠ è½½ç±»SearchResultså°è£…æœç´¢ç»“æœï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨é»˜è®¤çš„Djangoåˆ†é¡µå™¨ã€‚

è§†å›¾çš„æ¨¡æ¿ä¾§è¾¹æ ä¸­æœ‰è¡¨å•ï¼Œä¸»æ ç›®ä¸­ä¸ºæœç´¢ç»“æœï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

![Django 3 Elasticsearchæœç´¢ç»“æœ](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/308652f9c66f475694efcbf4f0c4b277~tplv-k3u1fbpfcp-zoom-1.image)

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨CRUDLå‡½æ•°åˆ›å»ºåº”ç”¨*ä¸€èŠ‚
-   *é€šè¿‡Haystackå’ŒWhooshå®ç°å¤šè¯­è¨€æœç´¢*ä¸€èŠ‚
-   *é€šè¿‡django-crispy-formsåˆ›å»ºè¡¨å•å¸ƒå±€*ä¸€èŠ‚
-   *ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚
# ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript

æœ¬ç« ä¸­æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä¸‹å†…å®¹ï¼š

-   ç¼–æ’ base.htmlæ¨¡æ¿
-   ä½¿ç”¨ Django Sekizai
-   åœ¨JavaScriptä¸­æš´éœ²é…ç½®
-   ä½¿ç”¨HTML5 dataå±æ€§
-   æä¾›å“åº”å¼å›¾ç‰‡
-   å®ç°æŒç»­æ»šåŠ¨
-   åœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­æ‰“å¼€å¯¹è±¡è¯¦æƒ…
-   å®ç°Likeå¾®ä»¶
-   é€šè¿‡Ajaxä¸Šä¼ å›¾ç‰‡

## å¼•è¨€

é™æ€ç½‘ç«™é€‚ç”¨äºé™æ€å†…å®¹ï¼Œå¦‚ä¼ ç»Ÿæ–‡æ¡£ã€åœ¨çº¿å›¾ä¹¦æˆ–è¯¾ç¨‹ï¼›ä½†å¦‚ä»Šå¤§éƒ¨åˆ†äº¤äº’å¼webåº”ç”¨å’Œå¹³å°å¿…é¡»æ‹¥æœ‰åŠ¨æ€ç»„ä»¶ï¼Œæ‰èƒ½é¹¤ç«‹é¸¡ç¾¤ã€ä¸ºè®¿å®¢æä¾›æœ€å¥½çš„ç”¨æˆ·ä½“éªŒã€‚æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ åœ¨Djangoä¸­å¦‚ä½•ä½¿ç”¨JavaScriptå’ŒCSSã€‚æˆ‘ä»¬ä¼šä½¿ç”¨åˆ°Bootstrap 4å‰ç«¯æ¡†æ¶æ¥è¿›è¡Œå“åº”å¼å¸ƒå±€ï¼Œä»¥åŠä½¿ç”¨jQuery JavaScriptæ¡†æ¶æ¥å®ç°æ›´å…·ç”Ÿäº§åŠ›çš„è„šæœ¬ã€‚

## æŠ€æœ¯è¦æ±‚

å’Œå‰é¢ä¸€æ ·ï¼Œå­¦ä¹ æœ¬ç« ä»£ç ï¼Œåº”å½“å®‰è£…æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„Pythonã€MySQLæˆ–PostgreSQLæ•°æ®åº“ï¼Œä»¥åŠåœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…Djangoé¡¹ç›®ã€‚æœ‰äº›å°èŠ‚ä¼šéœ€è¦ç”¨åˆ°ç‰¹å®šçš„Pythonä¾èµ–ã€‚æœ‰äº›ä¼šç”¨åˆ°é¢å¤–çš„JavaScriptåº“ã€‚åœ¨å¯¹åº”çš„å°èŠ‚ä¸­ä¼šè¿›è¡Œè¯´æ˜ã€‚

æœ¬ç« ä¸­çš„ä»£ç è¯·å‚è§ [GitHub ä»“åº“](https://github.com/alanhou/django3-cookbook)çš„ Chapter04ç›®å½•ã€‚

> è¯‘è€…æ³¨ï¼šæœ¬ç« ä¸­ä½¿ç”¨åˆ°äº† PostgreSQLï¼Œä¹ æƒ¯ä½¿ç”¨ MySQLçš„å°ä¼™ä¼´ä»¬è¯·è‡ªè¡Œå®‰è£…é…ç½®ï¼ŒåŒæ—¶è¯·è®°å¾—å®‰è£…psycopg2
>
> pip install psycopg2-binary

## ç¼–æ’ base.htmlæ¨¡æ¿

åœ¨å¼€å§‹ä½¿ç”¨æ¨¡æ¿å‰ï¼Œé¦–å…ˆè¦åšçš„æ˜¯åˆ›å»ºä¸€ä¸ªbase.htmlåŸºç¡€æ¨¡æ¿ï¼Œé¡¹ç›®ä¸­çš„å¤§éƒ¨åˆ†é¡µé¢æ¨¡æ¿å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¼”ç¤ºå¦‚ä½•ä¸ºå¤šè¯­ç§HTML5ç½‘ç«™åˆ›å»ºè¿™ç§æ¨¡æ¿ï¼ŒåŒæ—¶é¡¾åŠå“åº”å¼ã€‚

> ğŸ’¡å“åº”å¼(responsive)ç½‘ç«™å¯¹æ‰€æœ‰è®¾å¤‡æä¾›ç›¸åŒçš„åŸºç¡€å†…å®¹ï¼ŒæŒ‰è§†çª—è¿›è¡Œç›¸åº”çš„æ ·å¼å±•ç¤ºï¼Œä¸ç®¡ä½¿ç”¨çš„æ˜¯æ¡Œé¢æµè§ˆå™¨ã€å¹³æ¿ç”µè„‘è¿˜æ˜¯æ‰‹æœºã€‚è¿™ä¸è‡ªé€‚åº”(adaptive)ç½‘ç«™ä¸åŒï¼Œåè€…æ ¹æ®user agentæ¥è‡ªå†³å®šè®¾å¤‡ç±»å‹ï¼Œç„¶åæä¾›ä¸åŒçš„å†…å®¹ã€æ ‡è®°ï¼Œç”šè‡³ä¼šæ ¹æ®user agentçš„åˆ†ç±»ä¸åŒè€Œä½¿ç”¨ä¸åŒçš„åŠŸèƒ½ã€‚

### å‡†å¤‡å·¥ä½œ

åœ¨é¡¹ç›®ä¸­åˆ›å»ºtemplatesç›®å½•ï¼Œå¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ¨¡æ¿ç›®å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
# myproject/settings/_base.py
TEMPLATES = [ 
  {
    "BACKEND": "django.template.backends.django.DjangoTemplates",
    "DIRS": [os.path.join(BASE_DIR, "myproject", "templates")],
    "APP_DIRS": True,
    "OPTIONS": {
      "context_processors": [
        "django.template.context_processors.debug", 
        "django.template.context_processors.request", 
        "django.contrib.auth.context_processors.auth", 
        "django.contrib.messages.context_processors.messages", 
        "django.template.context_processors.media", 
        "django.template.context_processors.static",
      ] 
    },
  } 
]
```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

1.  åœ¨æ¨¡æ¿æ ¹ç›®å½•ä¸‹ï¼Œä½¿ç”¨å¦‚ä¸‹å†…å®¹åˆ›å»ºä¸€ä¸ªbase.htmlæ–‡ä»¶ï¼š


    ```
    {# base.html #}
    <!doctype html>
    {% load i18n static %} <html lang="en"> 
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <title>{% block head_title %}{% endblock %}</title> 
        {% include "misc/includes/favicons.html" %}
        {% block meta_tags %}{% endblock %}
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" /> 
        <link rel="stylesheet" href="{% static 'site/css/style.css' %}" crossorigin="anonymous" />
        {% block css %}{% endblock %}
        {% block extra_head %}{% endblock %}
      </head>
      <body>
        {% include "misc/includes/header.html" %} 
        <div class="container my-5">
          {% block content %}
            <div class="row">
              <div class="col-lg-4">
              {% block sidebar %}{% endblock %}
              </div>
              <div class="col-lg-8">{% block main %}{% endblock %}</div>
            </div>
          {% endblock %}
        </div>
        {% include "misc/includes/footer.html" %}
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap /4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        {% block js %}{% endblock %}
        {% block extra_body %}{% endblock %}
      </body>
    </html>
    ```

1.  åœ¨misc/includesä¸­ï¼Œåˆ›å»ºåŒ…å«æ‰€æœ‰ç‰ˆæœ¬faviconçš„æ¨¡æ¿ï¼š


    ```
    {# misc/includes/favicon.html #}
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'site/img/favicon-32x32.png' %}" sizes="32x32"/> 
    <link rel="icon" type="image/png" href="{% static 'site/img/favicon-16x16.png' %}" sizes="16x16"/>
    ```
    
    > â„¹ï¸faviconæ˜¯ä¸€ä¸ªé€šå¸¸ä¼šåœ¨æµè§ˆå™¨æ ‡ç­¾ã€æœ€è¿‘è®¿é—®ç½‘ç«™çš„é›†åˆæˆ–æ¡Œé¢ä¸Šå¿«æ·æ–¹å¼ä¸­çœ‹åˆ°çš„å°å›¾ç‰‡ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåœ¨çº¿ç”Ÿæˆå™¨æ¥ä½¿ç”¨ logo ç”Ÿæˆé€‚ç”¨ä¸åŒç”¨ä¾‹ã€æµè§ˆå™¨åŠå¹³å°å¤šä¸ªç‰ˆæœ¬çš„faviconã€‚æˆ‘ä»¬å¸¸ç”¨çš„faviconç”Ÿæˆå™¨æœ‰https://favicomatic.com/å’Œhttps://realfavicongenerator.net/ ã€‚

1.  ä½¿ç”¨ç½‘ç«™çš„å¤´éƒ¨å’Œåº•éƒ¨åˆ›å»ºæ¨¡æ¿misc/includes/header.htmlå’Œmisc/includes/footer.htmlã€‚ç°åœ¨å¯ä»¥ä¿æŒæ–‡ä»¶çš„å†…å®¹ä¸ºç©ºã€‚

### å®ç°åŸç†...

åŸºç¡€æ¨¡æ¿åŒ…å«HTMLæ–‡æ¡£çš„`<head>` å’Œ `<body>`ä¸¤å¤§ç‰ˆå—ï¼Œå…¶ä¸­åŒ…å«ç½‘ç«™ä¸­å…¶å®ƒé¡µé¢éƒ½å°†é‡ç”¨çš„å†…å®¹ã€‚æ ¹æ®ç½‘é¡µè®¾è®¡çš„è¦æ±‚ï¼Œå¯ä»¥å¯¹ä¸åŒå¸ƒå±€å»ºç«‹ä¸åŒçš„åŸºç¡€æ¨¡æ¿ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªbase_simple.htmlæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åŒ…å«ç›¸åŒçš„`<head>`ç‰ˆå—ä»¥åŠæœ€ç®€åŒ–çš„`<body>`ç‰ˆå—ï¼Œå°†å…¶ç”¨äºç™»å½•é¡µã€å¯†ç é‡ç½®æˆ–å…¶å®ƒç®€å•é¡µé¢ã€‚ä¹Ÿå¯ä»¥å¯¹å…¶å®ƒå¸ƒå±€æ·»åŠ å•ç‹¬çš„åŸºç¡€æ¨¡æ¿ï¼Œå¦‚å•æ ã€ä¸¤æ å’Œä¸‰æ å¸ƒå±€ï¼Œæ¯ä¸ªéƒ½ç»§æ‰¿base.htmlå¹¶æŒ‰éœ€è¦é‡å†™å„ç‰ˆå—ã€‚

æˆ‘ä»¬æ¥çœ‹æ­¤å‰æ‰€å®šä¹‰çš„base.htmlçš„è¯¦æƒ…ã€‚ä»¥ä¸‹æ˜¯`<head>`ç‰ˆå—ä¸­çš„è¯¦ç»†è¯´æ˜ï¼š

-   æˆ‘ä»¬å®šä¹‰äº†UTF-8æ¥ä½œä¸ºé»˜è®¤ç¼–ç ä»¥æ”¯æŒå¤šè¯­è¨€å†…å®¹ã€‚
-   ç„¶åæ˜¯viewportçš„å®šä¹‰ï¼Œå®ƒä¼šä½¿ç”¨å…¨å®½æ¥åœ¨æµè§ˆå™¨ä¸­æŒ‰æ¯”ä¾‹æ˜¾ç¤ºç½‘ç«™ã€‚è¿™å¯¹äºç”±Bootstrapå‰ç«¯æ¡†æ¶æ‰€åˆ›å»ºå…·ä½“å±å¹•å¸ƒå±€çš„å°å±è®¾å¤‡æ˜¯éå¸¸æœ‰ç›Šçš„ã€‚
-   å½“ç„¶ï¼Œåœ¨æµè§ˆå™¨æ ‡ç­¾å’Œæœç´¢å¼•æ“æœç´¢ç»“æœä¸­ä¼šæœ‰è‡ªå®šä¹‰çš„ç½‘ç«™æ ‡é¢˜ã€‚
-   ç„¶åæ˜¯metaæ ‡ç­¾ç‰ˆå—ï¼Œå¯ç”¨äºæœç´¢å¼•æ“ä¼˜åŒ–(SEO)ã€Open Graphå’ŒTwitter Cardsã€‚
-   ä¹‹åæˆ‘ä»¬æ·»åŠ äº†ä¸åŒæ ¼å¼å’Œå¤§å°çš„faviconã€‚
-   æˆ‘ä»¬è¿˜åŒ…å«é»˜è®¤çš„Bootstrapå’Œè‡ªå®šä¹‰ç½‘ç«™æ ·å¼ã€‚åŠ è½½äº†Bootstrap CSSï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›æœ‰å“åº”å¼å¸ƒå±€ï¼Œè¿™æ ·ä¹Ÿä¼šå¯¹æ‰€æœ‰å…ƒç´ çš„åŸºæœ¬æ ·å¼è¿›è¡Œç»Ÿä¸€ï¼Œæ¥ä¿æŒè·¨æµè§ˆå™¨ä¸­çš„ä¸€è‡´æ€§ã€‚
-   æœ€åï¼Œæœ‰ä¸€ä¸ªå¯æ‰©å±•å…ƒæ ‡ç­¾ã€æ ·å¼ç­‰éœ€è¦ç”¨äº`<head>`ç‰ˆå—ä¸­çš„åŒºå—ã€‚

ä»¥ä¸‹æ˜¯<body>ç‰ˆå—ä¸­çš„è¯¦ç»†è¯´æ˜ï¼š

-   é¦–å…ˆæˆ‘ä»¬æ·»åŠ äº†ç½‘ç«™çš„å¤´éƒ¨å†…å®¹ã€‚è¿™é‡Œå¯ä»¥æ”¾ç½®logoã€ç½‘ç«™æ ‡é¢˜å’Œä¸»å¯¼èˆªã€‚
-   ç„¶åæœ‰ä¸€ä¸ªåŒ…å«å†…å®¹ç‰ˆå—å ä½çš„ä¸»å®¹å™¨åŒºï¼Œè¿™é‡Œå¯é€šè¿‡ç»§æ‰¿è¯¥æ¨¡æ¿è¿›è¡Œå¡«å……ã€‚
-   åœ¨è¿™ä¸€å®¹å™¨å†…æœ‰contentç‰ˆå—ï¼Œå…¶ä¸­åˆåŒ…å«sidebarå’Œmainç‰ˆå—ã€‚åœ¨å­æ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¾§è¾¹æ å¸ƒå±€ã€‚æˆ‘ä»¬å°†ä¼šé‡å†™sidebarå’Œmainç‰ˆå—ï¼Œä½†åœ¨éœ€è¦å…¨å®½å†…å®¹æ—¶ï¼Œæˆ‘ä»¬å°†é‡å†™contentç‰ˆå—ã€‚
-   æ¥ç€æ·»åŠ äº†ç½‘ç«™çš„åº•éƒ¨ã€‚è¿™é‡Œå¯ä»¥æ”¾ç½®ç‰ˆæƒä¿¡æ¯ä»¥åŠé“¾æ¥åˆ°é‡è¦ä¿¡æ¯é¡µé¢çš„é“¾æ¥ï¼Œæ¯”å¦‚éšç§æ”¿ç­–ã€ç”¨æˆ·æ¡æ¬¾ã€è”ç³»è¡¨å•ç­‰ç­‰ã€‚
-   å†åæˆ‘ä»¬åŠ è½½äº†jQueryå’ŒBootstrapè„šæœ¬ã€‚æŒ‰ç…§é¡µé¢åŠ è½½æ€§èƒ½æœ€ä½³å®è·µåœ¨<body>çš„æœ€åé¢æ·»åŠ äº†å¯æ‰©å±•çš„JavaScriptç‰ˆå—ï¼Œè¿™ç±»ä¼¼äº<head>ä¸­çš„æ ·å¼å¤„ç†ã€‚
-   æœ€åï¼Œæœ‰é’ˆå¯¹é¢å¤–JavaScriptå’Œé™„åŠ HTMLçš„ç‰ˆå—ï¼Œå¦‚é’ˆå¯¹JavaScriptçš„HTMLæ¨¡æ¿æˆ–éšè—æ¨¡æ€å¯¹è¯æ¡†ï¼Œåœ¨æœ¬ç« çš„ç¨åå°†ä¼šè®¨è®ºã€‚

æˆ‘ä»¬æ‰€åˆ›å»ºçš„åŸºç¡€æ¨¡æ¿å¹¶éæ˜¯ä¸€ä¸ªä¸€æˆä¸å˜çš„æ¨¡æ¿ã€‚å¯ä»¥ä¿®æ”¹å…¶ç»“æ„æˆ–æ·»åŠ æ‰€éœ€çš„å…ƒç´ ï¼Œä¾‹å¦‚é’ˆå¯¹ bodyå±æ€§çš„æ¨¡æ¿åŒºå—ã€Google Analyticsä»£ç æ®µã€å¸¸ç”¨JavaScriptæ–‡ä»¶ã€é’ˆå¯¹iPhoneä¹¦ç­¾çš„Apple touchå›¾æ ‡ã€Open Graphå…ƒæ ‡ç­¾ã€Twitter Cardæ ‡ç­¾ã€schema.orgå±æ€§ç­‰ç­‰ã€‚è¿˜å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚å®šä¹‰å…¶å®ƒçš„ç‰ˆå—ï¼Œç”šè‡³æ˜¯å°è£…æ•´ä¸ªbodyå†…å®¹ï¼Œä»¥ä¾¿åœ¨å­æ¨¡æ¿ä¸­è¿›è¡Œé‡å†™ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨ Django Sekizai*ä¸€èŠ‚
-   *åœ¨JavaScriptä¸­æš´éœ²é…ç½®*ä¸€èŠ‚

## ä½¿ç”¨ Django Sekizai

åœ¨Djangoæ¨¡æ¿ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨æ¨¡æ¿ç»§æ‰¿æ¥é‡å†™çˆ¶æ¨¡æ¿ä¸­çš„ç‰ˆå—æ¥åœ¨HTMLæ–‡æ¡£ä¸­æ·»åŠ æ ·å¼æˆ–è„šæœ¬ã€‚è¿™è¡¨ç¤ºæ¯ä¸ªè§†å›¾çš„ä¸»æ¨¡æ¿åº”çŸ¥æ™“å…¶å†…çš„æ‰€æœ‰å†…å®¹ï¼›ä½†æœ‰æ—¶è®©æ‰€åŒ…å«æ¨¡æ¿æ¥å†³å®šæ ·å¼å’Œè„šæœ¬çš„åŠ è½½ä¼šæ›´ä¸ºä¾¿æ·ã€‚é€šè¿‡Django Sekizaiå¯è¿›è¡Œå®ç°ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°±æ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ã€‚

### å‡†å¤‡å·¥ä½œ

åœ¨å¼€å§‹æœ¬å°èŠ‚çš„å­¦ä¹ å‰ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥è¿›è¡Œå‡†å¤‡ï¼š

1.  åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…django-classy-tagså’Œdjango-sekizaiï¼ˆå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°requirements/_base.txtä¸­ï¼‰ï¼š


    ```
    (env)$ pip install -e git+https://github.com/divio/django-classy-tags.git@4c94d0354eca1600ad2ead9c3c151ad57af398a4#egg=django-classy-tags
    (env)$ pip install django-sekizai==1.0.0
    ```

1.  ç„¶ååœ¨é…ç½®æ–‡ä»¶çš„å·²å®‰è£…åº”ç”¨ä¸­æ·»åŠ sekizaiï¼š


    ```
    # myproject/settings/_base.py
    INSTALLED_APPS = [ 
      #...
      "sekizai",
      #... 
    ]
    ```

1.  æ¥ç€åœ¨é…ç½®æ–‡ä»¶çš„æ¨¡æ¿é…ç½®ä¸­æ·»åŠ sekizaiä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼š


    ```
    # myproject/settings/_base.py
    TEMPLATES = [ 
      {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [os.path.join(BASE_DIR, "myproject", "templates")], 
        "APP_DIRS": True,
        "OPTIONS": {
          "context_processors": [ 
            "django.template.context_processors.debug", 
            "django.template.context_processors.request", 
            "django.contrib.auth.context_processors.auth", 
            "django.contrib.messages.context_processors.messages", 
            "django.template.context_processors.media", 
            "django.template.context_processors.static", 
            "sekizai.context_processors.sekizai",
          ]
        },
      } 
    ]
    ```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥å®Œæˆæœ¬å°èŠ‚çš„å­¦ä¹ ï¼š

1.  åœ¨base.htmlæ¨¡æ¿çš„å¼€å¤´åŠ è½½sekizai_tagsåº“ï¼š


    ```
    {# base.html #}
    <!doctype html>
    {% load i18n static sekizai_tags %}
    ```

1.  è¿˜æ˜¯åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œåœ¨`<head>`ç‰ˆå—çš„æœ€åï¼Œæ·»åŠ æ¨¡æ¿æ ‡ç­¾{% render_block "css" %}å¦‚ä¸‹ï¼š


    ```
      {% block css %}{% endblock %}
      {% render_block "css" %}
      {% block extra_head %}{% endblock %}
    </head>
    ```

1.  ç„¶ååœ¨`<body>` ç‰ˆå—çš„ç»“æŸå¤„æ·»åŠ æ¨¡æ¿æ ‡ç­¾`{% render_block "js" %}`å¦‚ä¸‹ï¼š


    ```
      {% block js %}{% endblock %}
      {% render_block "js" %}
      {% block extra_body %}{% endblock %}
    </body>
    ```

1.  ç°åœ¨ï¼Œæƒ³åœ¨ä»»æ„æ¨¡æ¿ä¸­æ·»åŠ æ ·å¼æˆ–JavaScriptæ—¶ï¼Œåƒä¸‹é¢è¿™æ ·ä½¿ç”¨`{% addtoblock %}`æ¨¡æ¿æ ‡ç­¾ï¼š


    ```
    {% load static sekizai_tags %}
    <div>Sample widget</div>
    {% addtoblock "css" %}
    <link rel="stylesheet" href="{% static 'site/css/sample-widget.css' %}"/>
    {% endaddtoblock %}
    
    {% addtoblock "js" %}
    <script src="{% static 'site/js/sample-widget.js' %}"></script>
    {% endaddtoblock %}
    ```

### å®ç°åŸç†...

Django Sekizaié€‚ç”¨äº{% include %} æ¨¡æ¿æ ‡ç­¾æ‰€åŒ…å«çš„æ¨¡æ¿ã€é€šè¿‡æ¨¡æ¿æ¸²æŸ“çš„è‡ªå®šä¹‰æ¨¡æ¿æ ‡ç­¾æˆ–é’ˆå¯¹è¡¨å•ç»„ä»¶çš„æ¨¡æ¿ã€‚æ¨¡æ¿æ ‡ç­¾{% addtoblock %}å®šä¹‰äº†æˆ‘ä»¬æƒ³è¦æ·»åŠ HTMLå†…å®¹çš„Sekizaiç‰ˆå—ã€‚

åœ¨Sekizaiç‰ˆå—ä¸­æ·»åŠ å†…å®¹æ—¶ï¼Œdjango-sekizaiè¿›è¡Œä»…åŒ…å«è¯¥å†…å®¹ä¸€æ¬¡çš„å¤„ç†ã€‚è¿™è¡¨ç¤ºå¯ä»¥æœ‰å¤šä¸ªåŒä¸€ç±»å‹çš„ç»„ä»¶ï¼Œä½†å®ƒä»¬çš„CSSå’ŒJavaScriptéƒ½åªä¼šåŠ è½½å¹¶æ‰§è¡Œä¸€æ¬¡ã€‚

### ç›¸å…³å†…å®¹

-   *å®ç°Likeå¾®ä»¶*ä¸€èŠ‚
-   *é€šè¿‡Ajaxä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚

## åœ¨JavaScriptä¸­æš´éœ²é…ç½®

Djangoé¡¹ç›®çš„é…ç½®æ”¾åœ¨settingsæ–‡ä»¶ä¸­ï¼Œå¦‚ç”¨äºå¼€å‘ç¯å¢ƒçš„myproject/settings/dev.pyï¼›æˆ‘ä»¬åœ¨[**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)*ä¸ºå¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®è®¾ç½®*ä¸€èŠ‚ä¸­è¿›è¡Œè¿‡è®²è§£ã€‚å…¶ä¸­æœ‰äº›é…ç½®å€¼å¯ç”¨äºæµè§ˆå™¨çš„åŠŸèƒ½ï¼Œå› æ­¤ä¹Ÿéœ€è¦åœ¨JavaScriptä¸­è¿›è¡Œè®¾ç½®ã€‚æˆ‘ä»¬å¸Œæœ›åœ¨åŒä¸€å¤„å®šä¹‰é¡¹ç›®è®¾ç½®ï¼Œå› æ­¤åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å°†ä¸€äº›Djangoç«¯çš„é…ç½®å€¼ä¼ é€’åˆ°æµè§ˆå™¨ã€‚

### å‡†å¤‡å·¥ä½œ

ç¡®ä¿åœ¨TEMPLATES['OPTIONS']['context_processors'] é…ç½®ä¸­æœ‰è¯·æ±‚ä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼Œå¦‚ä¸‹ï¼š

```
# myproject/settings/_base.py
TEMPLATES = [ 
  {
    "BACKEND": "django.template.backends.django.DjangoTemplates", 
    "DIRS": [os.path.join(BASE_DIR, "myproject", "templates")], "APP_DIRS": True,
    "OPTIONS": {
      context_processors": [
        "django.template.context_processors.debug",
        "django.template.context_processors.request",
        "django.contrib.auth.context_processors.auth", 
        "django.contrib.messages.context_processors.messages", 
        "django.template.context_processors.media", 
        "django.template.context_processors.static", 
        "sekizai.context_processors.sekizai",
      ] 
    },
  } 
]
```

å¦‚æœªåˆ›å»ºçš„è¯ï¼Œè¿˜åº”åˆ›å»ºcoreåº”ç”¨ï¼Œå¹¶å°†å…¶æ·»åŠ è‡³é…ç½®æ–‡ä»¶çš„INSTALLED_APPSä¸­ï¼š

```
INSTALLED_APPS = [ 
  #...
  "myproject.apps.core",
  #... 
]
```

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥åˆ›å»ºå¹¶åŒ…å«JavaScripté…ç½®ï¼š

1.  åœ¨coreåº”ç”¨çš„views.pyæ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªè¿”å›JavaScriptå†…å®¹ç±»å‹çš„js_settings()è§†å›¾ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š


    ```
    # myproject/apps/core/views.py
    import json
    from django.http import HttpResponse
    from django.template import Template, Context
    from django.views.decorators.cache import cache_page 
    from django.conf import settings
    
    JS_SETTINGS_TEMPLATE = """
    window.settings = JSON.parse('{{ json_data|escapejs }}'); 
    """
    
    @cache_page(60 * 15)
    def js_settings(request):
      data = {
        "MEDIA_URL": settings.MEDIA_URL, 
        "STATIC_URL": settings.STATIC_URL, 
        "DEBUG": settings.DEBUG, 
        "LANGUAGES": settings.LANGUAGES,
        "DEFAULT_LANGUAGE_CODE": settings.LANGUAGE_CODE,
        "CURRENT_LANGUAGE_CODE": request.LANGUAGE_CODE, 
      }
      json_data = json.dumps(data)
      template = Template(JS_SETTINGS_TEMPLATE) 
      context = Context({"json_data": json_data}) 
      response = HttpResponse(
        content=template.render(context),
        content_type="application/javascript; charset=UTF-8", 
      )
      return response
    ```

1.  åœ¨URLé…ç½®ä¸­æ’å…¥è¯¥è§†å›¾ï¼š


    ```
    # myproject/urls.py
    from django.conf.urls.i18n import i18n_patterns 
    from django.urls import include, path
    from django.conf import settings
    from django.conf.urls.static import static
    
    from myproject.apps.core import views as core_views
    
    urlpatterns = i18n_patterns(
      # other URL configuration rules... 
      path("js-settings/", core_views.js_settings, name="js_settings"),
    )
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
    urlpatterns += static("/media/", document_root=settings.MEDIA_ROOT)
    ```

1.  é€šè¿‡åœ¨base.htmlæ¨¡æ¿çš„æœ€åæ·»åŠ è¯¥å†…å®¹æ¥åœ¨å‰å°ä¸­åŠ è½½JavaScriptè§†å›¾ï¼š


    ```
    {# base.html #}
      {# ... #}
      
      <script src="{% url 'js_settings' %}"></script>
      {% block js %}{% endblock %}
      {% render_block "js" %}
      {% block extra_body %}{% endblock %}
     </body>
     </html>
    ```

1.  æ­¤æ—¶å¯ä»¥åƒä¸‹é¢è¿™æ ·åœ¨ä»»æ„JavaScriptæ–‡ä»¶ä¸­è®¿é—®å…·ä½“çš„é…ç½®ï¼š


    ```
    if (window.settings.DEBUG) {
      console.warn('The website is running in DEBUG mode!');
    }
    ```

### å®ç°åŸç†...

åœ¨ js_settingsè§†å›¾ä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå¸Œæœ›ä¼ é€’ç»™æµè§ˆå™¨çš„è®¾ç½®å­—å…¸ï¼Œè½¬åŒ–å­—å…¸ä¸ºJSONï¼Œæ¸²æŸ“è§£æè¯¥JSONçš„JavaScriptçš„æ¨¡æ¿å¹¶å°†ç»“æœèµ‹å€¼ç»™window.settings å˜é‡ã€‚é€šè¿‡å°†å­—å…¸è½¬åŒ–ä¸ºJSONå­—ç¬¦ä¸²å¹¶åœ¨JavaScriptæ–‡ä»¶ä¸­è§£æï¼Œæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒæœ€åä¸€ä¸ªå…ƒç´ åé€—å·æ‰€å¸¦æ¥çš„é—®é¢˜ - è¿™åœ¨Pythonä¸­å…è®¸ä½¿ç”¨ï¼Œä½†åœ¨JavaScriptä¸­è§†ä½œæ— æ•ˆã€‚

æ¸²æŸ“åçš„JavaScriptæ–‡ä»¶ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

```
# http://127.0.0.1:8000/en/js-settings/
window.settings = JSON.parse('{\u0022MEDIA_URL\u0022: \u0022http://127.0.0.1:8000/media/\u0022, \u0022STATIC_URL\u0022: \u0022/static/20191001004640/\u0022, \u0022DEBUG\u0022: true, \u0022LANGUAGES\u0022: [[\u0022bg\u0022, \u0022Bulgarian\u0022], [\u0022hr\u0022, \u0022Croatian\u0022], [\u0022cs\u0022, \u0022Czech\u0022], [\u0022da\u0022, \u0022Danish\u0022], [\u0022nl\u0022, \u0022Dutch\u0022], [\u0022en\u0022, \u0022English\u0022], [\u0022et\u0022, \u0022Estonian\u0022], [\u0022fi\u0022, \u0022Finnish\u0022], [\u0022fr\u0022, \u0022French\u0022], [\u0022de\u0022, \u0022German\u0022], [\u0022el\u0022, \u0022Greek\u0022], [\u0022hu\u0022, \u0022Hungarian\u0022], [\u0022ga\u0022, \u0022Irish\u0022], [\u0022it\u0022, \u0022Italian\u0022], [\u0022lv\u0022, \u0022Latvian\u0022], [\u0022lt\u0022, \u0022Lithuanian\u0022], [\u0022mt\u0022, \u0022Maltese\u0022], [\u0022pl\u0022, \u0022Polish\u0022], [\u0022pt\u0022, \u0022Portuguese\u0022], [\u0022ro\u0022, \u0022Romanian\u0022], [\u0022sk\u0022, \u0022Slovak\u0022], [\u0022sl\u0022, \u0022Slovene\u0022], [\u0022es\u0022, \u0022Spanish\u0022], [\u0022sv\u0022, \u0022Swedish\u0022]], \u0022DEFAULT_LANGUAGE_CODE\u0022: \u0022en\u0022, \u0022CURRENT_LANGUAGE_CODE\u0022: \u0022en\u0022}');
```

### ç›¸å…³å†…å®¹

-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)*ä¸ºå¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®è®¾ç½®*ä¸€èŠ‚
-   *ç¼–æ’ base.htmlæ¨¡æ¿*ä¸€èŠ‚
-   *ä½¿ç”¨HTML5 dataå±æ€§*ä¸€èŠ‚

## ä½¿ç”¨HTML5 dataå±æ€§

HTML5ä¸­å¼•å…¥äº†data-*å±æ€§ç”¨è§£ææ¥è‡ªç½‘é¡µæœåŠ¡å™¨ä¸­çš„å…·ä½“HTMLå…ƒç´ ä¸ºJavaScriptå’ŒCSSã€‚åœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ä¸€ç§æœ‰æ•ˆæŠŠDjangoä¸­æ•°æ®æ·»åŠ åˆ°HTML5æ•°æ®å±æ€§ä¸­çš„æ–¹å¼ï¼Œç„¶åç”¨å®ä¾‹è®²è§£å¦‚ä½•åœ¨JavaScriptä¸­è¯»å–è¿™äº›æ•°æ®ï¼šæˆ‘ä»¬å°†æ¸²æŸ“å¸¦æœ‰å…·ä½“åœ°ç†ä½ç½®æ ‡è®°çš„Google Mapï¼›åœ¨ç‚¹å‡»æ ‡è®°æ—¶ï¼Œå°†ä¼šåœ¨ä¿¡æ¯çª—å£ä¸­æ˜¾ç¤ºè¯¥åœ°å€ã€‚

### å‡†å¤‡å·¥ä½œ

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥è¿›è¡Œå‡†å¤‡ï¼š

1.  åœ¨æœ¬ç« åŠæ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ä½¿ç”¨å¸¦æœ‰PostGISæ’ä»¶çš„PostgreSQLæ•°æ®åº“ã€‚è¦äº†è§£å¦‚ä½•å®‰è£…PostGISæ’ä»¶ï¼Œè¯·å‚é˜…[å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/en/3.0/ref/contrib/gis/install/postgis/)ã€‚

1.  ç¡®ä¿åœ¨Djangoé¡¹ç›®ä¸­ä½¿ç”¨äº†postgisæ•°æ®åº“åå°ï¼š


    ```
    # myproject/settings/_base.py
    DATABASES = { 
      "default": {
        "ENGINE": "django.contrib.gis.db.backends.postgis",
        "NAME": get_secret("DATABASE_NAME"),
        "USER": get_secret("DATABASE_USER"),
        "PASSWORD": get_secret("DATABASE_PASSWORD"),
        "HOST": "localhost",
        "PORT": "5432",
      }
    }
    ```

1.  åˆ›å»ºå¸¦æœ‰Locationæ¨¡å‹çš„locationsåº”ç”¨ã€‚å®ƒå°†åŒ…å«ä¸€ä¸ªUUIDä¸»é”®ã€Char å­—æ®µåç§°ã€è¡—é“åœ°å€ã€åŸå¸‚ã€å›½å®¶å’Œé‚®ç¼–ï¼ŒPostGISç›¸å…³çš„Geopositionå­—æ®µä»¥åŠDescriptionæ–‡æœ¬å­—æ®µï¼š


    ```
    # myproject/apps/locations/models.py
    import uuid
    from collections import namedtuple
    from django.contrib.gis.db import models
    from django.urls import reverse
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _ 
    from myproject.apps.core.models import (
      CreationModificationDateBase, UrlBase
    )
    
    COUNTRY_CHOICES = getattr(settings, "COUNTRY_CHOICES", [])
    
    Geoposition = namedtuple("Geoposition", ["latitude", "longitude"])
    
    class Location(CreationModificationDateBase, UrlBase): 
      uuid = models.UUIDField(primary_key=True, default=None, editable=False)
      name = models.CharField(_("Name"), max_length=200) 
      description = models.TextField(_("Description")) 
      street_address = models.CharField(_("Street address"), max_length=255, blank=True) 
      street_address2 = models.CharField(
        _("Street address (2nd line)"), max_length=255, blank=True 
      )
      postal_code = models.CharField(_("Postal code"), max_length=255, blank=True)
      city = models.CharField(_("City"), max_length=255, blank=True)
      country = models.CharField(
        _("Country"), choices=COUNTRY_CHOICES, max_length=255,
        blank=True
      )
      geoposition = models.PointField(blank=True, null=True)
    
      class Meta:
      verbose_name = _("Location") verbose_name_plural = _("Locations")
      def __str__(self): return self.name
    
      def get_url_path(self):
        return reverse("locations:location_detail", kwargs={"pk": self.pk})
    ```

1.  é‡å†™save()æ–¹æ³•æ¥åœ¨åˆ›å»ºåœ°ç‚¹æ—¶ç”Ÿæˆå”¯ä¸€UUIDå­—æ®µï¼š


    ```
    def save(self, *args, **kwargs):
      if self.pk is None: 
        self.pk = uuid.uuid4()
      super().save(*args, **kwargs)
    ```

1.  åˆ›å»ºæ–¹æ³•æ¥ä»¥ä¸€ä¸ªå­—ç¬¦ä¸²è·å–åœ°ç‚¹çš„å®Œæ•´åœ°å€ï¼š


    ```
    def get_field_value(self, field_name):
      if isinstance(field_name, str): 
        value = getattr(self, field_name) 
        if callable(value):
          value = value() 
          return value
      elif isinstance(field_name, (list, tuple)): 
        field_names = field_name
        values = []
        for field_name in field_names:
          value = self.get_field_value(field_name) 
          if value:
            values.append(value) 
        return " ".join(values)
      return ""
    
    def get_full_address(self):
      field_names = [ 
        "name",
        "street_address",
        "street_address2",
        ("postal_code", "city"),
        "get_country_display",
      ]
      full_address = []
      for field_name in field_names:
        value = self.get_field_value(field_name) 
        if value:
          full_address.append(value) 
      return ", ".join(full_address)
    ```

1.  åˆ›å»ºå‡½æ•°æ¥é€šè¿‡çº¬åº¦å’Œç»åº¦æ¥è®¾ç½®åœ°ç†ä½ç½®ï¼Œåœ¨æ•°æ®ä¸­ï¼Œåœ°ç†ä½ç½®ä¿å­˜ä¸ºä¸€ä¸ªPointå­—æ®µã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨Django shellã€è¡¨å•ã€ç®¡ç†å‘½ä»¤ã€æ•°æ®è¿ç§»å’Œå…¶å®ƒåœ°æ–¹ä½¿ç”¨è¿™äº›å‡½æ•°ï¼š


    ```
    def get_geoposition(self):
        print(self.geoposition)
        if not self.geoposition:
            return None
        return Geoposition(
            self.geoposition.coords[0], self.geoposition.coords[1]
        )
    
    def set_geoposition(self, latitude, longitude):
        from django.contrib.gis.geos import Point
        self.geoposition = Point(latitude, longitude, srid=4326)
    ```

1.  åœ¨æ›´æ–°æ¨¡å‹ååˆ«å¿˜è®°ç”Ÿæˆå¹¶è¿è¡Œè¿ç§»ã€‚

1.  åˆ›å»ºæ¨¡å‹ç®¡ç†åå°æ¥æ·»åŠ åŠä¿®æ”¹åœ°ç‚¹ã€‚è¿™é‡Œä¸ä½¿ç”¨æ ‡å‡†çš„ModelAdminï¼Œè€Œæ˜¯ä½¿ç”¨gisåº”ç”¨ä¸­çš„OSMGeoAdminã€‚å®ƒä¼šä½¿ç”¨OpenStreetMapæ¥æ¸²æŸ“ä¸€ä¸ªåœ°å›¾æ¥è®¾ç½®åœ°ç†ä½ç½®ï¼Œå‚è§https://www.openstreetmap.orgï¼š


    ```
    # myproject/apps/locations/admin.py
    from django.contrib.gis import admin 
    from .models import Location
    
    @admin.register(Location)
    class LocationAdmin(admin.OSMGeoAdmin):
      pass
    ```

1.  åœ¨åå°ä¸­æ·»åŠ ä¸€äº›ä½ç½®ä»¥ä¾›ä»Šåä½¿ç”¨ã€‚

æˆ‘ä»¬è¿˜å°†åœ¨åç»­å°èŠ‚ä¸­ä½¿ç”¨å¹¶æ”¹è¿›è¿™ä¸€locationsåº”ç”¨ã€‚

> **è¯‘è€…æ³¨ï¼š1ã€django.core.exceptions.ImproperlyConfigured: Could not find the GDAL library...**
>
> ```
> $ brew install gdal
> ```
>
> å…¶å®ƒå¹³å°å‚è§[å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/en/3.0/ref/contrib/gis/install/geolibs/)
>
> Postgisä¹Ÿå¯é€šè¿‡ Stack Builderï¼ˆSpatial Extensionsï¼‰ æ¥è¿›è¡Œå®‰è£…
>
> **2ã€TemplateDoesNotExist gis/admin/osm.html**
>
> åœ¨INSTALLED_APPSä¸­æ·»åŠ  'django.contrib.gis'

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š

1.  æ³¨å†ŒGoogle Maps APIå¯†é’¥ã€‚å¯ä»¥å‚ç…§[Googleå¼€å‘è€…æ–‡æ¡£](https://developers.google.com/maps/documentation/javascript/get-api-key)äº†è§£å¦‚ä½•æ“ä½œã€‚

1.  åœ¨secretsä¸­æ·»åŠ Google Maps APIå¯†é’¥ï¼Œç„¶ååœ¨è®¾ç½®ä¸­è¿›è¡Œè¯»å–ï¼š


    ```
    # myproject/settings/_base.py
    #...
    GOOGLE_MAPS_API_KEY = get_secret("GOOGLE_MAPS_API_KEY")
    ```

1.  åœ¨coreåº”ç”¨ä¸­ï¼Œåˆ›å»ºä¸Šä¸‹æ–‡å¤„ç†å™¨æ¥å°†GOOGLE_MAPS_API_KEYæš´éœ²åˆ°æ¨¡æ¿ä¸­ï¼š


    ```
    # myproject/apps/core/context_processors.py
    from django.conf import settings
    
    def google_maps(request):
      return {
        "GOOGLE_MAPS_API_KEY": settings.GOOGLE_MAPS_API_KEY, 
      }
    ```

1.  åœ¨æ¨¡æ¿é…ç½®ä¸­å¼•ç”¨è¿™ä¸€ä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼š


    ```
    # myproject/settings/_base.py
    TEMPLATES = [ 
      {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [os.path.join(BASE_DIR, "myproject", "templates")], 
        "APP_DIRS": True,
        "OPTIONS": {
          "context_processors": 
          [ 
            "django.template.context_processors.debug", 
            "django.template.context_processors.request", 
            "django.contrib.auth.context_processors.auth", 
            "django.contrib.messages.context_processors.messages", 
            "django.template.context_processors.media", 
            "django.template.context_processors.static", 
            "sekizai.context_processors.sekizai", 
            "myproject.apps.core.context_processors.google_maps",
          ] 
        },
      } 
    ]
    ```

1.  å¯¹åœ°ç‚¹åˆ›å»ºåˆ—è¡¨åŠè¯¦æƒ…è§†å›¾ï¼š


    ```
    # myproject/apps/locations/views.py
    from django.views.generic import ListView, DetailView 
    from .models import Location
    
    class LocationList(ListView): 
      model = Location 
      paginate_by = 10
    
    class LocationDetail(DetailView): 
      model = Location 
      context_object_name = "location"
    ```

1.  å¯¹locationsåº”ç”¨åˆ›å»ºURLé…ç½®ï¼š


    ```
    # myproject/apps/locations/urls.py
    from django.urls import path
    from .views import LocationList, LocationDetail
    
    urlpatterns = [
      path("", LocationList.as_view(), name="location_list"), 
      path("<uuid:pk>/", LocationDetail.as_view(), name="location_detail"), 
    ]
    ```

1.  åœ¨é¡¹ç›®çš„URLé…ç½®ä¸­åŒ…å«åœ°ç‚¹çš„URLï¼š


    ```
    # myproject/urls.py
    from django.contrib import admin
    from django.conf.urls.i18n import i18n_patterns 
    from django.urls import include, path
    from django.conf import settings
    from django.conf.urls.static import static 
    from django.shortcuts import redirect
    
    from myproject.apps.core import views as core_views
    
    urlpatterns = i18n_patterns(
      path("", lambda request: redirect("locations:location_list")),
      path("admin/", admin.site.urls),
      path("accounts/", include("django.contrib.auth.urls")), 
      path("locations/", include(("myproject.apps.locations.urls", "locations"), namespace="locations")),
      path("js-settings/", core_views.js_settings, name="js_settings"), 
    )
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)
    urlpatterns += static("/media/", document_root=settings.MEDIA_ROOT)
    ```

1.  æ˜¯æ—¶å€™åˆ›å»ºç”¨äºåœ°ç‚¹åˆ—è¡¨å’Œè¯¦æƒ…è§†å›¾çš„æ¨¡æ¿äº†ã€‚åœ°ç‚¹åˆ—è¡¨ç°åœ¨å°½é‡ä¿æŒç®€åŒ–ï¼Œæˆ‘ä»¬åªéœ€è¦èƒ½å¤Ÿæµè§ˆåœ°ç‚¹å¹¶è·å–åœ°ç‚¹è¯¦æƒ…è§†å›¾å³å¯ã€‚


    ```
    {# locations/location_list.html #}
    {% extends "base.html" %}
    {% load i18n %}
    {% block content %}
       <h1>{% trans "Interesting Locations" %}</h1>
       {% if object_list %}
           <ul>
               {% for location in object_list %}
                <li><a href="{{ location.get_url_path }}"> {{ location.name }}</a></li>
               {% endfor %}
           </ul>
        {% else %}
            <p>{% trans "There are no locations yet." %}</p>
        {% endif %}
    {% endblock %}
    ```

1.  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ç»§æ‰¿ base.htmlå¹¶é‡å†™contentç‰ˆå—æ¥åˆ›å»ºä¸€ä¸ªåœ°ç‚¹è¯¦æƒ…çš„æ¨¡æ¿ï¼š


    ```
    {# locations/location_detail.html #}
    {% extends "base.html" %} 
    {% load i18n static %}
    
    {% block content %}
      <a href="{% url 'locations:location_list' %}">{% trans "Interesting Locations" %}</a>
      <h1 class="map-title">{{ location.name }}</h1> 
      <div class="my-3">
        {{ location.description|linebreaks|urlize }} 
      </div>
      {% with geoposition=location.get_geoposition %}
          <div id="map" class="mb-3" data-latitude="{{ geoposition.latitude|stringformat:'f' }}" data-longitude="{{ geoposition.longitude|stringformat:"f" }}" data-address="{{ location.get_full_address }}"><
        /div>
      {% endwith %}
     {% endblock %}
    ```

1.  åŒæ—¶åœ¨åŒä¸€æ¨¡æ¿ä¸­ï¼Œé‡å†™jsç‰ˆå—ï¼š


    ```
    {% block js %}
      <script src="{% static 'site/js/location_detail.js' %}"></script> 
      <script async defer src="https://maps-api-ssl.google.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=Location.init"></script>
    {% endblock %}
    ```

1.   åƒæ¨¡æ¿ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿè¯»å–HTML5 dataå±æ€§çš„JavaScriptæ–‡ä»¶å¹¶ä½¿ç”¨å®ƒä»¬æ¥æ¸²æŸ“å¸¦æœ‰æ ‡è®°çš„åœ°å›¾ï¼š


    ```
    /* site_static/site/js/location_detail.js */
    (function(window) {
      "use strict";
    
      function Location() {
        this.case = document.getElementById("map"); 
        if (this.case) {
          this.getCoordinates(); 
          this.getAddress(); 
          this.getMap(); 
          this.getMarker(); 
          this.getInfoWindow();
        } 
      }
      Location.prototype.getCoordinates = function() { 
        this.coords = {
          lat: parseFloat(this.case.getAttribute("data-latitude")),
          lng: parseFloat(this.case.getAttribute("data-longitude"))
        }; 
      };
    
      Location.prototype.getAddress = function() {
        this.address = this.case.getAttribute("data-address");
      };
    
      Location.prototype.getMap = function() { 
        this.map = new google.maps.Map(this.case, {
          zoom: 15,
          center: this.coords 
        });
      };
    
      Location.prototype.getMarker = function() {
        this.marker = new google.maps.Marker({ 
          position: this.coords,
          map: this.map
        }); 
      };
    
      Location.prototype.getInfoWindow = function() {
        var self = this;
        var wrap = this.case.parentNode;
        var title = wrap.querySelector(".map-title").textContent;
      
        this.infoWindow = new google.maps.InfoWindow({
          content: "<h3>"+title+"</h3><p>"+this.address+"</p>"
        });
        this.marker.addListener("click", function() { 
          self.infoWindow.open(self.map, self.marker);
        }); 
      };
    
      var instance;
      Location.init = function() {
        // called by Google Maps service automatically once loaded
        // but is designed so that Location is a singleton
        if (!instance) {
          instance = new Location(); 
        }
      };
                
      // expose in the global namespace
      window.Location = Location; 
    }(window));
    ```

1.  è¦è®©åœ°å›¾ç¾è§‚çš„æ˜¾ç¤ºï¼Œæˆ‘éœ€è¦ä½¿ç”¨ä¸€äº›CSSï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š


    ```
    /* site_static/site/css/style.css */
    #map {
      box-sizing: padding-box;
      height: 0;
      padding-bottom: calc(9 / 16 * 100%); /* 16:9 aspect ratio */ 
      width: 100%;
    }
    @media screen and (max-width: 480px) {
      #map {
        display: none; /* hide on mobile devices (esp. portrait) */
      } 
    }
    ```

### å®ç°åŸç†...

å¦‚æœè¿è¡Œæœ¬åœ°å¼€å‘æœåŠ¡å™¨å¹¶æµè§ˆåœ°ç‚¹çš„è¯¦æƒ…è§†å›¾ï¼Œä¼šæµè§ˆåˆ°å¸¦æœ‰åœ°å›¾åŠæ ‡è®°çš„é¡µé¢ã€‚è€Œåœ¨ç‚¹å‡»æ ‡è®°æ—¶ï¼Œä¼šå¼¹å‡ºåœ°å€ä¿¡æ¯ã€‚åƒä¸‹é¢è¿™æ ·ï¼š


![Interesting Locations](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ea7e09cee614ebda8a58aa2e7891322~tplv-k3u1fbpfcp-watermark.image?)

ç§»åŠ¨è®¾å¤‡å› æ»šåŠ¨å åŠ çš„åŸå› è€Œæ— æ³•åœ°å›¾ä¸­æ»šåŠ¨ï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨å°å±ï¼ˆå®½åº¦å°äº480 pxï¼‰ä¸Šéšè—åœ°å›¾ï¼Œå› è€Œåœ¨ç¼©å°å±å¹•æ—¶ï¼Œåœ°å›¾æœ€ç»ˆä¼šä¸å¯è§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![Interesting Locationsæ‰‹æœº](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5706182c3b8843b1903b6c925caa912a~tplv-k3u1fbpfcp-zoom-1.image)

æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ä»£ç ã€‚åœ¨å‰å‡ æ­¥ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†Google Maps API å¯†é’¥å¹¶å¯¹æ‰€æœ‰æ¨¡æ¿è¿›è¡Œäº†æš´éœ²ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºäº†è§†å›¾æ¥æµè§ˆåœ°ç‚¹å¹¶å°†å®ƒä»¬æ’å…¥åˆ°äº†URLé…ç½®ä¸­ã€‚æ¥ç€åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨åŠè¯¦æƒ…æ¨¡æ¿ã€‚

> â„¹ï¸DetailViewçš„é»˜è®¤template_nameä¸ºå°å†™ç‰ˆæœ¬çš„æ¨¡å‹åï¼ŒåŠ ä¸Šdetailï¼›å› æ­¤æˆ‘ä»¬çš„æ¨¡æ¿æ–‡ä»¶åä¸ºlocation_detail.htmlã€‚å¦‚æœå¸Œæœ›ä½¿ç”¨å…¶å®ƒçš„æ¨¡æ¿ï¼Œå¯ä»¥åœ¨è§†å›¾ä¸­æŒ‡å®štemplate_nameå±æ€§ã€‚åŒç†ï¼ŒListViewçš„é»˜è®¤template_nameä¸ºå°å†™ç‰ˆæœ¬çš„æ¨¡å‹åï¼ŒåŠ ä¸Šlistï¼Œå› è€Œåç§°ä¸ºlocation_list.htmlã€‚

åœ¨è¯¦æƒ…æ¨¡æ¿ä¸­ï¼Œid="map"çš„`<div>`å…ƒç´ åé¢æ¥åœ°ç‚¹æ ‡é¢˜å’Œæè¿°ï¼Œä»¥åŠdata-latitudeã€data-longitudeå’Œdata-addresså±æ€§ã€‚è¿™äº›å…±åŒç»„æˆäº†contentç‰ˆå—çš„å…ƒç´ ã€‚`<body>`æœ€åé¢çš„jsç‰ˆå—ä¸­æ·»åŠ äº†ä¸¤ä¸ª`<script>`æ ‡ç­¾ï¼Œä¸€ä¸ªæ˜¯åé¢ä¼šè®²åˆ°çš„location_detail.jsï¼Œå¦ä¸€ä¸ªæ˜¯Google Maps APIè„šæœ¬ï¼Œå¯¹å…¶ä¼ é€’Maps APIå¯†é’¥ä»¥åŠAPIåŠ è½½æ—¶çš„å›è°ƒå‡½æ•°åç§°ã€‚

åœ¨JavaScriptæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨prototypeå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªLocationç±»ã€‚è¯¥å‡½æ•°æœ‰ä¸€ä¸ªé™æ€init()æ–¹æ³•ï¼Œç»™å®šä¸ºGoogle Maps APIçš„å›è°ƒå‡½æ•°ã€‚åœ¨è°ƒç”¨init()æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ„é€ å‡½æ•°æ¥åˆ›å»ºå•ä¸ªLocationå®ä¾‹ã€‚åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œé‡‡å–äº†ä¸€ç³»åˆ—æ­¥éª¤æ¥è®¾ç½®åœ°å›¾åŠå…¶åŠŸèƒ½ï¼š

1.  é¦–å…ˆé€šè¿‡IDæ‰¾åˆ°mapçš„å£³ï¼ˆå®¹å™¨ï¼‰ã€‚ä»…åœ¨æ‰¾åˆ°å…ƒç´ æ—¶æ‰ä¼šç»§ç»­ã€‚
1.  ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨data-latitudeå’Œdata-longitudeå±æ€§æ¥æŸ¥æ‰¾åœ°ç†åæ ‡ï¼Œå°†å®ƒä»¬å­˜å‚¨ä¸ºå­—å…¸æ¥ä½œä¸ºåœ°ç‚¹çš„åæ ‡ã€‚è¿™ä¸€å¯¹è±¡æ˜¯Google Maps APIæ‰€èƒ½è¯†åˆ«çš„å½¢å¼ï¼Œåœ¨ç¨åä½¿ç”¨ã€‚
1.  ä¸‹é¢è¯»å–data-addressï¼Œå¹¶å°†å…¶ç›´æ¥å­˜å‚¨ä¸ºåœ°ç‚¹çš„åœ°å€å±æ€§ã€‚
1.  ç°åœ¨æˆ‘ä»¬è¿›è¡Œæ„å»ºï¼Œä»åœ°å›¾å¼€å§‹ã€‚è¦ç¡®ä¿åœ°ç‚¹å¯è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¹‹å‰ä»æ•°æ®å±æ€§ä¸­æ‹‰å–çš„åæ ‡ä½œä¸ºä¸­ç‚¹ã€‚
1.  æ ‡è®°ä¼šè®©åœ°ç‚¹åœ¨åœ°å›¾ä¸Šæ›´æ˜æ˜¾ï¼Œä½ç½®ä½¿ç”¨åŒæ ·çš„åæ ‡ã€‚
1.  æœ€åï¼Œæˆ‘ä»¬æ„å»ºä¿¡æ¯å®¹å™¨ï¼Œè¿™æ˜¯ä¸€ç§ä½¿ç”¨APIç›´æ¥åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºçš„æ°”æ³¡å¼¹çª—ã€‚é™¤æ­¤å‰è·å–çš„åœ°å€å¤–ï¼Œæˆ‘ä»¬è¿˜æ ¹æ®æ¨¡æ¿ä¸­æŒ‡å®šçš„.map-titleç±»æ¥æŸ¥æ‰¾åœ°ç‚¹æ ‡é¢˜ã€‚å®ƒä¼šåœ¨çª—å£ä¸­ä»¥`<h1>`æ ‡é¢˜è¿›è¡Œæ·»åŠ ï¼Œåæ¥ä¸º`<p>`æ®µè½çš„åœ°å€ã€‚ä¸ºèƒ½æ˜¾ç¤ºè¯¥çª—å£ï¼Œæˆ‘ä»¬å¯¹æ ‡è®°æ·»åŠ äº†ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨æ¥æ‰“å¼€è¯¥çª—å£ã€‚

### ç›¸å…³å†…å®¹

-   åœ¨JavaScriptä¸­æš´éœ²é…ç½®
-   ç¼–æ’ base.htmlæ¨¡æ¿
-   æä¾›å“åº”å¼å›¾ç‰‡
-   åœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­æ‰“å¼€å¯¹è±¡è¯¦æƒ…
-   [**ç¬¬6ç«  æ¨¡å‹ç®¡ç†**](https://alanhou.org/django3-model-administration/)ä¸­çš„*åœ¨ä¿®æ”¹è¡¨å•ä¸­æ’å…¥åœ°å›¾*ä¸€èŠ‚

## æä¾›å“åº”å¼å›¾ç‰‡

å“åº”å¼ç½‘ç«™å·²æˆä¸ºå¸¸è§„æ“ä½œï¼Œåœ¨å¯¹ç§»åŠ¨è®¾å¤‡å’Œå°å¼æœºæä¾›åŒæ ·å†…å®¹æ—¶æµ®ç°å‡ºäº†å¾ˆå¤šæ€§èƒ½é—®é¢˜ã€‚ä¸€ç§åœ¨å°å±è®¾å¤‡ä¸Šé™ä½è´Ÿè½½æ—¶é—´çš„ç®€æ˜“æ–¹å¼æ˜¯æä¾›æ›´å°çš„å›¾ç‰‡ã€‚è¿™æ­£æ˜¯å“åº”å¼å›¾ç‰‡çš„æ ¸å¿ƒç»„ä»¶srcsetå’Œsizeså±æ€§å‘å…‰å‘çƒ­çš„åœ°æ–¹ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨å‰ä¸€å°èŠ‚ä¸­çš„locationsåº”ç”¨ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥æ·»åŠ å“åº”å¼å›¾ç‰‡ï¼š

1.  é¦–å…ˆåœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…django-imagekitå¹¶æ·»åŠ åˆ°requirements/_base.txt.ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨å®ƒæ¥å°†åŸå§‹å›¾ç‰‡ä¿®æ”¹ä¸ºæŒ‡å®šå°ºå¯¸ï¼š


    ```
    (env)$ pip install django-imagekit==4.0.2
    ```

1.  åœ¨è®¾ç½®æ–‡ä»¶çš„INSTALLED_APPSä¸­æ·»åŠ  imagekitï¼š


    ```
    # myproject/settings/_base.py
    INSTALLED_APPS = [ 
      #...
      "imagekit",
      #... 
    ]
    ```

1.  åœ¨models.pyæ–‡ä»¶çš„å¼€å¤´å¤„ï¼Œå¯¼å…¥ä¸€äº›ç”¨äºå›¾ç‰‡ç‰ˆæœ¬çš„åº“ã€å¹¶å®šä¹‰ä¸€ä¸ªç”¨äºå›¾ç‰‡æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶åçš„å‡½æ•°ï¼š


    ```
    # myproject/apps/locations/models.py
    import contextlib
    import os
    #...
    from imagekit.models import ImageSpecField 
    from pilkit.processors import ResizeToFill 
    #...
    
    def upload_to(instance, filename):
      now = timezone_now()
      base, extension = os.path.splitext(filename)
      extension = extension.lower()
      return f"locations/{now:%Y/%m}/{instance.pk}{extension}"
    ```

1.  æ­¤æ—¶å¯¹å®šä¹‰å›¾ç‰‡ç‰ˆæœ¬ç›¸åŒæ–‡ä»¶ä¸­çš„Locationæ¨¡å‹æ·»åŠ pictureå­—æ®µï¼š


    ```
    class Location(CreationModificationDateBase, UrlBase): 
      #...
      picture = models.ImageField(_("Picture"), upload_to=upload_to) 
      picture_desktop = ImageSpecField(
        source="picture", 
        processors=[ResizeToFill(1200, 600)], 
        format="JPEG",
        options={"quality": 100},
      )
      picture_tablet = ImageSpecField(
        source="picture", processors=[ResizeToFill(768, 384)], 
        format="PNG"
      )
      picture_mobile = ImageSpecField(
        source="picture", processors=[ResizeToFill(640, 320)], 
        format="PNG"
      )
    ```

1.  ç„¶åå¯¹Locationæ¨¡å‹é‡å†™delete()æ–¹æ³•æ¥åœ¨åˆ é™¤æ¨¡å‹å®ä¾‹æ—¶åˆ é™¤æ‰€ç”Ÿæˆçš„ç‰ˆæœ¬æ–‡ä»¶ï¼š\


    ```
    def delete(self, *args, **kwargs):
      from django.core.files.storage import default_storage
      
      if self.picture:
        with contextlib.suppress(FileNotFoundError):
          default_storage.delete(self.picture_desktop.path) 
          default_storage.delete(self.picture_tablet.path) 
          default_storage.delete(self.picture_mobile.path)
        self.picture.delete() 
    
      super().delete(*args, **kwargs)
    ```

1.  æ·»åŠ å¹¶è¿è¡Œè¿ç§»æ¥åœ¨æ•°æ®åº“æ¨¡å¼ä¸­æ·»åŠ æ–°çš„å›¾ç‰‡å­—æ®µã€‚

1.  æ›´æ–°åœ°ç‚¹è¯¦æƒ…æ¨¡æ¿æ¥åŒ…å«å›¾ç‰‡ï¼š


    ```
    {# locations/location_detail.html #}
    {% extends "base.html" %} 
    {% load i18n static %}
    
    {% block content %}
      <a href="{% url "locations:location_list" %}">{% trans "Interesting Locations" %}</a>
      <h1 class="map-title">{{ location.name }}</h1> 
      {% if location.picture %}
        <picture class="img-fluid"> 
          <source
            media="(max-width: 480px)"
            srcset="{{ location.picture_mobile.url }}" /> 
          <source
            media="(max-width: 768px)"
            srcset="{{ location.picture_tablet.url }}" /> 
          <img
            src="{{ location.picture_desktop.url }}" 
            alt="{{ location.name }}" 
            class="img-fluid"
          />
        </picture>
      {% endif %}
      {# ... #} 
    {% endblock %}
    
    {% block js %} 
      {# ... #}
    {% endblock %}
    ```

1.  æœ€åï¼Œåœ¨åå°ä¸­å¯¹åœ°ç‚¹æ·»åŠ è¿™äº›å›¾ç‰‡ã€‚

### å®ç°åŸç†...

å“åº”å¼å›¾ç‰‡å¾ˆå¼ºå¤§ï¼Œå¹¶ä¸”åº•å±‚åœ¨äºæ ¹æ®å±•ç¤ºå›¾ç‰‡æ˜¾ç¤ºè®¾å¤‡ç‰¹æ€§çš„mediaè§„åˆ™æ¥æä¾›ä¸åŒçš„å›¾ç‰‡ã€‚æˆ‘ä»¬é¦–å…ˆåšçš„æ˜¯æ·»åŠ django-imagekiåº”ç”¨ï¼Œè¿™è®©å…¶å¯ä»¥å®æ—¶æŒ‰éœ€ç”Ÿæˆä¸åŒçš„å›¾ç‰‡ã€‚

å¾ˆæ˜æ˜¾æˆ‘ä»¬è¿˜éœ€è¦åŸå§‹å›¾ç‰‡ï¼Œå› æ­¤åœ¨Locationæ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªåä¸ºpictureçš„å›¾ç‰‡å­—æ®µã€‚åœ¨ upload_to()å‡½æ•°ä¸­ï¼Œ æˆ‘ä»¬é€šè¿‡å¹´æœˆå’Œåœ°ç‚¹çš„UUIDä»¥åŠä¸Šä¼ æ–‡ä»¶çš„æ‰©å±•åæ„å»ºäº†uploadè·¯å¾„å’Œæ–‡ä»¶åã€‚æˆ‘ä»¬è¿˜åƒä¸‹é¢è¿™æ ·å®šä¹‰äº†å›¾ç‰‡ç‰ˆæœ¬è§„æ ¼ï¼š

-   picture_desktopå°ºå¯¸ä¸º1,200 x 600ï¼Œç”¨äºæ¡Œé¢ç”µè„‘å¸ƒå±€
-   picture_tabletçš„å°ºå¯¸ä¸º768 x 384ï¼Œç”¨äºå¹³æ¿ç”µè„‘
-   picture_mobileçš„å°ºå¯¸ä¸º640 x 320ï¼Œç”¨äºæ™ºèƒ½æ‰‹æœº

åœ¨åœ°ç‚¹çš„delete() æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æŸ¥çœ‹pictureå­—æ®µæ˜¯å¦æœ‰å€¼ï¼Œç„¶ååœ¨åˆ é™¤åœ°ç‚¹æœ¬èº«å‰ä¼šå»åˆ é™¤è¯¥å­—æ®µä»¥åŠå„å›¾ç‰‡ç‰ˆæœ¬ã€‚åœ¨ç£ç›˜ä¸Šæ‰¾ä¸åˆ°æ–‡ä»¶æ—¶æˆ‘ä»¬ä½¿ç”¨contextlib.suppress(FileNotFoundError)æ¥é™é»˜åœ°å¿½ç•¥é”™è¯¯ã€‚

æœ€æœ‰è¶£çš„éƒ¨åˆ†åœ¨æ¨¡æ¿ä¸­ã€‚åœ¨åœ°ç‚¹çš„å›¾ç‰‡å­˜åœ¨æ—¶ï¼Œæˆ‘ä»¬æ„å»º`<picture>`å…ƒç´ ã€‚è¡¨é¢ä¸Šè¿™åŸºæœ¬æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚è€Œäº‹å®ä¸Šå…¶ä¸­é™¤å»ç°åœ¨æ¨¡æ¿å°¾éƒ¨çš„`<img>`å¤–é‡Œé¢æ²¡æœ‰å…¶å®ƒå†…å®¹ï¼Œä½†å…¶ç”¨å¤„å¾ˆå¤§ã€‚é™¤é»˜è®¤å›¾ç‰‡å¤–ï¼Œæˆ‘ä»¬è¿˜ç”Ÿæˆäº†å…¶å®ƒå¤§å°çš„ç¼©ç•¥å›¾ - 480 px å’Œ 768 pxï¼Œå®ƒä»¬ç”¨äºæ„å»ºé¢å¤–çš„`<source>`å…ƒç´ ã€‚æ¯ä¸ª<source>å…ƒç´ å…·æœ‰mediaè§„åˆ™æ¡ä»¶ï¼Œæ ¹æ®æ¡ä»¶åœ¨srcsetå±æ€§å€¼ä¸­é€‰æ‹©å›¾ç‰‡ã€‚æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»…ä¸ºæ¯ä¸ª<source>æä¾›äº†ä¸€å¼ å›¾ç‰‡ã€‚åœ°ç‚¹è¯¦æƒ…é¡µé¢æ­¤æ—¶ä¼šåœ¨åœ°å›¾ä¸ŠåŒ…å«å›¾ç‰‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š


![åœ°å›¾åŠ å›¾ç‰‡ PC](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74e9b50cac2345b58273dae1ac7c15a6~tplv-k3u1fbpfcp-watermark.image?)

åœ¨æµè§ˆå™¨åŠ è½½æ ‡è®°æ—¶ï¼Œä¼šæŒ‰ç…§ä¸€ç³»åˆ—æ­¥éª¤æ¥å†³å®šåŠ è½½å“ªå¼ å›¾ç‰‡ï¼š

-   è½®æµæ£€æŸ¥æ¯ä¸ª`<source>`çš„mediaè§„åˆ™ï¼ŒæŸ¥çœ‹å…¶ä¸­æ˜¯å¦æœ‰åŒ¹é…å½“å‰è§†çª—çš„
-   åœ¨è§„åˆ™åŒ¹é…æ—¶è¯»å–srcsetå¹¶åŠ è½½å’Œæ˜¾ç¤ºç›¸åº”çš„å›¾ç‰‡URL
-   å¦‚æ— è§„åˆ™åŒ¹é…ï¼Œé‚£æœ€ç»ˆä½¿ç”¨srcï¼ŒåŠ è½½é»˜è®¤å›¾ç‰‡

ç»“æœæ˜¯åœ¨è¾ƒå°çš„è§†çª—ä¸­ä¼šåŠ è½½è¾ƒå°çš„å›¾ç‰‡ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»…375 pxå®½çš„è§†çª—ä¼šåŠ è½½æœ€å°çš„å›¾ç‰‡ï¼š

![åœ°å›¾åŠ å›¾ç‰‡æ‰‹æœº](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40c1e7f9d03d4049905edb982921e362~tplv-k3u1fbpfcp-zoom-1.image)

å¯¹äºå®Œå…¨æ— æ³•è¯†åˆ«`<picture>` å’Œ `<source>`çš„æµè§ˆå™¨ï¼Œè¿˜æ˜¯èƒ½åŠ è½½é»˜è®¤å›¾ç‰‡ï¼Œé‚£æ ·ä¸æ™®é€šçš„<img>å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚

### æ‰©å±•çŸ¥è¯†...

ä¸ä»…å¯ä»¥ä½¿ç”¨å“åº”å¼å›¾ç‰‡æ¥æä¾›ç›®æ ‡å›¾ç‰‡å°ºå¯¸ï¼Œä¹Ÿå¯ä»¥åŒºåˆ†åƒç´ å¯†åº¦æ¥æä¾›å¯¹ç»™å®šè§†çª—å°ºå¯¸è®¾è®¡æ‰€æ˜¾å¼å‰ªåˆ‡çš„å›¾ç‰‡ã€‚è¿™è¢«ç§°ä¹‹ä¸ºart directionã€‚å¦‚æœæƒ³è¦äº†è§£ï¼Œè¯·é˜…è¯»Mozillaå¼€å‘è€…ç½‘ç»œï¼ˆMDNï¼‰ä¸Šæœ‰å…³è¯¥ä¸»é¢˜çš„æ–‡ç« ï¼Œ[ç‚¹å‡»è®¿é—®](https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images)ã€‚

### ç›¸å…³å†…å®¹

-   *ç¼–æ’ base.htmlæ¨¡æ¿*ä¸€èŠ‚
-   *ä½¿ç”¨HTML5 dataå±æ€§*ä¸€èŠ‚
-   *åœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­æ‰“å¼€å¯¹è±¡è¯¦æƒ…*ä¸€èŠ‚
-   [**ç¬¬6ç«  æ¨¡å‹ç®¡ç†**](https://alanhou.org/django3-model-administration/)*åœ¨ä¿®æ”¹è¡¨å•ä¸­æ’å…¥åœ°å›¾*ä¸€èŠ‚

## å®ç°æŒç»­æ»šåŠ¨

ç¤¾äº¤ç½‘ç«™å¸¸å¸¸ä¼šæœ‰æŒç»­æ»šåŠ¨çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡æ— é™ä¸‹æ‹‰æ»šåŠ¨æ¥å®ç°ç¿»é¡µåŠŸèƒ½ã€‚è¿™ç§æ–¹å¼ä¸æ˜¯é€šè¿‡é“¾æ¥æ¥å•ç‹¬è·å–æ›´å¤šçš„å†…å®¹é›†åˆï¼Œè€Œæ˜¯ä¸€ä¸ªå­é¡¹é•¿åˆ—è¡¨ï¼Œåœ¨é¡µé¢ä¸‹æ‹‰æ»šåŠ¨æ—¶ï¼ŒåŠ è½½æ–°é¡¹å¹¶è‡ªåŠ¨åŠ å…¥åˆ°é¡µé¢åº•éƒ¨ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•é€šè¿‡Djangoå’Œ jScroll jQuery æ’ä»¶æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚

> â„¹ï¸å¯ä»¥é€šè¿‡https://jscroll.com/ ä¸‹è½½jScrollè„šæœ¬å¹¶é˜…è¯»æœ‰å…³è¯¥æ’ä»¶çš„æ–‡æ¡£ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬å°†å¤ç”¨å‰é¢å°èŠ‚ä¸­æ‰€åˆ›å»ºçš„locationsåº”ç”¨ã€‚

ä¸ºäº†è®©åˆ—è¡¨è§†å›¾ä¸­æ˜¾ç¤ºçš„å†…å®¹æ›´ä¸ºä¸°å¯Œï¼Œæˆ‘ä»¬åœ¨Locationæ¨¡å‹ä¸­æ·»åŠ ä¸€ä¸ªratingå­—æ®µï¼Œå¦‚ä¸‹ï¼š

```
# myproject/apps/locations/models.py
#...
RATING_CHOICES = ((1, "â˜…â˜†â˜†â˜†â˜†"), (2, "â˜…â˜…â˜†â˜†â˜†"), (3, "â˜…â˜…â˜…â˜†â˜†"), (4, "â˜…â˜…â˜…â˜…â˜†"), (5, "â˜…â˜…â˜…â˜…â˜…"))

class Location(CreationModificationDateBase, UrlBase): 
  #...
  rating = models.PositiveIntegerField(
    _("Rating"), choices=RATING_CHOICES, blank=True, null=True
  )

  #...
  def get_rating_percentage(self):
    return self.rating * 20 if self.rating is not None else None
```

get_rating_percentage()æ–¹æ³•ç”¨äºä»¥ç™¾åˆ†æ¯”å½¢å¼è¿”å›è¯„åˆ†ã€‚

åˆ«å¿˜äº†è¿ç§»æ“ä½œï¼Œç„¶ååœ¨åå°ä¸­å¯¹åœ°ç‚¹æ·»åŠ è¯„çº§ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥åˆ›å»ºæŒç»­æ»šåŠ¨é¡µé¢ï¼š

1.  é¦–å…ˆåœ¨åå°ä¸­æ·»åŠ è¶³å¤Ÿå¤šçš„åœ°ç‚¹ã€‚å‚ç…§*ä½¿ç”¨HTML5 dataå±æ€§*ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¼šæ·»åŠ ä¸€ä¸ªæ¯é¡µ10é¡¹çš„LocationListè§†å›¾ï¼Œå› æ­¤è‡³å°‘éœ€è¦11ä¸ªåœ°ç‚¹æ¥éªŒè¯æŒç»­æ»šåŠ¨çš„æ•ˆæœã€‚

1.  ä¿®æ”¹åœ°ç‚¹åˆ—è¡¨è§†å›¾çš„æ¨¡æ¿å¦‚ä¸‹ï¼š


    ```
    {# locations/location_list.html #}
    {% extends "base.html" %}
    {% load i18n static utility_tags %}
    
    {% block content %} 
      <div class="row">
        <div class="col-lg-8">
        <h1>{% trans "Interesting Locations" %}</h1> 
        {% if object_list %}
          <div class="item-list">
            {% for location in object_list %}
              <a href="{{ location.get_url_path }}" class="item d-block my-3">
                <div class="card">
                  <div class="card-body">
                    <div class="float-right"> 
                      <div class="rating" aria-label="{% blocktrans with stars=location.rating %} {{ stars }} of 5 stars {% endblocktrans %}">
                        <span style="width:{{ location.get_rating_percentage }}%"></span>
                      </div>
                    </div>
                    <p class="card-text">{{ location.name }}<br/> 
                      <small>{{ location.city }},{{location.get_country _display }}</small>
                    </p> 
                  </div>
                </div> 
              </a>
            {% endfor %}
            {% if page_obj.has_next %}
              <div class="text-center">
                <div class="loading-indicator"></div>
              </div>
              <p class="pagination">
                <a class="next-page" href="{% modify_query page=page_obj.next_page_number %}">
                  {% trans "More..." %}
                </a>
              </p>
            {% endif %}
          </div>
        {% else %}
          <p>{% trans "There are no locations yet." %}</p> 
        {% endif %}
      </div>
      <div class="col-lg-4">
        {% include "locations/includes/navigation.html" %} </div>
      </div>
    {% endblock %}
    ```

1.  åœ¨åŒä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç é‡å†™csså’Œjsä»£ç å—ï¼š


    ```
    {% block css %}
      <link rel="stylesheet" type="text/css" href="{% static 'site/css/rating.css' %}"> 
    {% endblock %}
    {% block js %}
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jscroll/2.3.9/jquery.jscroll.min.js"></script> 
      <script src="{% static 'site/js/list.js' %}"></script>
    {% endblock %}
    ```

1.  æ¨¡æ¿ä¸­çš„æœ€åä¸€æ­¥æ˜¯ç”¨JavaScripté‡å†™extra_bodyç‰ˆå—æ¥æ·»åŠ åŠ è½½ä¸­çš„å›¾æ ‡ï¼š


    ```
    {% block extra_body %}
      <script type="text/template" class="loader">
        <div class="text-center">
          <div class="loading-indicator"></div>
        </div>
      </script>
    {% endblock %}
    ```

1.  åˆ›å»ºé¡µé¢å¯¼èˆªåœ°å€ä¸ºlocations/includes/navigation.htmlã€‚ç›®å‰ä¿æŒä¸ºç©ºå³å¯ã€‚

1.  ä¸‹ä¸€æ­¥æ·»åŠ JavaScriptåˆå§‹åŒ–æŒç»­æ»šåŠ¨ç»„ä»¶ï¼š


    ```
    /* site_static/site/js/list.js */
    jQuery(function ($) {
      var $list = $('.item-list');
      var $loader = $('script[type="text/template"].loader'); 
      $list.jscroll({
        loadingHtml: $loader.html(), 
        padding: 100,
        pagingSelector: '.pagination', 
        nextSelector: 'a.next-page:last', 
        contentSelector: '.item,.pagination'
      }); 
    });
    ```

1.  æœ€åï¼Œæˆ‘æ·»åŠ ä¸€äº›CSSæ¥è®©è¯„åˆ†æ˜¾ç¤ºä¸ºå¯¹ç”¨æˆ·æ›´å‹å¥½çš„æ˜Ÿæ ‡ï¼Œè€Œä¸æ˜¯å¹²å·´å·´çš„æ•°å­—ï¼š


    ```
    /* site_static/site/css/rating.css */
    .rating {
      color: #c90; 
      display: block; 
      position: relative; 
      margin: 0;
      padding: 0; 
      white-space: nowrap;
    }
    
    .rating span { 
      color: #fc0; 
      display: block; 
      position: absolute; 
      overflow: hidden; 
      top: 0;
      left: 0;
      bottom: 0; 
      white-space: nowrap;
    }
    
    .rating span:before, .rating span:after {
      display: block;
      position: absolute;
      overflow: hidden;
      left: 0;
      top: 0;
      bottom: 0; 
    }
    
    .rating:before { 
      content: "â˜†â˜†â˜†â˜†â˜†";
    }
    
    .rating span:after { 
      content: "â˜…â˜…â˜…â˜…â˜…";
    }
    ```

1.  åœ¨ç½‘ç«™ä¸»æ ·å¼æ–‡ä»¶ä¸­ï¼Œæ·»åŠ åŠ è½½ä¸­çš„æ ·å¼ï¼š


    ```
    /* site_static/site/css/style.css */
    /* ... */ 
    .loading-indicator {
      display: inline-block; width: 45px;
      height: 45px;
    }
    .loading-indicator:after {
      content: "";
      display: block;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 5px solid rgba(0,0,0,.25);
      border-color: rgba(0,0,0,.25) transparent rgba(0,0,0,.25) transparent; 
      animation: dual-ring 1.2s linear infinite;
    }
    @keyframes dual-ring {
      0% {
        transform: rotate(0deg);
      } 
      100% {
        transform: rotate(360deg);
      }
    }
    ```

### å®ç°åŸç†...

åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åœ°ç‚¹åˆ—è¡¨è§†å›¾æ—¶ï¼Œä¼šåœ¨é¡µé¢ä¸­æ˜¾ç¤ºé€šè¿‡åœ¨è§†å›¾ä¸­ç”±paginate_byé¢„è®¾çš„æ¡æ•°ï¼ˆå³10æ¡ï¼‰ã€‚åœ¨ä¸‹æ‹‰æ—¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µå¹¶å°†è·å–åˆ°çš„å†…å®¹æ·»åŠ è‡³å®¹å™¨ä¸­ã€‚é¡µé¢é“¾æ¥ä½¿ç”¨[**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚ä¸­æ‰€ä»‹ç»çš„`{% modify_query %}`è‡ªå®šä¹‰æ¨¡æ¿æ ‡ç­¾æ¥å³æ ¹æ®å½“å‰é“¾æ¥ç”Ÿæˆç›¸åº”çš„URLï¼ŒæŒ‡å‘å¯¹åº”çš„ä¸‹ä¸€é¡µã€‚å¦‚æœç½‘é€Ÿè¾ƒæ…¢ï¼Œé‚£ä¹ˆåœ¨æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨æ—¶ï¼Œä¼šåœ¨ä¸‹ä¸€é¡µåŠ è½½å®Œæˆå¹¶æ·»åŠ è‡³å½“å‰åˆ—è¡¨å‰çœ‹åˆ°å¦‚ä¸‹é¢è¿™æ ·çš„é¡µé¢ï¼š

![jscroll æ— é™ä¸‹æ‹‰](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/568f11b7657240988aef8aeec93b4cec~tplv-k3u1fbpfcp-zoom-1.image)

è¿›ä¸€æ­¥è¿›è¡Œæ»šåŠ¨ï¼Œç¬¬äºŒã€ç¬¬ä¸‰é¡µåŠåç»­é¡µé¢çš„å†…å®¹ä¼šæ·»åŠ è‡³åº•éƒ¨ã€‚ç›´æ¥æ²¡æœ‰æ›´å¤šé¡µé¢å¯ä¾›åŠ è½½ï¼Œä½“ç°ä¸ºæœ€åä¸€ç»„ä¸­æ²¡æœ‰è¿›è¡Œä¸€æ­¥å¯ä¾›åŠ è½½çš„åˆ†é¡µé“¾æ¥ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Cloudflare CDN URLæ¥åŠ è½½jScrollï¼Œä½†å¦‚æœä½ é€‰æ‹©ä¸‹è½½æ–‡ä»¶è‡³æœ¬åœ°ï¼Œé‚£ä¹ˆä½¿ç”¨{% static %}æŸ¥è¯¢åœ¨æ·»åŠ è„šæœ¬è‡³æœ¬åœ°æ¨¡æ¿ã€‚

åœ¨åˆå§‹åŠ è½½é¡µé¢æ—¶ï¼Œå…ƒç´ å…·æœ‰item-list CSSç±»ï¼ŒåŒ…å«é¡µé¢å†…å®¹åŠåˆ†é¡µé“¾æ¥ï¼Œå¯é€šè¿‡list.jsä¸­çš„ä»£ç è½¬å˜ä¸ºjScrollå¯¹è±¡ã€‚å…¶å®è¿™ç§å®ç°éå¸¸é€šç”¨ï¼Œå®ƒå¯ä»¥æŒ‰ç…§ç›¸ä¼¼çš„æ ‡è®°ç»“æ„æ¥å¯åŠ¨ç”¨å¯¹ä»»æ„åˆ—è¡¨æ˜¾ç¤ºè¿›è¡ŒæŒç»­æ»šåŠ¨ã€‚

æä¾›äº†å¦‚ä¸‹é€‰é¡¹ä¸ºå®šä¹‰å…¶åŠŸèƒ½ï¼š

-   loadingHtmlï¼šåœ¨åŠ è½½æ–°é¡µé¢å†…å®¹æ—¶ä¼šè®¾å®šæ ‡è®°å¹¶ç”±jScrollæ³¨å…¥åˆ°åˆ—è¡¨çš„æœ€åã€‚æœ¬ä¾‹ä¸­ä¸ºä¸€ä¸ªåŠ¨æ€åŠ è½½æ ‡è®°ï¼Œç›´æ¥ç”±æ ‡è®°ä¸­çš„`<script type="text/template" />` æ ‡ç­¾å†…æ‰€åŒ…å«çš„HTMLç»˜åˆ¶ã€‚é€šè¿‡ç»™å®šè¿™ä¸€typeå±æ€§ï¼Œæµè§ˆå™¨ä¼šåƒæ™®é€šJavaScripté‚£æ ·å¯¹æ‰§è¡Œå®ƒï¼Œå…¶ä¸­çš„å†…å®¹åˆ™å¯¹ç”¨æˆ·éšè—ã€‚
-   paddingï¼šåœ¨é¡µé¢æ»šåŠ¨ä½ç½®å¤„äºåº•éƒ¨æ»šåŠ¨åŒºèŒƒå›´å†…æ—¶ï¼Œåº”å½“åŠ è½½æ–°é¡µé¢ã€‚æœ¬ä¾‹ä¸­æˆ‘ä»¬è®¾ç½®ä¸º100åƒç´ ã€‚
-   pagingSelectorï¼šè¡¨æ˜object_listä¸­å“ªä¸ªHTMLå…ƒç´ æ˜¯åˆ†é¡µé“¾æ¥çš„CSSé€‰æ‹©å™¨ã€‚å®ƒä»¬éšè—äºæµè§ˆå™¨ä¸­ï¼Œç”±jScrollæ’ä»¶è°ƒç”¨æ¥ç”±æŒç»­æ»šåŠ¨åŠ è½½æ›´å¤šé¡µé¢ï¼Œä½†å…¶å®ƒæµè§ˆå™¨ä¸­çš„ç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ç‚¹å‡»åˆ†é¡µã€‚
-   nextSelectorï¼šè¿™ä¸€ä¸ªCSSé€‰æ‹©å™¨æŸ¥æ‰¾è¯»å–ä¸‹ä¸€é¡µURLçš„HTMLå…ƒç´ ã€‚
-   contentSelectorï¼šä¹Ÿæ˜¯ä¸€ä¸ªCSSé€‰æ‹©å™¨ã€‚å®ƒæŒ‡å®šä»Ajaxæ‰€åŠ è½½çš„å†…å®¹ä¸­æå–å“ªäº›HTMLå…ƒç´ å¹¶åŠ å…¥åˆ°å®¹å™¨ä¸­ã€‚

rating.cssæ’å…¥Unicodeæ˜Ÿå½¢å­—ç¬¦å¹¶å¯¹ä¸­ç©ºçš„æ˜Ÿå½¢è¦†ç›–ä¸Šå·²å¡«å……æ˜Ÿå½¢æ¥å®ç°è¯„åˆ†æ•ˆæœã€‚ä½¿ç”¨ç­‰äºè¯„åˆ†å€¼æœ€å¤§ç™¾åˆ†æ¯”çš„å€¼ä½œä¸ºå®½åº¦ï¼ˆæœ¬ä¾‹ä¸º5ï¼‰ï¼Œå¡«å……åçš„æ˜Ÿå½¢åœ¨ä¸­ç©ºæ˜Ÿå½¢ä¹‹ä¸Šè¦†ç›–ç›¸åº”çš„ç©ºé—´ï¼Œå…è®¸è¿›è¡Œå°æ•°è¯„åˆ†ã€‚åœ¨æ ‡è®°ä¸­ï¼Œå¯¹äºä½¿ç”¨å±å¹•é˜…è¯»å™¨çš„äººä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰è¯„åˆ†ä¿¡æ¯çš„aria-labelå±æ€§ã€‚

æœ€åï¼Œ style.cssæ–‡ä»¶ä¸­çš„CSSä½¿ç”¨CSSåŠ¨ç”»æ¥åˆ›å»ºä¸€ä¸ªæ—‹è½¬çš„åŠ è½½å›¾æ ‡ã€‚

### æ‰©å±•çŸ¥è¯†...

åœ¨è¾¹æ ä¸­æœ‰ä¸€ä¸ªç”¨äºå¯¼èˆªçš„å ä½ç¬¦ã€‚æ³¨æ„å¯¹äºæŒç»­æ»šåŠ¨ï¼Œæ‰€æœ‰å†…å®¹åˆ—è¡¨ä¹‹åçš„äºŒçº§å¯¼èˆªåº”ä½äºè¾¹æ è€Œä¸æ˜¯footerä¸­ï¼Œå› ä¸ºè®¿å®¢å¯èƒ½æ°¸è¿œä¸ä¼šè§¦è¾¾é¡µé¢çš„åº•éƒ¨ã€‚

### ç›¸å…³å†…å®¹

-   [**ç¬¬3ç«  è¡¨å•å’Œè§†å›¾**](https://alanhou.org/forms-views/)ä¸­çš„*è¿‡æ»¤å¯¹è±¡åˆ—è¡¨*ä¸€èŠ‚
-   [**ç¬¬3ç«  è¡¨å•å’Œè§†å›¾**](https://alanhou.org/forms-views/)ä¸­çš„*ç®¡ç†åˆ†é¡µåˆ—è¡¨*ä¸€èŠ‚
-   [**ç¬¬3ç«  è¡¨å•å’Œè§†å›¾**](https://alanhou.org/forms-views/)ä¸­çš„*ç¼–å†™åŸºäºç±»çš„è§†å›¾*ä¸€èŠ‚
-   *åœ¨JavaScriptä¸­æš´éœ²é…ç½®*ä¸€èŠ‚
-   [**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)ä¸­çš„*åˆ›å»ºæ¨¡æ¿æ ‡ç­¾æ¥ä¿®æ”¹è¯·æ±‚æŸ¥è¯¢å‚æ•°*ä¸€èŠ‚

## åœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­æ‰“å¼€å¯¹è±¡è¯¦æƒ…

æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåœ°ç‚¹é“¾æ¥åˆ—è¡¨ï¼Œåœ¨ç‚¹å‡»æ—¶ï¼Œä¼šæ‰“å¼€å¸¦æœ‰ä¸€äº›åœ°ç‚¹ä¿¡æ¯å’ŒLearn more...é“¾æ¥çš„Bootstrapæ¨¡æ€æ¡†ï¼Œé“¾æ¥æŒ‡å‘åœ°ç‚¹è¯¦æƒ…é¡µï¼š

![æ¨¡æ€å¯¹è¯æ¡†](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55885ac88e1343d8bd1fab69e8b14231~tplv-k3u1fbpfcp-zoom-1.image)

å¯¹è¯æ¡†ä¸­çš„å†…å®¹ä½¿ç”¨AjaxåŠ è½½ã€‚å¯¹äºä¸æ”¯æŒJavaScriptçš„è®¿å®¢ï¼Œä¼šè·³è¿‡ä¸­é—´æ­¥éª¤ç«‹å³æ‰“å¼€è¯¦æƒ…é¡µã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨å‰ä¸€å°èŠ‚æ‰€åˆ›å»ºçš„locationsåº”ç”¨ã€‚

ç¡®ä¿å…¶ä¸­åŒ…å«äº†æˆ‘ä»¬å‰é¢æ‰€å®šä¹‰çš„è§†å›¾ã€URLé…ç½®ä»¥åŠåœ°ç‚¹åˆ—è¡¨å’Œè¯¦æƒ…æ¨¡æ¿ã€‚

### å¦‚ä½•å®ç°...

æ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥åœ¨åˆ—è¡¨è§†å›¾å’Œè¯¦æƒ…è§†å›¾ä¹‹é—´åˆ›å»ºä¸€ä¸ªæ¨¡æ€å¯¹è¯æ¡†ä¸­é—´é¡µï¼š

1.  é¦–å…ˆï¼Œåœ¨åœ°ç‚¹åº”ç”¨çš„URLé…ç½®ä¸­ï¼Œæ·»åŠ ä¸€æ¡å“åº”æ¨¡æ€å¯¹è¯æ¡†çš„è§„åˆ™ï¼š


    ```
    # myproject/apps/locations/urls.py
    from django.urls import path
    from .views import LocationList, LocationDetail
    
    urlpatterns = [
      path("", LocationList.as_view(), name="location_list"), 
      path("add/", add_or_change_location, name="add_location"), 
      path("<uuid:pk>/", LocationDetail.as_view(), name="location_detail"),
      path(
        "<uuid:pk>/modal/", 
        LocationDetail.as_view(template_name="locations/location_detail_modal.html"), 
        name="location_detail_modal",
      ),
    ]
    ```

1.  ä¸ºæ¨¡æ€å¯¹è¯æ¡†åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ï¼š


    ```
    {# locations/location_detail_modal.html #}
    {% load i18n %}
    <p class="text-center">
      {% if location.picture %} 
        <picture class="img-fluid">
          <source media="(max-width: 480px)" srcset="{{ location.picture_mobile.url }}"/>
          <source media="(max-width: 768px)" srcset="{{ location.picture_tablet.url }}"/>
          <img src="{{ location.picture_desktop.url }}" alt="{{ location.name }}" class="img-fluid" />
        </picture>
      {% endif %}
    </p>
    <div class="modal-footer text-right">
      <a href="{% url "locations:location_detail" pk=location.pk %}"
        class="btn btn-primary pull-right"> {% trans "Learn more..." %}
      </a> 
    </div>
    ```

1.  åœ¨åœ°ç‚¹åˆ—è¡¨çš„æ¨¡æ¿ä¸­ï¼Œé€šè¿‡æ·»åŠ è‡ªå®šä¹‰dataå±æ€§æ¥æ›´æ–°é“¾æ¥ä¸ºåœ°ç‚¹è¯¦æƒ…ï¼š


    ```
    {# locations/location_list.html #}
    {# ... #}
    <a href="{{ location.get_url_path }}"
      data-modal-title="{{ location.get_full_address }}" 
      data-modal-url="{% url 'locations:location_detail_modal'
      pk=location.pk %}"
      class="item d-block my-3"> 
      {# ... #}
    </a>
    {# ... #}
    ```

1.  åŒæ ·åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æ¨¡æ€å¯¹è¯æ¡†çš„ä»£ç é‡å†™extra_bodyå†…å®¹ï¼š


    ```
    {% block extra_body %} 
      {# ... #}
      <div id="modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" aria-labelledby="modal_title">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content"> <div class="modal-header">
            <h4 id="modal_title" class="modal-title"></h4>
            <button type="button" class="close" data-dismiss="modal"
              aria-label="{% trans 'Close' %}"> 
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body"></div> </div>
        </div>
       </div>
    {% endblock %}
    ```

1.  æœ€åï¼Œä¿®æ”¹list.jsæ–‡ä»¶ï¼Œæ·»åŠ è„šæœ¬æ¥å¤„ç†æ‰“å¼€å’Œå…³é—­æ¨¡æ€å¯¹è¯æ¡†ï¼š


    ```
    /* site_static/js/list.js */
    /* ... */ 
    jQuery(function ($) {
      var $list = $('.item-list');
      var $modal = $('#modal');
      $modal.on('click', '.close', function (event) {
        $modal.modal('hide');
        // do something when dialog is closed... 
      });
      $list.on('click', 'a.item', function (event) { 
        var $link = $(this);
        var url = $link.data('modal-url');
        var title = $link.data('modal-title');
        if (url && title) {
          event.preventDefault();
          $('.modal-title', $modal).text(title); 
          $('.modal-body', $modal).load(url, function () {
            $modal.on('shown.bs.modal', function () { 
              // do something when dialog is shown...
            }).modal('show'); 
          });
        } 
      });
    });
    ```

### å®ç°åŸç†...

å¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è®¿é—®åœ°ç‚¹åˆ—è¡¨è§†å›¾å¹¶ç‚¹å‡»å…¶ä¸­ä¸€ä¸ªåœ°ç‚¹æ—¶ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„æ¨¡æ€å¯¹è¯æ¡†ï¼š

![æ¨¡æ€å¯¹è¯æ¡†](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fd92bd4da39451e980602634239ed02~tplv-k3u1fbpfcp-zoom-1.image)

æˆ‘ä»¬æ¥çœ‹è¿™äº›æ˜¯å¦‚ä½•å…±åŒä½œç”¨çš„ã€‚åä¸ºlocation_detail_modalçš„URLè·¯å¾„æŒ‡å‘åŒä¸€åœ°ç‚¹çš„è¯¦æƒ…è§†å›¾ï¼Œä½†ä½¿ç”¨äº†ä¸åŒçš„æ¨¡æ¿ã€‚è¯¥æ¨¡æ¿ä»…æœ‰ä¸€å¼ å“åº”å¼å›¾ç‰‡å’Œå…·æœ‰Learn more...é“¾æ¥çš„æ¨¡æ€å¯¹è¯æ¡†åº•éƒ¨ï¼Œé“¾æ¥æŒ‡å‘è¯¥åœ°ç‚¹çš„å¸¸è§„è¯¦æƒ…é¡µã€‚åœ¨åˆ—è¡¨è§†å›¾ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†åˆ—è¡¨é¡¹çš„é“¾æ¥æ¥åŒ…å« data-modal-title å’Œ data- modal-urlå±æ€§ï¼Œç¨ååœ¨JavaScriptä¸­è¿›è¡Œå¼•ç”¨ã€‚å‰ä¸€ä¸ªå±æ€§è¡¨æ˜åº”å°†å®Œæ•´åœ°å€ç”¨ä½œæ ‡é¢˜ã€‚åä¸€ä¸ªå±æ€§è¡¨æ˜æ¨¡æ€å¯¹è¯æ¡†çš„ä¸»ä½“ HTMLåº”è¯¥æ¥æ”¶çš„ä½ç½®ã€‚åœ¨åˆ—è¡¨è§†å›¾çš„æœ€åæ˜¯Bootstrap 4æ¨¡æ€å¯¹è¯æ¡†çš„æ ‡è®°ã€‚è¯¥å¯¹è¯æ¡†åŒ…å«å…·æœ‰CloseæŒ‰é’®å’Œæ ‡é¢˜çš„çŠ¶å†µï¼Œä»¥åŠä¸»è¦è¯¦æƒ…çš„å†…å®¹åŒºã€‚JavaScriptåº”é€šè¿‡jsç‰ˆå—è¿›è¡Œæ·»åŠ ã€‚

åœ¨JavaScriptæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨jQueryæ¡†æ¶æ¥åˆ©ç”¨å…¶æ›´ç²¾ç®€çš„è¯­æ³•å’Œè·¨æµè§ˆå™¨åŠŸèƒ½ã€‚åœ¨åŠ è½½é¡µé¢æ—¶ï¼Œå¯¹.item-listå…ƒç´ æ·»åŠ äº†ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨`on('click')`ã€‚åœ¨ç‚¹å‡»ä»»æ„a.itemæ—¶ï¼Œäº‹ä»¶è¢«å§”æ‰˜ç»™å¤„ç†å™¨ï¼Œå®ƒè¯»å–å¹¶å­˜å‚¨è‡ªå®šä¹‰æ•°æ®å±æ€§ä¸ºurlå’Œtitleã€‚åœ¨æˆåŠŸæå–è¿™äº›å†…å®¹åï¼Œé˜»æ­¢åŸå§‹ç‚¹å‡»åŠ¨ä½œï¼ˆå¯¼èˆªè‡³å®Œæ•´çš„è¯¦æƒ…é¡µï¼‰æ‰§è¡Œï¼Œç„¶åè®¾ç½®æ¨¡æ€æ¡†ä»¥ä¾›æ˜¾ç¤ºã€‚è®¾ç½®æ–°æ ‡é¢˜å’Œéšè—å¯¹è¯æ¡†å¹¶é€šè¿‡AjaxåŠ è½½æ¨¡æ€å¯¹è¯æ¡†çš„å†…å®¹åˆ°.modal-bodyå…ƒç´ ä¸­ã€‚æœ€åä½¿ç”¨Bootstrap 4 modal() jQueryæ’ä»¶å°†æ¨¡æ€æ¡†æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚

å¦‚æœJavaScriptæ— æ³•é€šè¿‡è‡ªå®šä¹‰å±æ€§å¤„ç†æ¨¡æ€å¯¹è¯æ¡†çš„URLï¼Œç”šè‡³æ˜¯list.jsä¸­çš„JavaScriptå®Œå…¨æ— æ³•åŠ è½½æˆ–æ‰§è¡Œï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»åœ°ç‚¹é“¾æ¥æ­£å¸¸è¿›è¡Œè¯¦æƒ…é¡µã€‚æˆ‘ä»¬ä»¥æ¸è¿›å¼çš„å¢å¼ºå®ç°äº†æ¨¡æ€æ¡†ï¼Œè¿™æ ·ä¼šæå‡ç”¨æˆ·çš„ä½“éªŒï¼Œå³ä½¿å‡ºç°é”™è¯¯ä¹Ÿæ²¡é—®é¢˜ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨HTML5 dataå±æ€§*ä¸€èŠ‚
-   *æä¾›å“åº”å¼å›¾ç‰‡*ä¸€èŠ‚
-   *å®ç°æŒç»­æ»šåŠ¨*ä¸€èŠ‚
-   *å®ç°Likeå¾®ä»¶*ä¸€èŠ‚

## å®ç°Likeå¾®ä»¶

é€šå¸¸åœ¨å…·æœ‰ç¤¾äº¤ç»„ä»¶çš„ç½‘ç«™ä¸­ï¼Œä¼šå…·æœ‰Facebookã€Twitterå’ŒGoogle+æ’ä»¶æ¥ç”¨äºå–œæ¬¢å’Œåˆ†äº«å†…å®¹ã€‚æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®²è§£åœ¨Djangoä¸­å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œç”¨äºåœ¨ç”¨æˆ·å¯¹å†…å®¹ç‚¹èµæ—¶å°†ä¿¡æ¯ä¿å­˜è‡³æ•°æ®åº“ä¸­ã€‚å¯ä»¥æ ¹æ®ç”¨æˆ·åœ¨ç½‘ç«™ä¸Šå…·ä½“ç‚¹èµçš„å†…å®¹æ¥åˆ›å»ºç›¸åº”çš„è§†å›¾ã€‚æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªLikeæ’ä»¶ï¼ŒåŒ…å«ä¸¤ä¸ªçŠ¶æ€æŒ‰é’®ä»¥åŠæ˜¾ç¤ºæ€»ç‚¹èµæ•°çš„æ•°æ ‡ã€‚

ä»¥ä¸‹æˆªå›¾æ˜¾ç¤ºçš„æ˜¯æœªç‚¹èµçŠ¶æ€ï¼Œç”¨æˆ·é€šè¿‡ç‚¹å‡»æŒ‰é’®æ¥è¿›è¡Œç‚¹èµï¼š

![æœªç‚¹èµçŠ¶æ€](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/194967e1d39e405b8551a052737ae494~tplv-k3u1fbpfcp-zoom-1.image)

ä»¥ä¸‹æˆªå›¾æ˜¾ç¤ºçš„æ˜¯å·²ç‚¹èµçŠ¶æ€ï¼Œç”¨æˆ·é€šè¿‡ç‚¹å‡»æŒ‰é’®æ¥å–æ¶ˆç‚¹èµï¼š

![å·²ç‚¹èµçŠ¶æ€](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d7723be219da4fa79a6b1f0d021ef9b1~tplv-k3u1fbpfcp-zoom-1.image)

æ’ä»¶çŠ¶æ€ä¸­çš„æ”¹å˜äº¤ç”±Ajaxè°ƒç”¨å¤„ç†ã€‚

### å‡†å¤‡å·¥ä½œ

é¦–å…ˆï¼Œåˆ›å»ºlikesåº”ç”¨äº¤æ·»åŠ è‡³INSTALLED_APPSä¸­ã€‚ç„¶åè®¾ç½®ä¸€ä¸ªLikeæ¨¡å‹ï¼Œå®ƒæœ‰ä¸€ä¸ªå¯¹ç‚¹èµå†…å®¹ç”¨æˆ·çš„å¤–é”®å…³è”ï¼Œä»¥åŠå¯¹æ•°æ®åº“ä¸­ä»»æ„å¯¹è±¡çš„é€šç”¨å…³è”ã€‚æˆ‘ä»¬å°†ä½¿ç”¨**[ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„](https://alanhou.org/models-database-structure/)**ä¸­*åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³è”*ä¸€èŠ‚ä¸­æ‰€å†™ä¹‰çš„object_relation_base_factoryã€‚å¦‚æœä¸å¸Œæœ›ä½¿ç”¨mixinï¼Œå¯ä»¥åœ¨å¦‚ä¸‹æ¨¡å‹ä¸­è‡ªå·±å®šä¹‰ä¸€ä¸ªé€šç”¨å…³è”ï¼š

```
# myproject/apps/likes/models.py
from django.db import models
from django.utils.translation import ugettext_lazy as _ 
from django.conf import settings

from myproject.apps.core.models import ( 
  CreationModificationDateBase, 
  object_relation_base_factory,
)

LikeableObject = object_relation_base_factory(is_required=True)

class Like(CreationModificationDateBase, LikeableObject): 
  class Meta:
    verbose_name = _("Like") 
    verbose_name_plural = _("Likes") 
    ordering = ("-created",)

  user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
  
  def __str__(self):
    return _("{user} likes {obj}").format(user=self.user, obj=self.content_object)
```

åŒæ—¶ç¡®ä¿åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†requestä¸Šä¸‹æ–‡å¤„ç†å™¨ã€‚å¹¶ä¸”ä¸ºäº†è®©å½“å‰å·²ç™»å½•ç”¨æˆ·ä¸requestå…³è”éœ€è¦åœ¨requestä¸­æ·»åŠ authentication middlewareï¼š

```
# myproject/settings/_base.py
#...
MIDDLEWARE = [
  #... 
  "django.contrib.auth.middleware.AuthenticationMiddleware", 
  #...
]

TEMPLATES = [ 
  {
    #... 
    "OPTIONS": {
      "context_processors": [
        "django.template.context_processors.request",
        #... 
      ]
    }, 
  }
]
```

åˆ«å¿˜äº†å¯¹æ–°çš„Likeæ¨¡å‹åˆ›å»ºå’Œè¿è¡Œè¿ç§»æ¥è¿›è¡Œç›¸åº”çš„æ•°æ®åº“è®¾ç½®ã€‚

### å¦‚ä½•å®ç°...

é€æ­¥æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š

1.  åœ¨likesåº”ç”¨ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªtemplatetagsç›®å½•ï¼Œå…±ä¸­åŒ…å«ä¸€ä¸ªç©ºçš„`__init__.py`æ–‡ä»¶è®©å…¶æˆä¸ºPythonæ¨¡å—ã€‚ç„¶åæ·»åŠ `likes_tags.py`æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬å®šä¹‰`{% like_widget %}`æ¨¡æ¿æ ‡ç­¾å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/likes/templatetags/likes_tags.py
    from django import template
    from django.contrib.contenttypes.models import ContentType 
    from django.template.loader import render_to_string
    
    from ..models import Like 
    
    register = template.Library()
    
    # TAGS
    
    class ObjectLikeWidget(template.Node): 
      def __init__(self, var):
        self.var = var
    
      def render(self, context):
        liked_object = self.var.resolve(context)
        ct = ContentType.objects.get_for_model(liked_object) 
        user = context["request"].user
        
        if not user.is_authenticated:
          return ""
        context.push(object=liked_object, content_type_id=ct.pk) 
        output = render_to_string("likes/includes/widget.html", context.flatten()) 
        context.pop() 
        return output
    
    @register.tag
    def like_widget(parser, token):
      try:
        tag_name, for_str, var_name = token.split_contents()
      except ValueError:
        tag_name = "%r" % token.contents.split()[0] 
        raise template.TemplateSyntaxError(
          f"{tag_name} tag requires a following syntax: "
          f"{{% {tag_name} for <object> %}}"
       )
      var = template.Variable(var_name) 
      return ObjectLikeWidget(var)
    ```

1.  åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­æ·»åŠ è¿‡æ»¤å™¨æ¥è·å–æŸä¸ªç”¨æˆ·çš„LikeçŠ¶æ€ä»¥åŠå…·ä½“å¯¹è±¡çš„Likeæ€»æ•°ï¼š


    ```
    # myproject/apps/likes/templatetags/likes_tags.py
    #...
    # FILTERS
    
    @register.filter
    def liked_by(obj, user):
      ct = ContentType.objects.get_for_model(obj)
      liked = Like.objects.filter(user=user, content_type=ct, object_id=obj.pk)
      return liked.count() > 0
    
    @register.filter
    def liked_count(obj):
      ct = ContentType.objects.get_for_model(obj)
      likes = Like.objects.filter(content_type=ct, object_id=obj.pk) 
      return likes.count()
    ```

1.  åœ¨URLè§„åˆ™ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé’ˆå¯¹è§†å›¾çš„è§„åˆ™ï¼Œä½¿ç”¨Ajaxæ¥å¤„ç†ç‚¹èµå’Œå–æ¶ˆç‚¹èµï¼š


    ```
    # myproject/apps/likes/urls.py
    from django.urls import path 
    from .views import json_set_like
    
    urlpatterns = [ 
      path("<int:content_type_id>/<str:object_id>/", json_set_like, name="json_set_like")
    ]
    ```

1.  è¿˜åº”ä¿è¯URLä¸é¡¹ç›®ä¹‹é—´çš„æ˜ å°„ï¼š


    ```
    # myproject/urls.py
    from django.conf.urls.i18n import i18n_patterns 
    from django.urls import include, path
    
    urlpatterns = i18n_patterns( 
      #...
      path("likes/", include(("myproject.apps.likes.urls", "likes"), namespace="likes")),
    )
    ```

1.  æ¥ç€éœ€è¦å®šä¹‰è§†å›¾ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š


    ```
    # myproject/apps/likes/views.py
    from django.contrib.contenttypes.models import ContentType 
    from django.http import JsonResponse
    from django.views.decorators.cache import never_cache 
    from django.views.decorators.csrf import csrf_exempt
    
    from .models import Like
    from .templatetags.likes_tags import liked_count
    
    @never_cache
    @csrf_exempt
    def json_set_like(request, content_type_id, object_id):
      """
      Sets the object as a favorite for the current user 
      """
      result = {
        "success": False,
      }
      if request.user.is_authenticated and request.method == "POST": 
        content_type = ContentType.objects.get(id=content_type_id)
        obj = content_type.get_object_for_this_type(pk=object_id)
    
        like, is_created = Like.objects.get_or_create( 
          content_type=ContentType.objects.get_for_model(obj), 
          object_id=obj.pk,
          user=request.user
        )
        if not is_created: 
          like.delete()
    
        result = {
          "success": True,
          "action": "add" if is_created else "remove", 
          "count": liked_count(obj),
        }
      return JsonResponse(result)
    ```

1.  åœ¨ä»»æ„å¯¹è±¡çš„åˆ—è¡¨æˆ–è¯¦æƒ…è§†å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è¯¥å¾®ä»¶çš„æ¨¡æ¿æ ‡ç­¾ã€‚ä¸‹é¢å°†è¿™ä¸€å¾®ä»¶æ·»åŠ åˆ°å‰é¢å°èŠ‚ä¸­æ‰€åˆ›å»ºçš„åœ°ç‚¹è¯¦æƒ…é¡µä¸­ï¼š


    ```
    {# locations/location_detail.html #}
    {% extends "base.html" %}
    {% load i18n static likes_tags %}
    
    {% block content %}
      <a href="{% url "locations:location_list" %}">{% trans "Interesting Locations" %}</a> 
      <div class="float-right">
        {% if request.user.is_authenticated %} 
          {% like_widget for location %}
        {% endif %}
      </div>
      <h1 class="map-title">{{ location.name }}</h1> 
      {# ... #}
    {% endblock %}
    ```

1.  ç„¶åéœ€è¦ä¸ºè¯¥å¾®ä»¶æ·»åŠ ä¸€ä¸ªæ¨¡æ¿ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š


    ```
    {# likes/includes/widget.html #}
    {% load i18n static likes_tags sekizai_tags %} 
    <p class="like-widget">
      <button type="button"
        class="like-button btn btn-primary {% if object|liked_by:request.user %} active{% endif %}" 
        data-href="{% url "likes:json_set_like" content_type_id=content_type_id object_id=object.pk %}" 
        data-remove-label="{% trans "Like" %}" 
        data-add-label="{% trans "Unlike" %}">
        {% if object|liked_by:request.user %} 
          {% trans "Unlike" %}
        {% else %}
          {% trans "Like" %}
        {% endif %}
      </button>
      <span class="like-badge badge badge-secondary"> 
        {{ object|liked_count }}
      </span>
    </p>
    {% addtoblock "js" %}
    <script src="{% static 'likes/js/widget.js' %}"></script> 
    {% endaddtoblock %}
    ```

1.  æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºJavaScriptæ¥å¤„ç†åœ¨æµè§ˆä¸­ç‚¹èµå’Œå–æ¶ˆç‚¹èµçš„åŠ¨ä½œï¼Œå¦‚ä¸‹ï¼š


    ```
    /* myproject/apps/likes/static/likes/js/widget.js */
    (function($) {
      $(document).on("click", ".like-button", function() {
        var $button = $(this);
        var $widget = $button.closest(".like-widget"); 
        var $badge = $widget.find(".like-badge");
    
        $.post($button.data("href"), function(data) { 
          if (data.success) {
            var action = data.action; // "add" or "remove" 
            var label = $button.data(action + "-label");
    
            $button[action + "Class"]("active"); 
            $button.html(label);
            
            $badge.html(data.count); 
          }
        }, "json");
      });
    }(jQuery));
    ```

### å®ç°åŸç†...

æ­¤æ—¶å¯å¯¹ç½‘ç«™ä»»ä½•å¯¹è±¡ä½¿ç”¨`{% like_widget for object %}`æ¨¡æ¿æ ‡ç­¾ã€‚å®ƒç”Ÿæˆä¸€ä¸ªæ˜¾ç¤ºLikeçŠ¶æ€çš„å¾®ä»¶ï¼ŒçŠ¶æ€æ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦åŠå¦‚ä½•ä¸å¯¹è±¡å“åº”ç”Ÿæˆã€‚

LikeæŒ‰é’®æœ‰3ä¸ªè‡ªå®šä¹‰HTML5 dataå±æ€§ï¼š

-   data-hrefæä¾›ç”¨äºä¿®æ”¹è¯¥å¾®ä»¶å½“å‰çŠ¶æ€çš„å”¯ä¸€ã€æŒ‡å®šå¯¹è±¡çš„URL
-   data-add-textä¸ºåœ¨æ·»åŠ äº†Likeå…³è”åæ˜¾ç¤ºçš„ç¿»è¯‘æ–‡æœ¬ï¼ˆUnlikeï¼‰
-   ç›¸åº”åœ°data-remove-textä¸ºåˆ é™¤äº†Likeå…³è”åæ˜¾ç¤ºçš„ç¿»è¯‘æ–‡æœ¬ï¼ˆLikeï¼‰

æˆ‘ä»¬ä½¿ç”¨django-sekizaiåœ¨é¡µé¢ä¸­æ·»åŠ äº†`<script src="{% static 'likes/js/widget.js' %}"></script>` ã€‚æ³¨æ„å¦‚æœé¡µé¢ä¸­æœ‰ä¸€ä¸ªä»¥ä¸Šçš„Likeå¾®ä»¶æ—¶ï¼Œåªéœ€è¦åŒ…å«è¯¥JavaScriptä¸€æ¬¡å³å¯ã€‚è€Œå¦‚æœåœ¨é¡µé¢ä¸Šæ²¡æœ‰Likeå¾®ä»¶ï¼Œåˆ™æ— éœ€åŒ…å«è¯¥JavaScriptä»£ç ã€‚

åœ¨è¿™ä¸ªJavaScriptæ–‡ä»¶ä¸­ï¼ŒLikeæŒ‰é’®ç”±like-button CSSç±»è¿›è¡Œè¯†åˆ«ã€‚æœ‰ä¸€ä¸ªå…³è”åˆ°æ–‡æ¡£çš„äº‹ä»¶ç›‘å¬å™¨æ¥ç›‘å¬é¡µé¢ä¸Šçš„è¿™ç±»æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œç„¶åå¯¹data-hrefæ‰€æŒ‡å®šçš„URLè¿›è¡ŒAjax postè°ƒç”¨ã€‚

æŒ‡å®šçš„è§†å›¾json_set_likeæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šå†…å®¹ç±»å‹IDåŠæ‰€ç‚¹èµå¯¹è±¡çš„ä¸»é”®ã€‚è§†å›¾æ£€æŸ¥æŒ‡å®šå¯¹è±¡æ˜¯å¦å­˜åœ¨ç‚¹èµï¼Œå¦‚æœå­˜åœ¨åˆ™è¿›è¡Œåˆ é™¤ï¼›åä¹‹æ·»åŠ ä¸€ä¸ªLikeå¯¹è±¡ã€‚è§†å›¾ä¼šè¿”å›ä¸€ä¸ªJSONå“åº”ï¼ŒåŒ…å«successçŠ¶æ€ã€Likeå¯¹è±¡æ‰€æ¥æ”¶çš„åŠ¨ä½œï¼ˆaddæˆ–removeï¼‰ã€æ‰€æœ‰ç”¨æˆ·å¯¹è¯¥å¯¹è±¡çš„Likeæ€»æ•°ã€‚æ ¹æ®æ‰€è¿”å›çš„åŠ¨ä½œï¼ŒJavaScriptå°†å¯¹æŒ‰é’®æ˜¾ç¤ºç›¸åº”çš„çŠ¶æ€ã€‚

å¯ä»¥åœ¨æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ä¸­è°ƒè¯•Ajaxå“åº”ï¼Œé€šå¸¸ä½äºNetworkæ ‡ç­¾ä¸‹ã€‚å¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­å‡ºç°æœåŠ¡ç«¯é”™è¯¯ï¼Œåœ¨é…ç½®ä¸­å¼€å¯DEBUGåå¯ä»¥åœ¨å“åº”é¢„è§ˆä¸­çœ‹åˆ°é”™è¯¯è¿½è¸ªä¿¡æ¯ï¼Œå¦åˆ™ä¼šçœ‹åˆ°ä¸‹å›¾ä¸­æ‰€ç¤ºè¿”å›çš„JSONï¼š

![å¼€å‘è€…å·¥å…·è°ƒè¯•Ajaxå“åº”](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbd4cc0fbdb74b6a83408bc8380397ad~tplv-k3u1fbpfcp-zoom-1.image)

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨ Django Sekizai*ä¸€èŠ‚
-   *åœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­æ‰“å¼€å¯¹è±¡è¯¦æƒ…*ä¸€èŠ‚
-   *å®ç°æŒç»­æ»šåŠ¨*ä¸€èŠ‚
-   *é€šè¿‡Ajaxä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚
-   **[ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„](https://alanhou.org/models-database-structure/)**ä¸­*åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³è”*ä¸€èŠ‚
-   [**ç¬¬5ç«  è‡ªå®šä¹‰æ¨¡æ¿è¿‡æ»¤å™¨å’Œæ ‡ç­¾**](https://alanhou.org/django3-custom-template-filters-tags/)

## é€šè¿‡Ajaxä¸Šä¼ å›¾ç‰‡

ä½¿ç”¨é»˜è®¤çš„æ–‡ä»¶inputæ¡†ï¼Œå¾ˆå¿«å°±ä¼šå‘ç°éœ€è¦è¿›è¡Œæ”¹è¿›æ¥æå‡ç”¨æˆ·ä½“éªŒï¼š

-   é¦–å…ˆï¼Œåœ¨è¾“å…¥æ¡†ä¸­ä»…æ˜¾ç¤ºæ‰€é€‰æ–‡ä»¶è·¯å¾„ï¼Œè€Œç”¨æˆ·å¸Œæœ›åœ¨é€‰å–æ–‡ä»¶åé©¬ä¸Šçœ‹åˆ°æ‰€é€‰çš„å†…å®¹ã€‚
-   å…¶æ¬¡ï¼Œæ–‡ä»¶è¾“å…¥æ¡†æœ¬èº«é€šå¸¸ä¸è¶³ä»¥æ˜¾ç¤ºæ‰€é€‰çš„è·¯å¾„ï¼Œä»…æ˜¾ç¤ºå·¦ä¾§éƒ¨åˆ†ã€‚ç»“æœæ˜¯åœ¨è¾“å…¥æ¡†ä¸­å‡ ä¹çœ‹ä¸åˆ°æ–‡ä»¶åã€‚
-   æœ€åï¼Œå¦‚æœè¡¨å•å­˜åœ¨éªŒè¯é”™è¯¯ï¼Œäººä»¬ä¸å¸Œæœ›é‡æ–°å†é€‰æ‹©æ–‡ä»¶ï¼›éªŒè¯é”™è¯¯çš„è¡¨å•ä¸­åº”ä¿æŒæ–‡ä»¶çš„é€‰ä¸­çŠ¶æ€ã€‚

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ å¦‚ä½•æ”¹è¿›æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨å‰é¢å°èŠ‚ä¸­æ‰€åˆ›å»ºçš„locationsåº”ç”¨ã€‚

æˆ‘ä»¬çš„JavaScriptæ–‡ä»¶ä¼šä¾èµ–äºå¤–éƒ¨åº“-jQuery File Uploadã€‚å¯ä»¥ä¸‹è½½https://github.com/blueimp/jQuery-File-Upload/tree/v10.2.0 ä¸­çš„æ–‡ä»¶å¹¶æ”¾å…¥ site_static/site/vendor/jQuery-File-Upload-10.2.0ã€‚è¿™ä¸ªå·¥å…·è¿˜è¦æ±‚ä½¿ç”¨jquery.ui.widget.jsï¼Œæ”¾åœ¨vendor/å­ç›®å½•ä¸­ã€‚å‡†å¤‡å¥½è¿™äº›åå°±å¯ä»¥å¼€å§‹æˆ‘ä»¬çš„å­¦ä¹ äº†ã€‚

### å¦‚ä½•å®ç°...

é€šè¿‡ä»¥ä¸‹æ­¥éª¤ä¸ºlocationså®šä¹‰ä¸€ä¸ªè¡¨å•ï¼Œè®©å…¶æ”¯æŒAjaxä¸Šä¼ ï¼š

1.  æˆ‘ä»¬ä¸ºlocationsåˆ›å»ºä¸€ä¸ªæ¨¡å‹è¡¨å•ï¼Œæœ‰éå¿…å¡«çš„pictureå­—æ®µã€éšè—çš„picture_pathå­—æ®µã€åœ°ç†ä½ç½®ä½¿ç”¨çš„latitudeå’Œlongitudeå­—æ®µï¼š

    ```
    # myproject/apps/locations/forms.py
    import os
    from django import forms
    from django.urls import reverse
    from django.utils.translation import ugettext_lazy as _ 
    from django.core.files.storage import default_storage
    from crispy_forms import bootstrap, helper, layout 
    from .models import Location


    class LocationForm(forms.ModelForm): 
      picture = forms.ImageField(
        label=_("Picture"), max_length=255, 
        widget=forms.FileInput(), required=False
      )
      picture_path = forms.CharField(
        max_length=255, widget=forms.HiddenInput(), required=False 
      )
      latitude = forms.FloatField(
        label=_("Latitude"),
        help_text=_("Latitude (Lat.) is the angle between any point and the equator (north pole is at 90; south pole is at -90)."),
        required=False,
      )
      longitude = forms.FloatField(
        label=_("Longitude"),
        help_text=_("Longitude (Long.) is the angle east or west of an arbitrary point on Earth from Greenwich (UK), which is the international zero-longitude point (longitude=0 degrees). The anti-meridian of Greenwich is both 180 (direction to east) and -180 (direction to west)."),
        required=False,
      )
      class Meta:
        model = Location
        exclude = ["geoposition", "rating"]
    ```

1.  åœ¨è¯¥è¡¨å•çš„__init__()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä»æ¨¡å‹å®ä¾‹ä¸­è¯»å–ä½ç½®ï¼Œç„¶åå¯¹è¡¨å•å®šä¹‰django-crispy-formså¸ƒå±€ï¼š


    ```
    def __init__(self, request, *args, **kwargs): 
      self.request = request 
      super().__init__(*args, **kwargs) 
      geoposition = self.instance.get_geoposition() 
      if geoposition:
        self.fields["latitude"].initial = geoposition.latitude 
        self.fields["longitude"].initial = geoposition.longitude
    
      name_field = layout.Field("name", css_class="input-block- level")
      description_field = layout.Field(
        "description", css_class="input-block-level", rows="3"
      )
      main_fieldset = layout.Fieldset(_("Main data"), name_field, description_field)
    
      picture_field = layout.Field( 
        "picture",
        data_url=reverse("upload_file"),
        template="core/includes/file_upload_field.html", 
      )
      picture_path_field = layout.Field("picture_path")
    
      picture_fieldset = layout.Fieldset( 
        _("Picture"),
        picture_field,
        picture_path_field,
        title=_("Picture upload"),
        css_id="picture_fieldset",
      )
    
      street_address_field = layout.Field( 
        "street_address", css_class="input-block-level"
      )
      street_address2_field = layout.Field(
        "street_address2", css_class="input-block-level" 
      )
      postal_code_field = layout.Field("postal_code", css_class="input-block-level")
      city_field = layout.Field("city", css_class="input-block- level")
      country_field = layout.Field("country", css_class="input- block-level")
      latitude_field = layout.Field("latitude", css_class="input- block-level")
      longitude_field = layout.Field("longitude", css_class="input- block-level")
      address_fieldset = layout.Fieldset( 
        _("Address"),
        street_address_field,
        street_address2_field,
        postal_code_field,
        city_field,
        country_field,
        latitude_field,
        longitude_field,
      )
      submit_button = layout.Submit("save", _("Save"))
      actions = bootstrap.FormActions(layout.Div(submit_button, css_class="col"))
    
      self.helper = helper.FormHelper() 
      self.helper.form_action = self.request.path 
      self.helper.form_method = "POST" 
      self.helper.attrs = {"noValidate": "noValidate"} 
      self.helper.layout = layout.Layout(main_fieldset, picture_fieldset, address_fieldset, actions)
    ```

1.  ç„¶åæˆ‘ä»¬è¦å¯¹è¯¥è¡¨å•çš„pictureå’Œpicture_pathå­—æ®µæ·»åŠ éªŒè¯ï¼š


    ```
    def clean(self):
      cleaned_data = super().clean()
      picture_path = cleaned_data["picture_path"]
      if not self.instance.pk and not self.files.get("picture") and not picture_path:
        raise forms.ValidationError(_("Please choose an image."))
    ```

1.  æœ€åï¼Œæˆ‘ä»¬å¯¹è¯¥è¡¨å•æ·»åŠ ä¿å­˜æ–¹æ³•ï¼Œå¤„ç†å›¾ç‰‡å’Œåœ°ç†ä½ç½®çš„ä¿å­˜ï¼š


    ```
    def save(self, commit=True):
      instance = super().save(commit=False) 
      picture_path = self.cleaned_data["picture_path"] 
      if picture_path:
        temporary_image_path = os.path.join("temporary-uploads", picture_path)
        file_obj = default_storage.open(temporary_image_path) 
        instance.picture.save(picture_path, file_obj, save=False) 
        default_storage.delete(temporary_image_path)
      latitude = self.cleaned_data["latitude"] 
      longitude = self.cleaned_data["longitude"]
      if latitude is not None and longitude is not None:
        instance.set_geoposition(longitude=longitude, latitude=latitude)
      if commit: 
        instance.save()
        self.save_m2m() 
      return instance
    ```

1.  é™¤å‰é¢åœ¨locationsåº”ç”¨ä¸­å®šä¹‰çš„è§†å›¾å¤–ï¼Œè¿˜è¦æ·»åŠ ä¸€ä¸ªadd_or_change_locationè§†å›¾ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š


    ```
    # myproject/apps/locations/views.py
    from django.contrib.auth.decorators import login_required
    from django.shortcuts import render, redirect, get_object_or_404
    
    from .forms import LocationForm 
    from .models import Location
    
    #...
    
    @login_required
    def add_or_change_location(request, pk=None):
      location = None 
      if pk:
        location = get_object_or_404(Location, pk=pk) 
      if request.method == "POST":
        form = LocationForm(request, data=request.POST, files=request.FILES, instance=location)
        if form.is_valid():
          location = form.save()
          return redirect("locations:location_detail", pk=location.pk)
      else:
        form = LocationForm(request, instance=location)
      context = {"location": location, "form": form}
      return render(request, "locations/location_form.html", context)
    ```

1.  åœ¨URLé…ç½®ä¸­æ·»åŠ è¯¥è§†å›¾ï¼š


    ```
    # myproject/apps/locations/urls.py
    from django.urls import path
    from .views import add_or_change_location
    
    urlpatterns = [ 
      #...
      path("<uuid:pk>/change/", add_or_change_location, name="add_or_change_location"),
    ]
    ```

1.  åœ¨coreåº”ç”¨çš„è§†å›¾ä¸­ï¼Œæ·»åŠ é€šç”¨upload_fileå‡½æ•°ä¸Šä¼ å›¾ç‰‡ï¼Œä¾›å…¶å®ƒå…·æœ‰pictureå­—æ®µçš„åº”ç”¨å¤ç”¨ï¼š


    ```
    # myproject/apps/core/views.py
    import os
    from django.core.files.base import ContentFile
    from django.core.files.storage import default_storage 
    from django.http import JsonResponse
    from django.core.exceptions import SuspiciousOperation 
    from django.urls import reverse
    from django.views.decorators.csrf import csrf_protect 
    from django.utils.translation import gettext_lazy as _ 
    from django.conf import settings
    #...
    
    @csrf_protect
    def upload_file(request):
      status_code = 400
      data = {"files": [], "error": _("Bad request")}
      if request.method == "POST" and request.is_ajax() and "picture" in request.FILES:
        file_types = [f"image/{x}" for x in ["gif", "jpg", "jpeg", "png"]]
        file = request.FILES.get("picture")
        if file.content_type not in file_types:
          status_code = 405
          data["error"] = _("Invalid file format")
        else:
          upload_to = os.path.join("temporary-uploads", file.name)
          name = default_storage.save(upload_to, ContentFile(file.read()))
          file = default_storage.open(name) status_code = 200
          del data["error"] 
          absolute_uploads_dir = os.path.join(
            settings.MEDIA_ROOT, "temporary-uploads" 
          )
          file.filename = os.path.basename(file.name) 
          data["files"].append(
            {
              "name": file.filename, 
              "size": file.size, 
              "deleteType": "DELETE", 
              "deleteUrl": (
                reverse("delete_file") + f"?filename={file.filename}"
              ),
              "path": file.name[len(absolute_uploads_dir) + 1 :], 
            }
          )
          
      return JsonResponse(data, status=status_code)
    ```

1.  ä¸ºæ–°ä¸Šä¼ è§†å›¾è®¾ç½®URLè§„åˆ™å¦‚ä¸‹ï¼š


    ```
    # myproject/urls.py
    from django.urls import path
    from myproject.apps.core import views as core_views
    
    #...
    
    urlpatterns += [ 
      path(
        "upload-file/", 
        core_views.upload_file, 
        name="upload_file",
      ), 
    ]
    ```

1.  ä¸‹é¢ä¸ºåœ°ç‚¹è¡¨å•åˆ›å»ºæ¨¡æ¿å¦‚ä¸‹ï¼š


    ```
    {# locations/location_form.html #}
    {% extends "base.html" %}
    {% load i18n crispy_forms_tags %}
    
    {% block content %}
        <div class="row">
            <div class="col-lg-8">
                <a href="{% url 'locations:location_list' %}">{% trans "Interesting Locations" %}</a>
                <h1>
                    {% if location %}
                        {% blocktrans trimmed with name=location.name %}
                            Change Location "{{ name }}"
                        {% endblocktrans %}
                    {% else %}
                        {% trans "Add Location" %}
                    {% endif %}
                </h1>
                {% crispy form %}
            </div>
        </div>
    {% endblock %}
    ```

1.  æˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›æ¨¡æ¿ã€‚åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ è‡ªå®šä¹‰æ¨¡æ¿ï¼Œå…¶ä¸­åŒ…å«æ‰€éœ€çš„CSSå’ŒJavaScriptï¼š


    ```
    {# core/includes/file_upload_field.html #}
    {% load i18n crispy_forms_field static sekizai_tags %}
    
    {% include "core/includes/picture_preview.html" %}
    <{% if tag %}{{ tag }}{% else %}div{% endif %} id="div_{{ field.auto_id }}"
    class="form-group{% if 'form-horizontal' in form_class %} row{% endif %}
    {% if wrapper_class %} {{ wrapper_class }}{% endif %}
    {% if field.css_classes %} {{ field.css_classes }}{% endif %}">
        {% if field.label and form_show_labels %} 
            <label for="{{ field.id_for_label }}"
                class="col-form-label {{ label_class }}
                {% if field.field.required %} requiredField{% endif %}">
                {{ field.label|safe }}{% if field.field.required %}<span class="asteriskField">*</span>{% endif %}
             </label>
        {% endif %}
    
        <div class="{{ field_class }}">
            <span class="btn btn-success fileinput-button">
                <span>{% trans "Upload File..." %}</span>
                    {% crispy_field field %}
            </span>
            {% include 'bootstrap4/layout/help_text_and_errors.html' %} 
            <p class="form-text text-muted">
                {% trans "Available formats are JPG, GIF, and PNG." %}
            {% trans "Minimal size is 800 Ã— 800 px." %} 
            </p>
        </div>
    </{% if tag %}{{ tag }}{% else %}div{% endif %}>
    
    {% addtoblock "css" %}
    <link rel="stylesheet" href="{% static 'site/vendor/jQuery-File-Upload-10.2.0/css/jquery.fileupload-ui.css' %}"/>
    <link rel="stylesheet" href="{% static 'site/vendor/jQuery-File-Upload-10.2.0/css/jquery.fileupload.css' %}"/>
    {% endaddtoblock %}
    
    {% addtoblock "js" %}
    <script src="{% static 'site/vendor/jQuery-File-Upload-10.2.0/js/vendor/jquery.ui.widget.js' %}"></script> 
    <script src="{% static 'site/vendor/jQuery-File-Upload-10.2.0/js/jquery.iframe-transport.js' %}"></script> 
    <script src="{% static 'site/vendor/jQuery-File-Upload-10.2.0/js/jquery.fileupload.js' %}"></script>
    <script src="{% static 'site/js/picture_upload.js' %}"></script> 
    {% endaddtoblock %}
    ```

1.  ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªç”¨äºå›¾ç‰‡é¢„è§ˆçš„æ¨¡æ¿ï¼š


    ```
    {# core/includes/picture_preview.html #}
    <div id="picture_preview">
        {% if form.instance.picture %}
            <img src="{{ form.instance.picture.url }}" alt="" class="img-fluid"/>
        {% endif %}
    </div>
    <div id="progress" class="progress" style="visibility: hidden"> 
        <div class="progress-bar progress-bar-striped
            progress-bar-animated" 
            role="progressbar" 
            aria-valuenow="0" 
            aria-valuemin="0" 
            aria-valuemax="100" 
            style="width: 0%"></div>
    </div>
    ```

1.  æœ€åï¼Œæ·»åŠ å¤„ç†å›¾ç‰‡ä¸Šä¼ å’Œé¢„è§ˆçš„JavaScriptï¼š


    ```
    /* site_static/site/js/picture_upload.js */
    $(function() { 
        $("#id_picture_path").each(function() {
            $picture_path = $(this); 
            if ($picture_path.val()) {
                $("#picture_preview").html( 
                    '<img src="' +
                    window.settings.MEDIA_URL + 
                    "temporary-uploads/" + 
                    $picture_path.val() +
                    '" alt="" class="img-fluid" />'
                ); 
            }
        }); 
        $("#id_picture").fileupload({
            dataType: "json",
            add: function(e, data) {
                $("#progress").css("visibility", "visible");
                data.submit(); 
            },
            progressall: function(e, data) {
                var progress = parseInt((data.loaded / data.total) * 100,10);
                $("#progress .progress-bar")
                .attr("aria-valuenow", progress)
                .css("width", progress + "%"); 
            },
            done: function(e, data) { 
                $.each(data.result.files, function(index, file) {
                    $("#picture_preview").html( 
                    '<img src="' +
                        window.settings.MEDIA_URL + 
                        "temporary-uploads/" + 
                        file.name +
                        '" alt="" class="img-fluid" />'
                    );
                    $("#id_picture_path").val(file.name); 
                });
                $("#progress").css("visibility", "hidden"); 
            }
        }); 
    });
    ```

### å®ç°åŸç†...

å¦‚æœJavaScriptæ‰§è¡Œå¤±è´¥ï¼Œè¡¨å•ä»ç„¶å¯ç”¨ï¼Œä½†åœ¨JavaScriptæ­£å¸¸è¿è¡Œæ—¶ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ”¹è¿›äº†çš„è¡¨å•ï¼Œæ–‡ä»¶å­—æ®µç”±æŒ‰é’®æ›¿æ¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![ä¸Šä¼ æŒ‰é’®](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eae0dffbc3ea433a9e5c00c581ebcdd3~tplv-k3u1fbpfcp-zoom-1.image)

åœ¨é€šè¿‡ç‚¹å‡»Upload File...æŒ‰é’®é€‰ä¸­å›¾ç‰‡åï¼Œæµè§ˆå™¨ä¸­çš„ç»“æœç±»ä¼¼ä¸‹é¢çš„æˆªå›¾ï¼š

![ä¸Šä¼ å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5b8e11e78994900abd2110ba0aa9f5b~tplv-k3u1fbpfcp-watermark.image?)

ç‚¹å‡»Upload File...æŒ‰é’®ä¼šè§¦å‘æ–‡ä»¶å¯¹è¯æ¡†ï¼Œè¦æ±‚é€‰æ‹©æ–‡ä»¶ï¼Œé€‰ä¸­åä¼šç«‹å³å¼€å§‹Ajaxä¸Šä¼ å¤„ç†ã€‚ç„¶åæˆ‘ä»¬çœ‹åˆ°æ·»åŠ äº†å›¾ç‰‡çš„é¢„è§ˆã€‚é¢„è§ˆçš„å›¾ç‰‡ä¸Šä¼ åˆ°äº†ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œæ–‡ä»¶åä¿å­˜åœ¨picture_pathéšè—å­—æ®µä¸­ã€‚åœ¨æäº¤è¡¨å•æ—¶ï¼Œè¡¨å•é€šè¿‡ä¸´æ—¶ç›®å½•æˆ–å›¾ç‰‡å­—æ®µä¿å­˜è¯¥å›¾ç‰‡ã€‚å›¾ç‰‡å­—æ®µçš„å€¼åœ¨æäº¤è¡¨å•æ—¶æ²¡æœ‰JavaScriptæˆ–æ— æ³•åŠ è½½JavaScriptçš„æƒ…å†µä¸‹ä¼šè¿›è¡Œæäº¤ã€‚å¦‚æœåœ¨é¡µé¢é‡æ–°åŠ è½½åå…¶å®ƒå­—æ®µå­˜åœ¨éªŒè¯é”™è¯¯ï¼Œé‚£ä¹ˆé¢„è§ˆå›¾ç‰‡æ ¹æ®picture_pathè¿›è¡ŒåŠ è½½ã€‚

æˆ‘ä»¬è¿›ä¸€æ­¥æ·±æŒ–è¿è¡Œæ­¥éª¤ï¼ŒæŸ¥çœ‹å…¶è¿è¡ŒåŸç†ã€‚

åœ¨é’ˆå¯¹Locationæ¨¡å‹çš„æ¨¡å‹è¡¨å•ä¸­ï¼Œæˆ‘ä»¬ä»¤pictureå­—æ®µéå¿…å¡«ï¼Œä½†å®ƒåœ¨æ¨¡å‹å±‚é¢æ˜¯å¿…å¡«çš„ã€‚æ­¤å¤–ï¼Œè¿˜æ·»åŠ äº†picture_pathå­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µè‡³å°‘æœ‰ä¸€ä¸ªè¦æäº¤è‡³è¡¨å•ã€‚åœ¨crispy-formså¸ƒå±€ä¸­ï¼Œæˆ‘ä»¬å¯¹pictureå­—æ®µå®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰æ¨¡æ¿file_upload_field.htmlã€‚åœ¨é‡Œé¢è®¾ç½®äº†é¢„è§ˆå›¾ç‰‡ã€ä¸Šä¼ è¿›åº¦æ¡ã€å…è®¸ä¸Šä¼ æ–‡ä»¶æ ¼å¼ä»¥åŠæœ€å°å°ºå¯¸çš„è‡ªå®šä¹‰å¸®åŠ©æ–‡æœ¬ã€‚è¿˜åœ¨è¯¥æ¨¡æ¿ä¸­æ·»åŠ äº† jQuery File Uploadåº“ä¸­çš„CSSå’ŒJavaScriptæ–‡ä»¶ä»¥åŠè‡ªå®šä¹‰è„šæœ¬picture_upload.jsã€‚CSSæ–‡ä»¶å°†ä¸Šä¼ å­—æ®µæ¸²æŸ“ä¸ºç¾è§‚çš„æŒ‰é’®ã€‚JavaScriptè´Ÿè´£åŸºäºAjaxçš„æ–‡ä»¶ä¸Šä¼ ã€‚

picture_upload.jså°†æ‰€é€‰ä¸­çš„æ–‡ä»¶å‘é€ç»™upload_fileè§†å›¾ã€‚è¯¥è§†å›¾æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶æ˜¯å¦ä¸ºå›¾ç‰‡ç±»å‹å¹¶å°è¯•å°†å…¶ä¿å­˜è‡³é¡¹ç›®MEDIA_ROOTä¸­çš„temporary-uploads/ç›®å½•ä¸‹ã€‚æ­¤è§†å›¾è¿”å›æ–‡ä»¶æˆåŠŸæˆ–ä¸æˆåŠŸä¸Šä¼ è¯¦æƒ…çš„JSONã€‚

åœ¨é€‰ä¸­å¹¶ä¸Šä¼ å›¾ç‰‡åŠæäº¤è¡¨å•ä¹‹åï¼Œä¼šè°ƒç”¨LocationFormçš„save()æ–¹æ³•ã€‚å¦‚æœå­˜åœ¨picture_pathå­—æ®µï¼Œä¼šä»ä¸´æ—¶ç›®å½•ä¸­æå–æ–‡ä»¶ã€å¤åˆ¶åˆ°Locationæ¨¡å‹çš„pictureå­—æ®µä¸­ã€‚ç„¶åä¼šåˆ é™¤ä¸´æ—¶ç›®å½•ä¸­çš„å›¾ç‰‡å¹¶ä¿å­˜Locationå®ä¾‹ã€‚

### æ‰©å±•çŸ¥è¯†...

æˆ‘ä»¬åœ¨æ¨¡å‹è¡¨å•ä¸­æ’é™¤äº†geopositionå­—æ®µï¼Œè€Œæ˜¯å°†åœ°ç†ä½ç½®çš„æ•°æ®ä»¥çº¬åº¦å’Œç»åº¦å­—æ®µè¿›è¡Œæ¸²æŸ“ã€‚é»˜è®¤åœ°ç†ä½ç½®çš„PointFieldä»¥Leaflet.jsåœ°å›¾è¿›è¡Œæ¸²æŸ“ï¼Œæ— æ³•è‡ªå®šä¹‰ã€‚é€šè¿‡è¿™ä¸¤ä¸ªçº¬åº¦å’Œç»åº¦å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»åœ°ä½¿ç”¨Google Maps API, Bing Maps APIæˆ–Leaflet.jsæ¥åœ¨åœ°å›¾ä¸­æ˜¾ç¤ºï¼Œå¯æ‰‹åŠ¨è¾“å…¥æˆ–é€šè¿‡è¾“å…¥çš„åœ°å€ä»£ç ç”Ÿæˆã€‚

ä¸ºæ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†å‰é¢åœ¨*ä½¿ç”¨HTML5 dataå±æ€§*ä¸€èŠ‚ä¸­å®šä¹‰çš„ä¸¤ä¸ªå¸®åŠ©æ–¹æ³•get_geoposition() å’Œ set_geoposition()ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨HTML5 dataå±æ€§*ä¸€èŠ‚
-   [**ç¬¬3ç«  è¡¨å•å’Œè§†å›¾**](https://alanhou.org/forms-views/)ä¸­çš„*ä¸Šä¼ å›¾ç‰‡*ä¸€èŠ‚
-   *åœ¨æ¨¡æ€å¯¹è¯æ¡†ä¸­æ‰“å¼€å¯¹è±¡è¯¦æƒ…*ä¸€èŠ‚
-   *å®ç°æŒç»­æ»šåŠ¨*ä¸€èŠ‚
-   *å®ç°Likeå¾®ä»¶*ä¸€èŠ‚
-   [**ç¬¬7ç«  å®‰å…¨å’Œæ€§èƒ½**](https://alanhou.org/django3-security-performance/)ä¸­çš„*è®©è¡¨å•é¿å…è·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)æ”»å‡»*ä¸€èŠ‚
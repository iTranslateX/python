# ç¬¬2ç«  æ¨¡å‹å’Œæ•°æ®åº“ç»“æ„

æœ¬ç« åŒ…å«å¦‚ä¸‹ä¸»é¢˜ï¼š

-   ä½¿ç”¨æ¨¡å‹mixin
-   é€šè¿‡URLç›¸å…³çš„æ–¹æ³•åˆ›å»ºæ¨¡å‹mixin
-   åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†åˆ›å»ºå’Œå˜æ›´æ—¥æœŸ
-   åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾
-   åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³ç³»
-   å¤„ç†å¤šè¯­è¨€å­—æ®µ
-   æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨
-   è§„é¿å¾ªç¯ä¾èµ–
-   æ·»åŠ æ•°æ®åº“çº¦æŸ
-   ä½¿ç”¨è¿ç§»
-   ä¿®æ”¹å¤–é”®ä¸ºmany-to-manyå­—æ®µ

## å¼•è¨€

åœ¨å¯åŠ¨æ–°åº”ç”¨æ—¶ï¼Œé¦–å…ˆæ˜¯åˆ›å»ºèƒ½ä»£è¡¨æ•°æ®åº“ç»“æ„çš„æ¨¡å‹ã€‚å‡è®¾ä½ å·²ç»åˆ›å»ºè¿‡Djangoåº”ç”¨æˆ–è€…è‡³å°‘æ˜¯é˜…è¯»å¹¶æŒæ¡äº†Djangoå®˜æ–¹è¯¾ç¨‹ã€‚æœ¬ç« ä¸­ï¼Œä½ å°†å­¦ä¹ åˆ°ä¸€äº›æŠ€æœ¯ï¼Œèƒ½è®©é¡¹ç›®ä¸­çš„ä¸åŒåº”ç”¨ä¿æŒæ•°æ®åº“ç»“æ„çš„è¿ç»­æ€§ã€‚ç„¶åï¼Œä½ å°†å­¦ä¹ åˆ°å¦‚ä½•å¤„ç†æ•°æ®åº“ä¸­æ•°æ®çš„å›½é™…åŒ–ã€‚å†åï¼Œä½ å°†å­¦ä¹ åˆ°å¦‚ä½•åœ¨æ¨¡å‹ä¸­é¿å…å¾ªç¯ä¾èµ–ä»¥åŠå¦‚ä½•è®¾ç½®æ•°æ®åº“çº¦æŸã€‚åœ¨æœ¬ç« çš„æœ€åï¼Œä½ å°†å­¦ä¹ åˆ°å¦‚ä½•åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ä½¿ç”¨è¿ç§»æ¥ä¿®æ”¹æ•°æ®åº“ç»“æ„ã€‚

## æŠ€æœ¯è¦æ±‚

ä½¿ç”¨æœ¬ä¹¦ä¸­çš„ä»£ç ï¼Œéœ€è¦æœ‰ç¨³å®šç‰ˆæœ¬çš„Pythonã€MySQLæˆ–PostgreSQLæ•°æ®åº“ï¼Œä»¥åŠä½äºè™šæ‹Ÿç¯å¢ƒä¸­çš„Djangoé¡¹ç›®ã€‚

å¯ä»¥åœ¨[GitHubä»“åº“](https://github.com/alanhou/django3-cookbook)çš„Chapter02ç›®å½•ä¸­æŸ¥çœ‹æœ¬ç« çš„ä»£ç ã€‚

## ä½¿ç”¨æ¨¡å‹mixin

åœ¨é¢å‘å¯¹è±¡è¯­è¨€å¦‚Pythonä¸­ï¼Œmixinç±»å¯çœ‹ä½œå¸¦æœ‰å®ç°åŠŸèƒ½çš„æ¥å£ã€‚åœ¨æ¨¡å‹ç»§æ‰¿mixinæ—¶ï¼Œå®ƒç»§æ‰¿è¯¥æ¥å£å¹¶åŒ…å«å…¶æ‰€æœ‰çš„å­—æ®µã€å±æ€§ï¼ˆattributesï¼‰ã€ç§æœ‰å±æ€§ï¼ˆpropertyï¼‰å’Œæ–¹æ³•ã€‚Djangoæ¨¡å‹ä¸­çš„mixinå¯åœ¨ä¸åŒæ¨¡å‹ä¸­å¤šæ¬¡å¤ç”¨é€šç”¨åŠŸèƒ½ã€‚Djangoä¸­çš„æ¨¡å‹mixinæ˜¯æŠ½è±¡æ¨¡å‹åŸºç±»ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„å‡ ä¸ªå°èŠ‚ä¸­è¿›è¡Œæ¢è®¨ã€‚

### å‡†å¤‡å·¥ä½œ

é¦–å…ˆéœ€è¦åˆ›å»ºå¯å¤ç”¨çš„mixinã€‚æŠŠæ¨¡å‹mixinæ”¾åœ¨myproject.apps.coreä¸­ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å¦‚æœåˆ›å»ºä¸€ä¸ªä¼šä¸ä»–äººå…±äº«çš„å¯å¤ç”¨åº”ç”¨ï¼Œå°†æ¨¡å‹mixinæ”¾åœ¨å¯å¤ç”¨åº”ç”¨æœ¬èº«å½“ä¸­ï¼Œå¯ä»¥æ˜¯åœ¨base.pyæ–‡ä»¶ä¸­ã€‚

### å¦‚ä½•å®ç°...

æ‰“å¼€ä»»æ„å¸Œæœ›ä½¿ç”¨mixinçš„Djangoåº”ç”¨çš„models.pyæ–‡ä»¶ï¼Œå¹¶è¾“å…¥å¦‚ä¸‹ä»£ç ï¼š

```
# myproject/apps/ideas/models.py
from django.db import models
from django.urls import reverse
from django.utils.translation import gettext_lazy as _

from myproject.apps.core.models import ( 
  CreationModificationDateBase, 
  MetaTagsBase,
  UrlBase,
)

class Idea(CreationModificationDateBase, MetaTagsBase, UrlBase): 
  title = models.CharField(
    _("Title"),
    max_length=200, 
  )
  content = models.TextField( 
    _("Content"),
  )
  # other fields...

  class Meta:
    verbose_name = _("Idea") 
    verbose_name_plural = _("Ideas")

  def __str__(self): 
    return self.title

  def get_url_path(self):
    return reverse("idea_details", kwargs={
      "idea_id": str(self.pk), 
    })
```

### å®ç°åŸç†...

Djangoçš„æ¨¡å‹ç»§æ‰¿æ”¯æŒ3ç§ç±»å‹çš„ç»§æ‰¿ï¼šæŠ½è±¡åŸºç±»ã€å¤šè¡¨ç»§æ‰¿å’Œä»£ç æ¨¡å‹ã€‚æ¨¡å‹mixinæ˜¯æŠ½è±¡æ¨¡å‹ç±»ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬é€šè¿‡æŠ½è±¡Metaç±»ä»¥æŒ‡å®šçš„å­—æ®µã€å±æ€§å’Œæ–¹æ³•è¿›è¡Œå®šä¹‰ã€‚åœ¨åˆ›å»ºåƒå‰ä¾‹ä¸­æ‰€ç¤ºçš„Ideaè¿™æ ·çš„æ¨¡å‹æ—¶ï¼Œå®ƒä¼šç»§æ‰¿CreationModificationDateMixinã€MetaTagsMixinå’ŒUrlMixinçš„æ‰€æœ‰åŠŸèƒ½ã€‚è¿™äº›æŠ½è±¡ç±»çš„æ‰€æœ‰å­—æ®µåœ¨æ•°æ®è¡¨ä¸­ä»¥ç»§æ‰¿æ¨¡å‹çš„å­—æ®µè¿›è¡Œä¿å­˜ã€‚ä¸‹é¢çš„å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•å®šä¹‰æ¨¡å‹mixinã€‚

### æ‰©å±•çŸ¥è¯†...

åœ¨å¸¸è§„çš„Pythonç±»ç»§æ‰¿ä¸­ï¼Œå¦‚æœæœ‰ä¸€ä¸ªä»¥ä¸Šçš„åŸºç±»ï¼Œå®ƒä»¬éƒ½ä¼šå®ç°å…·ä½“çš„æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨å­ç±» å®ä¾‹ä¸Šçš„æ–¹æ³•ï¼Œä»…ç¬¬ä¸€ä¸ªçˆ¶ç±»çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š

```
>>> class A(object):
...   def test(self):
...     print("A.test() called") 
...

>>> class B(object):
...   def test(self):
...     print("B.test() called") 
...

>>> class C(object):
...   def test(self):
...     print("C.test() called") 
...

>>> class D(A, B, C):
...   def test(self): 
...     super().test()
...     print("D.test() called")

>>> d = D() 
>>> d.test()
A.test() called 
D.test() called
```

è¿™ä¸Djangoæ¨¡å‹åŸºç±»ç›¸åŒï¼›ä½†æœ‰ä¸€ä¸ªç‰¹ä¾‹ã€‚

> â„¹ï¸Djangoæ¡†æ¶é€šè¿‡å…ƒç±»è°ƒç”¨æ¯ä¸ªåŸºç±»çš„save()å’Œdelete()æ–¹æ³•å®ç°äº†ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ã€‚

è¿™è¡¨ç¤ºä½ å¯ä»¥æ”¾å¿ƒåœ°é€šè¿‡é‡å†™save()å’Œdelete()æ–¹æ³•å¯¹åœ¨mixinä¸­ç‰¹åˆ«å®šä¹‰çš„æŒ‡å®šå­—æ®µè¿›è¡Œä¿å­˜å‰ã€ä¿å­˜åã€åˆ é™¤å‰å’Œåˆ é™¤åçš„æ“ä½œã€‚

è¦å­¦ä¹ æœ‰å…³æ¨¡å‹ç»§æ‰¿ä¸åŒç±»å‹çš„æ›´å¤šçŸ¥è¯†ï¼Œå‚æ•°Djangoå®˜æ–¹æ–‡æ¡£ä¸­çš„[æ¨¡å‹ç»§æ‰¿](https://docs.djangoproject.com/en/3.0/topics/db/models/#model-inheritance)éƒ¨åˆ†ã€‚

### ç›¸å…³å†…å®¹

-   *é€šè¿‡URLç›¸å…³çš„æ–¹æ³•åˆ›å»ºæ¨¡å‹mixin*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†åˆ›å»ºå’Œå˜æ›´æ—¥æœŸ*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾*ä¸€èŠ‚

## é€šè¿‡URLç›¸å…³çš„æ–¹æ³•åˆ›å»ºæ¨¡å‹mixin

å¯¹äºæ¯ä¸ªæœ‰è‡ªå·±ç‹¬ç«‹è¯¦æƒ…é¡µçš„æ¨¡å‹ï¼Œå®šä¹‰ä¸€ä¸ªget_absolute_url()æ˜¯ä¸€ç§å¥½åšæ³•ã€‚è¿™ä¸€æ–¹æ³•å¯åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨å¹¶ç”¨äºåœ¨Djangoåå°ç«™ç‚¹ä¸­é¢„è§ˆå·²ä¿å­˜å¯¹è±¡ã€‚ä½†get_absolute_url()æœ¬èº«æœ‰äº›æ­§ä¹‰ï¼Œå®ƒè¿”å›çš„æ˜¯URLè·¯å¾„è€Œéå®Œæ•´URLã€‚

åœ¨è¿™ä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ›å»ºä¸ºæ¨¡å‹å…·ä½“çš„URLæä¾›ç®€åŒ–æ”¯æŒçš„æ¨¡å‹mixinã€‚è¿™ä¸€mixinè®©æˆ‘ä»¬å¯ä»¥åšå¦‚ä¸‹äº‹æƒ…ï¼š

-   å…è®¸æˆ‘ä»¬åœ¨æ¨¡å‹ä¸­å®šä¹‰URLè·¯å¾„æˆ–å®Œæ•´URL
-   è‡ªåŠ¨æ ¹æ®æˆ‘ä»¬çš„å®šä¹‰ç”Ÿæˆå…¶å®ƒURL
-   åœ¨åå°å®šä¹‰ get_absolute_url() æ–¹æ³•

### å‡†å¤‡å·¥ä½œ

å¦‚å°šæœªåˆ›å»ºï¼Œè¯·åˆ›å»ºmyproject.apps.coreåº”ç”¨ï¼Œåœ¨å…¶ä¸­å­˜å‚¨æ¨¡å‹mixinã€‚ç„¶ååœ¨coreåŒ…ä¸­åˆ›å»ºmodels.pyæ–‡ä»¶ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ åˆ›å»ºçš„æ˜¯å¯å¤ç”¨åº”ç”¨ï¼Œå¯ä»¥å°†mixinæ”¾åœ¨åº”ç”¨çš„base.pyæ–‡ä»¶ä¸­ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤é€ä¸€æ‰§è¡Œï¼š

1.  å°†å¦‚ä¸‹å†…å®¹æ·»åŠ åˆ°coreåº”ç”¨çš„models.pyæ–‡ä»¶ä¸­ï¼š


    ```
    # myproject/apps/core/models.py
    from urllib.parse import urlparse, urlunparse 
    from django.conf import settings
    
    from django.db import models
    class UrlBase(models.Model): 
      """
      A replacement for get_absolute_url()
      Models extending this mixin should have either get_url or
      get_url_path implemented. 
      """
      class Meta: 
        abstract = True
    
      def get_url(self):
        if hasattr(self.get_url_path, "dont_recurse"):
          raise NotImplementedError
        try:
          path = self.get_url_path() 
        except NotImplementedError:
          raise
        return settings.WEBSITE_URL + path
      get_url.dont_recurse = True
    
      def get_url_path(self):
        if hasattr(self.get_url, "dont_recurse"):
          raise NotImplementedError
        try:
          url = self.get_url() 
        except NotImplementedError:
          raise
        bits = urlparse(url)
        return urlunparse(("", "") + bits[2:])
    get_url_path.dont_recurse = True
    
    def get_absolute_url(self): 
      return self.get_url()
    ```

1.   å‘å¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§è®¾ç½®æ·»åŠ WEBSITE_URLè®¾ç½®ï¼Œåé¢ä¸å¸¦æ–œçº¿ã€‚ä¾‹å¦‚ï¼Œå¼€å‘ç¯å¢ƒçš„è®¾ç½®å¦‚ä¸‹ï¼š


    ```
    # myproject/settings/dev.py
    from ._base import *
    
    DEBUG = True
    WEBSITE_URL = "http://127.0.0.1:8000" # æœ€åé¢ä¸å¸¦æ–œçº¿
    ```

1.   è¦åœ¨åº”ç”¨ä¸­ä½¿ç”¨mixinï¼Œé€šè¿‡coreåº”ç”¨å¯¼å…¥mixinï¼Œåœ¨æ¨¡å‹ç±»ä¸­ç»§æ‰¿è¯¥mixinï¼Œå¹¶å®šä¹‰get_url_path()æ–¹æ³•å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.urls import reverse
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.models import UrlBase 
    
    class Idea(UrlBase):
      # å­—æ®µã€å±æ€§ã€ç§æœ‰å±æ€§å’Œæ–¹æ³•... 
      def get_url_path(self):
        return reverse("idea_details", kwargs={ 
          "idea_id": str(self.pk),
        })
    ```

### å®ç°åŸç†...

UrlBaseç±»æ˜¯æ‹¥æœ‰3ä¸ªæ–¹æ³•çš„æŠ½è±¡æ¨¡å‹ï¼Œå¦‚ä¸‹ï¼š

-   get_url()è·å–å¯¹è±¡çš„å®Œæ•´URL
-   get_url_path()è·å–å¯¹è±¡çš„ç»å¯¹è·¯å¾„
-   get_absolute_url()ä¸get_url_path()æ–¹æ³•ç±»ä¼¼

get_url()å’Œget_url_path()æ–¹æ³•ä¼šåœ¨ç»§æ‰¿åçš„æ¨¡å‹ç±»ä¸­è¿›è¡Œé‡å†™ï¼Œå¦‚Ideaã€‚å¯ä»¥å®šä¹‰get_url()ï¼Œget_url_path()ä¼šå°†å…¶å˜ä¸ºè·¯å¾„ã€‚ç›¸åº”åœ°ä¹Ÿå¯ä»¥å®šä¹‰get_url_path()ï¼Œè€Œget_url() ä¼šåœ¨å…¶è·¯å¾„å‰æ·»åŠ ç½‘ç«™URLã€‚

> â„¹ï¸ä¸€æ¡é»„é‡‘æ³•åˆ™æ˜¯ä¿æŒé‡å†™ get_url_path()æ–¹æ³•ã€‚

åœ¨æ¨¡æ¿ä¸­ï¼Œåœ¨éœ€è¦é“¾æ¥åˆ°åŒä¸€ç½‘ç«™ä¸Šçš„å¯¹è±¡æ—¶ä½¿ç”¨get_url_path()ï¼Œå¦‚ä¸‹ï¼š

```
<a href="{{ idea.get_url_path }}">{{ idea.title }}</a>
```

å¯¹äºå¤–éƒ¨é€šè®¯çš„é“¾æ¥ï¼Œå¦‚emailã€RSS feedæˆ–APIï¼Œä½¿ç”¨get_url()ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```
<a href="{{ â€¨idea.get_url }}">{{ idea.title }}</a>
```

é»˜è®¤çš„get_absolute_url()æ–¹æ³•ä¼šåœ¨Djangoæ¨¡å‹ç®¡ç†åå°ä¸­ä½¿ç”¨ï¼Œç”¨äºâ€œåœ¨ç½‘ç«™ä¸­æµè§ˆâ€çš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥ç”±ç¬¬ä¸‰æ–¹Djangoåº”ç”¨æ‰€ä½¿ç”¨ã€‚

### æ‰©å±•çŸ¥è¯†...

> ğŸ’¡é€šå¸¸æ¥è¯´ï¼Œä¸è¦åœ¨URLä¸­ä½¿ç”¨é€’å¢ä¸»é”®ï¼Œå› ä¸ºè¿™æ ·ä¸å¤ªå®‰å…¨ï¼Œä¼šå°†ä¸»é”®æš´éœ²ç»™ç»ˆç«¯ç”¨æˆ·ï¼šæ•°æ®æ€»æ¡æ•°ä¼šå¯¹ç”¨æˆ·å¯è§ï¼Œä¹Ÿå¤ªæ˜“äºé€šè¿‡ä¿®æ”¹URLè·¯å¾„æ¥è®¿é—®ä¸åŒæ•°æ®äº†ã€‚

åœ¨è¯¦æƒ…é¡µURLä¸­ä½¿ç”¨ä¸»é”®æ—¶ï¼Œä¸»é”®åº”ç”¨ä¸ºUUIDï¼ˆé€šç”¨å”¯ä¸€è¯†åˆ«ç ï¼‰æˆ–éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ã€‚å¦åˆ™è¯·åƒä¸‹é¢è¿™æ ·åˆ›å»ºå¹¶ä½¿ç”¨slugå­—æ®µï¼š

```
class Idea(UrlBase):
    slug = models.SlugField(_("Slug for URLs"), max_length=50)
```

### ç›¸å…³å†…å®¹

-   ä½¿ç”¨æ¨¡å‹mixin
-   åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†åˆ›å»ºå’Œå˜æ›´æ—¥æœŸ
-   åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾
-   åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³ç³»
-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)ä¸­çš„*ä¸ºå¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®è®¾ç½®*ä¸€èŠ‚

## åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†åˆ›å»ºå’Œå˜æ›´æ—¥æœŸ

åœ¨æ¨¡å‹ä¸­åŒ…å«æ—¶é—´æˆ³ä¾›åˆ›å»ºå’Œä¿®æ”¹æ¨¡å‹å®ä¾‹æ—¶ä½¿ç”¨éå¸¸æ™®éã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ›å»ºä¸€ä¸ªå¯¹æ¨¡å‹ä¿å­˜åˆ›å»ºå’Œä¿®æ”¹æ—¥æœŸçš„ç®€å•æ¨¡å‹mixinã€‚ä½¿ç”¨è¿™ç±»mixinå¯ä»¥ç¡®ä¿æ¯ä¸ªæ¨¡å‹å¯¹æ—¶é—´æˆ³ä½¿ç”¨ç›¸åŒçš„å­—æ®µåï¼Œå¹¶å…·æœ‰åŒæ ·çš„è¡Œä¸ºã€‚

### å‡†å¤‡å·¥ä½œ

å¦‚å°šæœªåˆ›å»ºï¼Œè¯·åˆ›å»ºmyproject.apps.coreåŒ…æ¥ä¿å­˜mixinã€‚ç„¶åï¼Œåœ¨coreåŒ…ä¸­åˆ›å»ºmodels.pyæ–‡ä»¶ã€‚

### å¦‚ä½•å®ç°...

æ‰“å¼€myprojects.apps.coreåŒ…ä¸­çš„models.pyæ–‡ä»¶ï¼Œå¹¶æ’å…¥å¦‚ä¸‹å†…å®¹ï¼š

```
# myproject/apps/core/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _

class CreationModificationDateBase(models.Model): 
  """
  Abstract base class with a creation and modification date and time
  """
  created = models.DateTimeField( 
    _("Creation Date and Time"), 
    auto_now_add=True,
  )
  modified = models.DateTimeField( 
    _("Modification Date and Time"), 
    auto_now=True,
  )

  class Meta:
    abstract = True
```

### å®ç°åŸç†...

CreationModificationDateMixinç±»æ˜¯ä¸€ä¸ªæŠ½è±¡æ¨¡å‹ï¼Œè¿™è¡¨ç¤ºç»§æ‰¿æ¨¡å‹ç±»ä¼šåœ¨åŒä¸€å¼ æ•°æ®è¡¨ä¸­åˆ›å»ºæ‰€æœ‰å­—æ®µï¼Œå³è¿™å°†ä¼šæ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œè®©æ•°æ®è¡¨æ›´éš¾ä»¥å¤„ç†ã€‚

è¿™ä¸€mixinæœ‰ä¸¤ä¸ªæ—¥æœŸæ—¶é—´å­—æ®µï¼Œcreatedå’Œmodifiedã€‚å€ŸåŠ©auto_now_addå’Œauto_nowå±æ€§ï¼Œåœ¨ä¿å­˜æ¨¡å‹æ—¶ä¼šè‡ªåŠ¨ä¿å­˜æ—¶é—´æˆ³ã€‚è¿™äº›å­—æ®µä¼šè‡ªåŠ¨è·å–editable=Falseå±æ€§ï¼Œå› æ­¤ä¼šåœ¨åå°ç®¡ç†è¡¨å•ä¸­éšè—ã€‚å¦‚æœåœ¨è®¾ç½®ä¸­USE_TZè®¾ç½®ä¸ºTrueï¼ˆé»˜è®¤å€¼ä¸”æ˜¯æ¨èå€¼ï¼‰ï¼Œä¼šä½¿ç”¨é€‚é…æ—¶åŒºçš„æ—¶é—´æˆ³ã€‚å¦åˆ™ï¼Œä¼šä½¿ç”¨åŸæ—¶åŒºæ—¶é—´æˆ³ã€‚é€‚é…æ—¶åŒºçš„æ—¶é—´æˆ³åœ¨æ•°æ®åº“ä¸­ä»¥ä¸–ç•Œæ ‡å‡†æ—¶é—´ï¼ˆUTCï¼‰è¿›è¡Œä¿å­˜ï¼Œåœ¨è¯»å–æˆ–å†™å…¥æ—¶ä¼šè½¬æ¢ä¸ºé¡¹ç›®çš„é»˜è®¤æ—¶é—´ã€‚åŸæ—¶åŒºæ—¶é—´æˆ³åœ¨æ•°æ®åº“ä¸­ä»¥é¡¹ç›®çš„æœ¬åœ°æ—¶åŒºè¿›è¡Œå­˜å‚¨ï¼Œé€šå¸¸ä¸å¤ªé€‚ç”¨ï¼Œå› ä¸ºè¿™æ ·ä¼šè®©è·¨æ—¶åŒºçš„ç®¡ç†å˜å¾—æ›´ä¸ºå¤æ‚ã€‚

è¦ä½¿ç”¨è¿™ä¸€mixinï¼Œæˆ‘ä»¬åªéœ€è¦å¯¼å…¥å¹¶æ‰©å±•æ¨¡å‹å³å¯ï¼Œå¦‚ä¸‹ï¼š

```
# myproject/apps/ideas/models.py
from django.db import models

from myproject.apps.core.models import CreationModificationDateBase

class Idea(CreationModificationDateBase):
    # other fields, attributes, properties, and methods...
```

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨æ¨¡å‹mixin*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³ç³»*ä¸€èŠ‚

## åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾

åœ¨é’ˆå¯¹æœç´¢å¼•æ“ä¼˜åŒ–ç«™ç‚¹æ—¶ï¼Œä¸ä»…éœ€è¦åœ¨æ¯ä¸ªé¡µé¢ä½¿ç”¨è¯­æ³•æ ‡è®°ï¼Œè¿˜éœ€è¦åŒ…å«ä¸€äº›é€‚å½“çš„å…ƒæ ‡ç­¾ã€‚ä¸ºä¿æŒæœ€å¤§åŒ–çš„çµæ´»æ€§ï¼Œå¦‚æœå¯¹åœ¨ç½‘ç«™ä¸­å…·æœ‰è‡ªå·±è¯¦æƒ…é¡µé¢çš„å…·ä½“å¯¹è±¡æœ‰å®šä¹‰é€šç”¨å…ƒæ ‡ç­¾å†…å®¹çš„æ–¹å¼ä¼šéå¸¸æœ‰å¸®åŠ©ã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ›å»ºåŒ…å«å…³é”®è¯ã€æè¿°ã€ä½œè€…å’Œç‰ˆæƒå…ƒæ ‡ç­¾ç›¸å…³å­—æ®µå’Œæ–¹æ³•çš„æ¨¡å‹mixinã€‚

### å‡†å¤‡å·¥ä½œ

å’Œå‰é¢å°èŠ‚ä¸€æ ·ï¼Œè¯·ç¡®ä¿æœ‰ç”¨äºmixinçš„myproject.apps.coreåŒ…ã€‚åŒæ—¶ï¼Œåœ¨åŒ…ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•ç»“æ„templates/utils/includes/ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªmeta.htmlæ–‡ä»¶ç”¨äºå­˜å‚¨åŸºç¡€å…ƒæ ‡ç­¾æ ‡è®°ã€‚

### å¦‚ä½•å®ç°...

ä¸‹é¢å°±å¼€å§‹åˆ›å»ºæ¨¡å‹mixinï¼š

1.  åœ¨è®¾ç½®æ–‡ä»¶çš„INSTALLED_APPSä¸­æ·»åŠ myproject.apps.coreï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è®©æ¨¡å‹ä¸­çš„templatesç›®å½•ç”Ÿæ•ˆã€‚

1.  åœ¨meta.htmlæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹åŸºç¡€metaæ ‡ç­¾ï¼š\


    ```
    {# templates/core/includes/meta.html #}
    <meta name="{{ name }}" content="{{ content }}" />
    ```

1.   ä½¿ç”¨ä½ å¸¸ç”¨çš„ç¼–è¾‘å™¨æ‰“å¼€coreåŒ…ä¸­çš„ models.pyæ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\


    ```
    # myproject/apps/core/models.py
    from django.conf import settings
    from django.db import models
    from django.utils.translation import gettext_lazy as _ 
    from django.utils.safestring import mark_safe
    from django.template.loader import render_to_string
    
    class MetaTagsBase(models.Model): 
      """
      Abstract base class for generating meta tags 
      """
      meta_keywords = models.CharField(
        _("Keywords"),
        max_length=255,
        blank=True,
        help_text=_("Separate keywords with commas."),
      )
      meta_description = models.CharField(
        _("Description"), 
        max_length=255, 
        blank=True,
      )
      meta_author = models.CharField(
        _("Author"), 
        max_length=255, 
        blank=True,
      )
      meta_copyright = models.CharField(
        _("Copyright"), 
        max_length=255, 
        blank=True,
      )
      class Meta: 
        abstract = True
    
      def get_meta_field(self, name, content): 
        tag = ""
        if name and content:
        tag = render_to_string("core/includes/meta.html", {
          "name": name,
          "content": content,
        })
        return mark_safe(tag)
    
      def get_meta_keywords(self):
        return self.get_meta_field("keywords", self.meta_keywords)
    
      def get_meta_description(self):
        return self.get_meta_field("description", self.meta_description)
      
      def get_meta_author(self):
        return self.get_meta_field("author", self.meta_author)
    
      def get_meta_copyright(self):
        return self.get_meta_field("copyright", self.meta_copyright)
      
      def get_meta_tags(self):
      return mark_safe("\n".join((
        self.get_meta_keywords(), 
        self.get_meta_description(), 
        self.get_meta_author(), 
        self.get_meta_copyright(),
      )))
    ```

### å®ç°åŸç†...

è¿™ä¸€mixinå‘æ¨¡å‹æ·»åŠ 4ä¸ªè¿›è¡Œæ‰©å±•çš„å­—æ®µï¼šmeta_keywordsã€meta_descriptionã€meta_authorå’Œmeta_copyrightã€‚è¿˜æ·»åŠ äº†å¯¹åº”çš„get_*()æ–¹æ³•ç”¨äºæ¸²æŸ“ç›¸å…³è”çš„å…ƒæ ‡ç­¾ã€‚å…¶ä¸­æ¯ä¸€ä¸ªéƒ½å‘æ ¸å¿ƒçš„get_meta_field()æ–¹æ³•ä¼ é€’äº†åç§°åŠç›¸åº”çš„å­—é¢ï¼Œè¯¥æ–¹æ³•ç”¨äºè¿”å›æ ¹æ®meta.htmlæ¨¡æ¿æ‰€æ¸²æŸ“çš„æ ‡è®°ã€‚æœ€åæä¾›äº†ä¸€ä¸ªget_meta_tags()å¿«æ·æ–¹æ³•æ¥å¯¹æ‰€æœ‰å¯ç”¨çš„å…ƒæ ‡ç­¾ä¸€æ¬¡æ€§åœ°ç”Ÿæˆç»„åˆæ ‡è®°ã€‚

å¦‚æœåœ¨æ¨¡å‹ä¸­ä½¿ç”¨è¿™ä¸€mixinï¼Œå¦‚Ideaæ¨¡å‹ï¼Œå³åœ¨æœ¬ç« ä¸€å¼€å§‹*ä½¿ç”¨æ¨¡å‹mixin*ä¸€èŠ‚ä¸­æ‰€ä½¿ç”¨çš„ï¼Œå¯ä»¥åœ¨è¯¦æƒ…é¡µæ¨¡æ¿ä¸­åœ¨HEADä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹æ¥æ¸²æŸ“æ‰€æœ‰çš„metaæ ‡ç­¾ï¼š

```
{% block meta_tags %} 
{{ block.super }}
{{ idea.get_meta_tags }} 
{% endblock %}
```

è¿™é‡Œmeta_tagså—åœ¨çˆ¶æ¨¡æ¿ä¸­å·²è¿›è¡Œäº†å®šä¹‰ï¼Œå¹¶ä¸”è¿™ä¸€ä»£ç å—å±•ç¤ºäº†å­æ¨¡æ¿ä¸­å¦‚ä½•é‡å®šä¹‰è¯¥ä»£ç å—ï¼Œé¦–å…ˆä»¥block.superåŒ…å«çˆ¶çº§ä¸­çš„å†…å®¹ï¼Œç„¶åä½¿ç”¨ideaå¯¹è±¡ä¸­çš„å…¶å®ƒæ ‡ç­¾æ¥æ‰©å±•å®ƒã€‚ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨{{ idea.get_meta_description }}è¿™æ ·åœ¨ä»…å¯¹å…·ä½“metaæ ‡ç­¾è¿›è¡Œæ¸²æŸ“ã€‚

è¯»è€…å¯èƒ½æ³¨æ„åˆ°äº†models.pyçš„ä»£ç ä¸­ï¼Œæ‰€æ¸²æŸ“çš„å…ƒæ ‡ç­¾æ ‡è®°ä¸ºsafeï¼Œå³ä¸è¿›è¡Œè½¬ä¹‰ï¼Œæˆ‘ä»¬ä¸ä¸€å®šè¦ä½¿ç”¨safeæ¨¡æ¿è¿‡æ»¤å™¨ã€‚ä»…æ¥è‡ªäºæ•°æ®åº“çš„å€¼ä¼šè¿›è¡Œè½¬ä¹‰ï¼Œç”¨äºç¡®ä¿æœ€ç»ˆçš„HTMLæ ¼å¼æ­£ç¡®ã€‚meta_keywordsåŠå…¶å®ƒå­—æ®µçš„æ•°æ®åº“æ•°æ®ä¼šåœ¨è°ƒç”¨render_to_string() æˆ–meta.html æ¨¡å‹æ—¶è‡ªåŠ¨è¿›è¡Œè½¬ä¹‰ï¼Œå› ä¸ºè¯¥æ¨¡æ¿æ²¡æœ‰åœ¨å†…å®¹ä¸­æŒ‡å®š{% autoescape off %}ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨æ¨¡å‹mixin*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†åˆ›å»ºå’Œå˜æ›´æ—¥æœŸ*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³ç³»*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*å®‰æ’base.htmlæ¨¡æ¿*ä¸€èŠ‚

## åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†é€šç”¨å…³ç³»

é™¤å¸¸è§„çš„æ•°æ®åº“å…³è”å¦‚å¤–è”å…³è”æˆ–å¤šå¯¹å¤šå…³è”å¤–ï¼ŒDjangoæœ‰ä¸€ç§å…³è”ä¸€ä¸ªæ¨¡å‹åˆ°ä»»ä½•å…¶å®ƒæ¨¡å‹çš„å®ä¾‹ã€‚è¿™ä¸€æ¦‚å¿µç§°ä¸ºé€šç”¨å…³ç³»ï¼ˆgeneric relationï¼‰ã€‚å¯¹äºé€šç”¨å…³è”ï¼Œæˆ‘ä»¬ä¼šä¿å­˜æ‰€å…³è”æ¨¡å‹çš„å†…å®¹ç±»å‹ä»¥åŠæ¨¡å‹å®ä¾‹çš„IDã€‚

æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åœ¨æ¨¡å‹mixinä¸­å¯¹é€šç”¨å…³è”è¿›è¡ŒæŠ½è±¡ã€‚

### å‡†å¤‡å·¥ä½œ

è¦æ­£å¸¸çš„å­¦ä¹ æœ¬å°èŠ‚ï¼Œéœ€è¦å®‰è£…ä¸€ä¸ªcontenttypesåº”ç”¨ã€‚é»˜è®¤å®ƒåº”å½“å·²ç»æ·»åŠ åˆ°äº†INSTALLED_APPSåˆ—è¡¨ä¸­ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š

```
# myproject/settings/_base.py
INSTALLED_APPS = [ 
  # contributed
  "django.contrib.admin", 
  "django.contrib.auth", 
  "django.contrib.contenttypes", 
  "django.contrib.sessions", 
  "django.contrib.messages", 
  "django.contrib.staticfiles", 
  # third-party
  # ...
  # local 
  "myproject.apps.core", 
  "myproject.apps.categories", 
  "myproject.apps.ideas",
]
```

åŒæ ·ï¼Œè¯·ç¡®ä¿å·²åˆ›å»ºäº†ä¾›æ¨¡å‹mixinä½¿ç”¨çš„myproject.apps.coreåº”ç”¨ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥åˆ›å»ºå’Œä½¿ç”¨é€šç”¨å…³ç³»çš„mixinï¼š

1.  åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­æ‰“å¼€coreåŒ…ä¸­çš„models.py æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    # myproject/apps/core/models.py
    from django.db import models
    from django.utils.translation import gettext_lazy as _
    from django.contrib.contenttypes.models import ContentType
    from django.contrib.contenttypes.fields import GenericForeignKey 
    from django.core.exceptions import FieldError
    
    def object_relation_base_factory( 
      prefix=None,
      prefix_verbose=None, 
      add_related_name=False, 
      limit_content_type_choices_to=None, 
      is_required=False):
      """
      Returns a mixin class for generic foreign keys using "Content type - object ID" with dynamic field names. This function is just a class generator.
      Parameters:
      prefix: a prefix, which is added in front of the fields
    
      prefix_verbose: a verbose name of the prefix, used to generate a title for the field column of the content object in the Admin
      add_related_name: a boolean value indicating, that a related name for the generated content type foreign key should be added. This value should be true, if you use more than one ObjectRelationBase in your model.
    
      The model fields are created using this naming scheme:
        <<prefix>>_content_type
        <<prefix>>_object_id
        <<prefix>>_content_object
      """
      p = ""
      if prefix:
        p = f"{prefix}_"
        prefix_verbose = prefix_verbose or _("Related object") 
        limit_content_type_choices_to = limit_content_type_choices_to or {}
      content_type_field = f"{p}content_type" 
      object_id_field = f"{p}object_id" content_object_field = f"{p}content_object"
    
      class TheClass(models.Model): 
        class Meta:
          abstract = True
    
      if add_related_name:
        if not prefix:
          raise FieldError("if add_related_name is set to "
                          "True, a prefix must be given")
          related_name = prefix 
      else:
        related_name = None
      
      optional = not is_required
    
      ct_verbose_name = _(f"{prefix_verbose}'s type (model)")
    
      content_type = models.ForeignKey( 
        ContentType,
        verbose_name=ct_verbose_name, 
        related_name=related_name,
        blank=optional,
        null=optional,
        help_text=_("Please select the type (model) "
                    "for the relation, you want to build."), 
        limit_choices_to=limit_content_type_choices_to,
        on_delete=models.CASCADE)
    
      fk_verbose_name = prefix_verbose
      
      object_id = models.CharField( 
        fk_verbose_name,
        blank=optional,
        null=False,
        help_text=_("Please enter the ID of the related object."), 
        max_length=255,
        default="") # for migrations
    
      content_object = GenericForeignKey( 
        ct_field=content_type_field, 
        fk_field=object_id_field)
    
      TheClass.add_to_class(content_type_field, content_type) 
      TheClass.add_to_class(object_id_field, object_id) 
      TheClass.add_to_class(content_object_field, content_object)
      
      return TheClass
    ```

1.  ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨åº”ç”¨ä¸­ä½¿ç”¨ä¸¤ä¸ªé€šç”¨å…³è”çš„ç¤ºä¾‹ä»£ç ç‰‡æ–­ï¼ˆæ”¾åœ¨ideas/models.pyä¸­ï¼‰ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.models import ( 
      object_relation_base_factory as generic_relation,
    )
    
    FavoriteObjectBase = generic_relation( 
      is_required=True,
    )
    
    OwnerBase = generic_relation( 
      prefix="owner",
      prefix_verbose=_("Owner"), 
      is_required=True, 
      add_related_name=True, 
      limit_content_type_choices_to={
        "model__in": (
          "user",
          "group", 
        )
      } 
    )
    
    class Like(FavoriteObjectBase, OwnerBase): 
      class Meta:
        verbose_name = _("Like") 
        verbose_name_plural = _("Likes")
    
      def __str__(self):
        return _("{owner} likes {object}").format(
          owner=self.owner_content_object,
          object=self.content_object
        )
    ```

### å®ç°åŸç†...

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µä»£ç æ¯”å‰é¢çš„è¦å¤æ‚ã€‚

object_relation_base_factoryå‡½æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€çŸ­åˆ«åè¿›è¡Œå¯¼å…¥ä¸ºgeneric_relationï¼Œå¹¶ä¸æ˜¯mixinæœ¬èº«ï¼›å®ƒæ˜¯ç”Ÿæˆæ¨¡å‹mixinçš„å‡½æ•°ï¼Œå³ä¸€ä¸ªç”¨äºç»§æ‰¿çš„æŠ½è±¡æ¨¡å‹ç±»ã€‚åŠ¨æ€åˆ›å»ºçš„mixinæ·»åŠ äº†content_typeå’Œobject_idå­—æ®µä»¥åŠæŒ‡å®šæ‰€å…³è”å®ä¾‹çš„content_objecté€šç”¨å¤–é”®ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç›´æ¥å®šä¹‰å¸¦æœ‰è¿™ä¸ªä¸‰ä¸ªå±æ€§çš„æ¨¡å‹mixinå‘¢ï¼ŸåŠ¨æ€ç”Ÿæˆçš„æŠ½è±¡ç±»è®©æˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªå­—æ®µåæ‹¥æœ‰å‰ç¼€ï¼›å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæ¨¡å‹ä¸­æ‹¥æœ‰å¤šä¸ªé€šç”¨å…³è”ã€‚ä¾‹å¦‚ï¼Œå‰é¢æ‰€å±•ç¤ºçš„Likeæ¨¡å‹ï¼Œä¼šå¯¹æ‰€å–œæ¬¢çš„å¯¹è±¡æ‹¥æœ‰content_typeã€object_idå’Œcontent_objectå­—æ®µï¼Œä»¥åŠå‘é€å–œæ¬¢çš„å¯¹è±¡ï¼ˆç”¨æˆ·æˆ–ç»„ï¼‰çš„owner_content_typeã€owner_object_idå’Œowner_content_objectå­—æ®µã€‚

è¢«æˆ‘ä»¬ç®€åŒ–ä¸ºgeneric_relationçš„object_relation_base_factoryå‡½æ•°ï¼Œå¢åŠ äº†ç”±limit_content_type_choices_toå‚æ•°é™å®šå†…å®¹ç±»å‹é€‰é¡¹çš„å¯èƒ½æ€§ã€‚å‰é¢çš„ç¤ºä¾‹é™åˆ¶å®šäº†owner_content_typeé€‰é¡¹ä¸ºä»…ä¸ºUserå’ŒGroupæ¨¡å‹çš„å†…å®¹ç±»å‹ã€‚

### ç›¸å…³å†…å®¹

-   *é€šè¿‡URLç›¸å…³çš„æ–¹æ³•åˆ›å»ºæ¨¡å‹mixin*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†åˆ›å»ºå’Œå˜æ›´æ—¥æœŸ*ä¸€èŠ‚
-   *åˆ›å»ºæ¨¡å‹mixinæ¥å¤„ç†å…ƒæ ‡ç­¾*ä¸€èŠ‚
-   [**ç¬¬4ç«  æ¨¡æ¿å’ŒJavaScript**](https://alanhou.org/django3-templates-javascript/)ä¸­çš„*å®ç°Likeç»„ä»¶*ä¸€èŠ‚

## å¤„ç†å¤šè¯­è¨€å­—æ®µ

Djangoä½¿ç”¨å›½é™…åŒ–æœºåˆ¶æ¥æ¥åœ¨ä»£ç å’Œæ¨¡æ¿ä¸­ç¿»è¯‘å¯è§†åŒ–å­—ç¬¦ä¸²ã€‚ä½†å¦‚ä½•åœ¨æ¨¡å‹ä¸­å®ç°å¤šè¯­è¨€å†…å®¹ç”±å¼€å‘è€…å†³å®šã€‚æˆ‘ä»¬å°†å±•ç¤ºä¸€äº›åœ¨é¡¹ç›®ä¸­ç›´æ¥å®ç°å¤šè¯­è¨€æ¨¡å‹çš„æ–¹å¼ã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯åœ¨æ¨¡å‹ä¸­ä½¿ç”¨ç‰¹å®šè¯­è¨€çš„å­—æ®µã€‚

è¯¥æ–¹æ³•æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

-   åœ¨æ¨¡å‹ä¸­å®šä¹‰å¤šè¯­è¨€å­—æ®µä¸€ç›®äº†ç„¶
-   åœ¨æ•°æ®åº“æŸ¥è¯¢ä¸­ä½¿ç”¨å¤šè¯­è¨€å­—æ®µéå¸¸ç®€å•
-   å¯ä»¥ä½¿ç”¨å·²æœ‰çš„ç®¡ç†åå°æ¥ç¼–è¾‘å¤šè¯­è¨€å­—æ®µæ¨¡å‹ï¼Œè€Œæ— éœ€åšé¢å¤–çš„ä¿®æ”¹
-   å¦‚è‹¥éœ€è¦ï¼Œå¯ä»¥è½»æ¾åœ°åœ¨åŒä¸€ä¸ªæ¨¡æ¿ä¸­å±•ç¤ºä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰ç¿»è¯‘
-   åœ¨è®¾ç½®ä¸­ä¿®æ”¹è¯­è¨€æ•°é‡åï¼Œéœ€è¦åœ¨å¤šè¯­è¨€ä¸­æ¨¡å‹ä¸­åˆ›å»ºå­—æ®µå¹¶è¿›è¡Œè¿ç§»

### å‡†å¤‡å·¥ä½œ

æœ‰æ²¡æœ‰åˆ›å»ºåœ¨æœ¬ç« å‰é¢å°èŠ‚ä¸­ä½¿ç”¨åˆ°çš„myproject.apps.coreåŒ…ï¼Ÿç°åœ¨éœ€è¦åœ¨coreåº”ç”¨ä¸­æ–°å¢model_fields.pyæ–‡ä»¶ï¼Œç”¨äºè‡ªå®šä¹‰æ¨¡å‹å­—æ®µã€‚

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤åœ¨å®šä¹‰å¤šè¯­è¨€å­—ç¬¦å­—ç¬¦æ®µåŠå¤šè¯­è¨€æ–‡æœ¬å­—æ®µï¼š

1.  æ‰“å¼€model_fields.pyæ–‡ä»¶ï¼Œå¹¶åˆ›å»ºå¦‚ä¸‹çš„å¤šè¯­è¨€åŸºç¡€å­—æ®µï¼š\


    ```
    # myproject/apps/core/model_fields.py
    from django.conf import settings
    from django.db import models
    from django.utils.translation import get_language 
    from django.utils import translation
    
    class MultilingualField(models.Field):
      SUPPORTED_FIELD_TYPES = [models.CharField, models.TextField]
    
      def __init__(self, verbose_name=None, **kwargs): 
        self.localized_field_model = None
        for model in MultilingualField.SUPPORTED_FIELD_TYPES:
          if issubclass(self.__class__, model): 
            self.localized_field_model = model
        self._blank = kwargs.get("blank", False) 
        self._editable = kwargs.get("editable", True) 
        super().__init__(verbose_name, **kwargs)
    
      @staticmethod
      def localized_field_name(name, lang_code):
        lang_code_safe = lang_code.replace("-", "_") 
        return f"{name}_{lang_code_safe}"
    
      def get_localized_field(self, lang_code, lang_name): 
        _blank = (self._blank
                  if lang_code == settings.LANGUAGE_CODE
                  else True)
        localized_field = self.localized_field_model(
          f"{self.verbose_name} ({lang_name})", 
          name=self.name, 
          primary_key=self.primary_key, 
          max_length=self.max_length, 
          unique=self.unique,
          blank=_blank,
          null=False, # we ignore the null argument! 
          db_index=self.db_index, 
          default=self.default or "", 
          editable=self._editable, 
          serialize=self.serialize, 
          choices=self.choices, 
          help_text=self.help_text,
          db_column=None, 
          db_tablespace=self.db_tablespace)
        return localized_field
    
      def contribute_to_class(self, cls, name, 
                              private_only=False,
                              virtual_only=False):
         def translated_value(self):
          language = get_language() 
          val = self.__dict__.get(
              MultilingualField.localized_field_name( 
                name, language))
          if not val:
            val = self.__dict__.get(
                MultilingualField.localized_field_name( 
                    name, settings.LANGUAGE_CODE))
        return val
    
      # generate language-specific fields dynamically 
      if not cls._meta.abstract:
        if self.localized_field_model:
          for lang_code, lang_name in settings.LANGUAGES:
            localized_field = self.get_localized_field( 
                lang_code, lang_name)
            localized_field.contribute_to_class(
                cls, MultilingualField.localized_field_name(
                          name, lang_code))
          setattr(cls, name, property(translated_value))
        else:
          super().contribute_to_class(
            cls, name, private_only, virtual_only)
    ```

1.  åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå¯¹å­—ç¬¦å’Œæ–‡æœ¬å­—æ®µè¡¨å•ç»§æ‰¿å­ç±»ï¼Œå¦‚ä¸‹ï¼š


    ```
    class MultilingualCharField(models.CharField, MultilingualField): 
      pass
      
    class MultilingualTextField(models.TextField, MultilingualField): 
      pass
    ```

1.  åœ¨coreåº”ç”¨ä¸­åˆ›å»ºadmin.pyæ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    # myproject/apps/core/admin.py
    from django.conf import settings
    
    def get_multilingual_field_names(field_name): 
      lang_code_underscored = settings.LANGUAGE_CODE.replace("-", "_")
      field_names = [f"{field_name}_{lang_code_underscored}"] 
      for lang_code, lang_name in settings.LANGUAGES:
        if lang_code != settings.LANGUAGE_CODE: 
          lang_code_underscored = lang_code.replace("-", "_") 
          field_names.append(
                f"{field_name}_{lang_code_underscored}"
            )
      return field_names
    ```

ä¸‹é¢æˆ‘ä»¬å°†ç ”ç©¶å¦‚ä½•åœ¨åº”ç”¨ä¸­ä½¿ç”¨å¤šè¯­è¨€å­—æ®µçš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹ï¼š

1.  é¦–å…ˆï¼Œåœ¨é¡¹ç›®çš„è®¾ç½®ä¸­è®¾ç½®å¤šè¯­è¨€ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬çš„ç½‘ç«™å°†æ”¯æŒæ¬§ç›Ÿçš„æ‰€æœ‰å®˜æ–¹è¯­è¨€ï¼Œè‹±è¯­ä½œä¸ºå…¶é»˜è®¤è¯­è¨€ï¼š


    ```
    # myproject/settings/_base.py 
    LANGUAGE_CODE = "en"
    # All official languages of European Union 
    
    LANGUAGES = [
      ("bg", "Bulgarian"),  ("hr", "Croatian"),
      ("cs", "Czech"),      ("da", "Danish"),
      ("nl", "Dutch"),      ("en", "English"),
      ("et", "Estonian"),   ("fi", "Finnish"),
      ("fr", "French"),     ("de", "German"),
      ("el", "Greek"),      ("hu", "Hungarian"),
      ("ga", "Irish"),      ("it", "Italian"),
      ("lv", "Latvian"),    ("lt", "Lithuanian"),
      ("mt", "Maltese"),    ("pl", "Polish"),
      ("pt", "Portuguese"), ("ro", "Romanian"),
      ("sk", "Slovak"),     ("sl", "Slovene"),
      ("es", "Spanish"),    ("sv", "Swedish"),
    ]
    ```

1.  ç„¶åï¼Œæ‰“å¼€myproject.apps.ideasåº”ç”¨ä¸­çš„models.pyæ–‡ä»¶ï¼Œå¹¶é’ˆå¯¹Ideaæ¨¡å‹åˆ›å»ºå¤šè¯­è¨€å­—æ®µï¼Œå¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.model_fields import ( 
      MultilingualCharField, 
      MultilingualTextField,
    )
    
    class Idea(models.Model):
      title = MultilingualCharField(
        _("Title"),
        max_length=200, 
      )
      content = MultilingualTextField( 
        _("Content"),
      )
    
      class Meta:
        verbose_name = _("Idea") 
        verbose_name_plural = _("Ideas")
    
      def __str__(self): 
        return self.title
    ```

1.  ä¸ºideasé¡¹ç›®åˆ›å»ºä¸€ä¸ªadmin.pyæ–‡ä»¶ï¼š


    ```
    # myproject/apps/ideas/admin.py
    from django.contrib import admin
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.admin import get_multilingual_field_names 
    
    from .models import Idea
    
    @admin.register(Idea)
    class IdeaAdmin(admin.ModelAdmin):
      fieldsets = [
        (_("Title and Content"), {
        "fields": get_multilingual_field_names("title") + 
            get_multilingual_field_names("content")
        }), 
      ]
    ```

### å®ç°åŸç†...

Ideaçš„ç¤ºä¾‹ä¼šç”Ÿæˆç±»ä¼¼ä¸‹é¢è¿™æ ·çš„æ¨¡å‹ï¼š

```
class Idea(models.Model): 
  title_bg = models.CharField(
    _("Title (Bulgarian)"),
    max_length=200, 
  )
  title_hr = models.CharField( 
    _("Title (Croatian)"), 
    max_length=200,
  )
  # titles for other languages... 
  title_sv = models.CharField(
    _("Title (Swedish)"),
    max_length=200, 
  )

  content_bg = MultilingualTextField( 
    _("Content (Bulgarian)"),
  )
  content_hr = MultilingualTextField(
    _("Content (Croatian)"),
  )
  # content for other languages... 
  content_sv = MultilingualTextField(
    _("Content (Swedish)"),
  )

  class Meta:
    verbose_name = _("Idea") 
    verbose_name_plural = _("Ideas")
  
  def __str__(self): 
    return self.title
```

å¦‚æœè¯­è¨€ä»£ç ä¸­åœ¨æ¨ªæ ï¼Œå¦‚de-chè¡¨ç¤ºç‘å£«å¾·è¯­ï¼Œè¿™ç§è¯­è¨€çš„å­—æ®µä¼šè¢«æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œå¦‚title_de_chå’Œcontent_de_chã€‚

é™¤æ‰€ç”Ÿæˆçš„å…·ä½“è¯­è¨€å­—æ®µå¤–ï¼Œè¿˜ä¼šæœ‰ä¸¤ä¸ªå±æ€§ï¼šæ ‡é¢˜å’Œå†…å®¹ï¼Œå°†åœ¨å½“å‰ä½¿ç”¨è¯­è¨€ä¸­è¿”å›ç›¸åº”å­—æ®µã€‚å¦‚æœæ²¡æœ‰æœ¬åœ°åŒ–å­—æ®µå†…å®¹å°±ä¼šä½¿ç”¨é»˜è®¤è¯­è¨€ã€‚

MultilingualCharFieldå’ŒMultilingualTextFieldå­—æ®µä¼šæ ¹æ®LANGUAGESè®¾ç½®åŠ¨æ€å…¼å®¹æ¨¡å‹å­—æ®µã€‚å®ƒä»¬ä¼šé‡å†™åœ¨Djangoæ¡†æ¶åˆ›å»ºæ¨¡å‹ç±»æ—¶ä½¿ç”¨çš„contribute_to_class()æ–¹æ³•ã€‚å¤šè¯­è¨€å­—æ®µåŠ¨æ€ä¸ºé¡¹ç›®çš„æ¯ç§è¯­è¨€æ·»åŠ å­—ç¬¦æˆ–æ–‡æœ¬å­—æ®µã€‚éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿ç§»æ¥åœ¨æ•°æ®åº“ä¸­å¢åŠ ç›¸åº”çš„å­—æ®µã€‚åŒæ—¶ï¼Œé»˜è®¤åˆ›å»ºè¿™äº›å±æ€§æ¥è¿”å›å½“å‰ä½¿ç”¨è¯­è¨€æˆ–ä¸»è¯­è¨€çš„ç¿»è¯‘å€¼ã€‚

åœ¨åå°ä¸­ï¼Œget_multilingual_field_names()ä¼šè¿”å›ä¸€ä¸ªå…·ä½“è¯­è¨€å­—æ®µååˆ—è¡¨ï¼Œä»¥ä¸€ç§é»˜è®¤è¯­è¨€å¼€å¤´ï¼Œç„¶åæ¥LANGUAGESè®¾ç½®ä¸­çš„å…¶å®ƒè¯­è¨€ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›åœ¨æ¨¡å‹åŠè§†å›¾ä¸­ä½¿ç”¨å¤šè¯­è¨€å­—æ®µçš„ç¤ºä¾‹ï¼š

å¦‚æœæ¨¡æ¿ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œå®ƒä¼šæ˜¾ç¤ºå½“å‰ä½¿ç”¨è¯­è¨€ä¸­çš„æ–‡æœ¬ï¼Œæ¯”å¦‚ç«‹é™¶å®›è¯­ï¼Œåœ¨ç¿»è¯‘ä¸å­˜åœ¨æ—¶å°±ä¾ç„¶ä½¿ç”¨è‹±è¯­ï¼š

```
<h1>{{ idea.title }}</h1>
<div>{{ idea.content|urlize|linebreaks }}</div>
```

å¦‚æœæƒ³è®©QuerySetæŒ‰ç…§ç¿»è¯‘åçš„æ ‡é¢˜è¿›è¡Œæ’åºï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹çš„å®šä¹‰ï¼š

```
>>> lang_code = input("Enter language code: ")
>>> lang_code_underscored = lang_code.replace("-", "_")
>>> qs = Idea.objects.order_by(f"title_{lang_code_underscored}")
```

### ç›¸å…³å†…å®¹

-   *æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨*ä¸€èŠ‚
-   *ä½¿ç”¨è¿ç§»*ä¸€èŠ‚
-   [**ç¬¬6ç«  æ¨¡å‹ç®¡ç†**](https://alanhou.org/django3-model-administration/)

## æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨

ç¬¬äºŒç§åœ¨æ•°æ®åº“ä¸­å¤„ç†å¤šè¯­è¨€å†…å®¹çš„æ–¹æ³•ä¸ºå¯¹æ¯ä¸ªå¤šè¯­è¨€æ¨¡å‹ä½¿ç”¨æ¨¡å‹ç¿»è¯‘è¡¨ã€‚

è¿™ç§æ–¹æ³•çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š

-   å¯ä»¥ä½¿ç”¨ç°æœ‰åå°æ¥åœ¨è¡Œå†…ç¼–è¾‘ç¿»è¯‘
-   åœ¨ä¿®æ”¹è®¾ç½®ä¸­çš„è¯­è¨€é‡åï¼Œæ— éœ€åšå‡ºè¿ç§»æˆ–å…¶å®ƒæ“ä½œ
-   å¯ä»¥æ¯«ä¸è´¹åŠ›åœ°æ˜¾ç¤ºå½“å‰è¯­è¨€çš„ç¿»è¯‘ï¼Œä½†å¯¹äºåœ¨åŒä¸€é¡µé¢ä¸­æ˜¾ç¤ºå¤šç§æŒ‡å®šè¯­è¨€çš„ç¿»è¯‘æ—¶ä¼šæ›´ä¸ºå¤æ‚
-   éœ€è¦äº†è§£å¹¶ä½¿ç”¨æœ¬å°èŠ‚ä¸­åˆ›å»ºæ¨¡å‹ç¿»è¯‘çš„å…·ä½“å¥—è·¯
-   æœ¬æ–¹æ³•è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢æ—¶ä¼šæ¯”è¾ƒå¤æ‚ï¼Œä½†é€šè¿‡å­¦ä¹ ä¼šå‘ç°ä»å¯ä»¥å®ç°

### å‡†å¤‡å·¥ä½œ

åŒæ ·ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨myprojects.apps.coreåº”ç”¨ã€‚

### å¦‚ä½•å®ç°...

æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤æ¥å‡†å¤‡å¤šè¯­è¨€æ¨¡å‹ï¼š

1.  åœ¨coreåº”ç”¨ä¸­ï¼Œåˆ›å»ºmodel_fields.pyå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    # myproject/apps/core/model_fields.py
    from django.conf import settings
    from django.utils.translation import get_language 
    from django.utils import translation
    
    class TranslatedField(object):
      def __init__(self, field_name):
        self.field_name = field_name
    
      def __get__(self, instance, owner): 
        lang_code = translation.get_language() 
        if lang_code == settings.LANGUAGE_CODE:
          # The fields of the default language are in the main model
          return getattr(instance, self.field_name) 
        else:
          # The fields of the other languages are in the translation
          # model, but falls back to the main model 
          translations = instance.translations.filter(
            language=lang_code,
          ).first() or instance
          return getattr(translations, self.field_name)
    ```

1.  åœ¨core åº”ç”¨ä¸­å¢åŠ admin.pyæ–‡ä»¶å¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    # myproject/apps/core/admin.py
    from django import forms
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _
    
    class LanguageChoicesForm(forms.ModelForm): 
      def __init__(self, *args, **kwargs): 
        LANGUAGES_EXCEPT_THE_DEFAULT = [
          (lang_code, lang_name)
          for lang_code, lang_name in settings.LANGUAGES 
          if lang_code != settings.LANGUAGE_CODE
        ]
        super().__init__(*args, **kwargs) 
        self.fields["language"] = forms.ChoiceField(
          label=_("Language"), 
          choices=LANGUAGES_EXCEPT_THE_DEFAULT, 
          required=True,
        )
    ```

ä¸‹é¢æˆ‘ä»¬æ¥å®ç°å¤šè¯­è¨€æ¨¡å‹ï¼š

1.  é¦–å…ˆåœ¨é¡¹ç›®çš„è®¾ç½®ä¸­è®¾ç½®å¤šè¯­è¨€ã€‚æ¯”å¦‚æˆ‘ä»¬çš„ç½‘ç«™æ”¯æŒæ¬§ç›Ÿçš„æ‰€æœ‰å®˜æ–¹è¯­è¨€ï¼Œè‹±è¯­æ˜¯é»˜è®¤è¯­è¨€ï¼š


    ```
    # myproject/settings/_base.py 
    LANGUAGE_CODE = "en"
    
    # All official languages of European Union 
    LANGUAGES = [
      ("bg", "Bulgarian"),  ("hr", "Croatian"),
      ("cs", "Czech"),      ("da", "Danish"),
      ("nl", "Dutch"),      ("en", "English"),
      ("et", "Estonian"),   ("fi", "Finnish"),
      ("fr", "French"),     ("de", "German"),
      ("el", "Greek"),      ("hu", "Hungarian"),
      ("ga", "Irish"),      ("it", "Italian"),
      ("lv", "Latvian"),    ("lt", "Lithuanian"),
      ("mt", "Maltese"),    ("pl", "Polish"),
      ("pt", "Portuguese"), ("ro", "Romanian"),
      ("sk", "Slovak"),     ("sl", "Slovene"),
      ("es", "Spanish"),    ("sv", "Swedish"),
    ]
    ```

1.  ç„¶åæˆ‘ä»¬æ¥åˆ›å»ºIdeaå’ŒIdeaTranslationsæ¨¡å‹ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.model_fields import TranslatedField
    
    class Idea(models.Model): 
      title = models.CharField(
        _("Title"),
        max_length=200, 
      )
      content = models.TextField( 
        _("Content"),
      )
      translated_title = TranslatedField("title")
      translated_content = TranslatedField("content")
    
      class Meta:
        verbose_name = _("Idea") 
        verbose_name_plural = _("Ideas")
    
      def __str__(self): 
        return self.title


    class IdeaTranslations(models.Model): 
      idea = models.ForeignKey(
        Idea,
        verbose_name=_("Idea"), 
        on_delete=models.CASCADE, 
        related_name="translations",
      )
      language = models.CharField(_("Language"), max_length=7)
    
      title = models.CharField( 
        _("Title"),
        max_length=200, 
      )
      content = models.TextField( 
        _("Content"),
      )
    
      class Meta:
        verbose_name = _("Idea Translations") 
        verbose_name_plural = _("Idea Translations") 
        ordering = ["language"]
        unique_together = [["idea", "language"]]
    
      def __str__(self): 
        return self.title
    ```

1.  æœ€åï¼Œå¯¹ideasåº”ç”¨åˆ›å»ºadmin.pyå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š


    ```
    # myproject/apps/ideas/admin.py
    from django.contrib import admin
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.admin import LanguageChoicesForm 
    
    from .models import Idea, IdeaTranslations


    class IdeaTranslationsForm(LanguageChoicesForm): 
      class Meta:
        model = IdeaTranslations 
        fields = "__all__"


    class IdeaTranslationsInline(admin.StackedInline): 
      form = IdeaTranslationsForm
      model = IdeaTranslations
      extra = 0


    @admin.register(Idea)
    class IdeaAdmin(admin.ModelAdmin):
      inlines = [IdeaTranslationsInline]
      fieldsets = [
        (_("Title and Content"), {
          "fields": ["title", "content"]
        }),
      ]
    ```

### å®ç°åŸç†...

æˆ‘ä»¬å°†é»˜è®¤è¯­è¨€çš„å…·ä½“è¯­è¨€å­—æ®µæ”¾åˆ°Ideaæ¨¡å‹æœ¬èº«å½“ä¸­ã€‚æ¯ç§è¯­è¨€çš„ç¿»è¯‘ä½äºIdeaTranslationsæ¨¡å‹ä¸­ï¼Œåœ¨åå°ä¸­ä»¥å†…è”ç¿»è¯‘çš„å½¢å¼åˆ—å‡ºã€‚IdeaTranslationsåœ¨æ¨¡å‹å±‚æ²¡æœ‰è¯­è¨€é€‰é¡¹æ˜¯æœ‰åŸå› çš„ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åœ¨æ¯æ¬¡æ·»åŠ æ–°è¯­è¨€æˆ–åˆ é™¤è¯­è¨€æ—¶éƒ½è¿›è¡Œè¿ç§»ã€‚å–è€Œä»£ä¹‹çš„æ˜¯æŠŠè¯­è¨€é€‰é¡¹æ”¾åˆ°åå°è¡¨å•ä¸­ï¼ŒåŒæ—¶ç¡®ä¿è·³è¿‡é»˜è®¤è¯­è¨€æˆ–åœ¨é€‰é¡¹çš„åˆ—è¡¨ä¸å¯ç”¨ã€‚è¯­è¨€é€‰é¡¹é€šè¿‡LanguageChoicesFormç±»è¿›è¡Œçš„é™åˆ¶ã€‚

è¦è·å–å½“å‰è¯­è¨€çš„æŒ‡å®šå­—æ®µï¼Œä½¿ç”¨å®šä¹‰ä¸ºTranslatedFieldçš„è¿™äº›å­—æ®µã€‚åœ¨æ¨¡æ¿ä¸­åƒä¸‹é¢è¿™æ ·ï¼š

```
<h1>{{ idea.translated_title }}</h1>
<div>{{ idea.translated_content|urlize|linebreaks }}</div>
```

è¦é€šè¿‡æŒ‡å®šè¯­è¨€çš„ç¿»è¯‘åæ ‡é¢˜è¿›è¡Œæ’åºï¼Œéœ€è¦åƒä¸‹é¢è¿™æ ·ä½¿ç”¨annotate()æ–¹æ³•ï¼š

```
>>> from django.conf import settings
>>> from django.db import models
>>> lang_code = input("Enter language code: ")

>>> if lang_code == settings.LANGUAGE_CODE:
...   qs = Idea.objects.annotate(
...     title_translation=models.F("title"),
...     content_translation=models.F("content"), 
...   )
...  else:
...    qs = Idea.objects.filter(
...        translations__language=lang_code,    
...     ).annotate(
...        title_translation=models.F("translations__title"),
...        content_translation=models.F("translations__content"),
...     )
>>> qs = qs.order_by("title_translation")

>>> for idea in qs:
...   print(idea.title_translation)
```

æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨Django shellä¸­å¼¹å‡ºè¦æ±‚è¾“å…¥è¯­è¨€ä»£ç ã€‚å¦‚æœä¸ºé»˜è®¤è¯­è¨€ï¼Œæˆ‘ä»¬å°†æ ‡é¢˜å’Œå†…å®¹å­˜å‚¨ä¸ºIdeaæ¨¡å‹ä¸­çš„title_translationå’Œcontent_translationã€‚å¦‚æœé€‰ä¸­çš„æ˜¯å…¶å®ƒè¯­è¨€ï¼Œæˆ‘ä»¬ä»IdeaTranslationsæ¨¡å‹ä¸­æŒ‰ç…§æ‰€é€‰ä¸­è¯­è¨€å°†æ ‡é¢˜å’Œå†…å®¹è¯»å–ä¸ºtitle_translationå’Œcontent_translationã€‚

ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡title_translationæˆ–content_translationå¯¹æŸ¥è¯¢é›†åˆï¼ˆQuerySetï¼‰è¿›è¡Œè¿‡æ»¤æˆ–æ’åºã€‚

### ç›¸å…³å†…å®¹

-   *å¤„ç†å¤šè¯­è¨€å­—æ®µ*ä¸€èŠ‚
-   [**ç¬¬6ç«  æ¨¡å‹ç®¡ç†**](https://alanhou.org/django3-model-administration/)

## è§„é¿å¾ªç¯ä¾èµ–

åœ¨å¼€å‘Djangoæ¨¡å‹æ—¶ï¼Œé¿å…å¾ªç¯ä¾èµ–å°¤å…¶æ˜¯åœ¨models.pyä¸­è§„é¿è¿™ä¸€é—®é¢˜å°¤ä¸ºé‡è¦ã€‚å¾ªç¯ä¾èµ–æ˜¯æŒ‡åœ¨Pythonæ¨¡å—å¯¹å½¼æ­¤è¿›è¡Œå¯¼å…¥æ“ä½œã€‚åº”ç»å¯¹é¿å…åœ¨ä¸åŒçš„models.pyæ–‡ä»¶ä¹‹é—´è¿›è¡Œäº¤å‰å¯¼å…¥ï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´ä¸¥é‡çš„ç¨³å®šæ€§é—®é¢˜ã€‚å¦‚æœæœ‰ç›¸äº’ä¾èµ–ï¼Œè¯·ä½¿ç”¨æœ¬å°èŠ‚ä¸­æ‰€ä»‹ç»çš„æ–¹æ³•ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨categorieså’Œideasåº”ç”¨æ¥è®²è§£å¦‚ä½•å¤„ç†äº¤å‰ä¾èµ–çš„é—®é¢˜ã€‚

### å¦‚ä½•å®ç°...

æŒ‰ç…§å¦‚ä¸‹æ–¹æ³•å¤„ç†ä½¿ç”¨åˆ°å…¶å®ƒåº”ç”¨ä¸­æ¨¡å‹çš„æ¨¡å‹ï¼š

1.  å¯¹äºå¤–é”®å’Œä¸å…¶å®ƒåº”ç”¨ä¸­æ¨¡å‹çš„å¤šå¯¹å¤šå…³è”ï¼Œä½¿ç”¨<app_label>.<model>çš„å£°æ˜æ–¹å¼æ¥ä»£æ›¿æ¨¡å‹çš„å¯¼å…¥ã€‚åœ¨Djangoä¸­è¿™å¯¹ForeignKeyã€OneToOneFieldå’ŒManyToManyFieldéƒ½æœ‰æ•ˆï¼Œå¦‚ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _
    
    class Idea(models.Model): 
      author = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        verbose_name=_("Author"), 
        on_delete=models.SET_NULL, 
        blank=True,
        null=True, 
      )
      category = models.ForeignKey( 
        "categories.Category", 
        verbose_name=_("Category"), 
        blank=True,
        null=True,
        on_delete=models.SET_NULL, 
      )
      # other fields, attributes, properties and methods...
    ```
    
    è¿™é‡Œsettings.AUTH_USER_MODELæ˜¯ä¸€ä¸ªè®¾ç½®ï¼Œå¸¦æœ‰auth.Userè¿™æ ·çš„å€¼

1.  å¦‚æœä½ éœ€è¦åœ¨è°¢è°¢å­¦å§ä¸­è®¿é—®å…¶å®ƒåº”ç”¨çš„æ¨¡å‹çš„è¯ï¼Œåœ¨æ–¹æ³•å†…éƒ¨è€Œä¸è¦åœ¨æ¨¡å‹çº§åˆ«å¯¼å…¥æ¨¡å‹ï¼Œå¦‚ä¸‹ï¼š


    ```
    # myproject/apps/categories/models.py
    from django.db import models
    from django.utils.translation import gettext_lazy as _
    
    class Category(models.Model):
      # fields, attributes, properties, and methods...
      
      def get_ideas_without_this_category(self):
        from myproject.apps.ideas.models import Idea
        return Idea.objects.exclude(category=self)
    ```

1.  å¦‚ä½•ä½¿ç”¨æ¨¡å‹ç»§æ‰¿ï¼Œå¦‚é’ˆå¯¹æ¨¡å‹mixinï¼Œå°†åŸºç±»æ”¾åˆ°å•ç‹¬çš„åº”ç”¨ä¸­å¹¶åœ¨INSTALLED_APPSä¸­å°†å®ƒä»¬æ”¾åˆ°å…¶å®ƒåº”ç”¨ä¹‹å‰ï¼Œå¦‚ä¸‹ï¼š


    ```
    # myproject/settings/_base.py
    
    INSTALLED_APPS = [ 
      # contributed
      "django.contrib.admin", 
      "django.contrib.auth", 
      "django.contrib.contenttypes", 
      "django.contrib.sessions", 
      "django.contrib.messages", 
      "django.contrib.staticfiles", 
      # third-party
      # ...
      # local 
      "myproject.apps.core", 
      "myproject.apps.categories", 
      "myproject.apps.ideas",
    ]
    ```

è¿™é‡Œideasåº”ç”¨å°†åƒä¸‹é¢è¿™æ ·ä½¿ç”¨coreåº”ç”¨ä¸­çš„æ¨¡å‹mixinï¼š

```
# myproject/apps/ideas/models.py
from django.db import models
from django.conf import settings
from django.utils.translation import gettext_lazy as _

from myproject.apps.core.models import ( 
  CreationModificationDateBase, 
  MetaTagsBase,
  UrlBase,
)

class Idea(CreationModificationDateBase, MetaTagsBase, UrlBase):
  # fields, attributes, properties, and methods...
```

### ç›¸å…³å†…å®¹

-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/django3-web-development-cookbook/)ä¸­çš„*ä¸ºå¼€å‘ã€æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®è®¾ç½®*ä¸€èŠ‚
-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/django3-web-development-cookbook/)ä¸­çš„*åœ¨Pythonæ–‡ä»¶ä¸­é‡è§†å¯¼å…¥é¡ºåº*ä¸€èŠ‚
-   *ä½¿ç”¨æ¨¡å‹mixin*ä¸€èŠ‚
-   *ä¿®æ”¹å¤–é”®ä¸ºmany-to-manyå­—æ®µ*ä¸€èŠ‚

## æ·»åŠ æ•°æ®åº“çº¦æŸ

ä¸ºæ›´å¥½åœ°ä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œç»å¸¸ä¼šå®šä¹‰æ•°æ®åº“çº¦æŸï¼Œè¡¨æ˜ä¸€äº›å­—æ®µä¸å…¶å®ƒæ•°æ®è¡¨ç›¸ç»‘å®šï¼Œè®©è¿™äº›å­—æ®µä¿æŒå”¯ä¸€æˆ–ä¸ä¸ºnullã€‚æ›´é«˜çº§çš„æ•°æ®åº“çº¦æŸï¼Œå¦‚è®©å­—æ®µæ ¹æ®æ¡ä»¶ä¿æŒå”¯ä¸€æˆ–ä¸ºä¸€äº›å­—æ®µå€¼è®¾ç½®æŒ‡å®šæ¡ä»¶ï¼ŒDjangoæä¾›äº†ä¸€äº›ç‰¹æ®Šç±»ï¼šUniqueConstraintå’ŒCheckConstraintã€‚æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„å®ä¾‹ã€‚

### å‡†å¤‡å·¥ä½œ

æˆ‘ä»¬ä½¿ç”¨ideasåº”ç”¨å¹¶ä¸”Ideaæ¨¡å‹åˆ°å°‘è¦åŒ…å«titleå’Œauthorå­—æ®µã€‚

### å¦‚ä½•å®ç°...

è®¾ç½®Ideaæ¨¡å‹Metaç±»ä¸­çš„æ•°æ®åº“çº¦æŸå¦‚ä¸‹ï¼š

```
# myproject/apps/ideas/models.py
from django.db import models
from django.utils.translation import gettext_lazy as _


class Idea(models.Model): 
  author = models.ForeignKey(
    settings.AUTH_USER_MODEL, 
    verbose_name=_("Author"), 
    on_delete=models.SET_NULL, 
    blank=True,
    null=True,
    related_name="authored_ideas", 
  )
  title = models.CharField( 
    _("Title"),
    max_length=200, 
  )

  class Meta:
    verbose_name = _("Idea") 
    verbose_name_plural = _("Ideas") 
    constraints = [
      models.UniqueConstraint( 
        fields=["title"], 
        condition=~models.Q(author=None), 
        name="unique_titles_for_each_author",
    ), 
    models.CheckConstraint(
      check=models.Q( 
        title__iregex=r"^\S.*\S$"
        # starts with non-whitespace, 
        # ends with non-whitespace, 
        # anything in the middle
    ),
    name="title_has_no_leading_and_trailing_whitespaces",
  )
]
```

### å®ç°åŸç†...

æˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­å®šä¹‰ä¸¤ä¸ªçº¦æŸã€‚

ç¬¬ä¸€ä¸ªæ˜¯UniqueConstraintï¼Œé™å®šæ¯ä¸ªä½œè€…çš„æ ‡é¢˜è¦å”¯ä¸€ã€‚å¦‚æœæœªè®¾å®šä½œè€…ï¼Œåˆ™æ ‡é¢˜å…è®¸é‡å¤ã€‚è¦æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†ä½œè€…æˆ‘ä»¬ä½¿ç”¨å¦å®šæŸ¥è¯¢ï¼š~models.Q(author=None)ã€‚æ³¨æ„åœ¨Djangoï¼ŒæŸ¥æ‰¾ä¸­çš„~ è¿ç®—ç¬¦ç­‰ä»·äºQuerySetä¸­çš„exclude()æ–¹æ³•ï¼Œå› æ­¤ä»¥ä¸‹çš„æŸ¥è¯¢é›†æ˜¯ç­‰ä»·çš„ï¼š

```
ideas_with_authors = Idea.objects.exclude(author=None)
ideas_with_authors2 = Idea.objects.filter(~models.Q(author=None))
```

ç¬¬äºŒä¸ªçº¦æŸCheckConstraintï¼ŒæŸ¥çœ‹æ ‡é¢˜æ˜¯å¦ä»¥ç©ºç™½å¼€å§‹åŠç»“æŸã€‚å¯¹äºè¿™ç±»ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾ã€‚

### æ‰©å±•çŸ¥è¯†...

æ•°æ®åº“çº¦æŸä¸å½±å“è¡¨å•éªŒè¯ã€‚å¦‚å°†å†…å®¹ä¿å­˜åˆ°æ•°æ®åº“æ—¶ï¼Œå¦‚æœæ•°æ®ä¸æ»¡è¶³æ¡ä»¶åˆ™æŠ›å‡ºdjango.db.utils.IntegrityErrorã€‚

å¦‚æœå¸Œæœ›åœ¨è¡¨å•ä¸­è¿›è¡Œæ•°æ®éªŒè¯ï¼Œéœ€è¦è‡ªå·±å•ç‹¬è¿›è¡Œå®ç°ï¼Œä¾‹å¦‚ï¼Œåœ¨æ¨¡å‹çš„clean()æ–¹æ³•æ·»åŠ é€»è¾‘ã€‚Ideaä¼šå˜æˆç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š

```
# myproject/apps/ideas/models.py
from django.db import models
from django.conf import settings
from django.core.exceptions import ValidationError 
from django.utils.translation import gettext_lazy as _

class Idea(models.Model): 
  author = models.ForeignKey(
    settings.AUTH_USER_MODEL, 
    verbose_name=_("Author"), 
    on_delete=models.SET_NULL, 
    blank=True,
    null=True,
    related_name="authored_ideas2",
  )
  title = models.CharField( 
    _("Title"),
    max_length=200, 
  )

  # other fields and attributes...

  class Meta:
    verbose_name = _("Idea") 
    verbose_name_plural = _("Ideas") 
    constraints = [
      models.UniqueConstraint( 
        fields=["title"], 
        condition=~models.Q(author=None), 
        name="unique_titles_for_each_author2",
      ), 
      models.CheckConstraint(
        check=models.Q( 
          title__iregex=r"^\S.*\S$"
          # starts with non-whitespace, 
          # ends with non-whitespace, 
          # anything in the middle
        ),
        name="title_has_no_leading_and_trailing_whitespaces2", 
      )
    ]

  def clean(self):
    import re
    if self.author and Idea.objects.exclude(pk=self.pk).filter(
      author=self.author,
      title=self.title, 
    ).exists():
      raise ValidationError(
        _("Each idea of the same user should have a unique title.")
      )
    if not re.match(r"^\S.*\S$", self.title):
      raise ValidationError(
        _("The title cannot start or end with a whitespace.")
      )

  # other properties and methods...
```

### ç›¸å…³å†…å®¹

-   [**ç¬¬3ç«  è¡¨å•å’Œè§†å›¾**](https://alanhou.org/forms-views/)
-   [**ç¬¬10ç«  é”¦ä¸Šæ·»èŠ±**](https://alanhou.org/django3-bells-whistles/)ä¸­çš„*ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢è¡¨è¾¾å¼*ä¸€èŠ‚

## ä½¿ç”¨è¿ç§»

åœ¨æ•æ·è½¯ä»¶å¼€å‘ä¸­ï¼Œè¦æ±‚é¡¹ç›®ä¸æ–­æ¼”è¿›å¹¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¿æŒæ›´æ–°ã€‚å› ä¸ºå¼€å‘æ˜¯è¿­ä»£è¿›è¡Œçš„ï¼Œéœ€è¦åœ¨è¿‡ç¨‹ä¸­è¿›è¡Œæ•°æ®åº“æ¨¡å¼çš„æ›´æ”¹ã€‚å€ŸåŠ©äºDjangoçš„è¿ç§»å‘½ä»¤ï¼Œæˆ‘ä»¬æ— éœ€æ‰‹åŠ¨æ›´æ”¹æ•°æ®è¡¨åŠå­—æ®µï¼Œè¿™å¤§å¤šæ•°éƒ½æ˜¯é€šè¿‡å‘½ä»¤è¡Œè‡ªåŠ¨å®Œæˆçš„ã€‚

### å‡†å¤‡å·¥ä½œ

åœ¨å‘½ä»¤è¡Œå·¥å…·ä¸­å¯ç”¨è™šæ‹Ÿç¯å¢ƒï¼Œå¹¶å°†å½“å‰ç›®å½•åˆ‡æ¢ä¸ºé¡¹ç›®ç›®å½•ã€‚

### å¦‚ä½•å®ç°...

è¦å®ç°æ•°æ®åº“è¿ç§»ï¼Œå‚è§å¦‚ä¸‹æ­¥éª¤ï¼š

1.  åœ¨æ–°çš„categoriesæˆ–ideasåº”ç”¨åˆ›å»ºæ¨¡å‹æ—¶ï¼Œéœ€è¦å…ˆç”Ÿæˆç”¨äºåˆ›å»ºåº”ç”¨å¯¹åº”æ•°æ®è¡¨çš„åˆå§‹è¿ç§»ä»£ç ã€‚å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®ç°ï¼š


    ```
    (env)$ python manage.py makemigrations ideas
    ```

1.  é¦–æ¬¡å¸Œæœ›å¯¹é¡¹ç›®åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨æ—¶ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š


    ```
    (env)$ python manage.py migrate
    ```
    
    åœ¨å¸Œæœ›å¯¹æ‰€æœ‰åº”ç”¨æ‰§è¡Œæ–°çš„è¿ç§»æ—¶è¿è¡Œè¯¥å‘½ä»¤ã€‚

1.  å¦‚æœå¸Œæœ›å¯¹å…·ä½“åº”ç”¨æ‰§è¡Œè¿ç§»ï¼Œåˆ™è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š


    ```
    (env)$ python manage.py migrate ideas
    ```

1.  å¦‚è‹¥æƒ³å¯¹æ•°æ®åº“æ¨¡å¼è¿›è¡Œä¿®æ”¹ï¼Œéœ€è¦å¯¹è¯¥æ¨¡å¼åˆ›å»ºè¿ç§»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ideaæ¨¡å‹æ·»åŠ ä¸€ä¸ªå‰¯æ ‡é¢˜å­—æ®µï¼Œåˆ™å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æ·»åŠ è‡³è¿ç§»æ–‡ä»¶ï¼š


    ```
    (env)$ python manage.py makemigrations --name=subtitle_added ideas
    ```
    
    ä½†æ˜¯ï¼Œå¯ä»¥è·³è¿‡ --name=subtitle_addedå­—æ®µçš„æŒ‡å®šï¼Œå› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹Djangoä¼šç”Ÿæˆå¯è¯´æ˜å«ä¹‰çš„é»˜è®¤åç§°ã€‚

1.  æœ‰æ—¶ï¼Œå¯ä»¥æ‰¹é‡åœ¨å·²æœ‰æ¨¡å¼ä¸­æ·»åŠ æˆ–ä¿®æ”¹æ•°æ®ï¼Œè¿™å¯ä»¥é€šè¿‡æ•°æ®è¿ç§»æ¥å®ç°ï¼Œè€Œæ— éœ€è¿›è¡Œæ¨¡å¼è¿ç§»ã€‚è¦åˆ›å»ºåœ¨æ•°æ®è¡¨ä¸­ä¿®æ”¹æ•°æ®çš„è¿ç§»ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š


    ```
    (env)$ python manage.py makemigrations --name=populate_subtitle \ 
    > --empty ideas
    ```
    
    --emptyå‚æ•°å‘Šè¯‰Djangoè¦åˆ›å»ºä¸€ä¸ªæ¡†æ¶æ•°æ®è¿ç§»ï¼Œåœ¨åº”ç”¨å‰éœ€è¦ä¿®æ”¹ä»¥æ‰§è¡Œå¿…è¦çš„æ•°æ®æ“ä½œã€‚å¯¹äºæ•°æ®è¿ç§»ï¼Œæ¨èè®¾ç½®åç§°ã€‚

1.  å¯è¿è¡Œå¦‚ä¸‹å‘½ä»¤æ¥åˆ—ä¸¾æ‰€æœ‰å¯ç”¨çš„å·²åº”ç”¨å’Œæœªåº”ç”¨è¿ç§»ï¼š


    ```
    (env)$ python manage.py showmigrations
    ```
    
    å·²åº”ç”¨è¿ç§»åˆ—ä¸¾æ—¶çš„å‰ç¼€ä¸º[X] ã€‚æœªåº”ç”¨çš„è¿ç§»åˆ—ä¸¾æ—¶å‰ç¼€ä¸º[ ] ã€‚

1.  å¯ä»¥é€šè¿‡è¿è¡Œç›¸åŒçš„å‘½ä»¤ï¼Œä½†ä¼ é€’åº”ç”¨åæ¥åˆ—å‡ºæŒ‡å®šåº”ç”¨çš„å¯ç”¨è¿ç§»ï¼Œå¦‚ä¸‹ï¼š


    ```
    (env)$ python manage.py showmigrations ideas
    ```

### å®ç°åŸç†...

Djangoçš„è¿ç§»æ˜¯é’ˆå¯¹æ•°æ®åº“è¿ç§»æœºåˆ¶çš„æŒ‡ä»¤æ–‡ä»¶ã€‚è¿™ä¸ªæŒ‡ä»¤æ–‡ä»¶å‘Šè¯‰æˆ‘ä»¬è¦åˆ›å»ºæˆ–åˆ é™¤å“ªäº›æ•°æ®è¡¨ã€æ·»åŠ æˆ–åˆ é™¤å“ªäº›å­—æ®µæ®µï¼Œä»¥åŠæ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤å“ªäº›æ•°æ®ã€‚åŒæ—¶ä¹Ÿå®šä¹‰äº†å“ªäº›è¿ç§»ä¾èµ–äºå¦å¤–çš„å“ªäº›è¿ç§»ã€‚

Djangoä¸­æœ‰ä¸¤ç§ç±»å‹çš„è¿ç§»ã€‚ä¸€ç§æ˜¯æ¨¡å¼ï¼ˆschemaï¼‰è¿ç§»ï¼Œå¦ä¸€ç§æ˜¯æ•°æ®è¿ç§»ã€‚æ¨¡å¼è¿ç§»åº”å½“åœ¨æ–°å¢æ¨¡å‹ã€æ·»åŠ æˆ–åˆ é™¤å­—æ®µæ—¶åˆ›å»ºã€‚æ•°æ®è¿ç§»åº”åœ¨å¸Œæœ›åœ¨æ•°æ®åº“ä¸­å¡«å……ä¸€äº›å€¼æˆ–æ‰¹é‡ä»æ•°æ®åº“ä¸­åˆ é™¤å€¼æ—¶ä½¿ç”¨ã€‚æ•°æ®è¿ç§»åœ¨å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨å‘½ä»¤åˆ›å»ºï¼Œç„¶ååœ¨è¿ç§»æ–‡ä»¶ä¸­æ·»åŠ ä»£ç ã€‚

å„åº”ç”¨çš„è¿ç§»ä¿å­˜åœ¨å„è‡ªçš„migrationsç›®å½•ä¸­ã€‚ç¬¬ä¸€æ¬¡è¿ç§»åç§°é€šå¸¸ä¸º0001_initial.pyï¼Œæˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨çš„å…¶å®ƒè¿ç§»åç§°ä¸º0002_subtitle_added.pyåŠ0003_populate_subtitle.pyã€‚æ¯æ¬¡è¿ç§»ä¼šè·å–ä¸€ä¸ªè‡ªåŠ¨é€’å¢çš„æ•°å­—å‰ç¼€ã€‚æ¯æ‰§è¡Œä¸€æ¬¡è¿ç§»ï¼Œéƒ½ä¼šåœ¨django_migrationsæ•°æ®è¡¨ä¸­ä¿å­˜ä¸€æ¡è®°å½•ã€‚

å¯ä»¥é€šè¿‡æŒ‡å®šè¿ç§»ç¼–å·æ¥å›è¿ç§»ï¼Œå¦‚ä»¥ä¸‹å‘½ä»¤æ‰€ç¤ºï¼š

```
(env)$ python manage.py migrate ideas 0002
```

è¦å–æ¶ˆåŒ…å«åˆå§‹è¿ç§»åœ¨å†…çš„æ‰€æœ‰åº”ç”¨è¿ç§»ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```
(env)$ python manage.py migrate ideas zero
```

å–æ¶ˆè¿ç§»è¦æ±‚æ¯æ¬¡è¿ç§»å­˜åœ¨å‰å‘å’Œåå‘æ“ä½œã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåå°æ“ä½œå°†ç²¾ç¡®åœ°å–æ¶ˆç”±å‰å‘æ“ä½œæ‰€åšçš„ä¿®æ”¹ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ä¿®æ”¹ä¸å¯æ¢å¤ï¼Œæ¯”å¦‚åœ¨å‰å°æ“ä½œä»æ¨¡å¼ä¸­åˆ é™¤äº†æŸåˆ—çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºå®ƒé”€æ¯äº†æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåå°æ“ä½œå¯ä»¥æ¢å¤æ¨¡å¼ï¼Œä½†æ•°æ®åˆ™æ— æ³•æ¢å¤ï¼Œå¦ä¸€ç§å¯èƒ½æ˜¯å®Œå…¨æ²¡æœ‰åå‘æ“ä½œå­˜åœ¨ã€‚

> ğŸ’¡åœ¨æµ‹è¯•äº†å‰å‘å’Œåå°è¿ç§»æµç¨‹å¹¶ç¡®ä¿åœ¨å…¶å®ƒå¼€å‘ç¯å¢ƒå’Œå¯¹å…¬ç½‘ç«™ç¯å¢ƒä¸­è‰¯å¥½è¿è¡Œä¹‹å‰ï¼Œè¯·ä¸è¦æäº¤è¿ç§»åˆ°ç‰ˆæœ¬æ§åˆ¶ä¸­ã€‚

### æ‰©å±•çŸ¥è¯†...

ç¼–å†™æ•°æ®åº“è¿ç§»çš„æ›´å¤šå†…å®¹å‚è§å®˜æ–¹ How ToæŒ‡å—ï¼šhttps://docs.djangoproject.com/en/3.0/howto/writing-migrations/ã€‚

### ç›¸å…³å†…å®¹

-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)ä¸­çš„*ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ*ä¸€èŠ‚
-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)ä¸­çš„*ä½¿ç”¨Dockerå®¹å™¨å¤„ç†Django, Gunicorn, Nginxå’ŒPostgreSQL*ä¸€èŠ‚
-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)ä¸­çš„*é€šè¿‡pipå¤„ç†é¡¹ç›®ä¾èµ–*ä¸€èŠ‚
-   [**ç¬¬1ç«  Django 3.0å…¥é—¨**](https://alanhou.org/getting-started-django3/)ä¸­çš„*åœ¨é¡¹ç›®ä¸­åŒ…å«å¤–éƒ¨ä¾èµ–*ä¸€èŠ‚
-   *ä¿®æ”¹å¤–é”®ä¸ºmany-to-manyå­—æ®µ*ä¸€èŠ‚

## ä¿®æ”¹å¤–é”®ä¸ºmany-to-manyå­—æ®µ

æœ¬å°èŠ‚çš„å®ä¾‹ä¸ºå¦‚ä½•å°†å¤šå¯¹ä¸€å…³è”ä¿®æ”¹ä¸ºå¤šå¯¹å¤šå…³è”ï¼ŒåŒæ—¶ä¿ç•™å·²æœ‰æ•°æ®ã€‚æˆ‘ä»¬é’ˆå¯¹æ­¤æƒ…å†µå°†åŒæ—¶ä½¿ç”¨æ¨¡å¼å’Œæ•°æ®è¿ç§»ã€‚

### å‡†å¤‡å·¥ä½œ

å‡å®šæœ‰Ideaæ¨¡å‹ï¼ŒåŒ…å«ä¸€ä¸ªæŒ‡å‘Categoryæ¨¡å‹çš„å¤–é”®ã€‚

1.  æˆ‘ä»¬åœ¨categoriesåº”ç”¨ä¸­å®šä¹‰Categoryæ¨¡å‹å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/categories/models.py
    from django.db import models
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.model_fields import MultilingualCharField
    
    class Category(models.Model): 
      title = MultilingualCharField(
        _("Title"),
        max_length=200, 
      )
      
      class Meta:
        verbose_name = _("Category") 
        verbose_name_plural = _("Categories")
    
      def __str__(self): 
        return self.title
    ```

1.  åœ¨ideasåº”ç”¨ä¸­å®šä¹‰Ideaæ¨¡å‹å¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _
    from myproject.apps.core.model_fields 
    
    import ( 
      MultilingualCharField, 
      MultilingualTextField,
    )
    
    class Idea(models.Model):
      title = MultilingualCharField(
        _("Title"),
        max_length=200, 
      )
      content = MultilingualTextField( 
        _("Content"),
      )
      category = models.ForeignKey( 
        "categories.Category", 
        verbose_name=_("Category"), 
        blank=True,
        null=True, 
        on_delete=models.SET_NULL, 
        related_name="category_ideas",
      )
      
      class Meta:
      verbose_name = _("Idea") 
      verbose_name_plural = _("Ideas")
      
      def __str__(self): 
        return self.title
    ```

1.  ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºå¹¶æ‰§è¡Œåˆå§‹åŒ–è¿ç§»ï¼š


    ```
    (env)$ python manage.py makemigrations categories 
    (env)$ python manage.py makemigrations ideas 
    (env)$ python manage.py migrate
    ```

### å¦‚ä½•å®ç°...

ä»¥ä¸‹æ­¥éª¤å±•ç¤ºå¦‚ä½•ä»å¤–é”®åˆ‡æ¢ä¸ºå¤šå¯¹å¤šå…³è”ï¼ŒåŒæ—¶ä¿ç•™å·²æœ‰æ•°æ®ï¼š

1.  æ–°å¢å¤šå¯¹å¤šå­—æ®µcategorieså¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.model_fields import ( 
      MultilingualCharField,
      MultilingualTextField,
    )
    
    class Idea(models.Model):
      title = MultilingualCharField(
        _("Title"),
        max_length=200, 
      )
      content = MultilingualTextField( 
        _("Content"),
      )
      category = models.ForeignKey(
        "categories.Category", 
        verbose_name=_("Category"), 
        blank=True,
        null=True, 
        on_delete=models.SET_NULL, 
        related_name="category_ideas",
      )
      categories = models.ManyToManyField( 
        "categories.Category", 
        verbose_name=_("Categories"), 
        blank=True, 
        related_name="ideas",
      )
    
      class Meta:
        verbose_name = _("Idea") 
        verbose_name_plural = _("Ideas")
    
      def __str__(self): 
        return self.title
    ```

1.  åˆ›å»ºå¹¶è¿è¡Œæ¨¡å¼è¿ç§»æ¥å¯¹æ•°æ®åº“æ·»åŠ æ–°å…³è”ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤º


    ```
    (env)$ python manage.py makemigrations ideas 
    (env)$ python manage.py migrate ideas
    ```

1.  åˆ›å»ºä¸€ä¸ªæ•°æ®è¿ç§»æ¥å°†categoriesä»å¤–é”®æ‹·è´åˆ°å¤šå¯¹å¤šå­—æ®µï¼Œå¦‚ä¸‹ï¼š


    ```
    (env)$ python manage.py makemigrations --empty \ 
    > --name=copy_categories ideas
    ```

1.  æ‰“å¼€æ–°åˆ›å»ºçš„è¿ç§»æ–‡ä»¶ï¼ˆ0003_copy_categories.pyï¼‰ï¼Œå¹¶å®šä¹‰å‰å°è¿ç§»æŒ‡ä»¤ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š


    ```
    # myproject/apps/ideas/migrations/0003_copy_categories.py
    from django.db import migrations
    
    def copy_categories(apps, schema_editor): 
      Idea = apps.get_model("ideas", "Idea") 
      for idea in Idea.objects.all():
        if idea.category: 
          idea.categories.add(idea.category)


    class Migration(migrations.Migration):
    
      dependencies = [
        ('ideas', '0002_idea_categories'),
      ]
    
      operations = [
        migrations.RunPython(copy_categories),
      ]
    ```

1.  è¿è¡Œæ–°çš„æ•°æ®è¿ç§»å¦‚ä¸‹ï¼š


    ```
    (env)$ python manage.py migrate ideas
    ```

1.  åˆ é™¤models.pyæ–‡ä»¶ä¸­çš„å¤–é”®å­—æ®µcategoryï¼Œä»…ä¿ç•™æ–°çš„å¤šå¯¹å¤šå­—æ®µcategoriesï¼Œå¦‚ä¸‹ï¼š


    ```
    # myproject/apps/ideas/models.py
    from django.db import models
    from django.conf import settings
    from django.utils.translation import gettext_lazy as _
    
    from myproject.apps.core.model_fields import ( 
      MultilingualCharField, 
      MultilingualTextField,
    )
    
    class Idea(models.Model):
      title = MultilingualCharField(
        _("Title"),
        max_length=200, 
      )
      content = MultilingualTextField(
        _("Content"),
      )
    
      categories = models.ManyToManyField( 
        "categories.Category", 
        verbose_name=_("Categories"), 
        blank=True, 
        related_name="ideas",
      )
    
      class Meta:
        verbose_name = _("Idea") 
        verbose_name_plural = _("Ideas")
    
      def __str__(self): 
        return self.title
    ```

1.  åˆ›å»ºå¹¶è¿è¡Œæ¨¡å¼è¿ç§»ï¼Œæ¥åˆ é™¤æ•°æ®è¡¨ä¸­çš„Categorieså­—æ®µï¼Œå¦‚ä¸‹ï¼š


    ```
    (env)$ python manage.py makemigrations ideas 
    (env)$ python manage.py migrate ideas
    ```

### å®ç°åŸç†...

é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨Ideaæ¨¡å‹ä¸­æ·»åŠ äº†ä¸€ä¸ªå¤šå¯¹å¤šå­—æ®µï¼Œå¹¶ç”Ÿæˆäº†ä¸€ä¸ªæ•°æ®åº“ä¸­ç›¸åº”åœ°è¿›è¡Œæ›´æ–°çš„è¿ç§»æ–‡ä»¶ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä¼šä»å¤–é”®categoryå°†å·²æœ‰å…³è”æ‹·è´åˆ°æ–°çš„å¤šå¯¹å¤šå­—æ®µcategoriesçš„æ•°æ®è¿ç§»ã€‚æœ€åï¼Œæˆ‘ä»¬ä»æ¨¡å‹ä¸­åˆ é™¤äº†å¤–é”®ï¼Œå¹¶å†æ¬¡æ›´æ–°äº†æ•°æ®åº“ã€‚

### æ‰©å±•çŸ¥è¯†...

æˆ‘ä»¬çš„æ•°æ®è¿ç§»å½“å‰ä»…åŒ…å«å‰å°æ“ä½œã€å°†å¤–é”®categoryæ‹·è´ä¸ºæ–°çš„categorieså…³è”çš„å‡†å¤‡ä¸ªå…³è”é¡¹ã€‚è™½ç„¶è¿™é‡Œæ²¡æœ‰è¯¦è¿°ï¼Œåœ¨çœŸå®åœºæ™¯ä¸­æœ€å¥½è¿˜åº”åŒ…å«åå‘æ“ä½œã€‚è¿™å¯é€šè¿‡å°†å…³è”é¡¹æ‹·è´å›åˆ°categoryå¤–é”®æ¥å®ç°ã€‚å¯æƒœåœ°æ˜¯ï¼Œä»€ä¹ˆé—®é¢˜å¸¦æœ‰å¤šä¸ªåˆ†ç±»çš„Ideaå¯¹è±¡ä¼šä¸¢å¤±é¢å¤–æ•°æ®ã€‚

### ç›¸å…³å†…å®¹

-   *ä½¿ç”¨è¿ç§»*ä¸€èŠ‚
-   *å¤„ç†å¤šè¯­è¨€å­—æ®µ*ä¸€èŠ‚
-   *æ“ä½œæ¨¡å‹ç¿»è¯‘æ•°æ®è¡¨*ä¸€èŠ‚
-   *è§„é¿å¾ªç¯ä¾èµ–*ä¸€èŠ‚